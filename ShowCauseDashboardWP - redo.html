<!-- Bootstrap core CSS -->

<link href="../Style%20Library/CustomStyleLibraries/jquery-ui-datepicker/jquery-ui.min.css?v=1.0" rel="stylesheet">
<link href="../Style%20Library/CustomStyleLibraries/bootstrap-3.3.7-dist/css/bootstrap.min.css?v=1.0" rel="stylesheet">
<link href="../Style%20Library/CustomStyleLibraries/datatable/dataTables.bootstrap4.css?v=1.0" rel="stylesheet" />
<link href="../Style%20Library/CustomStyleLibraries/datatable/dataTables.responsive.css?v=1.0" rel="stylesheet" />
<link href="../Style%20Library/CustomStyleLibraries/datatable/dataTables.bootstrap4.min.css?v=1.0" rel="stylesheet" />
<link href="../Style%20Library/CustomStyleLibraries/bootstrap-5.1.0-dist/form-wizard/form-wizard.css?v=1.0" rel="stylesheet">
<link href="../Style%20Library/CustomStyleLibraries/bootstrap-tagsinput/bootstrap-tagsinput.css?v=1.0" rel="stylesheet">

<script src="../Style%20Library/CustomStyleLibraries/jquery-ui-datepicker/jquery-ui.min.js?v=1.0"></script>

<script src="../Style%20Library/CustomStyleLibraries/bootstrap-3.3.7-dist/js/bootstrap.min.js?v=1.0"></script>
<script src="../Style%20Library/CustomStyleLibraries/datatable/jquery.dataTables.min.js?v=1.0"></script>
<script src="../Style%20Library/CustomStyleLibraries/datatable/dataTables.bootstrap.min.js?v=1.0"></script>
<script src="../Style%20Library/CustomStyleLibraries/datatable/dataTables.responsive.js?v=1.0"></script>
<script src="../Style%20Library/CustomStyleLibraries/bootstrap-tagsinput/bootstrap-tagsinput.js?v=1.0"></script>


<script src="../Style%20Library/CustomStyleLibraries/datatable/dataTables.responsive.js?v=1.0"></script>


<style type="text/css">
    input[type=text][disabled], input[type=file][disabled], input:not([type])[disabled], textarea[disabled], select[disabled], .sp-peoplepicker-topLevelDisabled, .ms-inputBoxDisabled {
        background-color: #eee;
    }
    hr {
        border-top: 1px solid lightsteelblue;
    }
    h2{
            border-bottom: 1px solid #33993355;
    }
    .intend-5{
        margin-left:50px;
    }
    .m-5{
        margin: 6px;
    }
</style>




    <div style="margin-top: 0px;">


        <div class="row">
            <div class="container">
                <section>


                    <div class="wizard">
                        <div class="wizard-inner">
                            <div class="connecting-line"></div>
                            <ul class="nav nav-tabs" role="tablist">
                                <li id="li_Step1" role="presentation" class="active" style="width:25%">
                                    <a href="#divStep1" data-toggle="tab" aria-controls="step1" role="tab" title="Case Info" data-original-title="Case Info" onclick="moveTo(1)">
                                        <span class="round-tab">
                                            <i class="glyphicon glyphicon-record"></i>
                                        </span>
                                    </a>
                                    <center style="top: -14px;position: relative;">Case Info</center>
                                </li>
                                <li id="li_Step2" role="presentation" class="" style="width:25%">
                                    <a href="#divStep2" data-toggle="tab" aria-controls="step2" role="tab" title="Product Sampling" data-original-title="Product Sampling" onclick="moveTo(2)">
                                        <span class="round-tab">
                                            <i class="glyphicon "></i>
                                        </span>
                                    </a>
                                    <center style="top: -14px;position: relative;">Product Sampling</center>
                                </li>
                                <li id="li_Step3" role="presentation" class="" style="width:25%">
                                    <a href="#divStep3" data-toggle="tab" aria-controls="step3" role="tab" title="Firm Response" data-original-title="Firm Response" onclick="moveTo(3)">
                                        <span class="round-tab">
                                            <i class="glyphicon "></i>
                                        </span>
                                    </a>
                                    <center style="top: -14px;position: relative;">Firm Response</center>
                                </li>
                                <li id="li_Step4" role="presentation" class="" style="width:25%">
                                    <a href="#divStep4" data-toggle="tab" aria-controls="step4" role="tab" title="Correspondence" data-original-title="Correspondence" onclick="moveTo(4)">
                                        <span class="round-tab">
                                            <i class="glyphicon "></i>
                                        </span>
                                    </a>
                                    <center style="top: -14px;position: relative;">Correspondence</center>
                                </li>

                                
                            </ul>

                        </div>


                    </div>


                </section>
            </div>
        </div>


    </div>




    <hr />

    <div id="divFromDetials">

        <input type='hidden' id='hid_ID' />
        <input type='hidden' id='hid_Status' />
        <input type='hidden' id='hid_Stage' />
        <input type='hidden' id='hid_CurrentStatus' />
        <input type='hidden' id='hid_CurrentStage' />

        <div id="divStep1">

            <div class="row">
                <div class="col-md-12">
                    <h2>Case Info</h2>
                </div>
            </div>
            <div class="row intend-5">

                <div class="col-md-4">
                    <div class="form-group">
                        <div class="form-label-group">
                            <label>Case Category<i class="text-danger">*</i> </label>
                            <select id="ddlCaseCategory" class="form-control"></select>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="form-group">
                        <div class="form-label-group">
                            <label>Case No<i class="text-danger">*</i></label>
                            <input type="text" id="txtCaseNo" class="form-control" maxlength="255" />
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-group">
                        <div class="form-label-group">
                            <label>Inspector Name<i class="text-danger">*</i></label>
                            <input type="text" id="txtInspectorName" class="form-control" maxlength="255" />
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-group">
                        <div class="form-label-group">
                            <label>Designation<i class="text-danger">*</i></label>
                            <input type="text" id="txtDesignation" class="form-control" maxlength="255" />
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-group">
                        <div class="form-label-group">
                            <label>Contact Number</label>
                            <input type="text" id="txtContactNumber" class="form-control" maxlength="255" />
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-group">
                        <div class="form-label-group">
                            <label>Region / Province<i class="text-danger">*</i></label>
                            <input type="text" id="txtRegionProvince" class="form-control" maxlength="255" />
                        </div>
                    </div>
                </div>


                <div class="col-md-4">
                    <div class="form-group">
                        <div class="form-label-group">
                            <label>Official Address<i class="text-danger">*</i></label>
                            <textarea id="txtOfficialAddress" class="form-control" cols="20" rows="3"></textarea>
                        </div>
                    </div>
                </div>


                <div class="col-md-4">
                    <div class="form-group">
                        <div class="form-label-group">
                            <label>Location Of Inspector<i class="text-danger">*</i></label>
                            <textarea id="txtLocationOfInspector" class="form-control" cols="20" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                

            </div>
            <hr />
            <center>
                <ul id="ulControlsStep1" class="list-inline pull-center">
                    <li>
                        <!--<button type="button" class="btn btn-primary save-btn" onclick="SaveStep(1)"><i class="glyphicon glyphicon-floppy-disk"></i> Save</button>-->
                        <button type="button" class="btn btn-success finish-btn" onclick="FinishStep(1)" style="display:none;"><i class="glyphicon glyphicon-floppy-saved"></i> Finish</button>
                        <button type="button" class="btn btn-info" onclick="moveTo(2)">Next <i class="glyphicon glyphicon-arrow-right"></i></button>
                    </li>
                </ul>
            </center>
        </div>


        <div id="divStep2" style="display:none;">

            <div class="row">
                <div class="col-md-12">
                    <h2>Product Sampling

                        <a id="btnAddProductDetail" href="#" title="Add Product" onclick="openProduct(0)" class="btn btn-info btn-sm pull-right h5" style="display:none;"><i class="glyphicon glyphicon-plus"></i>&nbsp;Add Product</a>
                    </h2>
                </div>
            </div>



            <div class="row intend-5" id="divProductTable">
                <div class="col-md-12">
                    <br/>
                </div>
                <div class="col-md-12">

                    <table id="tblProductList" class="table table-striped small" style="width: 100%">
                        <thead class="alert alert-info h5">

                            <tr>
                                <th class="th-sm">
                                    #
                                </th>
                                <th class="th-sm">
                                    Product Name
                                </th>
                                <th class="th-sm">
                                    Manufacturing
                                </th>
                                <th class="th-sm">
                                    Batch No
                                </th>

                                <th class="th-sm">
                                    Manufacturing Date
                                </th>
                                <th class="th-sm">
                                    Expiry Date
                                </th>

                                <th class="th-sm">
                                    DI Sampling
                                </th>
                                <th class="th-sm">
                                    Laboratory Report Status
                                </th>
                                <th class="th-sm" align='center' style='text-align:center;'>
                                    Action
                                </th>
                            </tr>

                        </thead>

                        <tbody><tr><td colspan="9">No product defined!</td></tr></tbody>

                    </table>


                </div>
            </div>



            <hr />
            <center>
                <ul id="ulControlsStep2" class="list-inline pull-center">
                    <li>
                        <button type="button" class="btn btn-default" onclick="backTo(1)"><i class="glyphicon glyphicon-arrow-left"></i> Back</button>
                        <!--<button type="button" class="btn btn-success save-btn" onclick="SaveStep(2)"><i class="glyphicon glyphicon-floppy-disk"></i> Save</button>-->
                        <button type="button" class="btn btn-success finish-btn" onclick="FinishStep(2)" style="display:none;"><i class="glyphicon glyphicon-floppy-saved"></i> Finish</button>
                        <button type="button" class="btn btn-info" onclick="moveTo(3)">Next <i class="glyphicon glyphicon-arrow-right"></i></button>
                    </li>
                </ul>
            </center>
        </div>

        <div id="divStep3" style="display:none;">

            <div class="row">
                <div class="col-md-12">
                    <h2>Firm Response
                        <a id="btnAddFirmResponse" href="#" title="Firm Response" onclick="openFirmResponse(0)" class="btn btn-info btn-sm pull-right h5" style="display:none;"><i class="glyphicon glyphicon-plus"></i>&nbsp;Add Firm Response</a>
                    </h2>
                </div>
            </div>


            <div class="row intend-5" id="divFirmResponseTable">
                <div class="col-md-12">
                    <br/>
                </div>
                <div class="col-md-12">


                    <table id="tbl_FirmResponse" class="table table-striped small" style="width: 100%">
                        <thead class="alert alert-info h5">

                            <tr>
                                <th class="th-sm">
                                    #
                                </th>
                                <th class="th-sm">
                                    Product Name
                                </th>
                                <th class="th-sm">
                                    Batch No
                                </th>
                                <th class="th-sm">
                                    Remarks
                                </th>
                                <th class="th-sm">
                                    Response Date
                                </th>
                                <th class="th-sm" align='center' style='text-align:center;'>
                                    Action
                                </th>
                            </tr>

                        </thead>

                        <tbody><tr class="empty-row"><td colspan="6">No firm response found!</td></tr></tbody>

                    </table>


                </div>
            </div>


            <hr />
            <center>
                <ul id="ulControlsStep3" class="list-inline pull-center">
                    <li>
                        <button type="button" class="btn btn-default" onclick="backTo(2)"><i class="glyphicon glyphicon-arrow-left"></i> Back</button>
                        <!--<button type="button" class="btn btn-success save-btn" onclick="SaveStep(3)"><i class="glyphicon glyphicon-floppy-disk"></i> Save</button>-->
                        <button type="button" class="btn btn-success finish-btn" onclick="FinishStep(3)" style="display:none;"><i class="glyphicon glyphicon-floppy-saved"></i> Finish</button>
                        <button type="button" class="btn btn-info" onclick="moveTo(4)">Next <i class="glyphicon glyphicon-arrow-right"></i></button>
                    </li>
                </ul>
            </center>
        </div>

        <div id="divStep4" style="display:none;">

            <div class="row">
                <div class="col-md-12">
                    <h2>Correspondence
                        <a id="btnAddCorrespondence" href="#" title="Add Correspondence" onclick="openCorrespondence(0)" class="btn btn-info btn-sm pull-right h5" style="display:none;"><i class="glyphicon glyphicon-plus"></i>&nbsp;Add Correspondence</a>
                    </h2>
                </div>
            </div>


            <div class="row intend-5" id="divCorrespondenceTable">
                <div class="col-md-12">
                    <br />
                </div>
                <div class="col-md-12">


                    <table id="tbl_Correspondence" class="table table-striped small" style="width: 100%">
                        <thead class="alert alert-info h5">

                            <tr>
                                <th class="th-sm">
                                    #
                                </th>
                                <th class="th-sm">
                                    Correspondence Key
                                </th>
                                <th class="th-sm">
                                    Date
                                </th>
                                <th class="th-sm">
                                    Remarks
                                </th>
                                <th class="th-sm" align='center' style='text-align:center;'>
                                    Action
                                </th>
                            </tr>

                        </thead>

                        <tbody><tr class="empty-row"><td colspan="5">No correspondence found!</td></tr></tbody>

                    </table>


                </div>
            </div>

            <hr />
            <center>
                <ul id="ulControlsStep4" class="list-inline pull-center">
                    <li>
                        <button type="button" class="btn btn-default" onclick="backTo(3)"><i class="glyphicon glyphicon-arrow-left"></i> Back</button>
                        <!--<button type="button" class="btn btn-success save-btn" onclick="SaveStep(4)"><i class="glyphicon glyphicon-floppy-disk"></i> Save</button>-->
                        <button type="button" class="btn btn-success finish-btn" onclick="FinishStep(4)" style="display:none;"><i class="glyphicon glyphicon-floppy-saved"></i> Finish</button>
                        <!--<button type="button" class="btn btn-info" onclick="moveTo(5)">Next <i class="glyphicon glyphicon-arrow-right"></i></button>-->
                    </li>
                </ul>
            </center>
        </div>

        

        <center>
            <ul id="ulControlsClose" class="list-inline pull-center" style="display:none;">
                <li>
                    <button type="button" class="btn btn-default" onclick="javascript: window.location = 'Products.aspx';">Close</button>
                </li>
            </ul>
        </center>
        


        <div class="row" id="divActionLogs" style="display:none;">

            <div class="col-md-12">

                <hr class="xno-margin" />

                <h4 class="pull-left">Action History</h4>

                <div>

                    <table id="tblActionHistory" class="table table-striped small" style="width: 100%">
                        <thead class="alert alert-info h5">
                            <!--style="background-color: #336699; color: white"-->

                            <tr>
                                <th class="th-sm">
                                    Action On
                                </th>
                                <th style="text-align: left" class="th-sm">
                                    Action By
                                </th>
                                <th class="th-sm">
                                    Action Taken
                                </th>
                                <th class="th-sm" style="width:57%;">
                                    Comment
                                </th>
                            </tr>

                        </thead>

                        <tbody></tbody>


                    </table>

                </div>




            </div>
        </div>

        <div style="display:none;">

            <button type="button" id="btnClose" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="button" id="btnSave" class="btn btn-success" onclick="saveRecord();"><i class="glyphicon glyphicon-floppy-disk"></i> Save</button>

        </div>

    </div>



            <!-- Start Product Modal -->
            <div class="modal fade" id="divModal-Product" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true" id="mod_mesga">&times;</span>
                            </button>
                            <h2 class="modal-title" style="border:0px;">Add Product</h2>
                        </div>
                        <div class="modal-body">
                            <input type='hidden' id='hid_ShowCauseProductId' />

                            <div>


                                <div class="row">

                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <div class="form-label-group">
                                                <label>Product Name<i class="text-danger">*</i></label>
                                                <select id="ddlProduct" class="form-control"></select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <div class="form-label-group">
                                                <label>Plant / Manufacturing<i class="text-danger">*</i></label>
                                                <!--<textarea id="txtManufacturing" class="form-control" cols="20" rows="3"></textarea>-->
                                                <input type="text" id="txtManufacturing" maxlength="1000" class="form-control" />
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <div class="form-label-group">
                                                <label>Batch No<i class="text-danger">*</i></label>
                                                <input type="text" id="txtBatchNo" class="form-control" maxlength="255" />
                                            </div>
                                        </div>
                                    </div>


                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <div class="form-label-group">
                                                <label>Manufacturing Date<i class="text-danger">*</i></label>
                                                <input type="text" id="txtManufacturingDate" class="form-control datepicker " maxlength="15" autocomplete="off" />
                                            </div>
                                        </div>
                                    </div>


                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <div class="form-label-group">
                                                <label>Expiry Date<i class="text-danger">*</i></label>
                                                <input type="text" id="txtExpiryDate" class="form-control datepicker " maxlength="15" autocomplete="off" />
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <div class="form-label-group">
                                                <label>Quantity Drawn<i class="text-danger">*</i></label>
                                                <input type="text" id="txtQuantityDrawn" class="form-control" maxlength="255" />
                                            </div>
                                        </div>
                                    </div>



                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <div class="form-label-group">
                                                <label>Batch Size<i class="text-danger">*</i></label>
                                                <input type="text" id="txtBatchSize" class="form-control" maxlength="255" />
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <div class="form-label-group">
                                                <label>Supplied Quantity<i class="text-danger">*</i></label>
                                                <input type="text" id="txtSuppliedQuantity" class="form-control" maxlength="255" />
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <div class="form-label-group">
                                                <label>Supplied To<i class="text-danger">*</i></label>
                                                <input type="text" id="txtSuppliedTo" class="form-control" maxlength="255" />
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <div class="form-label-group">
                                                <label>Sales / Invoice Record<i class="text-danger">*</i></label>
                                                <input type="text" id="txtSalesInvoice" class="form-control" maxlength="255" />
                                            </div>
                                        </div>
                                    </div>


                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <div class="form-label-group">
                                                <label>DI Sampling<i class="text-danger">*</i></label>
                                                <select id="ddlDISampling" class="form-control"></select>
                                            </div>
                                        </div>
                                    </div>


                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <div class="form-label-group">
                                                <label>Laboratory Report Status<i class="text-danger">*</i></label>
                                                <select id="ddlLaboratoryReportStatus" class="form-control"></select>
                                            </div>
                                        </div>
                                    </div>


                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <div class="form-label-group">
                                                <label>Report Remarks<i class="text-danger hide">*</i></label>
                                                <textarea id="txtReportRemarks" class="form-control" cols="20" rows="4"></textarea>
                                            </div>
                                        </div>
                                    </div>

                                </div>





                                <div class="row" id="divAttachment_Products" style="display:none;">
                                    <div class="col-md-12">
                                        <hr />
                                        <h4 class="pull-left">Product Attachments</h4>
                                        <a id="btnAddAttachment" href="#" title="Add Attachment" onclick="openAddAttachment(0,'Products')" class="btn btn-info btn-sm pull-right h5"><i class="glyphicon glyphicon-plus"></i>&nbsp;Add Attachment</a>

                                    </div>
                                    <div class="col-md-12">

                                        <table id="tblAttachment_Products" class="table table-striped small" style="width: 100%">
                                            <thead class="alert alert-info h5">

                                                <tr>
                                                    <th class="th-sm">
                                                        #
                                                    </th>
                                                    <th class="th-sm">
                                                        Ref. No
                                                    </th>
                                                    <th class="th-sm">
                                                        Dated
                                                    </th>
                                                    <th class="th-sm">
                                                        Files
                                                    </th>

                                                    <th class="th-sm">
                                                        Uploaded On
                                                    </th>
                                                    <th class="th-sm" align='center' style='text-align:center;'>
                                                        Action
                                                    </th>
                                                </tr>

                                            </thead>

                                            <tbody><tr class="empty-row"><td colspan="6">No attachment attachted!</td></tr></tbody>

                                        </table>


                                    </div>
                                </div>

                            </div>


                        </div>
                        <div class="modal-footer">

                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="button" id="btnSave" class="btn btn-success" onclick="saveProduct();"><i class="glyphicon glyphicon-floppy-disk"></i> Save</button>

                        </div>
                    </div>
                </div>


            </div>
            <!-- End Product Modal -->




<!-- Start Firm Response Modal -->
<div class="modal fade" id="divModal-FirmResponse" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" id="mod_mesga">&times;</span>
                </button>
                <h2 class="modal-title" style="border:0px;">Add Firm Response</h2>
            </div>
            <div class="modal-body" style="display: flow-root;">
                <input type='hidden' id='hid_FirmResponseId' />

                <div>


                    <div class="row">

                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Product Name<i class="text-danger">*</i></label>
                                    <select id="ddlFirmResponseProducts" class="form-control" onchange="onChangeddlFirmResponseProducts()"></select>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Batch No<i class="text-danger">*</i></label>
                                    <input type="text" id="txtFirmResponseBatchNo" class="form-control" maxlength="255" />
                                </div>
                            </div>
                        </div>

                    </div>



                    <div class="row" id="divLetterRefNoAttachments">



                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Letter Ref. No<i class="text-danger">*</i></label>
                                    <input type="text" id="txtFirmResponseRefNo" class="form-control" maxlength="255" />
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Dated<i class="text-danger">*</i></label>
                                    <input type="text" id="txtFirmResponseLetterRefDated" class="form-control datepicker" maxlength="15" autocomplete="off" />
                                </div>
                            </div>
                        </div>

                        <div class="col-md-5">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>File Attachment<i class="text-danger">*</i> </label>
                                    <input type="file" id="fileFirmResponseRefFiles" class="form-control" multiple="multiple" />
                                    <div id="divFirmResponseRefFiles" class="form-control" style="display:none; height: auto;"></div>
                                </div>
                            </div>
                        </div>

                    </div>


                    <div class="row" id="divCourierReceiptAttachments">



                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Response acknowledged /<br/>Courier Receipt Dated</label>                                    
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Dated<i class="text-danger">*</i></label>
                                    <input type="text" id="txtFirmResponseCourierReceiptDated" class="form-control datepicker" maxlength="15" autocomplete="off" />
                                </div>
                            </div>
                        </div>

                        <div class="col-md-5">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>File Attachment<i class="text-danger">*</i> </label>
                                    <input type="file" id="fileFirmResponseCourierReceiptFiles" class="form-control" multiple="multiple" />
                                    <div id="divFirmResponseCourierReceiptFiles" class="form-control" style="display:none; height: auto;"></div>
                                </div>
                            </div>
                        </div>

                    </div>



                        <div class="col-md-12">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Remarks<i class="text-danger hide">*</i></label>
                                    <textarea id="txtFirmResponseRemarks" class="form-control" cols="20" rows="4"></textarea>
                                </div>
                            </div>
                        </div>

                    </div>





                    <div class="row" id="divAttachment_FirmResponse" style="display:none;">
                        <div class="col-md-12">
                            <hr />
                            <h4 class="pull-left">Attachments</h4>
                            <a id="btnAddAttachment" href="#" title="Add Attachment" onclick="openAddAttachment(0, 'FirmResponse')" class="btn btn-info btn-sm pull-right h5"><i class="glyphicon glyphicon-plus"></i>&nbsp;Add Attachment</a>

                        </div>
                        <div class="col-md-12">

                            <table id="tblAttachment_FirmResponse" class="table table-striped small" style="width: 100%">
                                <thead class="alert alert-info h5">

                                    <tr>
                                        <th class="th-sm">
                                            #
                                        </th>
                                        <th class="th-sm">
                                            Ref. No
                                        </th>
                                        <th class="th-sm">
                                            Dated
                                        </th>
                                        <th class="th-sm">
                                            Files
                                        </th>

                                        <th class="th-sm">
                                            Uploaded On
                                        </th>
                                        <th class="th-sm" align='center' style='text-align:center;'>
                                            Action
                                        </th>
                                    </tr>

                                </thead>

                                <tbody><tr class="empty-row"><td colspan="6">No attachment attachted!</td></tr></tbody>

                            </table>


                        </div>
                    </div>

                </div>


            <div class="modal-footer">

                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" id="btnSave" class="btn btn-success" onclick="saveFirmResponse();"><i class="glyphicon glyphicon-floppy-disk"></i> Save</button>

            </div>
        </div>
    </div>
</div>
<!-- End Firm Response Modal -->


<!-- Start Correspondence Modal -->
<div class="modal fade" id="divModal-Correspondence" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" id="mod_mesga">&times;</span>
                </button>
                <h2 class="modal-title" style="border:0px;">Add Correspondence</h2>
            </div>
            <div class="modal-body" style="display: flow-root;">
                <input type='hidden' id='hid_CorrespondenceId' />

                <div>


                    <div class="row">

                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Correspondence Key<i class="text-danger">*</i></label>
                                    <select id="ddlCorrespondenceKey" class="form-control"></select>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Date<i class="text-danger">*</i></label>
                                    <input type="text" id="txtCorrespondenceDated" class="form-control datepicker" maxlength="15" autocomplete="off" />
                                </div>
                            </div>
                        </div>

                    </div>


                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Remarks<i class="text-danger hide">*</i></label>
                                    <textarea id="txtCorrespondenceRemarks" class="form-control" cols="20" rows="6"></textarea>
                                </div>
                            </div>
                        </div>

                    </div>

                        <div class="row" id="divCorrespondenceAttachments">

                            <div class="col-md-12">
                                <div class="form-group">
                                    <div class="form-label-group">
                                        <label>File Attachment<i class="text-danger">*</i> </label>
                                        <input type="file" id="fileCorrespondenceFiles" class="form-control" multiple="multiple" />
                                        <div id="divCorrespondenceFiles" class="form-control" style="display:none; height: auto;"></div>
                                    </div>
                                </div>
                            </div>

                        </div>


                    </div>
        
                

            </div>


            <div class="modal-footer">

                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" id="btnSave" class="btn btn-success" onclick="saveCorrespondence();"><i class="glyphicon glyphicon-floppy-disk"></i> Save</button>

            </div>
        </div>
    </div>
</div>
<!-- End Correspondence Modal -->




<!-- Start Attachment Modal -->
<div class="modal fade" id="divModal-Attachment" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" id="mod_mesga">&times;</span>
                </button>
                <h2 class="modal-title" style="border:0px;">Add Attachment</h2>
            </div>
            <div class="modal-body">
                <input type='hidden' id='hid_ProductId' />
                <input type='hidden' id='hid_AttachmentType' />

                <div>

                    <div class="row" id="divAttachmentFolder">



                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Ref. No<i class="text-danger">*</i></label>
                                    <input type="text" id="txtRefNo" class="form-control" maxlength="255" />
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Dated<i class="text-danger">*</i></label>
                                    <input type="text" id="txtDated" class="form-control datepicker" maxlength="15" autocomplete="off" />
                                </div>
                            </div>
                        </div>

                    </div>



                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>File Attachment<i class="text-danger">*</i> </label>
                                    <input type="file" id="fileAttachedFiles" class="form-control" multiple="multiple" />
                                </div>
                            </div>
                        </div>


                    </div>

                </div>


            </div>
            <div class="modal-footer">

                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" id="btnSave" class="btn btn-success" onclick="saveAttachment();"><i class="glyphicon glyphicon-floppy-disk"></i> Save Attachment</button>

            </div>
        </div>
    </div>


</div>
<!-- End Attachment Modal -->

<!-- Modal View Document -->
<div class="modal fade" id="divModal_ViewDocument" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" id="mod_mesga">&times;</span>
                </button>
                <button type="button" class="close" onclick="min_max(this)">
                    <span><i class="glyphicon glyphicon-resize-horizontal"></i></span>
                </button>
                <h3 class="modal-title" id="h4NomenclatureTitle">File Title</h3>
            </div>
            <div class="modal-body">
                <div id="divfrmpdf"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>

            </div>
        </div>
    </div>
</div>
<!-- Modal View Document -->


            <script type="text/javascript">

                var _isEditable = false;
                function backTo(index) {
                    moveTo(index);
                }
                function moveTo(index) {



                    /*
                            if ($('#hid_Status').val() == "Rejected") {

                                switch ($('#hid_Stage').val()) {
                                    case "Create":
                                        //if (index != 1)
                                        {
                                            moveTo(1);
                                        }
                                        break;
                                    case "Applied":
                                        //if (index != 2)
                                        {
                                            moveTo(2);
                                        }
                                        break;
                                    case "Pre-Registration":
                                        //if (index != 3)
                                        {
                                            moveTo(3);
                                        }
                                        break;
                                    case "Registered":
                                        //if (index != 4)
                                        {
                                            moveTo(4);
                                        }
                                        break;
                                    case "PRV":
                                        //if (index != 5)
                                        {
                                            moveTo(5);
                                        }
                                        break;
                                    case "Renewal":
                                        //if (index != 6)
                                        {
                                            moveTo(6);
                                        }
                                        break;
                                    default:
                                        if (index != 1) {
                                            moveTo(1);
                                        }
                                        break;
                                }

                                $("ul[id*='ulControlsStep']").hide();
                            }
                            else {
                            */

                    var focusOnSecsion = "";

                    switch (index) {
                        case 1:
                            $("#divStep1,#ulControlsStep1").show();

                            $("#divStep2,#ulControlsStep2,#divStep3,#ulControlsStep3,#divStep4,#ulControlsStep4").hide();
                            $("#divStep1").find('input,select,textarea').prop('disabled', false);

                            /*$("#btnAddPackSize,#btnAddAttachment,#btnAddFolder,#btnAddQuery").hide();
                            $("#divPackSizeTable,#divAttachment,#divProductQuery").hide();
                            $("#ulControlsClose").hide();
                            */

                            $(".wizard").find(".nav > li").removeClass('active').addClass('disabled');
                            $(".wizard").find(".nav  .glyphicon").removeClass('glyphicon-record glyphicon-ok');
                            $(".wizard").find(".nav > #li_Step1").addClass('active');
                            $(".wizard").find(".nav > #li_Step1").find('.glyphicon').addClass('glyphicon-record');


                            break;
                        case 2:
                            $("#divStep2,#ulControlsStep2").show();
                            $("#divStep1,#ulControlsStep1,#divStep3,#ulControlsStep3,#divStep4,#ulControlsStep4").hide();
                            $("#divStep2").find('input,select,textarea').prop('disabled', false);
                            /*

                            $("#btnAddPackSize,#btnAddQuery").show();
                            $("#divPackSizeTable,#divAttachment,#divProductQuery").show();
                            //$("#btnAddAttachment,#btnAddFolder").hide();
                            if (havePremission(Permission.UPLOAD, Module.ProductManagement, $("#ddlCountry").val())) {
                                $("#btnAddAttachment,#btnAddFolder").show();
                                $("#divAttachment_Applied").find("#btnAddAttachment,#btnAddFolder").show();
                            } else {
                                $("#btnAddAttachment,#btnAddFolder").hide();
                            }
                            $("#ulControlsClose").hide();
                            */
                            $(".wizard").find(".nav > li").removeClass('active').addClass('disabled');
                            $(".wizard").find(".nav  .glyphicon").removeClass('glyphicon-record glyphicon-ok');
                            $(".wizard").find(".nav > #li_Step1").find('.glyphicon').addClass('glyphicon-ok');
                            $(".wizard").find(".nav > #li_Step2").addClass('active');
                            $(".wizard").find(".nav > #li_Step2").find('.glyphicon').addClass('glyphicon-record');

                            break;
                        case 3:
                            $("#divStep3,#ulControlsStep3").show();
                            $("#divStep1,#ulControlsStep1,#divStep2,#ulControlsStep2,#divStep4,#ulControlsStep4").hide();
                            $("#divStep3").find('input,select,textarea').prop('disabled', false);
                            /*
                            $("#divCreateStep,#divAppliedStep,#divPreRegistrationStep,#ulControlsStep3").show();
                            $("#ulControlsStep1,#ulControlsStep2,#divPRVStep,#ulControlsStep4,#divRegistrationStep,#divRenewalStep,#ulControlsStep5,#ulControlsStep6").hide();
                            $("#divCreateStep,#divAppliedStep").find('input,select,textarea').prop('disabled', false);
                            $("#divPreRegistrationStep").find('input,select,textarea').prop('disabled', false);


                            $("#btnAddPackSize,#btnAddQuery,#divPackSizeTable,#divProductQuery,#divAttachment").show();
                            $("#btnRegisteredPackaging").hide();
                            
                            //$("#btnAddAttachment,#btnAddFolder").hide();
                            if (havePremission(Permission.UPLOAD, Module.ProductManagement, $("#ddlCountry").val())) {
                                $("#btnAddAttachment,#btnAddFolder").show();
                                $("#divAttachment_PreRegistration").find("#btnAddAttachment,#btnAddFolder").show();
                            } else {
                                $("#btnAddAttachment,#btnAddFolder").hide();
                            }

                            $("#ulControlsClose").hide();
                            */
                            $(".wizard").find(".nav > li").removeClass('active').addClass('disabled');
                            $(".wizard").find(".nav  .glyphicon").removeClass('glyphicon-record glyphicon-ok');
                            $(".wizard").find(".nav > #li_Step1,.nav #li_Step2").find('.glyphicon').addClass('glyphicon-ok');
                            $(".wizard").find(".nav > #li_Step3").addClass('active');
                            $(".wizard").find(".nav > #li_Step3").find('.glyphicon').addClass('glyphicon-record');

                            break;
                        case 4:

                            $("#divStep4,#ulControlsStep4").show();
                            $("#divStep1,#ulControlsStep1,#divStep2,#ulControlsStep2,#divStep3,#ulControlsStep3").hide();
                            $("#divStep4").find('input,select,textarea').prop('disabled', false);
                            /*
                            $("#divCreateStep,#divAppliedStep,#divPreRegistrationStep,#divRegistrationStep,#ulControlsStep4").show();
                            $("#ulControlsStep1,#ulControlsStep2,#ulControlsStep3,#divPRVStep,#divRenewalStep,#ulControlsStep5,#ulControlsStep6").hide();
                            $("#divCreateStep,#divAppliedStep,#divPreRegistrationStep").find('input,select,textarea').prop('disabled', false);
                            $("#divRegistrationStep").find('input,select,textarea').prop('disabled', false);
                            $("#divPRVStep,#ddlShelfLife").prop('disabled', false);
                            $("#divPRVStep").find('input,select,textarea').prop('disabled', false);


                            //$("#btnAddAttachment,#btnAddFolder").hide();
                            $("#btnAddPackSize,#divPackSizeTable,#divAttachment,#divProductQuery,#btnAddQuery,#btnRegisteredPackaging").show();


                            if (havePremission(Permission.UPLOAD, Module.ProductManagement, $("#ddlCountry").val())) {
                                $("#btnAddAttachment,#btnAddFolder").show();
                                $("#divAttachment_Registration").find("#btnAddAttachment,#btnAddFolder").show();
                            } else {
                                $("#btnAddAttachment,#btnAddFolder").hide();
                            }


                            $("#ulControlsClose").hide();
                            */

                            $(".wizard").find(".nav > li").removeClass('active').addClass('disabled');
                            $(".wizard").find(".nav  .glyphicon").removeClass('glyphicon-record glyphicon-ok');
                            $(".wizard").find(".nav #li_Step1,.nav #li_Step2,.nav #li_Step3").find('.glyphicon').addClass('glyphicon-ok');
                            $(".wizard").find(".nav > #li_Step4").addClass('active');
                            $(".wizard").find(".nav > #li_Step4").find('.glyphicon').addClass('glyphicon-record');

                            break;
                        default:


                            $("#divStep1,#ulControlsStep1").show();
                            $("#divStep4,#ulControlsStep4,#divStep2,#ulControlsStep2,#divStep3,#ulControlsStep3").hide();
                            $("#divStep1").find('input,select,textarea').prop('disabled', false);

                            /*
                            $("#divCreateStep,#ulControlsStep1").show();
                            $("#divAppliedStep,#ulControlsStep2,#divPreRegistrationStep,#ulControlsStep3,#divRegistrationStep,#divRenewalStep,#divPRVStep,#ulControlsStep4,#ulControlsStep5,#ulControlsStep6").hide();
                            $("#divCreateStep").find('input,select,textarea').prop('disabled', false);

                            $("#btnAddPackSize,#btnAddAttachment,#btnAddFolder,#btnAddQuery,#btnRegisteredPackaging").hide();
                            $("#divPackSizeTable,#divAttachment,#divProductQuery").hide();
                            $("#ulControlsClose").hide();
                            */
                            $(".wizard").find(".nav > li").removeClass('active').addClass('disabled');
                            $(".wizard").find(".nav  .glyphicon").removeClass('glyphicon-record glyphicon-ok');
                            $(".wizard").find(".nav > #li_Step1").addClass('active');
                            $(".wizard").find(".nav > #li_Step1").find('.glyphicon').addClass('glyphicon-record');

                            break;
                    }
                    /*
                    if (_isEditable == true) {


                        if ($('#hid_Stage').val() != $('#hid_CurrentStage').val()) {
                            $(".save-btn,.finish-btn").prop('disabled', false);
                            $(".save-btn,.finish-btn").removeClass('disabled');


                            $('#hid_Status').val("On Hold");
                        } else {

                            $(".save-btn,.finish-btn").prop('disabled', true);
                            $(".save-btn,.finish-btn").addClass('disabled');

                            $('#hid_Status').val($("#hid_CurrentStatus").val());
                        }


                        if ($('#hid_Status').val() == "Draft" || $('#hid_Status').val() == "On Hold" || $('#hid_Status').val() == "Send Back") {
                            $(".save-btn,.finish-btn").prop('disabled', false);
                            $(".save-btn,.finish-btn").removeClass('disabled');
                        }

                        //$('#hid_Status').val("On Hold");
                        //if ($('#hid_Status').val() == $("#hid_CurrentStatus").val()) {

                        //}

                    }*/

                    if (focusOnSecsion.length > 0) {
                        setTimeout(function () {
                            var a = document.createElement('A');
                            a.href = focusOnSecsion;
                            //document.body.appendChild(a);
                            a.click();

                        }, 100);
                    }

                    //}
                }

                function lockMoving() {
                    setTimeout(function () {

                        switch ($('#hid_Stage').val()) {
                            case "Create":
                                moveTo(1);
                                break;
                            case "Applied":
                                moveTo(2);
                                break;
                            case "Pre-Registration":
                                moveTo(3);
                                break;
                            case "Registered":
                                moveTo(4);
                                break;
                            case "PRV":
                                moveTo(5);
                                break;
                            case "Renewal":
                                moveTo(6);
                                break;
                            default:
                                moveTo(1);
                                break;
                        }

                        setTimeout(function () {

                            $("ul[id*='ulControlsStep']").hide();

                            $("#ulControlsClose").show();

                            mode = 'view';

                            $("#divCreateStep,#divAppliedStep,#divPreRegistrationStep,#divPRVStep,#divRegistrationStep,#divRenewalStep").find('input,select,textarea').prop('disabled', true);

                            $("#btnAddPackSize,#btnAddQuery,#btnAddAttachment,#btnAddFolder,#btnRegisteredPackaging").hide();

                        }, 100);

                    }, 100);

                }


                function SaveStep(index) {
                    saveRecord('Save', index);
                }


                function FinishStep(index) {
                    saveRecord('Finish', index);
                }
            </script>


            <script type="text/javascript">
                $(document).ready(function () {

                    //RequestStarted();

                    $("#pageContentTitle").text("Create New Showcause Notice");

                    //$(".ms-listviewtable").find('thead th').addClass("alert alert-info h5 ");
                    //$(".ms-listviewtable").addClass('table table-bordered');

                    if (havePremission(Permission.UPLOAD, Module.ShowCause ) == true) {
                        
                        $("#btnAddProductDetail,#btnAddFirmResponse,#btnAddCorrespondence").show();
                        $("#btnAddAttachment,#btnAddFolder,.finish-btn,#btnSave").show();
                    } else {
                        $("#btnSave").remove();
                    }


                    $('.datepicker').datepicker({
                        onSelect: function (dateText, datepickerObj) {
                            console.log("Selected date: " + dateText + "; input's current value: " + this.value, datepickerObj);
                        }
                    });



                    bindAllDDLs();
                    
                    //RequestEnded();

                    var rid = GetUrlKeyValue('rid');
                    if ((Number(rid) > 0) == true) {
                        $('#hid_ID').val(rid);

                        openShowCauseDetails(rid);
                    }



                });


                var _recordId = 0;
                function openShowCauseDetails(_id, mode) {

                    var dashbaordForm = $("#divFromDetials");


                    mode = 'edit';

                    dashbaordForm.find(".modal-title").text('Applind For New Product');

                    // reset All controls
                    dashbaordForm.find("select,input[type='text'],input[type='hidden']").val('');
                    dashbaordForm.find(".is-invalid").removeClass("is-invalid");

                    if (_id && Number(_id) > 0) {

                        /*
                        var idFilter = "Id eq '" + _id + "'";
                        var filterProducts = idFilter + "&$select=ID,Title,Generic,PackType,Strength,MarketedStatus,SubmissionDate,Status,Stage," +
                            "CompanyLookupId," +
                            "CountryLookupId," +
                            "CategoryLookupId," +
                            "DosageTypeId," +
                            "ManufacturingSiteLookupId," +
                            "ShelfLifeLookupId," +
                            "Created";*/
                        _recordId = _id;
                        showLoader();
                        setTimeout(function () {
                            GetSPListItems("ShowCauseCases", _recordId, '', false)
                                .done(function (data) {

                                    try {

                                        var _item = data.d;
                                        if (_item) {

                                            // is record Accessiable

                                            //isPageAccessable(_item.CountryLookupId);

                                            dashbaordForm.find('#hid_ID').val(_item.Id);
                                            //dashbaordForm.find('#hid_Status').val(_item.Status);
                                            //dashbaordForm.find('#hid_Stage').val(_item.Stage);
                                            //dashbaordForm.find('#hid_CurrentStatus').val(_item.Status);
                                            //dashbaordForm.find('#hid_CurrentStage').val(_item.Stage);

                                            $("#pageContentTitle").text("View Details: " + _item.Title);


                                            /*ddlCaseCategory
                                            txtCaseNo
                                            txtInspectorName
                                            txtDesignation
                                            txtContactNumber
                                            txtRegionProvince
                                            txtOfficialAddress
                                            txtLocationOfInspector

                                            CaseNo, InspectorName, Designation, ContactNumber, RegionProvince, OfficialAddress, LocationOfInspection, CaseCategoryLookup
                                            */
                                            dashbaordForm.find('#txtCaseNo').val(_item.CaseNo);
                                            dashbaordForm.find('#txtInspectorName').val(_item.InspectorName);
                                            dashbaordForm.find('#txtDesignation').val(_item.Designation);
                                            dashbaordForm.find('#txtContactNumber').val(_item.ContactNumber);
                                            dashbaordForm.find('#txtRegionProvince').val(_item.RegionProvince);
                                            dashbaordForm.find('#txtOfficialAddress').val(_item.OfficialAddress);
                                            dashbaordForm.find('#txtLocationOfInspector').val(_item.LocationOfInspection);
                                            dashbaordForm.find('#ddlCaseCategory').val(_item.CaseCategoryLookupId);



                                            _isEditable = true;


                                            /*
                                            if (_item.Status == "Draft" || _item.Status == "On Hold" || _item.Status == "Send Back") {

                                                mode = 'edit';

                                                $(".save-btn,.finish-btn").prop('disabled', false);
                                                $(".save-btn,.finish-btn").removeClass('disabled');

                                                if (havePremission(Permission.UPLOAD, Module.ProductManagement, _item.CountryLookupId) == false) {

                                                    $("ul[id*='ulControlsStep']").hide();

                                                    $("#ulControlsClose").show();

                                                    mode = 'view';

                                                    $("#divCreateStep,#divAppliedStep,#divPreRegistrationStep,#divPRVStep,#divRegistrationStep,#divRenewalStep").find('input,select,textarea').prop('disabled', true);

                                                    $("#btnAddPackSize,#btnAddQuery,#btnAddAttachment,#btnAddFolder,#btnRegisteredPackaging").hide();

                                                    $(".nav").find("a").attr('onclick', 'lockMoving()');

                                                    $(".save-btn,.finish-btn").prop('disabled', true);
                                                    $(".save-btn,.finish-btn").addClass('disabled');
                                                }


                                            }
                                            */

                                            notificationMarkAsSeen();


                                            RequestEnded();

                                            bindShowcauseProducts(_item.Id, mode);
                                            bindShowcauseFirmResponse(_item.Id, mode);
                                            bindShowCauseCorrespondence(_item.Id, mode);
                                           /* bindPackSize(_item.Id, mode);
                                            bindAttachment(_item.Id, mode);
                                            bindProductQuery(_item.Id, mode);
                                            bindActionHistory(_item.Id);
                                            bindProductTrail(_item.Id);
                                            */
                                            RequestEnded();
                                            hideLoader();


                                        }

                                    } catch (ex2) {
                                        console.error(ex2);
                                        RequestEnded();
                                        hideLoader();
                                    }

                                    //dashbaordForm.modal('show');

                                }).fail(function (data) {
                                    RequestEnded();
                                });
                        }, 100);

                        //dashbaordForm.find("#divPackSizeTable,#divAttachment,#divProductQuery").show();

                    } else {

                        //dashbaordForm.modal('show');

                        //dashbaordForm.find("#divPackSizeTable,#divAttachment,#divProductQuery").hide();
                    }

                }



                function openProduct(_productid, mode) {

                    var modalWindow = $("#divModal-Product");

                    modalWindow.find(".modal-title").text('Add Product');

                    // reset All controls
                    modalWindow.find("select,input[type='text'],input[type='hidden'],textarea").val('');
                    modalWindow.find(".is-invalid").removeClass("is-invalid");
                    modalWindow.find('#hid_ShowCauseProductId').val('0');
                    modalWindow.find('#divAttachment_Products').hide();
                    

                    if (_productid && Number(_productid) > 0) {

                        modalWindow.find('#divAttachment_Products').show();


                        if (mode.toLowerCase() == 'edit') {
                            modalWindow.find(".modal-title").text('Edit Product');

                            if (havePremission(Permission.UPLOAD, Module.ShowCause) == true) {

                                modalWindow.find("#btnAddAttachment,#btnSave").show();

                                modalWindow.find('input,select,textarea').prop('disabled', false);
                            } else {
                                modalWindow.find("#btnSave").remove();
                                modalWindow.find('input,select,textarea').prop('disabled', true);
                            }

                        } else {
                            modalWindow.find(".modal-title").text('View Product');

                            modalWindow.find("#btnAddAttachment,#btnSave").hide();
                            modalWindow.find('input,select,textarea').prop('disabled', true);
                        }                        


                        GetSPListItems("ShowCauseProducts", _productid, '')
                            .done(function (data) {

                                var _item = data.d;
                                if (_item) {

                                    modalWindow.find('#hid_ShowCauseProductId').val(_item.Id);


                                    modalWindow.find('#txtCaseNo').val(_item.Title);
                                    modalWindow.find('#txtManufacturing').val(_item.Manufacturing);
                                    modalWindow.find('#ddlProduct').val(_item.ProductLookupId);
                                    modalWindow.find('#txtBatchNo').val(_item.BatchNo);
                                    //modalWindow.find('#txtManufacturingDate').val(_item.ManufacturingDate);
                                    //modalWindow.find('#txtExpiryDate').val(_item.ExpiryDate);
                                    modalWindow.find('#txtQuantityDrawn').val(_item.QuantityDrawn);
                                    modalWindow.find('#txtBatchSize').val(_item.BatchSize);
                                    modalWindow.find('#txtSuppliedQuantity').val(_item.SuppliedQuantity);
                                    modalWindow.find('#txtSuppliedTo').val(_item.SuppliedTo);
                                    modalWindow.find('#txtSalesInvoice').val(_item.SalesInvoiceRecord);
                                    modalWindow.find('#ddlDISampling').val(_item.DISamplingLookupId);
                                    modalWindow.find('#ddlLaboratoryReportStatus').val(_item.LaboratoryReportStatusId);

                                    modalWindow.find('#txtReportRemarks').val(_item.ReportRemarks);


                                    var _manufacturingDate = new Date(_item.ManufacturingDate);
                                    if (_manufacturingDate && _manufacturingDate.getFullYear() > 1970)
                                        modalWindow.find("#txtManufacturingDate").datepicker('setDate', _manufacturingDate);

                                    var _expiryDate = new Date(_item.ExpiryDate);
                                    if (_expiryDate && _expiryDate.getFullYear() > 1970)
                                        modalWindow.find("#txtExpiryDate").datepicker('setDate', _expiryDate);
                                    bindProductsAttachments(_recordId, _item.Id, 'edit');

                                }

                                modalWindow.modal('show');

                            });

                    } else {

                        modalWindow.modal('show');
                    }
                }


                function openFirmResponse(_FirmResponseid, mode) {

                    var modalWindow = $("#divModal-FirmResponse");

                    modalWindow.find(".modal-title").text('Add Firm Response');

                    // reset All controls
                    modalWindow.find("select,input[type='text'],input[type='hidden'],textarea").val('');
                    modalWindow.find(".is-invalid").removeClass("is-invalid");
                    modalWindow.find('#hid_FirmResponseId').val('0');
                    modalWindow.find('#divAttachment_FirmResponse').hide();
                    modalWindow.find("#divFirmResponseRefFiles,#divFirmResponseCourierReceiptFiles").hide();

                    bindFirmResponseProductsDDL(_recordId);

                    if (_FirmResponseid && Number(_FirmResponseid) > 0) {
                        
                        if (mode.toLowerCase() == 'edit') {
                            modalWindow.find(".modal-title").text('Edit Firm Response');

                            if (havePremission(Permission.UPLOAD, Module.ShowCause) == true) {

                                modalWindow.find("#btnSave").show();

                                modalWindow.find('input,select,textarea').prop('disabled', false);

                                modalWindow.find("input[type='file']").show();
                            } else {
                                modalWindow.find("#btnSave").remove();
                                modalWindow.find('input,select,textarea').prop('disabled', true);
                                modalWindow.find("input[type='file']").hide();
                            }

                        } else {
                            modalWindow.find(".modal-title").text('View Firm Response');

                            modalWindow.find("#btnSave").hide();
                            modalWindow.find('input,select,textarea').prop('disabled', true);
                            modalWindow.find("input[type='file']").hide();
                        }


                        GetSPListItems("ShowCauseFirmResponse", _FirmResponseid, '')
                            .done(function (data) {

                                var _item = data.d;
                                if (_item) {

                                    modalWindow.find('#hid_FirmResponseId').val(_item.Id);


                                    modalWindow.find('#ddlFirmResponseProducts').val(_item.ProductLookupId);
                                    modalWindow.find('#txtFirmResponseBatchNo').val(_item.BatchNo);
                                    modalWindow.find('#txtFirmResponseRemarks').val(_item.Remarks);


                                    modalWindow.find('#divAttachment_FirmResponse').hide();
                                    bindfirmResponseAttachments(_recordId, _item.Id, 'edit');

                                }

                                modalWindow.modal('show');

                            });

                    } else {

                        modalWindow.modal('show');
                    }
                }

                

                function openCorrespondence(_CorrespondenceId, mode) {

                    console.error('got here')
                    var modalWindow = $("#divModal-Correspondence");

                    modalWindow.find(".modal-title").text('Add Correspondence');

                    // reset All controls
                    modalWindow.find("select,input[type='text'],input[type='hidden'],textarea").val('');
                    modalWindow.find(".is-invalid").removeClass("is-invalid");
                    modalWindow.find('#hid_CorrespondenceId').val('0');
                    modalWindow.find('#divAttachment_Correspondence').hide();
                    modalWindow.find("#divCorrespondenceFiles").hide();
                    
                    if (_CorrespondenceId && Number(_CorrespondenceId) > 0) {
                        
                        if (mode.toLowerCase() == 'edit') {
                            modalWindow.find(".modal-title").text('Edit Correspondence');

                            if (havePremission(Permission.UPLOAD, Module.ShowCause) == true) {

                                modalWindow.find("#btnSave").show();

                                modalWindow.find('input,select,textarea').prop('disabled', false);
                                modalWindow.find("input[type='file']").show();
                            } else {
                                modalWindow.find("#btnSave").remove();
                                modalWindow.find('input,select,textarea').prop('disabled', true);
                                modalWindow.find("input[type='file']").hide();
                            }

                        } else {
                            modalWindow.find(".modal-title").text('View Correspondence');

                            modalWindow.find("#btnSave").hide();
                            modalWindow.find('input,select,textarea').prop('disabled', true);
                            modalWindow.find("input[type='file']").hide();
                        }

                        GetSPListItems("ShowCauseCorrespondence", _CorrespondenceId, '')
                            .done(function (data) {

                                var _item = data.d;
                                if (_item) {

                                    modalWindow.find('#hid_CorrespondenceId').val(_item.Id);

                                    modalWindow.find('#ddlCorrespondenceKey').val(_item.CorrespondenceKeyId);
                                    //modalWindow.find('#txtCorrespondenceDated').val(_item.Date);

                                    var _refDated = new Date(_item.Date);
                                    if (_refDated && _refDated.getFullYear() > 1970)
                                        modalWindow.find("#txtCorrespondenceDated").datepicker('setDate', _refDated);

                                    modalWindow.find('#txtCorrespondenceRemarks').val(_item.Remarks);


                                    bindCorrespondenceAttachments(_recordId, _item.Id, 'edit');

                                }

                                modalWindow.modal('show');

                            });

                    } else {

                        modalWindow.modal('show');
                    }
                }


                function bindAllDDLs() {

                    $("#ddlCaseCategory,#ddlProduct,#ddlDISampling,#ddlLaboratoryReportStatus,#ddlCorrespondenceKey").find('option').remove();
                    $("#ddlCaseCategory,#ddlProduct,#ddlDISampling,#ddlLaboratoryReportStatus,#ddlCorrespondenceKey").append("<option value=''> -- Select -- </option>");

                    var isActiveFilter = ""; //"IsActive eq '1'";

                    GetSPListItems("ShowCauseCategory", 0, isActiveFilter)
                        .done(function (data) {
                            try {

                                if (data && data.d && data.d.results.length > 0) {
                                    for (var _u = 0 ; _u < data.d.results.length; _u++) {
                                        var _thisUserItem = data.d.results[_u];
                                        var newOPtion = "<option value='" + _thisUserItem.Id + "'>" + _thisUserItem.Title + "</option>";
                                        $("#ddlCaseCategory").append(newOPtion);
                                    }
                                }

                            } catch (ex) { console.log(ex); }
                        });

                    GetSPListItems("DISamplingList", 0, isActiveFilter)
                        .done(function (data) {
                            try {

                                if (data && data.d && data.d.results.length > 0) {
                                    for (var _u = 0 ; _u < data.d.results.length; _u++) {
                                        var _thisUserItem = data.d.results[_u];
                                        var newOPtion = "<option value='" + _thisUserItem.Id + "'>" + _thisUserItem.Title + "</option>";
                                        $("#ddlDISampling").append(newOPtion);
                                    }
                                }

                            } catch (ex) { console.log(ex); }
                        });

                    GetSPListItems("LaboratoryReportStatus", 0, isActiveFilter)
                        .done(function (data) {
                            try {

                                if (data && data.d && data.d.results.length > 0) {
                                    for (var _u = 0 ; _u < data.d.results.length; _u++) {
                                        var _thisUserItem = data.d.results[_u];
                                        var newOPtion = "<option value='" + _thisUserItem.Id + "'>" + _thisUserItem.Title + "</option>";
                                        $("#ddlLaboratoryReportStatus").append(newOPtion);
                                    }
                                }

                            } catch (ex) { console.log(ex); }
                        });

                    GetSPListItems("ShowCauseCorrespondenceKeys", 0, isActiveFilter)
                        .done(function (data) {
                            try {

                                if (data && data.d && data.d.results.length > 0) {
                                    for (var _u = 0 ; _u < data.d.results.length; _u++) {
                                        var _thisUserItem = data.d.results[_u];
                                        var newOPtion = "<option value='" + _thisUserItem.Id + "'>" + _thisUserItem.Title + "</option>";
                                        $("#ddlCorrespondenceKey").append(newOPtion);
                                    }
                                }

                            } catch (ex) { console.log(ex); }
                        });

                    isActiveFilter = "IsActive eq 1 and IsDeleted eq '0' and Status eq 'Approved'&$orderby=Title";

                    GetSPListItems("Products", 0, isActiveFilter)
                        .done(function (data) {
                            try {

                                if (data && data.d && data.d.results.length > 0) {
                                    for (var _u = 0 ; _u < data.d.results.length; _u++) {
                                        var _thisUserItem = data.d.results[_u];
                                        var newOPtion = "<option value='" + _thisUserItem.Id + "'>" + _thisUserItem.Title + "</option>";
                                        $("#ddlProduct").append(newOPtion);
                                    }
                                }

                            } catch (ex) { console.log(ex); }
                        });

                }
                
                function bindFirmResponseProductsDDL(_CaseId) {

                    $("#ddlFirmResponseProducts").find('option').remove();
                    $("#ddlFirmResponseProducts").append("<option value=''> -- Select -- </option>");
                    
                    if (Number(_CaseId) > 0) {
                        
                        var idFilter = "ShowcauseCaseLookupId eq " + _CaseId + " and IsDeleted eq '0'";

                        var filterProducts = idFilter + "&$select=ID,Title,Manufacturing,BatchNo,ShowcauseCaseLookupId,ProductLookup/Id,ProductLookup/Title&$expand=ProductLookup";

                        GetSPListItems("ShowCauseProducts", 0, filterProducts)
                            .done(function (data) {

                                try {

                                    if (data && data.d && data.d.results.length > 0) {

                                        for (var _u = 0 ; _u < data.d.results.length; _u++) {
                                            var _thisrecordItem = data.d.results[_u];
                                            if (_thisrecordItem.ProductLookup != null && Number(_thisrecordItem.ProductLookup.Id) > 0) {
                                                var newOPtion = "<option value='" + _thisrecordItem.Id + "' data-batch-no='" + _thisrecordItem.BatchNo + "'>" + _thisrecordItem.ProductLookup.Title + "</option>";
                                                $("#ddlFirmResponseProducts").append(newOPtion);
                                            }

                                        }
                                    }

                                } catch (ex) { console.log(ex); }

                            });
                    }
                }
                function onChangeddlFirmResponseProducts() {
                    var _batch_no = $("#ddlFirmResponseProducts").find("option:selected").data("batch-no");
                    if (_batch_no && _batch_no != null && _batch_no.length > 0) {                        
                        $("#txtFirmResponseBatchNo").val(_batch_no);
                    }
                }

                function bindShowcauseProducts(_CaseId, mode) {

                    if (Number(_CaseId) > 0) {


                        var idFilter = "ShowcauseCaseLookupId eq " + _CaseId + " and IsDeleted eq '0'";

                        var filterProducts = idFilter + "&$select=ID,Title,Manufacturing,BatchNo,ManufacturingDate,ExpiryDate,ShowcauseCaseLookupId,ProductLookup/Id,ProductLookup/Title,DISamplingLookup/Id,DISamplingLookup/Title,LaboratoryReportStatus/Id,LaboratoryReportStatus/Title&$expand=ProductLookup,DISamplingLookup,LaboratoryReportStatus";

                        GetSPListItems("ShowCauseProducts", 0, filterProducts)
                            .done(function (dataProductsLst) {

                                var responseProductsLst = dataProductsLst.d.results;

                                $('#tblProductList>tbody').html('');


                                for (var i = 0; i < responseProductsLst.length ; i++) {

                                    var _item = responseProductsLst[i];
                                    var _table = "#tblProductList";


                                    var newRow = "<tr id='" + _item["ID"] + "'>" +

                                        "<td>" + "[RowIndex]" + "</td>" +
                                        "<td>" + (_item["ProductLookup"] == null ? "" : _item["ProductLookup"].Title) + "</td>" +
                                        "<td>" + _item["Manufacturing"] + "</td>" +
                                        "<td>" + _item["BatchNo"] + "</td>" +
                                        "<td>" + toDisplayDate(_item["ManufacturingDate"]) + "</td>" +
                                        "<td>" + toDisplayDate(_item["ExpiryDate"]) + "</td>" +
                                        "<td>" + (_item["DISamplingLookup"] == null ? "" : _item["DISamplingLookup"].Title) + "</td>" +
                                        "<td>" + (_item["LaboratoryReportStatus"] == null ? "" : _item["LaboratoryReportStatus"].Title) + "</td>";
                                    
                                    var _actionButtonHTML = "";
                                    

                                    if (havePremission(Permission.UPLOAD, Module.ShowCause) == true) {
                                        _actionButtonHTML += "<a href='#' title='Edit' onclick='openProduct(" + _item.Id + ",\"edit\")' ><i class='glyphicon glyphicon-edit'></i></a>";
                                        _actionButtonHTML += (_actionButtonHTML.length > 0 ? "&nbsp;" : "") + "<a href='#'  title='Delete'  onclick='deleteShowCauseProduct(" + _item.Id + ")' ><i class='glyphicon glyphicon-trash'></i></a>";
                                    }
                                    else if (havePremission(Permission.VIEW, Module.ShowCause) == true) {
                                        _actionButtonHTML += "<a href='#' title='View' onclick='openProduct(" + _item.Id + ",\"view\")' ><i class='glyphicon glyphicon-list-alt'></i></a>";
                                    }
                                    
                                    if (mode == 'view') {
                                        _actionButtonHTML = "";
                                    }

                                    newRow = newRow + "<td align='center' style='text-align:center;' class='h5'>" + _actionButtonHTML + "</td>";
                                    newRow = newRow + "</tr>";


                                    newRow = newRow.replace(/\[RowIndex\]/g, ($(_table + '>tbody').find('tr').length + 1));

                                    $(_table + '>tbody').append(newRow);

                                }


                                if ($('#tblProductList>tbody').find('tr').length == 0) {
                                    $('#tblProductList>tbody').html('<tr><td colspan="7">No product defined!</td></tr>');
                                }

                            });
                    }
                }

                var lstAllShowCauseProducts;
                function bindShowcauseFirmResponse(_CaseId, mode) {

                    if (Number(_CaseId) > 0) {
                        
                        var getAllShowCauseProducts = "ShowcauseCaseLookupId eq " + _CaseId + " and IsDeleted eq '0'&$select=ID,ProductLookup/Id,ProductLookup/Title&$expand=ProductLookup";

                        GetSPListItems("ShowCauseProducts", 0, getAllShowCauseProducts, false)
                            .done(function (data) {

                                lstAllShowCauseProducts = data.d.results;
                            });


                        var idFilter = "ShowCauseLookupId eq " + _CaseId + " and IsDeleted eq '0'";

                        var filterProducts = idFilter + "&$select=ID,Title,BatchNo,Remarks,ShowCauseLookupId,ProductLookup/Id,ProductLookup/Title,Created&$expand=ProductLookup";

                        GetSPListItems("ShowCauseFirmResponse", 0, filterProducts)
                            .done(function (data) {

                                var response = data.d.results;

                                $('#tbl_FirmResponse>tbody').html('');


                                for (var i = 0; i < response.length ; i++) {

                                    var _item = response[i];
                                    var _table = "#tbl_FirmResponse";

                                    var prodoctTitle = "-";
                                    let selectedProductItem = lstAllShowCauseProducts.filter(function (af) { return af.Id == _item["ProductLookup"].Id;});
                                    if (selectedProductItem != null && selectedProductItem.length > 0) {
                                        prodoctTitle = selectedProductItem[0]["ProductLookup"].Title;
                                    }

                                    var _remarks = "";
                                    if (_item["Remarks"]) {
                                        _remarks = ((_item["Remarks"] != null && _item["Remarks"].length > 120) ? _item["Remarks"].substring(0, 100) + "..." : _item["Remarks"]);
                                    }

                                    var newRow = "<tr id='" + _item["ID"] + "'>" +

                                        "<td>" + "[RowIndex]" + "</td>" +
                                        "<td>" + prodoctTitle + "</td>" +
                                        "<td>" + _item["BatchNo"] + "</td>" +
                                        "<td>" + _remarks + "</td>" +
                                        "<td>" + toDisplayDate(_item["Created"]) + "</td>";
                                    var _actionButtonHTML = "";
                                    
                                    if (havePremission(Permission.UPLOAD, Module.ShowCause) == true) {
                                        _actionButtonHTML = "<a href='#' title='Edit' onclick='openFirmResponse(" + _item.Id + ",\"edit\")' ><i class='glyphicon glyphicon-edit'></i></a> &nbsp; ";
                                        _actionButtonHTML += "<a href='#'  title='Delete'  onclick='deleteFirmResponse(" + _item.Id + ")' ><i class='glyphicon glyphicon-trash'></i></a>";
                                    } else if (havePremission(Permission.VIEW, Module.ShowCause) == true) {
                                        _actionButtonHTML = "<a href='#' title='View' onclick='openFirmResponse(" + _item.Id + ",\"view\")' ><i class='glyphicon glyphicon-list-alt'></i></a>";
                                    }


                                    if (mode == 'view') {
                                        _actionButtonHTML = "";
                                    }

                                    newRow = newRow + "<td align='center' style='text-align:center;' class='h5'>" + _actionButtonHTML + "</td>";
                                    newRow = newRow + "</tr>";


                                    newRow = newRow.replace(/\[RowIndex\]/g, ($(_table + '>tbody').find('tr').length + 1));

                                    $(_table + '>tbody').append(newRow);

                                }


                                if ($('#tbl_FirmResponse>tbody').find('tr').length == 0) {
                                    $('#tbl_FirmResponse>tbody').html('<tr><td colspan="7">No product defined!</td></tr>');
                                }

                            });
                    }
                }


                function bindShowCauseCorrespondence(_CaseId, mode) {

                    if (Number(_CaseId) > 0) {


                        var idFilter = "ShowCauseLookupId eq " + _CaseId + " and IsDeleted eq '0'";

                        var filterProducts = idFilter + "&$select=ID,Title,Date,Remarks,ShowCauseLookupId,CorrespondenceKey/Id,CorrespondenceKey/Title,Created&$expand=CorrespondenceKey";

                        GetSPListItems("ShowCauseCorrespondence", 0, filterProducts)
                            .done(function (data) {

                                var response = data.d.results;

                                $('#tbl_Correspondence>tbody').html('');


                                for (var i = 0; i < response.length ; i++) {

                                    var _item = response[i];
                                    var _table = "#tbl_Correspondence";

                                    var correspondenceKeyTitle = "-";
                                    if (_item["CorrespondenceKey"] != null) {
                                        correspondenceKeyTitle = _item["CorrespondenceKey"].Title;
                                    }

                                    var _remarks = "";
                                    if (_item["Remarks"]) {
                                        _remarks = ((_item["Remarks"] != null && _item["Remarks"].length > 120) ? _item["Remarks"].substring(0, 100) + "..." : _item["Remarks"]);
                                    }

                                    var newRow = "<tr id='" + _item["ID"] + "'>" +

                                        "<td>" + "[RowIndex]" + "</td>" +
                                        "<td>" + correspondenceKeyTitle + "</td>" +
                                        "<td>" + toDisplayDate(_item["Date"]) + "</td>" +
                                        "<td>" + _remarks + "</td>";
                                    var _actionButtonHTML = "";
                                    
                                    if (havePremission(Permission.UPLOAD, Module.ShowCause) == true) {
                                        _actionButtonHTML = "<a href='#' title='Edit' onclick='openCorrespondence(" + _item.Id + ",\"edit\")' ><i class='glyphicon glyphicon-edit'></i></a> &nbsp; ";
                                        _actionButtonHTML += "<a href='#'  title='Delete'  onclick='deleteCorrespondence(" + _item.Id + ")' ><i class='glyphicon glyphicon-trash'></i></a>";
                                    }
                                    
                                    else if (havePremission(Permission.VIEW, Module.ShowCause) == true) {
                                        _actionButtonHTML += "<a href='#' title='View' onclick='openCorrespondence(" + _item.Id + ",\"view\")' ><i class='glyphicon glyphicon-list-alt'></i></a>";
                                    }



                                    if (mode == 'view') {
                                        _actionButtonHTML = "";
                                    }

                                    newRow = newRow + "<td align='center' style='text-align:center;' class='h5'>" + _actionButtonHTML + "</td>";
                                    newRow = newRow + "</tr>";


                                    newRow = newRow.replace(/\[RowIndex\]/g, ($(_table + '>tbody').find('tr').length + 1));

                                    $(_table + '>tbody').append(newRow);

                                }


                                if ($('#tbl_Correspondence>tbody').find('tr').length == 0) {
                                    $('#tbl_Correspondence>tbody').html('<tr><td colspan="7">No product defined!</td></tr>');
                                }

                            });
                    }
                }

                

                // tree view table (seems like tree view)
                function bindProductsAttachments(_caseId, _productId, mode) {

                    if (Number(_caseId) > 0 && Number(_productId) > 0) {

                        
                        var idFilter = "ShowCauseLookupId eq " + _caseId + " and ShowCauseProductLookupId eq " + _productId;


                        var filterProducts = idFilter + "&$select=ID,Title,FileName,RefNo,Created,Dated,ShowCauseLookup/Id,ShowCauseLookup/Title,ShowCauseProductLookup/Id,ShowCauseProductLookup/Title&$expand=ShowCauseLookup,ShowCauseProductLookup";

                        GetSPListItems("ShowCauseAttachments", 0, filterProducts)
                            .done(function (data) {

                                var response = data.d.results;

                                var modalWindow = $("#divModal-Product");

                                //if (response.length > 0) {
                                    modalWindow.find("table[id*='tblAttachment_Products']").find('tbody').find('tr').not('.empty-row').remove();
                                //}

                                for (var i = 0; i < response.length ; i++) {

                                    var _item = response[i];


                                    var _FilePreviewOption = "<a  href='#' class='alert-link' onclick='viewDocument(" + _item.Id + ",\"" + _item.FileName + "\");' title='Preview'  ><i class='glyphicon glyphicon-file'></i> " + _item["FileName"] + "</a>";


                                    var newRow = "<tr id='" + _item["ID"] + "' style='/*display:none;*/'  class='file-row'> " +
                                        "<td>&nbsp;[index]" + "</td>";

                                    newRow = newRow +
                                        "<td>" + (_item["RefNo"]) + "</td>" +
                                        "<td>" + toDisplayDate(_item["Dated"]) + "</td>" +
                                                "<td>" + _FilePreviewOption + "</td>" +
                                                "<td>" + toDisplayDate(_item["Created"]) + "</td>";
                                    

                                    var tableId = "#tblAttachment_Products";
                                    /*
                                    switch (_item.Stage) {
                                        case 'Applied':
                                            tableId = "#tblAttachment_Applied";

                                            newRow = newRow +
                                                "<td><i class='glyphicon glyphicon-folder-open' style='color:#f0ad4e;margin-right: 8px;'></i>" + _item["FolderLookup"].Title + "</td>" +
                                                "<td>" + _item["FileName"] + "</td>" +
                                                "<td>" + toDisplayDate(_item["Created"]) + "</td>" +
                                                "<td>" + (_item["IsCertificate"] == true ? 'Yes' : 'No') + "</td>";

                                            break;
                                        case 'Pre-Registration':
                                            tableId = "#tblAttachment_PreRegistration";

                                            newRow = newRow +
                                                "<td><i class='glyphicon glyphicon-folder-open' style='color:#f0ad4e;margin-right: 8px;'></i>" + _item["FolderLookup"].Title + "</td>" +
                                                "<td>" + _item["FileName"] + "</td>" +
                                                "<td>" + toDisplayDate(_item["Created"]) + "</td>" +
                                                "<td>" + (_item["IsCertificate"] == true ? 'Yes' : 'No') + "</td>";
                                            break;
                                        case 'Registered':
                                            tableId = "#tblAttachment_Registration";

                                            newRow = newRow +
                                                "<td><i class='glyphicon glyphicon-folder-open' style='color:#f0ad4e;margin-right: 8px;'></i>" + _item["FolderLookup"].Title + "</td>" +
                                                "<td>" + _item["FileName"] + "</td>" +
                                                "<td>" + toDisplayDate(_item["Created"]) + "</td>" +
                                                "<td>" + (_item["IsCertificate"] == true ? 'Yes' : 'No') + "</td>";
                                            break;
                                        case 'PRV':
                                            tableId = "#tblAttachment_PRV";

                                            newRow = newRow +
                                                "<td><i class='glyphicon glyphicon-folder-open' style='color:#f0ad4e;margin-right: 8px;'></i>" + _item["FolderLookup"].Title + "</td>" +
                                                "<td>" + _item["FileName"] + "</td>" +
                                                "<td>" + toDisplayDate(_item["Created"]) + "</td>" +
                                                "<td>" + (_item["IsCertificate"] == true ? 'Yes' : 'No') + "</td>";
                                            break;
                                        case 'Renewal':
                                            tableId = "#tblAttachment_Renewal";
                                                                                
                                            newRow = newRow +
                                                "<td><i class='glyphicon glyphicon-folder-open' style='color:#f0ad4e;margin-right: 8px;'></i>" + _item["FolderLookup"].Title + "</td>" +
                                                "<td>" + _item["FileName"] + "</td>" +
                                                "<td>" + toDisplayDate(_item["Created"]) + "</td>" +
                                                "<td>" + (_item["IsCertificate"] == true ? 'Yes' : 'No') + "</td>";

                                            break;
                                        default:
                                            break;
                                    }*/

                                    var _actionButtonHTML = "";

                                    if (havePremission(Permission.DOWNLOAD, Module.ShowCause) == true)
                                    {
                                        _actionButtonHTML = _actionButtonHTML + "<a href='#'  title='Download'  onclick='downloadDocument(" + _item.Id + ")' class='m-5' ><i class='glyphicon glyphicon-download'></i></a>";
                                    }

                                    if (mode != 'view' && havePremission(Permission.UPLOAD, Module.ShowCause) == true)
                                    {
                                        _actionButtonHTML = _actionButtonHTML + "<a href='#'  title='Delete'  onclick='deleteProductAttachment(" + _item.Id + ",\"Products\")' class='m-5' ><i class='glyphicon glyphicon-trash'></i></a>";
                                    }
                                    /*
                                    if (havePremission(Permission.Share, Module.ShowCause, $("#ddlCountry").val()) == true) {
                                        _actionButtonHTML = _actionButtonHTML + "&nbsp;<a id='btnShareIt_" + _item.Id + "' href='#' onclick=\"openShareWindow(" + _item.Id + "," + _item.Id + ",'" + _item["FileName"] + "');\"  title='Share'><i class='glyphicon glyphicon-share'></i></a> ";
                                    }
                                    */

                                    newRow = newRow + "<td align='center' style='text-align:center;' class='h5'>" + _actionButtonHTML + "</td>";
                                    newRow = newRow + "</tr>";



                                    if (tableId.length > 0) {

                                        var _rowIndex = $(tableId + '>tbody').find('tr').not('.empty-row').length + 1;
                                        newRow = newRow.replace(/\[index\]/g, _rowIndex);

                                        $(tableId + '>tbody').append(newRow);
                                    }
                                }

                                var allTables = $("table[id*='tblAttachment_Products']");
                                if (allTables != null && allTables) {
                                    allTables.each(function () {
                                        if ($(this).find('tbody').find('tr').not('.empty-row').length > 0)
                                            $(this).find('tbody').find('tr.empty-row').hide();
                                        else
                                            $(this).find('tbody').find('tr.empty-row').show();
                                    });
                                }
                            });
                    }
                }

                function bindfirmResponseAttachments(_caseId, _firmResponseId, mode) {

                    if (Number(_caseId) > 0 && Number(_firmResponseId) > 0) {


                        var idFilter = "ShowCauseLookupId eq " + _caseId + " and FirmResponseLookupId eq " + _firmResponseId;


                        var filterFirmResponses = idFilter + "&$select=ID,Title,FileName,RefNo,Created,Dated,AttachmentTypes,ShowCauseLookup/Id,ShowCauseLookup/Title,FirmResponseLookup/Id,FirmResponseLookup/Title&$expand=ShowCauseLookup,FirmResponseLookup";

                        GetSPListItems("ShowCauseAttachments", 0, filterFirmResponses)
                            .done(function (data) {

                                var response = data.d.results;

                                var modalWindow = $("#divModal-FirmResponse");

                                //if (response.length > 0) {
                                    modalWindow.find("table[id*='tblAttachment_FirmResponse']").find('tbody').find('tr').not('.empty-row').hide();
                                //}

                                modalWindow.find("#divFirmResponseRefFiles,#divFirmResponseCourierReceiptFiles").html("<ol></ol>");
                                modalWindow.find("#divFirmResponseRefFiles,#divFirmResponseCourierReceiptFiles").hide();

                                for (var i = 0; i < response.length ; i++) {

                                    var _item = response[i];

                                    
                                    var _actionButtonHTML = "" + _item["FileName"];

                                    if (havePremission(Permission.DOWNLOAD, Module.ShowCause) == true)
                                    {
                                        _actionButtonHTML = _actionButtonHTML + " <a href='#'  title='Download'  onclick='downloadDocument(" + _item.Id + ")' class='m-5' ><i class='glyphicon glyphicon-download'></i></a>";
                                    }

                                    if (mode != 'view' && havePremission(Permission.UPLOAD, Module.ShowCause) == true)
                                    {
                                        _actionButtonHTML = _actionButtonHTML + " <a href='#'  title='Delete'  onclick='deleteProductAttachment(" + _item.Id + ",\"Firm Response\")' class='xm-5' ><i class='glyphicon glyphicon-trash'></i></a>";
                                    }

                                    _actionButtonHTML = "<li>" + _actionButtonHTML + "</li>";


                                    var _refDated = new Date(_item.Dated);
                                    
                                    if (_item.AttachmentTypes == "Firm Response - Ref Letter")
                                    {
                                        //modalWindow.find("#divLetterRefNoAttachments")
                                        modalWindow.find("#txtFirmResponseRefNo").val(_item.RefNo);
                                        if (_refDated && _refDated.getFullYear() > 1970)
                                            modalWindow.find("#txtFirmResponseLetterRefDated").datepicker('setDate', _refDated);
                                        //modalWindow.find("#fileFirmResponseRefFiles")
                                        modalWindow.find("#divFirmResponseRefFiles ol").append(_actionButtonHTML);
                                        modalWindow.find("#divFirmResponseRefFiles").show();

                                    }

                                    if (_item.AttachmentTypes == "Firm Response - Courier Recipt") {

                                        //modalWindow.find("#divCourierReceiptAttachments")
                                        if (_refDated && _refDated.getFullYear() > 1970)
                                            modalWindow.find("#txtFirmResponseCourierReceiptDated").datepicker('setDate', _refDated);
                                        //modalWindow.find("#fileFirmResponseCourierReceiptFiles")
                                        modalWindow.find("#divFirmResponseCourierReceiptFiles ol").append(_actionButtonHTML);
                                        modalWindow.find("#divFirmResponseCourierReceiptFiles").show();
                                    }

                                    /*
                                    //var newRow = "<tr id='" + _item["ID"] + "' style='/*display:none;*///'  class='file-row'> " +
                                      /*  "<td>&nbsp;[index]" + "</td>";

                                    newRow = newRow +
                                        "<td>" + (_item["RefNo"]) + "</td>" +
                                        "<td>" + toDisplayDate(_item["Dated"]) + "</td>" +
                                                "<td>" + _item["FileName"] + "</td>" +
                                                "<td>" + toDisplayDate(_item["Created"]) + "</td>";


                                    var tableId = "#tblAttachment_FirmResponse";

                                    var _actionButtonHTML = "";

                                    //if (havePremission(Permission.DOWNLOAD, Module.ProductManagement, $("#ddlCountry").val()) == true)
                                    {
                                        _actionButtonHTML = _actionButtonHTML + "<a href='#'  title='Download'  onclick='downloadDocument(" + _item.Id + ")' class='m-5' ><i class='glyphicon glyphicon-download'></i></a>";
                                    }

                                    //if (mode != 'view' && havePremission(Permission.UPLOAD, Module.ProductManagement, $("#ddlCountry").val()) == true)
                                    {
                                        _actionButtonHTML = _actionButtonHTML + "<a href='#'  title='Delete'  onclick='deleteProductAttachment(" + _item.Id + ")' class='m-5' ><i class='glyphicon glyphicon-trash'></i></a>";
                                    }

                                    newRow = newRow + "<td align='center' style='text-align:center;' class='h5'>" + _actionButtonHTML + "</td>";
                                    newRow = newRow + "</tr>";
                                   
                                    if (tableId.length > 0) {

                                        var _rowIndex = $(tableId + '>tbody').find('tr').not('.empty-row').length + 1;
                                        newRow = newRow.replace(/\[index\]/g, _rowIndex);

                                        $(tableId + '>tbody').append(newRow);
                                    } 
                                    
                                    */
                                }
                                /*
                                //var allTables = $("table[id*='tblAttachment_FirmResponse']");
                                //if (allTables != null && allTables) {
                                //    allTables.each(function () {
                                //        if ($(this).find('tbody').find('tr').not('.empty-row').length > 0)
                                //            $(this).find('tbody').find('tr.empty-row').hide();
                                //        else
                                //            $(this).find('tbody').find('tr.empty-row').show();
                                //    });
                                //}
                                */
                            });
                    }
                }
                
                
                function bindCorrespondenceAttachments(_caseId, _correspondenceId, mode) {

                    if (Number(_caseId) > 0 && Number(_correspondenceId) > 0) {


                        var idFilter = "ShowCauseLookupId eq " + _caseId + " and CorrespondenceLookupId eq " + _correspondenceId;


                        var filterCorrespondences = idFilter + "&$select=ID,Title,FileName,RefNo,Created,Dated,AttachmentTypes,ShowCauseLookup/Id,ShowCauseLookup/Title,CorrespondenceLookup/Id,CorrespondenceLookup/Title&$expand=ShowCauseLookup,CorrespondenceLookup";

                        GetSPListItems("ShowCauseAttachments", 0, filterCorrespondences)
                            .done(function (data) {

                                var response = data.d.results;

                                var modalWindow = $("#divModal-Correspondence");
                                
                                modalWindow.find("#divCorrespondenceFiles").html("<ol></ol>");
                                modalWindow.find("#divCorrespondenceFiles").hide();

                                for (var i = 0; i < response.length ; i++) {

                                    var _item = response[i];


                                    var _actionButtonHTML = "" + _item["FileName"];

                                    if (havePremission(Permission.DOWNLOAD, Module.ShowCause) == true)
                                    {
                                        _actionButtonHTML = _actionButtonHTML + " <a href='#'  title='Download'  onclick='downloadDocument(" + _item.Id + ")' class='m-5' ><i class='glyphicon glyphicon-download'></i></a>";
                                    }

                                    if (mode != 'view' && havePremission(Permission.UPLOAD, Module.ShowCause) == true)
                                    {
                                        _actionButtonHTML = _actionButtonHTML + " <a href='#'  title='Delete'  onclick='deleteProductAttachment(" + _item.Id + ",\"Correspondence\")' class='xm-5' ><i class='glyphicon glyphicon-trash'></i></a>";
                                    }

                                    _actionButtonHTML = "<li>" + _actionButtonHTML + "</li>";


                                    var _refDated = new Date(_item.Dated);

                                    if (_item.AttachmentTypes == "Correspondence") {

                                        modalWindow.find("#divCorrespondenceFiles ol").append(_actionButtonHTML);
                                        modalWindow.find("#divCorrespondenceFiles").show();

                                    }



                                }
                            });
                    }
                }


                function expandableRows(_row){
                    var _folderId = $(_row).data('folderid-folder');
                    $(_row).parents("table").find("[data-folderid-file='" + _folderId + "']").toggle('fast');

                    if ($(_row).find(".expand-icon").hasClass('glyphicon-triangle-bottom') == true) {
                        $(_row).find(".expand-icon").removeClass('glyphicon-triangle-bottom');
                        $(_row).find(".expand-icon").addClass('glyphicon-triangle-right');
                    } else {
                        $(_row).find(".expand-icon").addClass('glyphicon-triangle-bottom');
                        $(_row).find(".expand-icon").removeClass('glyphicon-triangle-right');
                    }

                }
                

                function bindActionHistory(_productId) {
                    // Specify the Id of the Item that you want to fetch
                    $('#tblActionHistory>tbody').html('');

                    if (Number(_productId) > 0) {
                        var filterNomenclature = "ProductLookupId eq " + _productId + " and Module eq '" + Module.ProductManagement + "'&$select=ID,Title,ActionName,Comments,Created,Author/Title&$expand=Author&$orderby=Id desc";
                        GetSPListItems("ActionLogs", 0, filterNomenclature)
                            .done(function (data) {
                                var response = data.d.results;
                                for (var i = 0; i < response.length ; i++) {
                                    var _item = response[i];

                                    var newRow = "<tr id='" + _item["ID"] + "'>" +
                                        "<td>" + toDisplayDateTime(_item["Created"]) + "</td>" +
                                        "<td>" + toDisplayName(_item["Author"].Title) + "</td>" +
                                        "<td>" + _item["ActionName"] + "</td>" +
                                        "<td>" + (_item["Comments"] == null ? "" : _item["Comments"]) + "</td>" +
                                        "</tr>";

                                    $('#tblActionHistory>tbody').append(newRow);
                                    $('#divActionLogs').show();

                                }
                            });
                    }
                }




                function openAddAttachment(_id, stage) {

                    var modalWindow = $("#divModal-Attachment");

                    var _productId = $('#hid_ID').val();

                    // reset All controls
                    modalWindow.find("select,input[type='text'],input[type='hidden']").val('');
                    modalWindow.find(".is-invalid").removeClass("is-invalid");
                    modalWindow.find('#hid_ProductId').val(_productId);
                    $('#hid_AttachmentType').val(stage);
                    
                    $('#divAttachmentFolder').show();

                    modalWindow.modal('show');

                    if (stage == "Renewal") {

                        //$('#divAttachmentFolder').hide();
                        /*
                             if ($("#radRenewalApplied").prop('checked') == true) {
                                 modalWindow.find("#txtRenewalSubmissionDate").parents('.col-md-6').eq(0).show();
                                 modalWindow.find("#txtRenewalRegistrationDate").parents('.col-md-6').eq(0).hide();
                                 modalWindow.find("#txtRenewalExpiryDate").parents('.col-md-6').eq(0).hide();
                             }
                             else if ($("#radRenewalApproved").prop('checked') == true) {
                                 modalWindow.find("#txtRenewalSubmissionDate").parents('.col-md-6').eq(0).hide();
                                 modalWindow.find("#txtRenewalRegistrationDate").parents('.col-md-6').eq(0).show();
                                 modalWindow.find("#txtRenewalExpiryDate").parents('.col-md-6').eq(0).show();
                             }
                             else {
                                 modalWindow.find("#txtRenewalSubmissionDate").parents('.col-md-6').eq(0).hide();
                                 modalWindow.find("#txtRenewalRegistrationDate").parents('.col-md-6').eq(0).hide();
                                 modalWindow.find("#txtRenewalExpiryDate").parents('.col-md-6').eq(0).hide();
                             }
                             */


                    }


                }
                

                function viewDocument(_fileId, _FileTitle) {
                    if (Number(_fileId) > 0) {

                        //jQuery.noConflict();
                        $('#divModal_ViewDocument').find("#h4NomenclatureTitle").text(_FileTitle);
                        $('#divModal_ViewDocument').find("#frmpdf").remove();


                        //$("#divModal_ViewAllAttachements").removeClass('fade');
                        //$("#divModal_ViewAllAttachements").modal('hide');
                        //setTimeout(function () {
                        //    _needtoReopenthisWindow = $("#divModal_ViewAllAttachements");

                        //}, 500);

                        //$('#divModal_ViewDocument').find("#frmpdf").get(0).src = "";
                        //$('#divModal_ViewDocument').find("#frmpdf").get(0).style.display = "none";

                        //setTimeout(function () { },0);

                        var listName = 'ShowCauseAttachments';
                        var apiURL = _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('" + listName + "')/items/GetById(" + _fileId + ")/file";

                        $.ajax({
                            url: apiURL,
                            type: "GET",
                            headers: {
                                "Accept": "application/json; odata=verbose",
                            },
                            success: function (dataFileInfo) {

                                if (dataFileInfo.d) {

                                    var fileURL = location.origin + dataFileInfo.d.ServerRelativeUrl;
                                    window.open(fileURL, '_blank');

                                    /*
                                    if (fileURL.search('.docx') > 0) {
                                        downloadFunction(fileURL);
                                        alert("File has been downloaded!");
                                    }
                                    else {
                                        //document.getElementById("frmpdf").style.display = "block";
                                        //document.getElementById("frmpdf").src = fileURL;
            
                                        var _iframe = document.createElement("iframe");
                                        _iframe.id = "frmpdf";
                                        _iframe.src = fileURL;
                                        _iframe.width = "100%";
                                        _iframe.height = "700px";
            
                                        var element = document.getElementById("divfrmpdf");
                                        element.appendChild(_iframe);
            
            
                                        jQuery.noConflict();
                                        jQuery('#divModal_ViewDocument').modal('show');
                                    }*/
                                }
                            },
                            error: function (error) {
                                console.log("Error on getting file info", error);

                                RequestEnded();
                            }
                        });
                    }
                    else {
                        alert("No document found!");
                    }

                }

            </script>

            <script type="text/javascript">
                function saveRecord(_action, index) {

                    console.error('got here 2')

                    var isValid = true;

                    var modalWindow = $("#divFromDetials");

                    var _datePreRegistration;
                    var _submissionDate;

                    modalWindow.find('.is-invalid').removeClass("is-invalid");


                    if (1 == 1) {
                    //if (index == 1) {

                        if ((modalWindow.find("#ddlCaseCategory").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#ddlCaseCategory").addClass("is-invalid");
                        }
                        if ((modalWindow.find("#txtCaseNo").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtCaseNo").addClass("is-invalid");
                        }
                        if ((modalWindow.find("#txtInspectorName").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtInspectorName").addClass("is-invalid");
                        }
                        if ((modalWindow.find("#txtDesignation").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtDesignation").addClass("is-invalid");
                        }
                       /* if ((modalWindow.find("#txtContactNumber").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtContactNumber").addClass("is-invalid");
                        }*/
                        if ((modalWindow.find("#txtRegionProvince").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtRegionProvince").addClass("is-invalid");
                        }
                        if ((modalWindow.find("#txtOfficialAddress").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtOfficialAddress").addClass("is-invalid");
                        }
                        if ((modalWindow.find("#txtLocationOfInspector").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtLocationOfInspector").addClass("is-invalid");
                        }
                        if ((modalWindow.find("#ddlCaseCategory").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#ddlCaseCategory").addClass("is-invalid");
                        }




                        if (isValid == true) {

                            RequestStarted();

                            var _recordID = $("#hid_ID").val();


                            var jsonProductData = {
                                Title: modalWindow.find('#txtCaseNo').val(),
                                CaseNo: modalWindow.find('#txtCaseNo').val(),
                                InspectorName: modalWindow.find('#txtInspectorName').val(),
                                Designation: modalWindow.find('#txtDesignation').val(),
                                ContactNumber: modalWindow.find('#txtContactNumber').val(),
                                RegionProvince: modalWindow.find('#txtRegionProvince').val().trim(),
                                OfficialAddress: modalWindow.find('#txtOfficialAddress').val().trim(),
                                LocationOfInspection: modalWindow.find('#txtLocationOfInspector').val().trim(),
                                CaseCategoryLookupId: modalWindow.find('#ddlCaseCategory').val().trim()
                            }



                            var _confirmResult = false;
                            if (_action == 'Finish') {

                                _confirmResult = confirm("Are you sure you want to finish this case?");
                            }
                            else {
                                _confirmResult = true;
                            }


                            var _isUniqueValue = checkForDuplicateValues(jsonProductData.CaseNo, _recordID);

                            if (_confirmResult == true && _isUniqueValue == true) {

                                if (Number(_recordID) > 0) {

                                    UpdateSPList("ShowCauseCases", _recordID, jsonProductData).done(function (data) {

                                        //saveActionLog(_recordID, "Edit Product as " + $('#hid_Stage').val(), jsonProductData.Status, Module.ProductManagement);
                                        /*
                                        if (jsonProductData.Status == 'Send For Approval') {
                                            sendNotification();
                                        }*/

                                        window.location.href = "ShowCause.aspx";

                                    }).fail(function (jqXHR, textStatus) {

                                        alert("Showcause Saving Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                                        RequestEnded();
                                    });

                                }
                                else {

                                    InsertIntoSPList('ShowCauseCases', jsonProductData).done(function (data) {
                                        //console.log(data.d.results);
                                        if (Number(data.d.ID) > 0) {


                                            //saveActionLog(data.d.ID, "Created New Product as " + $('#hid_Stage').val(), data.d.Status, Module.ProductManagement);

                                            /*if (data.d.Status == 'Send For Approval') {
                                                sendNotification();
                                            }*/

                                            window.location.href = "ShowCause.aspx";

                                        }

                                    }).fail(function (jqXHR, textStatus) {

                                        alert("Showcause Saving Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                                        RequestEnded();
                                    });
                                }
                            }
                            else {

                                RequestEnded();
                                if (_isUniqueValue == false) {
                                    modalWindow.find("#txtCaseNo").addClass("is-invalid");
                                    alert("Another Cases already exist with same case number!\n'" + jsonProductData.Title + "'");
                                }

                            }

                        }
                        else {

                            $("#li_Step1").find("a").click()
                            alert("Please fill highlighted fields first!");
                        }
                    }
                }



                function checkForDuplicateValues(_caseNo, _id) {
                    var isValidName = true;

                    var filterProducts = "CaseNo eq '" + _caseNo + "' and IsDeleted eq '0' ";
                    if (Number(_id) > 0) {
                        filterProducts = filterProducts + " and Id ne '" + _id + "'";
                    }
                    GetSPListItems("ShowCauseCases", 0, filterProducts, false)
                        .done(function (data) {

                            var response = data.d.results;

                            if (response.length > 0) {
                                isValidName = false;
                            }

                        });

                    return isValidName;
                }

                function saveProduct() {

                    console.error('got here 2')

                    var isValid = true;

                    var modalWindow = $("#divModal-Product");

                    //var _hid_ProductId = modalWindow.find('#hid_ProductId').val();
                    var _hid_CaseId = $("#hid_ID").val();

                    if (Number(_hid_CaseId) > 0) {

                        modalWindow.find('.is-invalid').removeClass("is-invalid");

                        if ((Number(modalWindow.find("#ddlProduct").val()) > 0) == false) {
                            isValid = false;
                            modalWindow.find("#ddlProduct").addClass("is-invalid");
                        }

                        if ((modalWindow.find("#txtManufacturing").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtManufacturing").addClass("is-invalid");
                        }


                        if ((modalWindow.find("#txtBatchNo").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtBatchNo").addClass("is-invalid");
                        }

                        if ((modalWindow.find("#txtManufacturingDate").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtManufacturingDate").addClass("is-invalid");
                        }

                        if ((modalWindow.find("#txtExpiryDate").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtExpiryDate").addClass("is-invalid");
                        }
                        if ((modalWindow.find("#txtQuantityDrawn").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtQuantityDrawn").addClass("is-invalid");
                        }
                        if ((modalWindow.find("#txtBatchSize").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtBatchSize").addClass("is-invalid");
                        }
                        if ((modalWindow.find("#txtSuppliedQuantity").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtSuppliedQuantity").addClass("is-invalid");
                        }
                        if ((modalWindow.find("#txtSuppliedTo").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtSuppliedTo").addClass("is-invalid");
                        }
                        if ((modalWindow.find("#txtSalesInvoice").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtSalesInvoice").addClass("is-invalid");
                        }
                        if ((Number(modalWindow.find("#ddlDISampling").val()) > 0) == false) {
                            isValid = false;
                            modalWindow.find("#ddlDISampling").addClass("is-invalid");
                        }
                        if ((Number(modalWindow.find("#ddlLaboratoryReportStatus").val()) > 0) == false) {
                            isValid = false;
                            modalWindow.find("#ddlLaboratoryReportStatus").addClass("is-invalid");
                        }



                        if (isValid == true) {

                            RequestStarted();

                            var _recordID = $("#hid_ShowCauseProductId").val();

                            var jsonData = {

                                Title: $('#txtCaseNo').val(),
                                Manufacturing: modalWindow.find('#txtManufacturing').val(),
                                ProductLookupId: modalWindow.find('#ddlProduct').val(),
                                BatchNo: modalWindow.find('#txtBatchNo').val(),
                                ManufacturingDate: modalWindow.find('#txtManufacturingDate').val(),
                                ExpiryDate: modalWindow.find('#txtExpiryDate').val(),
                                QuantityDrawn: modalWindow.find('#txtQuantityDrawn').val(),
                                BatchSize: modalWindow.find('#txtBatchSize').val(),
                                SuppliedQuantity: modalWindow.find('#txtSuppliedQuantity').val(),
                                SuppliedTo: modalWindow.find('#txtSuppliedTo').val(),
                                SalesInvoiceRecord: modalWindow.find('#txtSalesInvoice').val(),
                                DISamplingLookupId: modalWindow.find('#ddlDISampling').val(),
                                LaboratoryReportStatusId: modalWindow.find('#ddlLaboratoryReportStatus').val(),
                                ReportRemarks: modalWindow.find('#txtReportRemarks').val(),
                                ShowcauseCaseLookupId: _hid_CaseId,
                                IsDeleted: false

                            }

                            if (Number(_recordID) > 0) {

                                UpdateSPList("ShowCauseProducts", _recordID, jsonData).done(function (data) {

                                    alert('Product has been edit successfully');
                                    // Retrive Nomenclatures newly Added
                                    

                                    var _hid_ProductId = $('#hid_ID').val();

                                    bindShowcauseProducts(_hid_ProductId, 'Edit');

                                    $("#divModal-Product").modal('hide');

                                    RequestEnded();

                                }).fail(function (jqXHR, textStatus) {

                                    alert("Product Saving Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                                    RequestEnded();
                                });

                            }
                            else {



                                InsertIntoSPList('ShowCauseProducts', jsonData).done(function (data) {
                                    //console.log(data.d.results);
                                    if (Number(data.d.ID) > 0) {


                                        alert('Product has been added successfully');
                                        // Retrive Nomenclatures newly Added
                                        var _hid_CaseId = $('#hid_ID').val();

                                        $("#hid_ShowCauseProductId").val(data.d.ID);
                                        
                                        $("#divModal-Product").find('#divAttachment_Products').show();

                                        bindShowcauseProducts(_hid_CaseId, 'Edit');
                                        //$("#divModal-Product").modal('hide');

                                        RequestEnded();
                                    }

                                }).fail(function (jqXHR, textStatus) {

                                    alert("Product Saving Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                                    RequestEnded();
                                });
                            }

                        }
                        else {
                            alert("Please fill highlighted fields first!");
                        }
                    }
                    else {
                        alert("Please save the case first!");
                    }
                }

                function deleteProduct(_recordID) {

                    var _confirmResult = confirm("Are you sure you want to delete this product?");
                    if (_confirmResult == true) {
                        var jsonData = {
                            IsDeleted: true
                        }
                        UpdateSPList("Products", _recordID, jsonData).done(function (data) {

                            alert('Product has been deleted successfully');
                            // Retrive Nomenclatures newly Added
                            //bindProductTable(0);

                            RequestEnded();

                        }).fail(function (jqXHR, textStatus) {

                            alert("Product Deleting Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                            RequestEnded();
                        });
                    }

                }
                


                function saveFirmResponse() {

                    console.error('got here 2');

                    var isValid = true;

                    var modalWindow = $("#divModal-FirmResponse");

                    //var _hid_ProductId = modalWindow.find('#hid_ProductId').val();
                    var _hid_CaseId = $("#hid_ID").val();

                    if (Number(_hid_CaseId) > 0) {

                        modalWindow.find('.is-invalid').removeClass("is-invalid");

                        if ((Number(modalWindow.find("#ddlFirmResponseProducts").val()) > 0) == false) {
                            isValid = false;
                            modalWindow.find("#ddlFirmResponseProducts").addClass("is-invalid");
                        }
                        if ((modalWindow.find("#txtFirmResponseBatchNo").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtFirmResponseBatchNo").addClass("is-invalid");
                        }
                       /* if ((modalWindow.find("#txtFirmResponseRemarks").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtFirmResponseRemarks").addClass("is-invalid");
                        }*/

                        /* Asma's Change : mendetory all
                        if ((modalWindow.find("#txtFirmResponseRefNo").val().length > 0) == true ||
                            (modalWindow.find("#txtFirmResponseLetterRefDated").val().length > 0) == true ||
                            (modalWindow.find("#fileFirmResponseRefFiles").get(0).files.length > 0) == true)*/
                        {

                            if ((modalWindow.find("#txtFirmResponseRefNo").val().length > 0) == false) {
                                isValid = false;
                                modalWindow.find("#txtFirmResponseRefNo").addClass("is-invalid");
                            }

                            if ((modalWindow.find("#txtFirmResponseLetterRefDated").val().length > 0) == false) {
                                isValid = false;
                                modalWindow.find("#txtFirmResponseLetterRefDated").addClass("is-invalid");
                            }

                            if ((modalWindow.find("#fileFirmResponseRefFiles").get(0).files.length > 0) == false) {
                                if (modalWindow.find("#divFirmResponseRefFiles").find('li').length == 0) {
                                    isValid = false;
                                    modalWindow.find("#fileFirmResponseRefFiles").addClass("is-invalid");
                                }
                            }

                        }

                        /* Asma's Change : mendetory all
                        if ((modalWindow.find("#txtFirmResponseCourierReceiptDated").val().length > 0) == true ||
                            (modalWindow.find("#fileFirmResponseCourierReceiptFiles").get(0).files.length > 0) == true) */
                        {

                            if ((modalWindow.find("#txtFirmResponseCourierReceiptDated").val().length > 0) == false) {
                                isValid = false;
                                modalWindow.find("#txtFirmResponseCourierReceiptDated").addClass("is-invalid");
                            }

                            if ((modalWindow.find("#fileFirmResponseCourierReceiptFiles").get(0).files.length > 0) == false) {
                                if (modalWindow.find("#divFirmResponseCourierReceiptFiles").find('li').length == 0) {
                                    isValid = false;
                                    modalWindow.find("#fileFirmResponseCourierReceiptFiles").addClass("is-invalid");
                                }
                            }

                        }



                        if (isValid == true) {

                            RequestStarted();

                            var _recordID = $("#hid_FirmResponseId").val();

                            var jsonData = {

                                Title: $('#txtCaseNo').val(),
                                ShowCauseLookupId: _hid_CaseId,
                                ProductLookupId: modalWindow.find('#ddlFirmResponseProducts').val(),
                                BatchNo: modalWindow.find('#txtFirmResponseBatchNo').val(),
                                Remarks: modalWindow.find('#txtFirmResponseRemarks').val()

                            }

                            if (Number(_recordID) > 0) {

                                UpdateSPList("ShowCauseFirmResponse", _recordID, jsonData).done(function (data) {


                                    saveFirmResponseRefLetterAttachment();
                                    saveFirmResponseCourierReciptAttachment();

                                    alert('Firm Response has been edit successfully');
                                    
                                    // Retrive Bind updted record
                                    var _caseid = $('#hid_ID').val();
                                    bindShowcauseFirmResponse(_caseid);

                                    $("#divModal-FirmResponse").modal('hide');

                                    RequestEnded();

                                }).fail(function (jqXHR, textStatus) {

                                    alert("Firm Response Saving Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                                    RequestEnded();
                                });

                            }
                            else {

                                InsertIntoSPList('ShowCauseFirmResponse', jsonData).done(function (data) {
                                    //console.log(data.d.results);
                                    if (Number(data.d.ID) > 0) {
                                        
                                        $("#hid_FirmResponseId").val(data.d.ID);

                                        saveFirmResponseRefLetterAttachment();
                                        saveFirmResponseCourierReciptAttachment();
                                        

                                        alert('Firm Response has been added successfully');




                                        // Retrive Bind newly Added record
                                        var _caseid = $('#hid_ID').val();
                                        bindShowcauseFirmResponse(_caseid);

                                        $("#divModal-FirmResponse").modal('hide');

                                        RequestEnded();
                                    }

                                }).fail(function (jqXHR, textStatus) {

                                    alert("Firm Response Saving Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                                    RequestEnded();
                                });
                            }

                        }
                        else {
                            alert("Please fill highlighted fields first!");
                        }
                    }
                    else {
                        alert("Please save the case first!");
                    }
                }
                
                function deleteFirmResponse(_recordID) {

                    var _confirmResult = confirm("Are you sure you want to delete this firm response?");
                    if (_confirmResult == true) {
                        var jsonData = {
                            IsDeleted: true
                        }
                        UpdateSPList("ShowCauseFirmResponse", _recordID, jsonData).done(function (data) {

                            alert('Firm response has been deleted successfully');

                            // Update UI
                            var _caseid =  $('#hid_ID').val();
                            bindShowcauseFirmResponse(_caseid);

                            RequestEnded();

                        }).fail(function (jqXHR, textStatus) {

                            alert("Firm Response Deleting Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                            RequestEnded();
                        });
                    }

                }



                // start
                function saveFirmResponseRefLetterAttachment() {

                    var docidall = "0;";
                    // Define the folder path for this example.
                    var serverRelativeUrlToFolder = 'ShowCauseAttachments';

                    // Get test values from the file input and text input page controls.
                    var fileInput = jQuery('#fileFirmResponseRefFiles');
                    var fileCount = fileInput[0].files.length;
                    // Get the server URL.
                    var serverUrl = _spPageContextInfo.webAbsoluteUrl;
                    var filesUploaded = 0;

                    var _CaseId = $('#hid_ID').val();

                    if (isPDFFiles()) {

                        RequestStarted();

                        for (var i = 0; i < fileCount; i++) {
                            // Initiate method calls using jQuery promises.
                            // Get the local file as an array buffer.
                            var getFile = getFileBuffer(i);
                            getFile.done(function (arrayBuffer, i) {

                                // Add the file to the SharePoint folder.
                                var addFile = addFileToFolder(arrayBuffer, i);
                                addFile.done(function (file, status, xhr) {
                                    //$("#msg").append("<div>File : "+file.d.Name+" ... uploaded sucessfully</div>");
                                    filesUploaded++;

                                    var getItem = getListItem(file.d.ListItemAllFields.__deferred.uri);
                                    getItem.done(function (listItem, status, xhr) {

                                    //var file = data.d;
                                    // register/post register
                                    var _attachmodalWin = $('#divModal-FirmResponse');
                                    var updateObject = {
                                        __metadata: {
                                            type: listItem.d.__metadata.type
                                        },
                                        ShowCauseLookupId: Number(_CaseId),
                                        FileName: fileInput[0].files[i].name,
                                        AttachmentTypes: "Firm Response - Ref Letter"
                                    };

                                        //hid_FirmResponseId
                                        //divLetterRefNoAttachments
                                        //txtFirmResponseRefNo
                                        //txtFirmResponseLetterRefDated
                                        //fileFirmResponseRefFiles
                                        //divFirmResponseRefFiles

                                        //divCourierReceiptAttachments
                                        //txtFirmResponseCourierReceiptDated
                                        //fileFirmResponseCourierReceiptFiles
                                        //divFirmResponseCourierReceiptFiles



                                        updateObject.FirmResponseLookupId = Number(_attachmodalWin.find('#hid_FirmResponseId').val());
                                        updateObject.RefNo = _attachmodalWin.find("#txtFirmResponseRefNo").val();
                                        updateObject.Dated = _attachmodalWin.find("#txtFirmResponseLetterRefDated").val();

                                        var changeItem = updateListItem(listItem.d.__metadata, JSON.stringify(updateObject));
                                        changeItem.done(function (data, status, xhr) {

                                    //var url = serverUrl + "/_api/Web/lists/getbytitle('" + serverRelativeUrlToFolder + "')/items(" + file.ListItemAllFields.Id + ")";
                                        docidall += listItem.d.Id + ";";
                                    //updateFileMetadata(url, updateObject, file, function (result) {
                                        //alert("File metadata updation done successfully");
                                    //}, function (result) {
                                        //alert("File upload done but metadata updating FAILED");
                                    //});
                                    if (fileCount == filesUploaded) {

                                        RequestEnded();
                                        $("#fileFirmResponseRefFiles").val("");



                                        filesUploaded = 0;
                                            }
                                        });
                                        changeItem.fail(onError => { hideLoader(); });
                                    });
                                    getItem.fail(onError => { hideLoader(); });
                                });
                                addFile.fail(onError);
                            });
                            getFile.fail(onError);
                        }
                    }

                    function isPDFFiles() {
                        var flag = true;
                        var files = fileInput[0].files;
                        var maxsize = 2 * 1024 * 1024 * 1024;//2GB
                        for (var i = 0; i < files.length; i++) {
                            // validate extension
                            //if (files[i].name.split(".")[1].toLowerCase() != "pdf") {
                            //    flag = false;
                            //    alert("Please update PDF files.");
                            //    break;
                            //}
                            /*if (files[i].name.substr(-3).toLowerCase() != "pdf") {
                                flag = false;
                                alert("Please update PDF files.");
                                break;
                            }
                            */
                            // validate file size
                            if (files[i].size > maxsize) {
                                flag = false;
                                alert("File size must be under 2GB.");
                                break;

                            }
                        }
                        return flag;
                    }
                    //update file metadata
                    function updateFileMetadata(apiUrl, updateObject, file, success, failure) {
                        $.ajax({
                            url: apiUrl,
                            type: "POST",
                            async: false,
                            data: JSON.stringify(updateObject),
                            headers: {
                                "accept": "application/json;odata=verbose",
                                "X-RequestDigest": $("#__REQUESTDIGEST").val(),
                                "Content-Type": "application/json;odata=verbose",
                                "X-Http-Method": "MERGE",
                                "IF-MATCH": file.ListItemAllFields.__metadata.etag,
                            },
                            success: function (data) {
                                success(data);
                            },
                            error: function (data) {
                                failure(data);
                            }
                        });
                    }
                    // Get the local file as an array buffer.
                    function getFileBuffer(i) {
                        var deferred = jQuery.Deferred();
                        var reader = new FileReader();
                        reader.onloadend = function (e) {
                            deferred.resolve(e.target.result, i);
                        }
                        reader.onerror = function (e) {
                            deferred.reject(e.target.error);
                        }
                        reader.readAsArrayBuffer(fileInput[0].files[i]);
                        return deferred.promise();
                    }

                    // Add the file to the file collection in the Shared Documents folder.
                    function addFileToFolder(arrayBuffer, i) {
                        var index = i;

                        // Get the file name from the file input control on the page.
                        //   var fileName = fileInput[0].files[index].name;

                        var today = new Date();
                        var timeStampString = new Date().getTime();
                        var cHour = today.getHours();
                        var cMin = today.getMinutes();
                        var cSec = today.getSeconds();
                        //  var fileName = fileInput[0].val().split('.').pop();

                        // var fileName = fileInput[0].files[index].name.split('.');
                        var filenameLength = fileInput[0].files[index].name.length;
                        var fileName = fileInput[0].files[index].name.substr(0, filenameLength - 4);
                        var fileExtenstion = fileInput[0].files[index].name.substr(filenameLength - 4);

                        fileName = fileName + "-" + timeStampString + fileExtenstion;


                        // Construct the endpoint.
                        var fileCollectionEndpoint = String.format(
                            "{0}/_api/web/getfolderbyserverrelativeurl('{1}')/files" +
                            "/add(overwrite=true, url='{2}')?$expand=ListItemAllFields",
                            serverUrl, serverRelativeUrlToFolder + '/' + _recordId, fileName);

                        // Send the request and return the response.
                        // This call returns the SharePoint file.
                        return jQuery.ajax({
                            url: fileCollectionEndpoint,
                            type: "POST",
                            data: arrayBuffer,
                            processData: false,
                            headers: {
                                "accept": "application/json;odata=verbose",
                                "X-RequestDigest": jQuery("#__REQUESTDIGEST").val(),
                                "content-length": arrayBuffer.byteLength
                            }
                        });
                    }

                }

                function saveFirmResponseCourierReciptAttachment() {

                    var docidall = "0;";
                    // Define the folder path for this example.
                    var serverRelativeUrlToFolder = 'ShowCauseAttachments';

                    // Get test values from the file input and text input page controls.
                    var fileInput = jQuery('#fileFirmResponseCourierReceiptFiles');
                    var fileCount = fileInput[0].files.length;
                    // Get the server URL.
                    var serverUrl = _spPageContextInfo.webAbsoluteUrl;
                    var filesUploaded = 0;

                    var _CaseId = $('#hid_ID').val();

                    if (isPDFFiles()) {

                        RequestStarted();

                        for (var i = 0; i < fileCount; i++) {
                            // Initiate method calls using jQuery promises.
                            // Get the local file as an array buffer.
                            var getFile = getFileBuffer(i);
                            getFile.done(function (arrayBuffer, i) {

                                // Add the file to the SharePoint folder.
                                var addFile = addFileToFolder(arrayBuffer, i);
                                addFile.done(function (data, status, xhr) {
                                    //$("#msg").append("<div>File : "+file.d.Name+" ... uploaded sucessfully</div>");
                                    filesUploaded++;
                                    var file = data.d;
                                    // register/post register
                                    var _attachmodalWin = $('#divModal-FirmResponse');
                                    var updateObject = {
                                        __metadata: {
                                            type: file.ListItemAllFields.__metadata.type
                                        },
                                        ShowCauseLookupId: Number(_CaseId),
                                        FileName: fileInput[0].files[i].name,
                                        AttachmentTypes: "Firm Response - Courier Recipt"
                                    };

                                    //hid_FirmResponseId
                                    //divLetterRefNoAttachments
                                    //txtFirmResponseRefNo
                                    //txtFirmResponseLetterRefDated
                                    //fileFirmResponseRefFiles
                                    //divFirmResponseRefFiles

                                    //divCourierReceiptAttachments
                                    //txtFirmResponseCourierReceiptDated
                                    //fileFirmResponseCourierReceiptFiles
                                    //divFirmResponseCourierReceiptFiles



                                    updateObject.FirmResponseLookupId = Number(_attachmodalWin.find('#hid_FirmResponseId').val());
                                    //updateObject.RefNo = _attachmodalWin.find("#txtFirmResponseRefNo").val();
                                    updateObject.Dated = _attachmodalWin.find("#txtFirmResponseCourierReceiptDated").val();



                                    var url = serverUrl + "/_api/Web/lists/getbytitle('" + serverRelativeUrlToFolder + "')/items(" + file.ListItemAllFields.Id + ")";
                                    docidall += file.ListItemAllFields.Id + ";";
                                    updateFileMetadata(url, updateObject, file, function (result) {
                                        //alert("File metadata updation done successfully");
                                    }, function (result) {
                                        //alert("File upload done but metadata updating FAILED");
                                    });
                                    if (fileCount == filesUploaded) {

                                        RequestEnded();
                                        $("#fileFirmResponseCourierReceiptFiles").val("");



                                        filesUploaded = 0;
                                    }
                                });
                                addFile.fail(onError);
                            });
                            getFile.fail(onError);
                        }
                    }

                    function isPDFFiles() {
                        var flag = true;
                        var files = fileInput[0].files;
                        var maxsize = 2 * 1024 * 1024 * 1024;//2GB
                        for (var i = 0; i < files.length; i++) {
                            // validate extension
                            //if (files[i].name.split(".")[1].toLowerCase() != "pdf") {
                            //    flag = false;
                            //    alert("Please update PDF files.");
                            //    break;
                            //}
                            /*if (files[i].name.substr(-3).toLowerCase() != "pdf") {
                                flag = false;
                                alert("Please update PDF files.");
                                break;
                            }
                            */
                            // validate file size
                            if (files[i].size > maxsize) {
                                flag = false;
                                alert("File size must be under 2GB.");
                                break;

                            }
                        }
                        return flag;
                    }
                    //update file metadata
                    function updateFileMetadata(apiUrl, updateObject, file, success, failure) {
                        $.ajax({
                            url: apiUrl,
                            type: "POST",
                            async: false,
                            data: JSON.stringify(updateObject),
                            headers: {
                                "accept": "application/json;odata=verbose",
                                "X-RequestDigest": $("#__REQUESTDIGEST").val(),
                                "Content-Type": "application/json;odata=verbose",
                                "X-Http-Method": "MERGE",
                                "IF-MATCH": file.ListItemAllFields.__metadata.etag,
                            },
                            success: function (data) {
                                success(data);
                            },
                            error: function (data) {
                                failure(data);
                            }
                        });
                    }
                    // Get the local file as an array buffer.
                    function getFileBuffer(i) {
                        var deferred = jQuery.Deferred();
                        var reader = new FileReader();
                        reader.onloadend = function (e) {
                            deferred.resolve(e.target.result, i);
                        }
                        reader.onerror = function (e) {
                            deferred.reject(e.target.error);
                        }
                        reader.readAsArrayBuffer(fileInput[0].files[i]);
                        return deferred.promise();
                    }

                    // Add the file to the file collection in the Shared Documents folder.
                    function addFileToFolder(arrayBuffer, i) {
                        var index = i;

                        // Get the file name from the file input control on the page.
                        //   var fileName = fileInput[0].files[index].name;

                        var today = new Date();
                        var timeStampString = new Date().getTime();
                        var cHour = today.getHours();
                        var cMin = today.getMinutes();
                        var cSec = today.getSeconds();
                        //  var fileName = fileInput[0].val().split('.').pop();

                        // var fileName = fileInput[0].files[index].name.split('.');
                        var filenameLength = fileInput[0].files[index].name.length;
                        var fileName = fileInput[0].files[index].name.substr(0, filenameLength - 4);
                        var fileExtenstion = fileInput[0].files[index].name.substr(filenameLength - 4);

                        fileName = fileName + "-" + timeStampString + fileExtenstion;


                        // Construct the endpoint.
                        var fileCollectionEndpoint = String.format(
                            "{0}/_api/web/getfolderbyserverrelativeurl('{1}')/files" +
                            "/add(overwrite=true, url='{2}')?$expand=ListItemAllFields",
                            serverUrl, serverRelativeUrlToFolder + '/' + _recordId, fileName);

                        // Send the request and return the response.
                        // This call returns the SharePoint file.
                        return jQuery.ajax({
                            url: fileCollectionEndpoint,
                            type: "POST",
                            data: arrayBuffer,
                            processData: false,
                            headers: {
                                "accept": "application/json;odata=verbose",
                                "X-RequestDigest": jQuery("#__REQUESTDIGEST").val(),
                                "content-length": arrayBuffer.byteLength
                            }
                        });
                    }

                }




                function saveCorrespondence() {

                    console.error('got here 2');

                    var isValid = true;

                    var modalWindow = $("#divModal-Correspondence");

                    //var _hid_ProductId = modalWindow.find('#hid_ProductId').val();
                    var _hid_CaseId = $("#hid_ID").val();

                    if (Number(_hid_CaseId) > 0) {

                        modalWindow.find('.is-invalid').removeClass("is-invalid");

                        if ((Number(modalWindow.find("#ddlCorrespondenceKey").val()) > 0) == false) {
                            isValid = false;
                            modalWindow.find("#ddlCorrespondenceKey").addClass("is-invalid");
                        }

                            if ((modalWindow.find("#txtCorrespondenceDated").val().length > 0) == false) {
                                isValid = false;
                                modalWindow.find("#txtCorrespondenceDated").addClass("is-invalid");
                            }

                            if ((modalWindow.find("#fileCorrespondenceFiles").get(0).files.length > 0) == false) {
                                if (modalWindow.find("#divCorrespondenceFiles").find('li').length == 0) {
                                    isValid = false;
                                    modalWindow.find("#fileCorrespondenceFiles").addClass("is-invalid");
                                }
                            }



                        if (isValid == true) {

                            RequestStarted();

                            var _recordID = $("#hid_CorrespondenceId").val();

                            var jsonData = {

                                Title: $('#txtCaseNo').val(),
                                ShowCauseLookupId: _hid_CaseId,
                                CorrespondenceKeyId: modalWindow.find('#ddlCorrespondenceKey').val(),
                                Date: modalWindow.find('#txtCorrespondenceDated').datepicker('getDate'),
                                Remarks: modalWindow.find('#txtCorrespondenceRemarks').val(),
                                IsDeleted: false
                            }

                            if (Number(_recordID) > 0) {

                                UpdateSPList("ShowCauseCorrespondence", _recordID, jsonData).done(function (data) {


                                    saveCorrespondenceAttachment();

                                    alert('Correspondence has been edit successfully');

                                    // Retrive Bind updted record
                                    var _caseid = $('#hid_ID').val();
                                    bindShowCauseCorrespondence(_caseid);

                                    $("#divModal-Correspondence").modal('hide');

                                    RequestEnded();

                                }).fail(function (jqXHR, textStatus) {

                                    alert("Correspondence Saving Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                                    RequestEnded();
                                });

                            }
                            else {

                                InsertIntoSPList('ShowCauseCorrespondence', jsonData).done(function (data) {
                                    //console.log(data.d.results);
                                    if (Number(data.d.ID) > 0) {

                                        $("#hid_CorrespondenceId").val(data.d.ID);

                                        saveCorrespondenceAttachment();


                                        alert('Correspondence has been added successfully');


                                        // Retrive Bind newly Added record
                                        var _caseid = $('#hid_ID').val();
                                        bindShowCauseCorrespondence(_caseid);

                                        $("#divModal-Correspondence").modal('hide');

                                        RequestEnded();
                                    }

                                }).fail(function (jqXHR, textStatus) {

                                    alert("Correspondence Saving Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                                    RequestEnded();
                                });
                            }

                        }
                        else {
                            alert("Please fill highlighted fields first!");
                        }
                    }
                    else {
                        alert("Please save the case first!");
                    }
                }

                function saveCorrespondenceAttachment() {
                    //AAT
                    console.error('got here 3');
                    var docidall = "0;";
                    // Define the folder path for this example.
                    var serverRelativeUrlToFolder = 'ShowCauseAttachments';

                    // Get test values from the file input and text input page controls.
                    var fileInput = jQuery('#fileCorrespondenceFiles');
                    var fileCount = fileInput[0].files.length;
                    // Get the server URL.
                    var serverUrl = _spPageContextInfo.webAbsoluteUrl;
                    var filesUploaded = 0;

                    var _CaseId = $('#hid_ID').val();

                    if (isPDFFiles()) {

                        RequestStarted();

                        for (var i = 0; i < fileCount; i++) {
                            // Initiate method calls using jQuery promises.
                            // Get the local file as an array buffer.
                            var getFile = getFileBuffer(i);
                            getFile.done(function (arrayBuffer, i) {

                                // Add the file to the SharePoint folder.
                                var addFile = addFileToFolder(arrayBuffer, i);
                                addFile.done(function (file, status, xhr) {
                                    //$("#msg").append("<div>File : "+file.d.Name+" ... uploaded sucessfully</div>");
                                    filesUploaded++;

                                    var getItem = getListItem(file.d.ListItemAllFields.__deferred.uri);
                                    getItem.done(function (listItem, status, xhr) {

                                    //var file = data.d;
                                    // register/post register
                                    var _attachmodalWin = $('#divModal-Correspondence');
                                    var updateObject = {
                                        __metadata: {
                                            type: listItem.d.__metadata.type
                                        },
                                        ShowCauseLookupId: Number(_CaseId),
                                        FileName: fileInput[0].files[i].name,
                                        AttachmentTypes: "Correspondence"
                                    };


                                    updateObject.CorrespondenceLookupId = Number(_attachmodalWin.find('#hid_CorrespondenceId').val());
                                    try{
                                        updateObject.RefNo = _attachmodalWin.find("#ddlCorrespondenceKey").find("option:selected").text();
                                    } catch (excorrespomce) {
                                        console.log("Error: " , excorrespomce)
                                    }
                                    updateObject.Dated = _attachmodalWin.find("#txtCorrespondenceDated").val();

                                        var changeItem = updateListItem(listItem.d.__metadata, JSON.stringify(updateObject));
                                        changeItem.done(function (data, status, xhr) {

                                    //var url = serverUrl + "/_api/Web/lists/getbytitle('" + serverRelativeUrlToFolder + "')/items(" + file.ListItemAllFields.Id + ")";
                                        docidall += listItem.d.Id + ";";
                                    //updateFileMetadata(url, updateObject, file, function (result) {
                                        //alert("File metadata updation done successfully");
                                    //}, function (result) {
                                        //alert("File upload done but metadata updating FAILED");
                                    //});
                                            if (fileCount == filesUploaded) {

                                                RequestEnded();
                                                $("#fileCorrespondenceFiles").val("");



                                                filesUploaded = 0;
                                            }
                                        });
                                        changeItem.fail(onError => { hideLoader(); });
                                    });
                                    getItem.fail(onError => { hideLoader(); });
                                });
                                addFile.fail(onError);
                            });
                            getFile.fail(onError);
                        }
                    }

                    function isPDFFiles() {
                        var flag = true;
                        var files = fileInput[0].files;
                        var maxsize = 2 * 1024 * 1024 * 1024;//2GB
                        for (var i = 0; i < files.length; i++) {
                            // validate extension
                            //if (files[i].name.split(".")[1].toLowerCase() != "pdf") {
                            //    flag = false;
                            //    alert("Please update PDF files.");
                            //    break;
                            //}
                            /*if (files[i].name.substr(-3).toLowerCase() != "pdf") {
                                flag = false;
                                alert("Please update PDF files.");
                                break;
                            }
                            */
                            // validate file size
                            if (files[i].size > maxsize) {
                                flag = false;
                                alert("File size must be under 2GB.");
                                break;

                            }
                        }
                        return flag;
                    }
                    //update file metadata
                    function updateFileMetadata(apiUrl, updateObject, file, success, failure) {
                        $.ajax({
                            url: apiUrl,
                            type: "POST",
                            async: false,
                            data: JSON.stringify(updateObject),
                            headers: {
                                "accept": "application/json;odata=verbose",
                                "X-RequestDigest": $("#__REQUESTDIGEST").val(),
                                "Content-Type": "application/json;odata=verbose",
                                "X-Http-Method": "MERGE",
                                "IF-MATCH": file.ListItemAllFields.__metadata.etag,
                            },
                            success: function (data) {
                                success(data);
                            },
                            error: function (data) {
                                failure(data);
                            }
                        });
                    }
                    // Get the local file as an array buffer.
                    function getFileBuffer(i) {
                        var deferred = jQuery.Deferred();
                        var reader = new FileReader();
                        reader.onloadend = function (e) {
                            deferred.resolve(e.target.result, i);
                        }
                        reader.onerror = function (e) {
                            deferred.reject(e.target.error);
                        }
                        reader.readAsArrayBuffer(fileInput[0].files[i]);
                        return deferred.promise();
                    }

                    // Add the file to the file collection in the Shared Documents folder.
                    function addFileToFolder(arrayBuffer, i) {
                        var index = i;

                        // Get the file name from the file input control on the page.
                        //   var fileName = fileInput[0].files[index].name;

                        var today = new Date();
                        var timeStampString = new Date().getTime();
                        var cHour = today.getHours();
                        var cMin = today.getMinutes();
                        var cSec = today.getSeconds();
                        //  var fileName = fileInput[0].val().split('.').pop();

                        // var fileName = fileInput[0].files[index].name.split('.');
                        var filenameLength = fileInput[0].files[index].name.length;
                        var fileName = fileInput[0].files[index].name.substr(0, filenameLength - 4);
                        var fileExtenstion = fileInput[0].files[index].name.substr(filenameLength - 4);

                        fileName = fileName + "-" + timeStampString + fileExtenstion;


                        // Construct the endpoint.
                        var fileCollectionEndpoint = String.format(
                            "{0}/_api/web/getfolderbyserverrelativeurl('{1}')/files" +
                            "/add(overwrite=true, url='{2}')?$expand=ListItemAllFields",
                            serverUrl, serverRelativeUrlToFolder + '/' + _recordId, fileName);

                        // Send the request and return the response.
                        // This call returns the SharePoint file.
                        return jQuery.ajax({
                            url: fileCollectionEndpoint,
                            type: "POST",
                            data: arrayBuffer,
                            processData: false,
                            headers: {
                                "accept": "application/json;odata=verbose",
                                "X-RequestDigest": jQuery("#__REQUESTDIGEST").val(),
                                "content-length": arrayBuffer.byteLength
                            }
                        });
                    }

                }
                function deleteCorrespondence(_recordID) {

                    var _confirmResult = confirm("Are you sure you want to delete this Correspondence?");
                    if (_confirmResult == true) {
                        var jsonData = {
                            IsDeleted: true
                        }
                        UpdateSPList("ShowCauseCorrespondence", _recordID, jsonData).done(function (data) {

                            alert('Correspondence has been deleted successfully');

                            // Update UI
                            var _caseid = $('#hid_ID').val();
                            bindShowCauseCorrespondence(_caseid);

                            RequestEnded();

                        }).fail(function (jqXHR, textStatus) {

                            alert("Correspondence Deleting Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                            RequestEnded();
                        });
                    }

                }





                function saveRegisteredPackSize() {

                    var isValid = true;

                    var modalWindow = $("#divModal-RegisteredPackaging");

                    var _hid_ProductId = $("#divModal-PackSize").find('#hid_ProductId').val();

                    if (Number(_hid_ProductId) > 0) {

                        modalWindow.find('.is-invalid').removeClass("is-invalid");

                        if ((modalWindow.find("#txtRegisteredPackSize").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtRegisteredPackSize").addClass("is-invalid");
                        }
                        if ((modalWindow.find("#txtRegisteredPackagingType").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtRegisteredPackagingType").addClass("is-invalid");
                        }


                        if ((modalWindow.find("#ddlRegisteredShelfLife").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#ddlRegisteredShelfLife").addClass("is-invalid");
                        }

                        if ((modalWindow.find("#txtRegisteredMRP").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtRegisteredMRP").addClass("is-invalid");
                        }

                        if ((modalWindow.find("#txtRegisteredStrength").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtRegisteredStrength").addClass("is-invalid");
                        }
                        /*
                        if ((modalWindow.find("#txtRegisteredSAP").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtRegisteredSAP").addClass("is-invalid");
                        }
                        */
                                                

                        if ((modalWindow.find("#txtRegisteredMarketedMRP").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtRegisteredMarketedMRP").addClass("is-invalid");
                        }
                        

                        if ((modalWindow.find("#txtRegisteredImplementationDate").val().length > 0) == false) {
                            isValid = false;
                            modalWindow.find("#txtRegisteredImplementationDate").addClass("is-invalid");
                        }


                        if (isValid == true) {

                            RequestStarted();

                            var _recordID = $("#hid_PackSizeId").val();

                            var jsonData = {
                                PackSize: modalWindow.find('#txtRegisteredPackSize').val(),
                                PackagingType: modalWindow.find('#txtRegisteredPackagingType').val(),

                                Shelf: modalWindow.find('#ddlRegisteredShelfLife').val(),
                                ShelfLifeLookupId: modalWindow.find('#ddlRegisteredShelfLife').val(),

                                MRP: modalWindow.find('#txtRegisteredMRP').val(),
                                Strength: modalWindow.find('#txtRegisteredStrength').val(),
                                SAP: modalWindow.find('#txtRegisteredSAP').val(),
                                MarketedMRP: modalWindow.find('#txtRegisteredMarketedMRP').val(),
                                MRPImplementationDate: modalWindow.find('#txtRegisteredImplementationDate').val(),
                                ProductLookupId: _hid_ProductId,
                                Stage: "Registered"
                            }

                            if (Number(_recordID) > 0) {

                                UpdateSPList("ProductPackSize", _recordID, jsonData).done(function (data) {

                                    alert('Registered packaging has been edit successfully');
                                    // Retrive Nomenclatures newly Added

                                    var _hid_ProductId = $('#hid_ID').val();

                                    bindPackSize(_hid_ProductId);

                                    $("#divModal-RegisteredPackaging").modal('hide');

                                    RequestEnded();

                                }).fail(function (jqXHR, textStatus) {

                                    alert("Product Saving Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                                    RequestEnded();
                                });

                            }
                            else {



                                InsertIntoSPList('ProductPackSize', jsonData).done(function (data) {
                                    //console.log(data.d.results);
                                    if (Number(data.d.ID) > 0) {


                                        alert('Registered packaging has been added successfully');
                                        // Retrive Nomenclatures newly Added
                                        var _hid_ProductId = $('#hid_ID').val();

                                        bindPackSize(_hid_ProductId);

                                        $("#divModal-RegisteredPackaging").modal('hide');

                                        RequestEnded();
                                    }

                                }).fail(function (jqXHR, textStatus) {

                                    alert("Product Saving Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                                    RequestEnded();
                                });
                            }

                        }
                        else {
                            alert("Please fill highlighted fields first!");
                        }
                    }
                    else {
                        alert("Please save the product first!");
                    }
                }


                function deleteShowCauseProduct(_recordID) {

                    var _confirmResult = confirm("Are you sure you want to remove this product from this case?");
                    if (_confirmResult == true) {

                        GetSPListItems("ShowCauseProducts", _recordID, '').done(function (data) {

                            if (data && data.d) {
                                deleteItem("ShowCauseProducts", data.d).done(function (data) {
                                    alert('Product has been removed successfully');

                                    var _hid_ProductId = $('#hid_ID').val();
                                    bindShowcauseProducts(_hid_ProductId, 'Edit');

                                    RequestEnded();
                                });
                            }

                        }).fail(function (jqXHR, textStatus) {

                            alert("Product Deleting Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                            RequestEnded();
                        });
                    }

                }
                

            </script>



            <script type="text/javascript">

                var Tasks = {
                    urlName: window.location.origin + "/",
                    siteName: '/sites/SearimsTest',
                };

                ExecuteOrDelayUntilScriptLoaded(function () {
                    var scriptbase = _spPageContextInfo.siteAbsoluteUrl + "/_layouts/15/";
                    console.error("scriptbase: " + scriptbase);
                    // Load the js files and continue to the successHandler
                    $.getScript(scriptbase + "SP.RequestExecutor.js", function () {
                        console.log("request executor is now loaded");
                        // Logic here
                    });
                }, "sp.js");

                var siteUrl = _spPageContextInfo.webAbsoluteUrl;
                console.error("siteUrl: " + siteUrl);

                // start
                function saveAttachment() {

                    var isValid = true;

                    var modalWindow = $('#divModal-Attachment');

                    modalWindow.find('.is-invalid').removeClass("is-invalid");

                    if ((modalWindow.find("#txtRefNo").val().length > 0) == false) {
                        isValid = false;
                        modalWindow.find("#txtRefNo").addClass("is-invalid");
                    }
                    if ((modalWindow.find("#txtDated").val().length > 0) == false) {
                        isValid = false;
                        modalWindow.find("#txtDated").addClass("is-invalid");
                    }
                    if ((modalWindow.find("#fileAttachedFiles").val().length > 0) == false) {
                        isValid = false;
                        modalWindow.find("#fileAttachedFiles").addClass("is-invalid");
                    }


                    if (isValid == true) {

                        var docidall = "0;";
                        // Define the folder path for this example.
                        var serverRelativeUrlToFolder = 'ShowCauseAttachments';

                        // Get test values from the file input and text input page controls.
                        var fileInput = jQuery('#fileAttachedFiles');
                        var fileCount = fileInput[0].files.length;
                        // Get the server URL.
                        var serverUrl = _spPageContextInfo.webAbsoluteUrl;
                        var filesUploaded = 0;

                        var _ProductId = $('#hid_ID').val();

                        if (isPDFFiles()) {

                            RequestStarted();

                            for (var i = 0; i < fileCount; i++) {
                                // Initiate method calls using jQuery promises.
                                // Get the local file as an array buffer.
                                var getFile = getFileBuffer(i);
                                getFile.done(function (arrayBuffer, i) {

                                    // Add the file to the SharePoint folder.
                                    var addFile = addFileToFolder(arrayBuffer, i);
                                    addFile.done(function (file, status, xhr) {
                                        //$("#msg").append("<div>File : "+file.d.Name+" ... uploaded sucessfully</div>");
                                        filesUploaded++;

                                        var getItem = getListItem(file.d.ListItemAllFields.__deferred.uri);
                                        getItem.done(function (listItem, status, xhr) {

                                        //var file = data.d;
                                        // register/post register
                                        var _attachmodalWin = $('#divModal-Attachment');
                                        var updateObject = {
                                            __metadata: {
                                                type: listItem.d.__metadata.type
                                            },
                                            ShowCauseLookupId: Number(_recordId),
                                            FileName: fileInput[0].files[i].name,
                                            AttachmentTypes: $('#hid_AttachmentType').val()
                                        };

                                        //if (updateObject.AttachmentTypes == "")
                                        {
                                            updateObject.ShowCauseProductLookupId = Number($('#hid_ShowCauseProductId').val());
                                            updateObject.RefNo = _attachmodalWin.find("#txtRefNo").val();
                                            updateObject.Dated = _attachmodalWin.find("#txtDated").val();

                                        }

                                        /*
                                        if (updateObject.Stage == "Renewal") {
                                            updateObject.Renewal_SubmissionDate = $("#divFromDetials").find('#txtRenewalSubmissionDate').datepicker('getDate');
                                            updateObject.Renewal_RegistrationDate = $("#divFromDetials").find('#txtRenewalRegistrationDate').datepicker('getDate');
                                            updateObject.Renewal_ExpiryDate = $("#divFromDetials").find('#txtRenewalExpiryDate').datepicker('getDate');
    
                                            if ($("#radRenewalApplied").prop('checked'))
                                                updateObject.RenewalType = 'Renewal Applied';
                                            if ($("#radRenewalApproved").prop('checked'))
                                                updateObject.RenewalType = 'Renewal Approved';
    
                                        }
                                        */

                                            var changeItem = updateListItem(listItem.d.__metadata, JSON.stringify(updateObject));
                                            changeItem.done(function (data, status, xhr) {

                                        //var url = serverUrl + "/_api/Web/lists/getbytitle('" + serverRelativeUrlToFolder + "')/items(" + file.ListItemAllFields.Id + ")";
                                            docidall += listItem.d.Id + ";";
                                        //updateFileMetadata(url, updateObject, file, function (result) {
                                            //alert("File metadata updation done successfully");
                                        //}, function (result) {
                                            //alert("File upload done but metadata updating FAILED");
                                        //});
                                        if (fileCount == filesUploaded) {


                                            bindProductsAttachments(_recordId, $('#hid_ShowCauseProductId').val(), 'edit');
                                            RequestEnded();
                                            alert("All files uploaded successfully.");
                                            $('#divModal-Attachment').modal('hide');
                                            $("#fileAttachedFiles").val("");
                                            $('#chkiscertificate').prop('checked', false);

                                            //$('#txtRenewalSubmissionDate,#txtRenewalRegistrationDate,#txtRenewalExpiryDate').datepicker('setDate', null);


                                            filesUploaded = 0;
                                                }
                                            });
                                            changeItem.fail(onError => { hideLoader(); });
                                        });
                                        getItem.fail(onError => { hideLoader(); });
                                    });
                                    addFile.fail(onError);
                                });
                                getFile.fail(onError);
                            }
                        }

                        function getListItem(fileListItemUri) {
                            console.error('got here 3');
                            return jQuery.ajax({
                                url: fileListItemUri,
                                type: "GET",
                                headers: { "accept": "application/json;odata=verbose" }
                            });
                        }

                        function updateListItem(itemMetadata, body) {
                            console.error('got here 4');

                            return jQuery.ajax({
                                url: itemMetadata.uri,
                                type: "POST",
                                data: body,
                                headers: {
                                    "X-RequestDigest": jQuery("#__REQUESTDIGEST").val(),
                                    "content-type": "application/json;odata=verbose",
                                    "content-length": body.length,
                                    "IF-MATCH": itemMetadata.etag,
                                    "X-HTTP-Method": "MERGE"
                                }
                            });
                        }

                        function isPDFFiles() {
                            var flag = true;
                            var files = fileInput[0].files;
                            var maxsize = 2 * 1024 * 1024 * 1024;//2GB
                            for (var i = 0; i < files.length; i++) {
                                // validate extension
                                //if (files[i].name.split(".")[1].toLowerCase() != "pdf") {
                                //    flag = false;
                                //    alert("Please update PDF files.");
                                //    break;
                                //}
                                if (files[i].name.substr(-3).toLowerCase() != "pdf") {
                                    flag = false;
                                    alert("Please update PDF files.");

                                    $('#divModal-Attachment').find("#fileAttachedFiles").addClass("is-invalid");
                                    break;
                                }

                                // validate file size
                                if (files[i].size > maxsize) {
                                    flag = false;
                                    alert("File size must be under 2GB.");

                                    $('#divModal-Attachment').find("#fileAttachedFiles").addClass("is-invalid");
                                    break;

                                }
                            }
                            return flag;
                        }
                        //update file metadata
                        function updateFileMetadata(apiUrl, updateObject, file, success, failure) {
                            $.ajax({
                                url: apiUrl,
                                type: "POST",
                                async: false,
                                data: JSON.stringify(updateObject),
                                headers: {
                                    "accept": "application/json;odata=verbose",
                                    "X-RequestDigest": $("#__REQUESTDIGEST").val(),
                                    "Content-Type": "application/json;odata=verbose",
                                    "X-Http-Method": "MERGE",
                                    "IF-MATCH": file.ListItemAllFields.__metadata.etag,
                                },
                                success: function (data) {
                                    success(data);
                                },
                                error: function (data) {
                                    failure(data);
                                }
                            });
                        }
                        // Get the local file as an array buffer.
                        function getFileBuffer(i) {
                            var deferred = jQuery.Deferred();
                            var reader = new FileReader();
                            reader.onloadend = function (e) {
                                deferred.resolve(e.target.result, i);
                            }
                            reader.onerror = function (e) {
                                deferred.reject(e.target.error);
                            }
                            reader.readAsArrayBuffer(fileInput[0].files[i]);
                            return deferred.promise();
                        }

                        // Add the file to the file collection in the Shared Documents folder.
                        function addFileToFolder(arrayBuffer, i) {
                            var index = i;

                            // Get the file name from the file input control on the page.
                            //   var fileName = fileInput[0].files[index].name;

                            var today = new Date();
                            var timeStampString = new Date().getTime();
                            var cHour = today.getHours();
                            var cMin = today.getMinutes();
                            var cSec = today.getSeconds();
                            //  var fileName = fileInput[0].val().split('.').pop();

                            // var fileName = fileInput[0].files[index].name.split('.');
                            var filenameLength = fileInput[0].files[index].name.length;
                            var fileName = fileInput[0].files[index].name.substr(0, filenameLength - 4);
                            var fileExtenstion = fileInput[0].files[index].name.substr(filenameLength - 4);

                            fileName = fileName + "-" + timeStampString + fileExtenstion;


                            // Construct the endpoint.
                            var fileCollectionEndpoint = String.format(
                                "{0}/_api/web/getfolderbyserverrelativeurl('{1}')/files" +
                                "/add(overwrite=true, url='{2}')?$expand=ListItemAllFields",
                                serverUrl, serverRelativeUrlToFolder + '/' + _recordId, fileName);

                            var deferred = jQuery.Deferred();
                            document.getElementById("btnSave").addEventListener("progress",
                                function (_evt) { fileuploaderprogresser2(_evt, "li-file-" + index, fileInput[0].files[index].size); }, false);
                            uploadLargeFile2(fileInput[0].files[index], serverRelativeUrlToFolder, fileName, arrayBuffer, deferred);
                            return deferred.promise();

                            // Send the request and return the response.
                            // This call returns the SharePoint file.
                            /*return jQuery.ajax({
                                url: fileCollectionEndpoint,
                                type: "POST",
                                data: arrayBuffer,
                                processData: false,
                                headers: {
                                    "accept": "application/json;odata=verbose",
                                    "X-RequestDigest": jQuery("#__REQUESTDIGEST").val(),
                                    "content-length": arrayBuffer.byteLength
                                }
                            });*/
                        }
                    }
                    else {
                        alert("Please fill highlighted fields first!");
                    }
                }
                // Display error messages.
                function onError(error) {
                    alert('File Uploading Fail! Try again after refreshing page.\n\nError Text:\n\n' + error.responseText);
                    RequestEnded();
                }

                function uploadLargeFile2(file, libname, filename, arrayBuffer, deferred) {
                    console.error('got here 7');
                    var docLibraryName = "/sites/SearimsTest/" + libname;
                    var fileName = filename;
                    var folderName = "";
                    createDummyFile(docLibraryName, fileName)
                    var fr = new FileReader();
                    var offset = 0;
                    var total = file.size;
                    var length = parseInt(1000000) > total ? Math.round(total * 0.8) : parseInt(1000000);
                    var chunks = [];

                    while (offset < total) {
                        if (offset + length > total)
                            length = total - offset;
                        chunks.push({
                            offset,
                            length,
                            method: getUploadMethod(offset, length, total)
                        });
                        offset += length;
                    }
                    for (var i = 0; i < chunks.length; i++)
                        console.log(chunks[i]);

                    const chunkPercentage = (total / chunks.length) / total * 100;

                    if (chunks.length > 0) {
                        const id = this.guid();
                        this.uploadFile(arrayBuffer, id, docLibraryName, filename, chunks, 0, 0, chunkPercentage, deferred, false);
                    }
                }

                function createDummyFile(libraryName, fileName) {
                    console.error('got here 8');

                    return new Promise((resolve, reject) => {
                        var endpoint = Tasks.urlName + Tasks.siteName + "/_api/web/GetFolderByServerRelativeUrl('" + libraryName + "')/Files/add(url=@TargetFileName,overwrite='true')?" +
                            "&@TargetFileName='" + fileName + "'";
                        const headers = {
                            "accept": "application/json;odata=verbose"
                        };
                        this.executeAsync(endpoint, this.convertDataBinaryString(2), headers).then(file => resolve(true)).catch(err => reject(err));
                    });
                }

                function guid() {
                    console.error('got here 9');
                    function s4() {
                        return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
                    }
                    return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
                }

                function getUploadMethod(offset, length, total) {
                    console.error('got here 10');
                    if (offset + length + 1 > total) {
                        return 'finishupload';
                    } else if (offset === 0) {
                        return 'startupload';
                    } else if (offset < total) {
                        return 'continueupload';
                    }
                    return null;
                }

                function uploadFile(result, id, libraryPath, fileName, chunks, index, byteOffset, chunkPercentage, deferred, lastCall) {
                    console.error('got here 11');
                    //we slice the file blob into the chunk we need to send in this request (byteOffset tells us the start position)  
                    const data = this.convertFileToBlobChunks(result, byteOffset, chunks[index]);

                    const progressEvent = new CustomEvent("progress", {
                        detail: {
                            index: index,
                            total: chunks.length,
                            offset: chunks[index].offset
                        },
                    });
                    document.getElementById("btnSave").dispatchEvent(progressEvent);

                    //upload the chunk to the server using REST, using the unique upload guid as the identifier
                    this.uploadFileChunk(id, libraryPath, fileName, chunks[index], data, byteOffset, deferred, lastCall).then(value => {

                        var jsonObject = JSON.parse(value.body);

                        const isFinished = index === chunks.length - 1;
                        index += 1;
                        const percentageComplete = isFinished ? 100 : Math.round((index * chunkPercentage));
                        if (index < chunks.length) {
                            this.uploadFile(result, id, libraryPath, fileName, chunks, index, byteOffset, chunkPercentage, deferred, lastCall);
                        } else {
                            console.error('uploadFileChunk resolve ');
                            deferred.resolve(jsonObject);
                            const progressEvent = new CustomEvent("progress", {
                                detail: {
                                    index: index,
                                    total: chunks.length,
                                    offset: chunks[index - 1].offset + chunks[index - 1].length
                                },
                            });
                            document.getElementById("btnSave").dispatchEvent(progressEvent);
                        }
                    }).catch(err => {
                        console.error('Error in uploadFileChunk! ' + err);
                        deferred.reject();
                    });
                }

                function convertFileToBlobChunks(result, byteOffset, chunkInfo) {
                    console.error('got here 12');
                    let arrayBuffer = result.slice(chunkInfo.offset, chunkInfo.offset + chunkInfo.length);
                    return this.convertDataBinaryString(arrayBuffer);
                }

                function convertDataBinaryString(data) {
                    let fileData = '';
                    let byteArray = new Uint8Array(data);
                    for (var i = 0; i < byteArray.byteLength; i++) {
                        fileData += String.fromCharCode(byteArray[i]);
                    }
                    return fileData;
                }


                function uploadFileChunk(id, libraryPath, fileName, chunk, data, byteOffset, deferred, lastCall) {
                    console.error('got here 13');
                    return new Promise((resolve, reject) => {
                        console.error('got here 15');
                        let offset = chunk.offset === 0 ? '' : ',fileOffset=' + chunk.offset;
                        console.error('got here 16');
                        var endpoint = Tasks.urlName + Tasks.siteName + "/_api/web/getfilebyserverrelativeurl('" + libraryPath + "/" + fileName + "')/" + chunk.method + "(uploadId=guid'" + id + "'" + offset + ")";
                        console.error('got here 17');
                        const headers = {
                            "Accept": "application/json; odata=verbose",
                            "Content-Type": "application/octet-stream"
                        };
                        console.error('got here 18');
                        this.executeAsync(endpoint, data, headers, deferred, lastCall).then(data => {
                            //var jsonObject = JSON.parse(data.body);
                            resolve(data);
                            console.error('got here 21');
                        }).catch(err => reject(err));
                    });
                }

                function executeAsync(endPointUrl, data1, requestHeaders, deferred, lastCall) {
                    console.error('got here 14');
                    return new Promise((resolve, reject) => {
                        // using a utils function we would get the APP WEB url value and pass it into the constructor... 
                        console.error('got here 19');
                        let executor = new SP.RequestExecutor(this.siteUrl);
                        console.error('got here 20');
                        // Send the request.  
                        executor.executeAsync({
                            url: endPointUrl,
                            method: "POST",
                            body: data1,
                            binaryStringRequestBody: true,
                            headers: requestHeaders,
                            success: function (data) {
                                resolve(data);
                            },//offset => resolve(offset),
                            error: err => reject(err.responseText)
                        });
                    });
                }


                function fileuploaderprogresser2(evt, _uploadingFileId, fileSize) {

                    console.error('fileuploaderprogresser2 ' + evt.detail.index + ' ' + evt.detail.total + ' ' + evt.detail.offset);
                    var fileSize = evt.detail.offset;
                    var percentComplete = evt.detail.index / evt.detail.total;
                    percentComplete = parseInt(percentComplete * 100);
                    console.error('fileuploaderprogresser2 percentComplete ' + percentComplete);

                    //var testTisObj = this;

                    var _progressBar = $("#olSelectFiles").find("#" + _uploadingFileId).find(".progress-bar");
                    if (_progressBar.length == 0) {
                        console.error('fileuploaderprogresser2 got here 1');
                        var htmlProgressBar = "<div class='progress no-margin'>" +
                            "  <div class='progress-bar progress-bar-warning progress-bar-striped' role='progressbar' aria-valuenow='" + percentComplete + "' aria-valuemin='0' aria-valuemax='100' style='width: " + percentComplete + "%'>" +
                            "    <span class='sr-only'>" + percentComplete + "% Complete (Still uploading)</span>" +
                            "  </div>" +
                            "</div>";
                        $("#olSelectFiles").find("#" + _uploadingFileId).html(htmlProgressBar);
                    }
                    else {
                        console.error('fileuploaderprogresser2 got here 2');
                        _progressBar.css("width", percentComplete + '%');
                        if (percentComplete < 100) {
                            console.error('fileuploaderprogresser2 got here 3');

                            _progressBar.find(".sr-only").text("" + percentComplete + "% Complete (Still uploading)");

                            //var fileSize = evt.loaded / 1024;

                            if (fileSize > 1048575) {
                                fileSize = (fileSize / 1024);
                                fileSize = (fileSize / 1024).toFixed(3) + " MB uploaded";
                            }
                            else if (fileSize > 1023)
                                fileSize = (fileSize / 1024).toFixed(3) + " KB uploaded";
                            else
                                fileSize = fileSize.toFixed(3) + " Bytes uploaded";


                            $("#" + _uploadingFileId).find('.span-info').text(fileSize);

                        }
                        else {
                            console.error('fileuploaderprogresser2 got here 4');

                            _progressBar.find(".sr-only").text("" + percentComplete + "% Uploaded");
                            _progressBar.addClass("progress-bar-success").removeClass("progress-bar-warning");
                            $("#" + _uploadingFileId).find('span').css("color", "white");
                            $("#" + _uploadingFileId).find('.span-info').text('');
                        }
                    }
                }

                var _attachmentTypeLast = null;
                function deleteProductAttachment(_recordID, _attachmentType) {

                    var _confirmResult = confirm("Are you sure you want to delete this attachment?");
                    if (_confirmResult == true) {
                        _attachmentTypeLast = _attachmentType;

                        GetSPListItems("ShowCauseAttachments", _recordID, '').done(function (data) {

                            if (data && data.d) {
                                deleteItem("ShowCauseAttachments", data.d).done(function (data) {
                                    alert('Attachment has been deleted successfully');
                                    
                                    var _recordId = $('#hid_ID').val();

                                    //bindAttachment(_recordId, 'Edit');
                                    if (_attachmentTypeLast.search("Products") > -1) {
                                        bindProductsAttachments(_recordId, $('#hid_ShowCauseProductId').val(), 'edit');
                                    }

                                    if (_attachmentTypeLast.search("Firm Response") > -1) {
                                        bindfirmResponseAttachments(_recordId, $('#hid_FirmResponseId').val(), 'edit');
                                    }


                                    if (_attachmentTypeLast.search("Correspondence") > -1) {
                                        bindCorrespondenceAttachments(_recordId, $('#hid_CorrespondenceId').val(), 'edit');
                                    }
                                    

                                    RequestEnded();

                                    _attachmentTypeLast = null;

                                });
                            }

                        }).fail(function (jqXHR, textStatus) {

                            alert("CompanyCredentials Deleting Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                            RequestEnded();
                        });
                    }

                }



                function downloadDocument(_fileId) {

                    var listName = 'ShowCauseAttachments';
                    var apiURL = _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('" + listName + "')/items/GetById(" + _fileId + ")/file"

                    $.ajax({
                        url: apiURL,
                        type: "GET",
                        async: false,
                        headers: {
                            "Accept": "application/json; odata=verbose",
                        },
                        success: function (dataFileInfo) {

                            if (dataFileInfo.d) {

                                var fileURL = location.origin + dataFileInfo.d.ServerRelativeUrl;
                                downloadFunction(fileURL);
                            }

                        },
                        error: function (error) {
                            console.log("Error on getting file info", error);

                            RequestEnded();
                        }
                    });
                }


                function downloadFunction(url) {
                    var file_path = url;
                    var a = document.createElement('A');
                    a.href = file_path;
                    a.download = file_path.substr(file_path.lastIndexOf('/') + 1);
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                }


            </script>





<!--  Notification  -->
<script type="text/javascript">
    
    function notificationMarkAsSeen() {
        try {

            var _notid = GetUrlKeyValue('notid');

            if (Number(_notid) > 0) {

                markAsRead(_notid);

            }


            var _ProductId = $('#hid_ID').val();

            if (Number(_ProductId) > 0) {

                var notificationsJson = {
                    RecordId: "" + _ProductId
                };

                notificationsJson.ModuleType = Module.ProductManagement;
                listTitle = "Products";


                var filterNomenclature = "HasSeen eq 0 and NotifyToUsersId eq " + _spPageContextInfo.userId + " and ModuleType eq '" + notificationsJson.ModuleType + "' and RecordId eq '" + notificationsJson.RecordId + "' and Action ne 'Submit'&$top=1000&$select=Id,Title,RecordId,ProductLookupId,ArtworkLookupId,CredentialLookupId,Action,HasSeen,SeenOn,ModuleType,Created";
                GetSPListItems("Notifications", 0, filterNomenclature)
                 .done(function (data) {

                     var response = data.d.results;
                     for (var i = 0; i < response.length ; i++) {
                         if (Number(response[i].Id) > 0) {
                             markAsRead(response[i].Id);
                         }
                     }
                 });

            }

        } catch (ex2) {
            console.log(ex2);
        }
    }


    function sendNotification() {


        /*

Title   Single line of text	
Modified	Date and Time	
Created	Date and Time	
Action	Single line of text	
NotifyToLookup	Lookup	
NotifyToUsers	Person or Group	
ActionByUser	Lookup	
HasSeen	Yes/No	
SeenOn	Date and Time	
RecordId	Single line of text	
ProductLookup	Lookup	
ArtworkLookup	Lookup	
CredentialLookup	Lookup	
ModuleType	Single line of text	
Created By	Person or Group	
Modified By	Person or Group

            */

        var sendNotifiaction = false;

        var notificationText = "";
        var notificationToUserLookupIds = [];
        var notificationToSPUserIds = [];
        var notificationAsGroup = false;



        notificationText = "A product has been submitted and waiting for your approval!";

        var profileIdLst = [];
        var filterProfileQuery = "CanApprove eq 1 and ModuleType eq '" + Module.ProductManagement + "' and CountryLookupId eq " + $("#ddlCountry").val() + "&$top=5000&$select=Id,ProfileLookupId";
        GetSPListItems("ProfileRights", 0, filterProfileQuery, false)
            .done(function (data) {
                if (data.d.results.length > 0) {
                    data.d.results.forEach(function (pdetails) {
                        
                        if (Number(pdetails.ProfileLookupId) > 0) {
                            
                            profileIdLst.push(pdetails.ProfileLookupId);

                        }
                    });

                }
            });

        var filterQuery = "IsActive eq 1&$top=5000&$select=Id,LoginIDId,ProfileLookupId";
        GetSPListItems("Users", 0, filterQuery, false)
            .done(function (data) {
                if (data.d.results.length > 0) {

                    data.d.results.forEach(function (uid) {
                        if (Number(uid.LoginIDId) > 0 && Number(uid.LoginIDId) != _spPageContextInfo.userId) {
                            if (uid.ProfileLookupId && uid.ProfileLookupId != null && uid.ProfileLookupId.results != null && uid.ProfileLookupId.results.length > 0) {
                                uid.ProfileLookupId.results.forEach(function (profileId) {

                                    if (Number(profileId) > 0 && profileIdLst.includes(profileId)) {

                                        notificationToUserLookupIds.push(uid.Id);
                                        notificationToSPUserIds.push(uid.LoginIDId);

                                        sendNotifiaction = true;
                                        notificationAsGroup = true;
                                    }

                                });
                            }
                        }
                    });

                }
            });


        

        if (sendNotifiaction == true) {

            if (notificationAsGroup == true) {

                var notificationsJson = {
                    Title: notificationText,
                    RecordId: $('#hid_ID').val(),
                    ProductLookupId: $('#hid_ID').val(),
                    Action: "Submit",
                    ActionByUserId: currentUserCustomInfo.Id,
                    NotifyToUsersId: { 'results': notificationToSPUserIds },
                    NotifyToLookupId: { 'results': notificationToUserLookupIds },
                    HasSeen: false,
                    ModuleType: Module.ProductManagement//SeenOn: null

                }

                InsertIntoSPList("Notifications", notificationsJson).done(function (data) {
                    console.log("Notifications Saved.");
                }).fail(onerror);

            }
            else {
                /*
                notificationToSPUserIds.forEach(function (userId) {
                    var userIDArray = [];
                    userIDArray.push(userId);
                    var notificationsJson = {
                        Title: notificationText,
                        NomenclatureLookupId: actionHistoryJson.NomenclatureLookupId,
                        Action: actionHistoryJson.ApproverAction,
                        ActionByUserId: currentUserCustomInfo.Id,
                        NotifyToId: { 'results': userIDArray },
                        HasSeen: false,
                        FolderId: "" + loadedFolder.ID
                        //SeenOn: null

                    }

                    InsertIntoSPList("Notifications", notificationsJson).done(function (data) {
                        console.log("Notification Saved.");
                    }).fail(onerror);
                });
                */
            }
        }
    }

</script>


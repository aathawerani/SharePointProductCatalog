<!-- Bootstrap core CSS -->

<link href="../Style%20Library/CustomStyleLibraries/chosen_v1.8.7/chosen.min.css?v=1.0" rel="stylesheet">
<link href="../Style%20Library/CustomStyleLibraries/jquery-ui-datepicker/jquery-ui.min.css?v=1.0" rel="stylesheet">
<link href="../Style%20Library/CustomStyleLibraries/bootstrap-3.3.7-dist/css/bootstrap.min.css?v=1.0" rel="stylesheet">
<link href="../Style%20Library/CustomStyleLibraries/datatable/dataTables.bootstrap4.css?v=1.0" rel="stylesheet" />
<link href="../Style%20Library/CustomStyleLibraries/datatable/dataTables.responsive.css?v=1.0" rel="stylesheet" />
<link href="../Style%20Library/CustomStyleLibraries/datatable/dataTables.bootstrap4.min.css?v=1.0" rel="stylesheet" />

<script src="../Style%20Library/CustomStyleLibraries/jquery-ui-datepicker/jquery-ui.min.js?v=1.0"></script>

<script src="../Style%20Library/CustomStyleLibraries/bootstrap-3.3.7-dist/js/bootstrap.min.js?v=1.0"></script>
<script src="../Style%20Library/CustomStyleLibraries/datatable/jquery.dataTables.min.js?v=1.0"></script>
<script src="../Style%20Library/CustomStyleLibraries/datatable/dataTables.bootstrap.min.js?v=1.0"></script>
<script src="../Style%20Library/CustomStyleLibraries/datatable/dataTables.responsive.js?v=1.0"></script>

<script src="../Style%20Library/CustomStyleLibraries/chosen_v1.8.7/chosen.jquery.min.js?v=1.0"></script>


<style type="text/css">
    .column_filter {
        width: 100% !important;
    }
</style>

<div style="margin-top: 0px;">

    <div class="row">
        <div class="col-md-12">
            <button type="button" class="btn btn-primary pull-right" id="btnAddCompanyCredentials" style="display:none;" onclick="openCompanyCredentialsDetails(0,'new')"><i class="glyphicon glyphicon-plus"></i> Create Company Credentials</button>
        </div>
    </div>

    <!--<div class="panel panel-default">
        <div class="panel-body">-->


    <div class="row" style="margin-top: 20px;">
        <div class="col-md-12">

            <table id="tblCompanyCredentials" class="table table-striped" style="width: 100%">
                <thead class="alert alert-info h5">

                    <tr>

                        <th class="th-sm" data-column='0'> <input type='text' class='column_filter form-control record-id' onchange='SearchCol(0)' autocomplete="off" /></th>
                        <th class="th-sm" data-column='1'> <input type='text' class='column_filter form-control' onkeyup='SearchCol(1)' autocomplete="off" /></th>
                        <th class="th-sm" data-column='2'> <input type='text' class='column_filter form-control' onkeyup='SearchCol(2)' autocomplete="off" /></th>
                        <th class="th-sm" data-column='3'> <input type='text' class='column_filter form-control' onkeyup='SearchCol(3)' autocomplete="off" /></th>
                        <th class="th-sm" data-column='4'> <input type='text' class='column_filter form-control' onkeyup='SearchCol(4)' autocomplete="off" /></th>
                        <th class="th-sm" data-column='5'> <input type='text' class='column_filter form-control' onkeyup='SearchCol(5)' autocomplete="off" /></th>
                        <th class="th-sm" data-column='6'> <input type='text' class='column_filter form-control' onkeyup='SearchCol(6)' autocomplete="off" /></th>
                        <th class="th-sm" data-column='7'> <input type='text' class='column_filter form-control' onkeyup='SearchCol(7)' autocomplete="off" /></th>
                        <th class="th-sm" data-column='8'> <input type='text' class='column_filter form-control date-picker-filter' onkeyup='SearchCol(8)' onchange='SearchCol(8)' autocomplete="off" /></th>
                        <th class="th-sm" data-column='9'> <input type='text' class='column_filter form-control date-picker-filter' onkeyup='SearchCol(9)' onchange='SearchCol(9)' autocomplete="off" /></th>
                        <th class="th-sm" data-column='10'>

                            <select class='column_filter form-control' onchange='SearchCol(10)'>
                                <option value="">All</option>
                                <option value="On Hold">On Hold</option>
                                <option value="Pending">Pending</option>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                                <option value="Send Back">Send Back</option>
                            </select>
                        </th>
                        <th class="th-sm" data-column='11'> </th>

                    </tr>
                    <tr>
                        <th class="th-sm">
                            Id
                        </th>
                        <th class="th-sm">
                            Modified
                        </th>
                        <th class="th-sm">
                            Company
                        </th>
                        <th class="th-sm">
                            Country
                        </th>
                        <th class=" th-sm">
                            Type of Credential
                        </th>
                        <th style="text-align: left" class="th-sm">
                            Name of Credential
                        </th>
                        <th class="th-sm">
                            License Number
                        </th>
                        <th class="th-sm">
                            Manufacturing Site
                        </th>
                        <th class="th-sm">
                            Valid From
                        </th>
                        <th class="th-sm">
                            Valid Till
                        </th>
                        <th class="th-sm">
                            Status
                        </th>
                        <th class="th-sm" align='center' style="text-align:center;">
                            Action
                        </th>
                    </tr>

                </thead>

                <tbody></tbody>

            </table>

        </div>
    </div>


    <!--</div>
    </div>-->

</div>

<!-- Start Product Modal -->
<div class="modal fade" id="divModal-CompanyCredentialsDetails" data-backdrop="static" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" id="mod_mesga">&times;</span>
                </button>
                <h2 class="modal-title">Create Company Credentials </h2>
            </div>
            <div class="modal-body">
                <input type='hidden' id='hid_ID' />

                <div>

                    <div class="row">

                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Company<i class="text-danger">*</i></label>
                                    <select id="ddlCompany" class="form-control">
                                        <option value="0">-- None --</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Country<i class="text-danger">*</i></label>
                                    <select id="ddlCountry" class="form-control"></select>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Manufacturing site <i class="text-danger">*</i></label>
                                    <select id="ddlManufacturingSite" class="form-control tag-input"></select>
                                </div>
                            </div>
                        </div>

                    </div>


                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Type of Credential<i class="text-danger">*</i> </label>
                                    <select id="ddlLicenseType" class="form-control">
                                        <option value="">-- None --</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Name of Credential<i class="text-danger">*</i> </label>
                                    <select id="ddlLicenseCertificate" class="form-control">
                                        <option value="">-- None --</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>License Number<i class="text-danger">*</i></label>
                                    <input type="text" id="txtLicenseNumber" class="form-control" maxlength="255" />
                                </div>
                            </div>
                        </div>


                    </div>

                    <div class="col-md-6 hide">
                        <div class="form-group">
                            <div class="form-label-group">
                                <label>GMP local & GMP Global  <i class="text-danger">*</i></label>
                                <input type="text" id="txtGMP" class="form-control" maxlength="255" autocomplete="off" />
                            </div>
                        </div>
                    </div>


                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Valid From  <i class="text-danger">*</i></label>
                                    <input type="text" id="txtValidFrom" class="form-control datepicker" maxlength="255" autocomplete="off" />
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Valid Till <i class="text-danger">*</i></label>
                                    <input type="text" id="txtValidTill" class="form-control datepicker" maxlength="15" autocomplete="off" />
                                </div>
                            </div>
                        </div>

                    </div>


                </div>
                <div class="modal-footer">

                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" id="btnSave" class="btn btn-info" onclick="saveCompanyCredentials();"><i class="glyphicon glyphicon-floppy-disk"></i> Save</button>
                    <button type="button" id="btnFinish" class="btn btn-success" style="display: none;" onclick="saveCompanyCredentials('finish');"><i class="glyphicon glyphicon-ok"></i> Finish</button>



                    <div class="row" id="divVariation">
                        <div class="col-md-12">
                            <hr />
                            <h4 class="pull-left">Variation</h4>
                            <a id="btnAddVariation" href="#" title="Add Variation" onclick="openVariationSPDailogBox(0)" class="btn btn-info btn-sm pull-right h5"><i class="glyphicon glyphicon-plus"></i>&nbsp;Add Variation</a>

                        </div>
                        <div class="col-md-12 text-left">

                            <table id="tblVariation" class="table table-striped small" style="width: 100%">
                                <thead class="alert alert-info h5">

                                    <tr>
                                        <th class="th-sm">
                                            #
                                        </th>
                                        <th class="th-sm">
                                            Variation Title
                                        </th>
                                        <th class="th-sm">
                                            Attachment Title
                                        </th>
                                        <th class="th-sm" align='center' style='text-align:center;'>
                                            Action
                                        </th>
                                    </tr>

                                </thead>

                                <tbody><tr><td colspan="6">No variation attachted!</td></tr></tbody>

                            </table>


                        </div>
                    </div>


                    <div class="row" id="divAttachment">
                        <div class="col-md-12">
                            <hr />
                            <h4 class="pull-left">Attachment</h4>
                            <a id="btnAddAttachment" href="#" title="Add Attachment" onclick="openAddAttachment(0)" class="btn btn-info btn-sm pull-right h5"><i class="glyphicon glyphicon-plus"></i>&nbsp;Add Attachment</a>

                            <a id="btnAddFolder" href="#" title="Add Folder" onclick="openFolderSPDialog()" class="btn btn-info btn-sm pull-right h5" style="margin-right: 8px;"><i class="glyphicon glyphicon-plus"></i>&nbsp;Add Folder</a>
                        </div>
                        <div class="col-md-12 text-left">

                            <table id="tblAttachment" class="table table-striped small" style="width: 100%">
                                <thead class="alert alert-info h5">

                                    <tr>
                                        <th class="th-sm">
                                            #
                                        </th>
                                        <th class="th-sm">
                                            Folder Name
                                        </th>
                                        <th class="th-sm">
                                            File Name
                                        </th>
                                        <th class="th-sm">
                                            Updated Date
                                        </th>
                                        <th class="th-sm">
                                            Updated By
                                        </th>
                                        <th class="th-sm" align='center' style='text-align:center;'>
                                            Action
                                        </th>
                                    </tr>

                                </thead>

                                <tbody><tr><td colspan="6">No attachment attachted!</td></tr></tbody>

                            </table>


                        </div>
                    </div>


                    <div class="row" id="divActionLogs" style="display:none;">
                        <div class="col-md-12  text-left">

                            <hr class="no-margin" />

                            <h4 class="pull-left">Action History</h4>

                            <div>

                                <table id="tblActionHistory" class="table table-striped small" style="width: 100%">
                                    <thead class="alert alert-info h5">
                                        <!--style="background-color: #336699; color: white"-->

                                        <tr>
                                            <th class="th-sm">
                                                Action On
                                            </th>
                                            <th style="text-align: left" class="th-sm">
                                                Action By
                                            </th>
                                            <th class="th-sm">
                                                Action Taken
                                            </th>
                                            <th class="th-sm" style="width:57%;">
                                                Comment
                                            </th>
                                        </tr>

                                    </thead>

                                    <tbody></tbody>

                                </table>

                            </div>


                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>
</div>
<!-- End Product Modal -->
<!-- Start Attachment Modal -->
<div class="modal fade" id="divModal-CompanyCredentialsAttachment" data-backdrop="static" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" id="mod_mesga">&times;</span>
                </button>
                <h2 class="modal-title">Add Attachment</h2>
            </div>
            <div class="modal-body">
                <input type='hidden' id='hid_CompanyCredentialsId' />

                <div>

                    <div class="row">

                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Folder<i class="text-danger hide">*</i></label>
                                    <select id="ddlFolders" class="form-control"></select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>File Attachment<i class="text-danger">*</i> </label>
                                    <input type="file" id="fileAttachedFiles" class="form-control" multiple="multiple" onchange="fileAttachedFiles_onChange(this)" />
                                </div>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <ol id="olSelectFiles" style="padding-left: 13px;"></ol>
                        </div>

                    </div>

                </div>


            </div>
            <div class="modal-footer">

                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" id="btnSave" class="btn btn-success" onclick="saveAttachment();"><i class="glyphicon glyphicon-floppy-disk"></i> Save Attachment</button>

            </div>
        </div>
    </div>


</div>
<!-- End Attachment Modal -->
<!-- Modal -->
<div class="modal fade" id="divModal-ShareDocument" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="width: 750px;right: 63px;">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" id="mod_mesga">&times;</span>
                </button>
                <h2 class="modal-title">Share Document</h2>

                <input type="hidden" id="hid_docid_shared" value="0" />

            </div>
            <div class="modal-body">
                <table id="tbluser" class="table table-striped" cellspacing="0" width="100%">
                    <thead class="alert alert-info h5">


                        <tr>
                            <th>
                                <input type="checkbox" class="chkHeader" id="chkhead" onclick="checkAll(this);" />
                            </th>

                            <th class="th-sm">
                                Name

                                <i class="fa fa-sort float-right" aria-hidden="true"></i>
                            </th>
                            <th class="th-sm">
                                User Type
                                <i class="fa fa-sort float-right" aria-hidden="true"></i>
                            </th>
                            <th class="th-sm">
                                Email
                                <i class="fa fa-sort float-right" aria-hidden="true"></i>
                            </th>

                            <th style="text-align: left" class="th-sm">
                                Status
                                <i class="fa fa-sort float-right" aria-hidden="true"></i>
                            </th>

                        </tr>

                    </thead>


                    <tbody></tbody>


                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" onclick="SharedDocWithuser();">Share</button>
            </div>
        </div>
    </div>

</div>

<!-- Modal View Document -->
<div class="modal fade" id="divModal_ViewDocument" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" id="mod_mesga">&times;</span>
                </button>
                <button type="button" class="close" onclick="min_max(this)">
                    <span><i class="glyphicon glyphicon-resize-horizontal"></i></span>
                </button>
                <h3 class="modal-title" id="h4NomenclatureTitle">File Title</h3>
            </div>
            <div class="modal-body">
                <div id="divfrmpdf"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>

            </div>
        </div>
    </div>
</div>
<!-- Modal View Document -->


<script type="text/javascript">

    var _needtoReopenthisWindow = null;
    var _modalItem = null;
    $(document).ready(function () {


        $('.datepicker').not(".hasDatepicker").datepicker({
            onSelect: function (dateText, datepickerObj) {
                console.log("Selected date: " + dateText + "; input's current value: " + this.value, datepickerObj);
            }
        });


        $('.date-picker-filter').datepicker({
            dateFormat: "d-M-yy",
            onSelect: function (dateText, datepickerObj) {
                console.log("Selected date: " + dateText + "; input's current value: " + this.value, datepickerObj);
                datepickerObj.input.trigger('change');
            }
        });

        bindCompanyCredentialsCompanyDDLs();


        $(".tag-input").chosen({
            width: "100%"
        });

        var record_ID = 0;
        try {
            record_ID = $("#hid_ID").val();
        } catch (a) { }



        if (havePremission(Permission.UPLOAD, Module.CompanyCredentials) == true) {
            $("#btnAddCompanyCredentials").show();
        }


        bindCompanyCredentialsTable(record_ID);

        bindShareDocumentUsers();


        $('.modal').on('hidden.bs.modal', function (e) {
            //setTimeout(function () {
            if ($(".modal:visible").length > 0) {
                _modalItem = $(".modal:visible").last();
                _modalItem.removeClass('fade');
                _modalItem.modal('hide');
            } else {
                if (_modalItem && _modalItem.length > 0) {
                    _modalItem.modal('show');
                    _modalItem.addClass('fade');
                    $(".modal-backdrop").addClass('fade');
                    _modalItem = null;
                }
            }

            if (_needtoReopenthisWindow != null) {
                _needtoReopenthisWindow.modal('show');
                _needtoReopenthisWindow = null;
            }

            //}, 100);
        });


    });



    var tblCompanyCredentialsDataTable = null;
    function bindCompanyCredentialsTable(_id) {
        // Specify the Id of the Item that you want to fetch

        if ($('#tblCompanyCredentials').hasClass("dataTable") == true) {
            $('#tblCompanyCredentials').DataTable().destroy();
        }
        $('#tblCompanyCredentials>tbody').html('');

        $('#tblCompanyCredentials').after(partialLoader);

        var idFilter = ""; //"IsDeleted eq 0"; //"IsActive eq 1";
        if (Number(_id) > 0) {
            idFilter = "Id eq " + _id;
        }


        var filterProducts = idFilter + "&$top=5000&$select=ID,Title," +
            "ValidFromDate," +
            "ValidTillDate," +
            "LicenseNumber," +
            "Status," +
            "CompanyLookup/Id,CompanyLookup/Title," +
            "ManufacturingSiteLookup/Id,ManufacturingSiteLookup/Title," +
            "LicenseTypeLookup/Id,LicenseTypeLookup/Title,LicenseCertificateLookup/Id,LicenseCertificateLookup/Title," +
            "CountryLookup/Id,CountryLookup/Title,Created,Modified" +
            "&$expand=CompanyLookup,CountryLookup,LicenseTypeLookup,LicenseCertificateLookup,ManufacturingSiteLookup&$orderby=Modified desc";

        GetSPListItems("CompanyCredentials", 0, filterProducts)
            .done(function (data) {

                var response = data.d.results;
                for (var i = 0; i < response.length ; i++) {

                    var _item = response[i];

                    if (havePremission(Permission.VIEW, Module.CompanyCredentials, _item["CountryLookup"].Id) == true) {
                        /*var _statusText = 'In-Active';

                        if (_item.IsActive)
                            _statusText = (_item.IsActive == true ? 'Active' : 'In-Active');
                            */

                        var newRow = "<tr id='" + _item["ID"] + "'>" +
                            "<td class='Col-ProductId'>-" + _item["ID"] + "-</td>" +
                            "<td class='Col-ProductModified'>-" + getDataTableSortableDateTime(_item["Modified"]) + _item["Modified"] + "-</td>" +
                            "<td class='Col-ProductName'>" + ((_item["CompanyLookup"]) ? _item["CompanyLookup"].Title : "") + "</td>" +
                            "<td>" + ((_item["CountryLookup"]) ? _item["CountryLookup"].Title : "") + "</td>" +
                            "<td>" + ((_item["LicenseTypeLookup"]) ? _item["LicenseTypeLookup"].Title : "") + "</td>" +
                            "<td>" + ((_item["LicenseCertificateLookup"]) ? _item["LicenseCertificateLookup"].Title : "") + "</td>" +
                            "<td>" + ((_item["LicenseNumber"]) ? _item["LicenseNumber"] : "-") + "</td>" +
                            "<td>" + ((_item["ManufacturingSiteLookup"]) ? _item["ManufacturingSiteLookup"].Title : "") + "</td>" +
                            "<td>" + toDisplayDate(_item["ValidFromDate"]) + "</td>" +
                            "<td>" + toDisplayDate(_item["ValidTillDate"]) + "</td>" +
                            "<td>" + _item["Status"] + "</td>";

                        var _actionButtonHTML = createActionDropdown(_item);

                        newRow = newRow + "<td align='center' style='text-align:center;'>" + _actionButtonHTML + "</td>";
                        newRow = newRow + "</tr>";

                        $('#tblCompanyCredentials>tbody').append(newRow);


                        getAttachmentCount(_item["ID"]);
                    }
                }

                if ($('#tblCompanyCredentials>tbody').find('tr').length == 0) {
                    $('#tblCompanyCredentials>tbody').html('<tr><td colspan="11">No company credentials found!</td></tr>');
                }

                $('#tblCompanyCredentials').on('draw.dt', function () {
                    $(".dataTables_filter").find('input').addClass('form-control input-sm');
                    $(".dataTables_filter").addClass('hide');

                });
                tblCompanyCredentialsDataTable = $("#tblCompanyCredentials").DataTable({
                    "order": [[1, "desc"]]
                });

                tblCompanyCredentialsDataTable.column(0).visible(false);
                tblCompanyCredentialsDataTable.column(1).visible(false);


                $('#tblCompanyCredentials' + '_wrapper').parents().eq(0).find('.partial-loader').remove();

                openCompanyCredentialsFromURL();

                notificationMarkAsSeen();
            });

    }

    function createActionDropdown(_item) {

        var buttonAttr = "";

        var _actionBtnHtml = "<div class='btn-group'>";
        _actionBtnHtml += "  <button type='button' class='btn btn-primary dropdown-toggle' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false' " + buttonAttr + ">        ";
        _actionBtnHtml += "    Action <span class='caret'></span>";
        _actionBtnHtml += "  </button>";
        _actionBtnHtml += "  <ul class='dropdown-menu dropdown-menu-right'>";


        _actionBtnHtml += "    <li class=''><a href='#' id='awf'  onclick='openCompanyCredentialsDetails(" + _item.Id + ",\"view\")' ><i class='glyphicon glyphicon-list-alt'></i>&nbsp;View</a></li>";

        //if (havePremission(Permission.UPLOAD, Module.CompanyCredentials, _item["CountryLookup"].Id) == true) {

        if (_item.Status == "Draft" || _item.Status == "On Hold" || _item.Status == "Send Back") {

            if (havePremission(Permission.UPLOAD, Module.CompanyCredentials, Number(_item.CountryLookup.Id)) == true) {
                _actionBtnHtml += "    <li class=''><a href='#' id='awf'  onclick='openCompanyCredentialsDetails(" + _item.Id + ",\"edit\")' ><i class='glyphicon glyphicon-edit'></i>&nbsp;Edit</a></li>";
            }
        }

        if (_item.Status == "Draft" || _item.Status == "On Hold") {

            if (havePremission(Permission.UPLOAD, Module.CompanyCredentials, Number(_item.CountryLookup.Id)) == true) {
                _actionBtnHtml += "    <li class=''><a href='#' id='awf'  onclick='deleteCompanyCredentials(" + _item.Id + ",\"delete\")' ><i class='glyphicon glyphicon-trash'></i>&nbsp;Delete</a></li>";
            }
        }

        if (_item.Status == "Approved") {
            if (havePremission(Permission.UPLOAD, Module.CompanyCredentials, Number(_item.CountryLookup.Id)) == true) {
                _actionBtnHtml = _actionBtnHtml + "    <li class=''><a href='#' id='awcn'  onclick='openCompanyCredentialsDetails(" + _item.Id + ",\"new\")' ><i class='glyphicon glyphicon-plus'></i>&nbsp;Add New Company Credentials</a></li>";
            }
        }

        //}

        _actionBtnHtml += "  </ul>";
        _actionBtnHtml += "</div>";



        return _actionBtnHtml;
    }


    function getAttachmentCount(_artworkId) {

        if (Number(_artworkId) > 0) {


            var idFilter = "CompanyCredentialLookupId eq " + _artworkId;

            var filterProducts = idFilter + "&$select=Id,Title,FileName,CompanyCredentialLookupId";

            GetSPListItems("CompanyCredentialsAttachment", 0, filterProducts)
                .done(function (data2) {

                    var response2 = data2.d.results;

                    if (response2.length > 0) {
                        var _countHTML = "&nbsp;<span class='badge'>" + response2.length + "</span>";
                        $('#tblCompanyCredentials>tbody').find("tr[id='" + response2[0].CompanyCredentialLookupId + "']").find('.Col-ProductName').append(_countHTML);
                    }

                });
        }
    }


    function openCompanyCredentialsFromURL() {
        var _recordId = 0;

        //GetUrlKeyValue('rid')
        //_recordId = GetQueryString('rid');


        _recordId = localStorage.getItem("CredentialsIdForView");

        if (Number(_recordId) > 0) {
            openCompanyCredentialsDetails(_recordId, 'view');
            localStorage.removeItem("CredentialsIdForView");
        }
    }

    function openCompanyCredentialsDetails(_id, _mode) {

        var modalWindow = $("#divModal-CompanyCredentialsDetails");


        modalWindow.find(".modal-title").text('Create Company Credentials');

        // reset All controls
        modalWindow.find("select,input[type='text'],textarea,input[type='hidden']").val('');
        modalWindow.find(".is-invalid").removeClass("is-invalid");

        if (_mode == 'view') {
            modalWindow.find(".modal-title").text('View Company Credentials');
            modalWindow.find("#btnSave,#btnFinish").hide();
            modalWindow.find('input,select,textarea').prop('disabled', true);

            $("#btnAddVariation,#btnAddFolder,#btnAddAttachment").hide();
            modalWindow.find("#divVariation,#divAttachment,#divActionLogs").show();
        }
        else if (_mode == 'edit') {
            if (havePremission(Permission.UPLOAD, Module.CompanyCredentials) == true) {
                modalWindow.find(".modal-title").text('Edit Company Credentials');
                modalWindow.find("#btnSave,#btnFinish").show();
                modalWindow.find('input,select,textarea').not("#txtGeneric,#txtStrength,#ddlDosageType").prop('disabled', false);

                $("#btnAddVariation,#btnAddFolder,#btnAddAttachment").show();
                modalWindow.find("#divVariation,#divAttachment,#divActionLogs").show();
            }
        }
        else if (_mode == 'new') {
            if (havePremission(Permission.UPLOAD, Module.CompanyCredentials) == true) {
                modalWindow.find(".modal-title").text('Add New Company Credentials');
                modalWindow.find("#btnSave").show();
                modalWindow.find("#btnFinish").hide();
                //modalWindow.find('input,select,textarea').not("#txtGeneric,#txtStrength,#ddlDosageType").prop('disabled', false); // it could be amended
                modalWindow.find('input,select,textarea').prop('disabled', false);


                $("#btnAddVariation,#btnAddFolder,#btnAddAttachment").hide();
                modalWindow.find("#divVariation,#divAttachment,#divActionLogs").hide();
            }
        }
        else {

            if (havePremission(Permission.UPLOAD, Module.CompanyCredentials) == true) {
                modalWindow.find(".modal-title").text('Create Company Credentials');
                modalWindow.find("#btnSave").show();
                modalWindow.find("#btnFinish").hide();
                modalWindow.find('input,select,textarea').not("#txtGeneric,#txtStrength,#ddlDosageType").prop('disabled', false);

                modalWindow.find("#divVariation,#divAttachment,#divActionLogs").hide();
            }
        }
        modalWindow.find('#ddlManufacturingSite').trigger('chosen:updated');

        if (_id && Number(_id) > 0) {

            modalWindow.find('#hid_ID').val(_id);


            GetSPListItems("CompanyCredentials", _id, '')
                .done(function (data) {

                    var _item = data.d;
                    if (_item) {

                        modalWindow.find('#hid_CompanyCredentialsId').val(_item.Id);

                        modalWindow.find('#ddlCompany').val(_item.CompanyLookupId);
                        modalWindow.find('#ddlCountry').val(_item.CountryLookupId);

                        modalWindow.find('#ddlLicenseType').val(_item.LicenseTypeLookupId);
                        modalWindow.find('#ddlLicenseCertificate').val(_item.LicenseCertificateLookupId);
                        modalWindow.find('#txtLicenseNumber').val(_item.LicenseNumber);
                        modalWindow.find('#txtGMP').val(_item.GMP);

                        modalWindow.find('#txtValidFrom').datepicker('setDate', parseISOString(_item.ValidFromDate));
                        modalWindow.find('#txtValidTill').datepicker('setDate', parseISOString(_item.ValidTillDate));

                        var manufactureSitesIds = "";

                        if (_item.ManufacturingSiteLookupId) {
                            manufactureSitesIds = _item.ManufacturingSiteLookupId;
                        }
                        modalWindow.find('#ddlManufacturingSite').val(manufactureSitesIds).trigger('chosen:updated');


                        if (_mode == 'new') {

                            modalWindow.find('#hid_CompanyCredentialsId').val('');
                            $("#hid_ID").val('');
                        } else {

                            if (havePremission(Permission.UPLOAD, Module.CompanyCredentials) == false) {
                                $("#btnAddVariation,#btnAddFolder,#btnAddAttachment").hide();
                            }


                            bindVariation(_item.Id, _mode);

                            bindAttachment(_item.Id, _mode);


                            bindActionHistory(_item.Id);
                        }

                    }

                    modalWindow.modal('show');

                });

        } else {

            modalWindow.find('#hid_ID').val("0");
            modalWindow.modal('show');
        }
    }



    function bindCompanyCredentialsCompanyDDLs() {

        $("#ddlCompany,#ddlCountry,#ddlManufacturingSite").find('option').remove();
        $("#ddlCompany,#ddlCountry,#ddlManufacturingSite").append("<option value=''> -- None -- </option>");

        var isActiveFilter = ""; //"IsActive eq '1'";

        GetSPListItems("Companies", 0, isActiveFilter)
            .done(function (data) {
                try {

                    if (data && data.d && data.d.results.length > 0) {
                        for (var _u = 0 ; _u < data.d.results.length; _u++) {
                            var _thisUserItem = data.d.results[_u];
                            var newOPtion = "<option value='" + _thisUserItem.Id + "'>" + _thisUserItem.Title + "</option>";
                            $("#ddlCompany").append(newOPtion);
                        }
                    }

                } catch (ex) { console.log(ex); }
            });

        GetSPListItems("Countries", 0, isActiveFilter)
            .done(function (data) {
                try {

                    if (data && data.d && data.d.results.length > 0) {
                        for (var _u = 0 ; _u < data.d.results.length; _u++) {
                            var _thisUserItem = data.d.results[_u];

                            if (havePremission(Permission.UPLOAD, Module.CompanyCredentials, _thisUserItem.Id) == true) {
                                var newOPtion = "<option value='" + _thisUserItem.Id + "'>" + _thisUserItem.Title + "</option>";
                                $("#ddlCountry").append(newOPtion);
                            }
                            else if (havePremission(Permission.VIEW, Module.CompanyCredentials, _thisUserItem.Id) == true) {

                                var newOPtion = "<option value='" + _thisUserItem.Id + "'disabled='disabled'>" + _thisUserItem.Title + "</option>";
                                $("#ddlCountry").append(newOPtion);
                            }

                        }
                    }

                } catch (ex) { console.log(ex); }
            });



        GetSPListItems("LicenseType", 0, isActiveFilter)
            .done(function (data) {
                try {

                    if (data && data.d && data.d.results.length > 0) {
                        for (var _u = 0 ; _u < data.d.results.length; _u++) {
                            var _thisUserItem = data.d.results[_u];
                            var newOPtion = "<option value='" + _thisUserItem.Id + "'>" + _thisUserItem.Title + "</option>";
                            $("#ddlLicenseType").append(newOPtion);
                        }
                    }

                } catch (ex) { console.log(ex); }
            });


        GetSPListItems("LicenseCertificate", 0, isActiveFilter)
            .done(function (data) {
                try {

                    if (data && data.d && data.d.results.length > 0) {
                        for (var _u = 0 ; _u < data.d.results.length; _u++) {
                            var _thisUserItem = data.d.results[_u];
                            var newOPtion = "<option value='" + _thisUserItem.Id + "'>" + _thisUserItem.Title + "</option>";
                            $("#ddlLicenseCertificate").append(newOPtion);
                        }
                    }

                } catch (ex) { console.log(ex); }
            });


        GetSPListItems("ManufacturingSites", 0, isActiveFilter)
            .done(function (data) {
                try {

                    if (data && data.d && data.d.results.length > 0) {
                        for (var _u = 0 ; _u < data.d.results.length; _u++) {
                            var _thisUserItem = data.d.results[_u];
                            var newOPtion = "<option value='" + _thisUserItem.Id + "'>" + _thisUserItem.Title + "</option>";
                            $("#ddlManufacturingSite").append(newOPtion);
                        }
                    }

                } catch (ex) { console.log(ex); }
            });
    }


    function SearchCol(_index) {
        var tableSelector = '#tblCompanyCredentials';
        var table = $(tableSelector);
        var datatable = $(tableSelector).DataTable();

        table.find('th input,th select').each(function () {
            var index = $(this).parents('th').data("column");
            var searchByValue = $(this).val();
            var isExpression = false;

            if (index > -1) {
                datatable.column(index).search(searchByValue);
            }
        });

        datatable.draw();
    }

</script>


<script type="text/javascript">

    function saveCompanyCredentials(_action) {

        var isValid = true;

        var modalWindow = $("#divModal-CompanyCredentialsDetails");


        modalWindow.find('.is-invalid').removeClass("is-invalid");

        if ((modalWindow.find("#ddlCompany").val().length > 0) == false) {
            isValid = false;
            modalWindow.find("#ddlCompany").addClass("is-invalid");
        }
        if ((modalWindow.find("#ddlCountry").val().length > 0) == false) {
            isValid = false;
            modalWindow.find("#ddlCountry").addClass("is-invalid");
        }

        if ((modalWindow.find("#ddlLicenseType").val().length > 0) == false) {
            isValid = false;
            modalWindow.find("#ddlLicenseType").addClass("is-invalid");
        }
        if ((modalWindow.find("#ddlLicenseCertificate").val().length > 0) == false) {
            isValid = false;
            modalWindow.find("#ddlLicenseCertificate").addClass("is-invalid");
        }
        if ((modalWindow.find("#txtLicenseNumber").val().length > 0) == false) {
            isValid = false;
            modalWindow.find("#txtLicenseNumber").addClass("is-invalid");
        }
        if ((modalWindow.find("#ddlManufacturingSite").val().length > 0) == false) {
            isValid = false;
            modalWindow.find("#ddlManufacturingSite,#ddlManufacturingSite_chosen").addClass("is-invalid");
        }

        /*
        if ((modalWindow.find("#txtGMP").val().length > 0) == false) {
            isValid = false;
            modalWindow.find("#txtGMP").addClass("is-invalid");
        }*/
        if ((modalWindow.find("#txtValidFrom").val().length > 0) == false) {
            isValid = false;
            modalWindow.find("#txtValidFrom").addClass("is-invalid");
        }
        if ((modalWindow.find("#txtValidTill").val().length > 0) == false) {
            isValid = false;
            modalWindow.find("#txtValidTill").addClass("is-invalid");
        }


        if (isValid == true) {

           // RequestStarted();

            var _recordID = $("#hid_ID").val();

            var _productId = modalWindow.find('#ddlProduct').val();

            var manufactureSitesId = modalWindow.find('#ddlManufacturingSite').val();


            var jsonData = {
                CompanyLookupId: modalWindow.find("#ddlCompany").val(),
                CountryLookupId: modalWindow.find("#ddlCountry").val(),
                LicenseTypeLookupId: modalWindow.find("#ddlLicenseType").val(),
                LicenseCertificateLookupId: modalWindow.find("#ddlLicenseCertificate").val(),
                LicenseNumber: modalWindow.find('#txtLicenseNumber').val(),
                ManufacturingSiteLookupId: manufactureSitesId,
                // GMP: modalWindow.find('#txtGMP').val(),
                ValidFromDate: modalWindow.find('#txtValidFrom').datepicker('getDate'),
                ValidTillDate: modalWindow.find('#txtValidTill').datepicker('getDate'),
                Status: 'On Hold'
            }

            if (_action == 'finish') {
                jsonData.Status = 'Pending';
            }

            if (Number(_recordID) > 0) {

                UpdateSPList("CompanyCredentials", _recordID, jsonData).done(function (data) {

                    saveActionLog(_recordID, "Edit", jsonData.Status, Module.CompanyCredentials);

                    sendNotification();

                    alert('Company Credentials has been edit successfully');
                    // Retrive Nomenclatures newly Added

                    bindCompanyCredentialsTable();

                    $("#divModal-CompanyCredentialsDetails").modal('hide');

                    RequestEnded();

                }).fail(function (jqXHR, textStatus) {

                    alert("CompanyCredentials Saving Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                    RequestEnded();
                });

            }
            else {

                InsertIntoSPList('CompanyCredentials', jsonData).done(function (data) {
                    //console.log(data.d.results);
                    if (Number(data.d.ID) > 0) {

                        saveActionLog(data.d.ID, "Created", data.d.Status, Module.CompanyCredentials);

                        //sendNotification();

                        openCompanyCredentialsDetails(data.d.ID, "edit");

                        alert('Company Credentials has been added successfully');

                        bindCompanyCredentialsTable();

                        //$("#divModal-CompanyCredentialsDetails").modal('hide');

                        RequestEnded();
                    }

                }).fail(function (jqXHR, textStatus) {

                    alert("CompanyCredentials Saving Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                    RequestEnded();
                });
            }

        }
        else {
            alert("Please fill highlighted fields first!");
        }
    }


    function deleteCompanyCredentials(_recordID) {

        var _confirmResult = confirm("Are you sure you want to delete this CompanyCredentials?");
        if (_confirmResult == true) {

            GetSPListItems("CompanyCredentials", _recordID, '').done(function (data) {

                if (data && data.d) {
                    deleteItem("CompanyCredentials", data.d).done(function (data) {
                        alert('CompanyCredentials has been deleted successfully');

                        //var _hid_ProductId = $("#divModal-LotReleased").find('#hid_ID').val();
                        bindCompanyCredentialsTable();

                        RequestEnded();
                    });
                }

            }).fail(function (jqXHR, textStatus) {

                alert("CompanyCredentials Deleting Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                RequestEnded();
            });
        }

    }

</script>





<script type="text/javascript">


    function openAddAttachment(_id) {

        var modalWindow = $("#divModal-CompanyCredentialsAttachment");

        var _CompanyCredentialsId = $("#divModal-CompanyCredentialsDetails").find('#hid_ID').val();

        // reset All controls
        modalWindow.find("select,input[type='text'],input[type='hidden']").val('');
        modalWindow.find(".is-invalid").removeClass("is-invalid");
        modalWindow.find('#hid_CompanyCredentialsId').val(_CompanyCredentialsId);
        modalWindow.find('#ddlFolders').find('option').remove();

        if (_CompanyCredentialsId && Number(_CompanyCredentialsId) > 0) {

            var folderFilter = "CompanyCredentialsLookupId eq " + _CompanyCredentialsId
            GetSPListItems("CompanyCredentialsFolders", 0, folderFilter)
                .done(function (folderData) {

                    modalWindow.find('#ddlFolders').append("<option value=''>" + " -- Select -- " + "</option>");

                    if (folderData && folderData.d && folderData.d.results && folderData.d.results.length > 0) {

                        folderData.d.results.forEach(function (_item) {
                            var _optionfolderhtml = "<option value='" + _item.Id + "'>" + _item.Title + "</option>";

                            modalWindow.find('#ddlFolders').append(_optionfolderhtml);
                        });

                        //modalWindow.modal('show');

                        //_needtoReopenthisWindow = $("#divModal-CompanyCredentialsDetails");
                    } else {
                        //alert("No folder available for this CompanyCredentials!");
                    }


                    modalWindow.modal('show');

                    _needtoReopenthisWindow = $("#divModal-CompanyCredentialsDetails");

                });

        }
    }

    function openFolderSPDialog() {

        var _CompanyCredentialsId = $("#divModal-CompanyCredentialsDetails").find('#hid_ID').val();
        var queryString = "ccid=" + _CompanyCredentialsId;
        var source = window.location.href;
        var sucMsg = "New Folder has been added successfully.";
        openNewItemDialog('CompanyCredentialsFolders', 'Add Folder', source, queryString, sucMsg, 650, false);

    }

    function bindAttachment(_CompanyCredentialsId, mode) {

        if (Number(_CompanyCredentialsId) > 0) {

            // Specify the Id of the Item that you want to fetch
            $('#tblAttachment>tbody').html('<tr><td colspan="6">No attachment attachted!</td></tr>');


            $('#tblAttachment').after(partialLoader);

            var idFilter = "CompanyCredentialLookupId eq " + _CompanyCredentialsId;


            var filterQuery = idFilter + "&$select=ID,Title,FileName,Created,CompanyCredentialLookup/Id,CompanyCredentialLookup/Title,FolderLookup/Id,FolderLookup/Title,Author/Id,Author/Title&$expand=CompanyCredentialLookup,FolderLookup,Author";

            GetSPListItems("CompanyCredentialsAttachment", 0, filterQuery)
                .done(function (data) {

                    var response = data.d.results;

                    if (response.length > 0) {
                        $('#tblAttachment>tbody').html('');
                    }

                    for (var i = 0; i < response.length ; i++) {

                        var _item = response[i];


                        var _FilePreviewOption = "<a  href='#' class='alert-link' onclick='viewDocument(" + _item.Id + ",\"" + _item.FileName + "\");' title='Preview'  ><i class='glyphicon glyphicon-file'></i> " + _item["FileName"] + "</a>";



                        var newRow = "<tr id='" + _item["ID"] + "'>" +

                            "<td>" + (i + 1) + "</td>" +
                            "<td>" + ((_item["FolderLookup"] && _item["FolderLookup"].Title && _item["FolderLookup"].Title.length > 0) ? "<i class='glyphicon glyphicon-folder-open' style='color:#f0ad4e;margin-right: 8px;'></i> " + _item["FolderLookup"].Title : "") + "</td>" +
                            "<td>" + _FilePreviewOption + "</td>" +
                            "<td>" + toDisplayDate(_item["Created"]) + "</td>" +
                            "<td>" + toDisplayName(_item["Author"].Title) + "</td>";

                        var _actionButtonHTML = "";



                        if (havePremission(Permission.DOWNLOAD, Module.CompanyCredentials, $("#divModal-CompanyCredentialsDetails").find("#ddlCountry").val()) == true) {
                            _actionButtonHTML = _actionButtonHTML + "<a href='#'  title='Download'  onclick='downloadDocument(" + _item.Id + ")' class='m-5' ><i class='glyphicon glyphicon-download'></i></a>";
                        }
                        if (mode != 'view' && havePremission(Permission.UPLOAD, Module.CompanyCredentials, $("#divModal-CompanyCredentialsDetails").find("#ddlCountry").val()) == true) {
                            _actionButtonHTML = _actionButtonHTML + "&nbsp;<a href='#'  title='Delete'  onclick='deleteCompanyCredentialsAttachment(" + _item.Id + ")' ><i class='glyphicon glyphicon-trash'></i></a>"
                        }
                        if (mode != 'view' && havePremission(Permission.Share, Module.CompanyCredentials, $("#divModal-CompanyCredentialsDetails").find("#ddlCountry").val()) == true) {
                            _actionButtonHTML = _actionButtonHTML + "&nbsp;<a id='btnShareIt_" + _item.Id + "' href='#' onclick=\"openShareWindow(" + _item.Id + "," + _item.Id + ",'" + _item["FileName"] + "');\"  title='Share'><i class='glyphicon glyphicon-share'></i></a> ";
                        }




                        newRow = newRow + "<td align='center' style='text-align:center;' class='h5'>" + _actionButtonHTML + "</td>";
                        newRow = newRow + "</tr>";

                        $('#tblAttachment>tbody').append(newRow);

                    }

                    $('#tblAttachment' + '').parents().eq(0).find('.partial-loader').remove();

                });
        }
    }



    function viewDocument(_fileId, _FileTitle) {
        if (Number(_fileId) > 0) {

            //jQuery.noConflict();
            $('#divModal_ViewDocument').find("#h4NomenclatureTitle").text(_FileTitle);
            $('#divModal_ViewDocument').find("#frmpdf").remove();


            //$("#divModal_ViewAllAttachements").removeClass('fade');
            //$("#divModal_ViewAllAttachements").modal('hide');
            //setTimeout(function () {
            //    _needtoReopenthisWindow = $("#divModal_ViewAllAttachements");

            //}, 500);

            //$('#divModal_ViewDocument').find("#frmpdf").get(0).src = "";
            //$('#divModal_ViewDocument').find("#frmpdf").get(0).style.display = "none";

            //setTimeout(function () { },0);

            var listName = 'CompanyCredentialsAttachment';
            var apiURL = _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('" + listName + "')/items/GetById(" + _fileId + ")/file";

            $.ajax({
                url: apiURL,
                type: "GET",
                headers: {
                    "Accept": "application/json; odata=verbose",
                },
                success: function (dataFileInfo) {

                    if (dataFileInfo.d) {

                        var fileURL = location.origin + dataFileInfo.d.ServerRelativeUrl;
                        window.open(fileURL, '_blank');

                        /*
                        if (fileURL.search('.docx') > 0) {
                            downloadFunction(fileURL);
                            alert("File has been downloaded!");
                        }
                        else {
                            //document.getElementById("frmpdf").style.display = "block";
                            //document.getElementById("frmpdf").src = fileURL;

                            var _iframe = document.createElement("iframe");
                            _iframe.id = "frmpdf";
                            _iframe.src = fileURL;
                            _iframe.width = "100%";
                            _iframe.height = "700px";

                            var element = document.getElementById("divfrmpdf");
                            element.appendChild(_iframe);


                            jQuery.noConflict();
                            jQuery('#divModal_ViewDocument').modal('show');
                        }*/
                    }
                },
                error: function (error) {
                    console.log("Error on getting file info", error);

                    RequestEnded();
                }
            });
        }
        else {
            alert("No document found!");
        }

    }


    function bindActionHistory(_productId) {
        // Specify the Id of the Item that you want to fetch
        $('#tblActionHistory>tbody').html('');

        $('#tblActionHistory').after(partialLoader);
        if (Number(_productId) > 0) {
            var filterNomenclature = "CredentialLookupId eq " + _productId + " and Module eq '" + Module.CompanyCredentials + "'&$select=ID,Title,ActionName,Comments,Created,Author/Title&$expand=Author&$orderby=Id desc";
            GetSPListItems("ActionLogs", 0, filterNomenclature)
                .done(function (data) {
                    var response = data.d.results;
                    for (var i = 0; i < response.length ; i++) {
                        var _item = response[i];

                        var newRow = "<tr id='" + _item["ID"] + "'>" +
                            "<td>" + toDisplayDateTime(_item["Created"]) + "</td>" +
                            "<td>" + toDisplayName(_item["Author"].Title) + "</td>" +
                            "<td>" + _item["ActionName"] + "</td>" +
                            "<td>" + (_item["Comments"] == null ? "" : _item["Comments"]) + "</td>" +
                            "</tr>";

                        $('#tblActionHistory>tbody').append(newRow);
                        $('#divActionLogs').show();

                    }

                    $('#tblActionHistory' + '').parents().eq(0).find('.partial-loader').remove();
                });
        }
    }

</script>



<script type="text/javascript">


    function openEditVariationSPDailogBox(_id, _mode) {
        var queryString = _mode.length > 0 ? ("pagemode=" + _mode) : "";
        var title = "Edit Variation";
        var sucMsg = "Variation has been edit successfully.";


        openEditItemDialog('CompanyCredentialsVariation', _id, title, queryString, sucMsg, false, _dialogReturnValueCallback);


        setTimeout(function () { spdailogpositionsetter() }, 1000);
    }

    function openVariationSPDailogBox(_thisButton) {
        var _CompanyCredentialsId = $("#divModal-CompanyCredentialsDetails").find('#hid_ID').val();
        var queryString = "ccid=" + _CompanyCredentialsId;
        var source = window.location.href;
        var sucMsg = "New Variation has been added successfully.";

        openNewItemDialog('CompanyCredentialsVariation', 'Add Variation', source, queryString, sucMsg, 650, false, _dialogReturnValueCallback);

        setTimeout(function () { spdailogpositionsetter() }, 1000);

    }
    function _dialogReturnValueCallback(dialogResult, returnValue) {
        if (dialogResult == 1) {
            //if ((typeof (_dialogReturnValueCallback) == "function")) { _dialogReturnValueCallback(); _dialogReturnValueCallback = null; }

            var _CompanyCredentialsId = $("#divModal-CompanyCredentialsDetails").find('#hid_ID').val();
            bindVariation(_CompanyCredentialsId, 'Edit')
        }
    }

    function bindVariation(_CompanyCredentialsId, mode) {

        if (Number(_CompanyCredentialsId) > 0) {

            // Specify the Id of the Item that you want to fetch
            $('#tblVariation>tbody').html('<tr><td colspan="4">No variation attachted!</td></tr>');

            $('#tblVariation').after(partialLoader);

            var idFilter = "CompanyCredentialLookupId eq " + _CompanyCredentialsId;


            var filterQuery = idFilter + "&$select=ID,Title,CompanyCredentialLookup/Id,CompanyCredentialLookup/Title,Author/Id,Author/Title&$expand=CompanyCredentialLookup,Author";

            GetSPListItems("CompanyCredentialsVariation", 0, filterQuery)
                .done(function (data) {

                    var response = data.d.results;

                    if (response.length > 0) {
                        $('#tblVariation>tbody').html('');
                    }

                    for (var i = 0; i < response.length ; i++) {

                        var _item = response[i];

                        var newRow = "<tr id='" + _item["ID"] + "'>" +

                            "<td>" + (i + 1) + "</td>" +
                            "<td>" + _item.Title + "</td>" +
                            "<td><ol style='padding-left: 12px;'>" + "</ol></td>";
                        //"<td>" + toDisplayDate(_item["Created"]) + "</td>";

                        var _actionButtonHTML = "";


                        if (mode != 'view' && havePremission(Permission.UPLOAD, Module.CompanyCredentials, $("#divModal-CompanyCredentialsDetails").find("#ddlCountry").val()) == true) {

                            _actionButtonHTML += "<a href='#'  title='Delete'  onclick='deleteVariation(" + _item.Id + ")' ><i class='glyphicon glyphicon-trash'></i></a>";
                            _actionButtonHTML += "&nbsp;<a id='btnVariation_" + _item.Id + "' href='#' onclick=\"openEditVariationSPDailogBox(" + _item.Id + ",'edit');\"  title='Edit'><i class='glyphicon glyphicon-edit'></i></a> ";

                        }


                        newRow = newRow + "<td align='center' style='text-align:center;' class='h5'>" + _actionButtonHTML + "</td>";
                        newRow = newRow + "</tr>";

                        $('#tblVariation>tbody').append(newRow);


                        bindAttachmentsInItem("CompanyCredentialsVariation", _item.Id);

                    }

                    $('#tblVariation' + '').parents().eq(0).find('.partial-loader').remove();

                });
        }
    }


    function deleteVariation(_recordID) {

        var _confirmResult = confirm("Are you sure you want to delete this attachment?");
        if (_confirmResult == true) {

            GetSPListItems("CompanyCredentialsVariation", _recordID, '').done(function (data) {

                if (data && data.d) {
                    deleteItem("CompanyCredentialsVariation", data.d).done(function (data) {
                        alert('Attachment has been deleted successfully');


                        var _recordId = $("#divModal-CompanyCredentialsDetails").find('#hid_ID').val();

                        bindVariation(_recordId, 'Edit');

                        RequestEnded();
                    });
                }

            }).fail(function (jqXHR, textStatus) {

                alert("Company Variation Deleting Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                RequestEnded();
            });
        }

    }



    function bindAttachmentsInItem(listName, id) {

        var apiURL = _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('" + listName + "')/items(" + id + ")/AttachmentFiles?pqid=" + id;

        $.ajax({
            url: apiURL,
            type: "GET",
            async: true,
            headers: {
                "Accept": "application/json; odata=verbose",
            },
            success: function (data) {
                var attachmentResponse = data.d.results;
                if (attachmentResponse.length > 0) {
                    var _queryId = attachmentResponse[0].__metadata.id.split('/Items(');
                    //"https:/ /iblgrouppk.sharepoint.com/sites/SearimsTest/_api/Web/Lists(guid'1dd329a2-9da8-469f-9148-8e5cd670a032')/Items(1)/AttachmentFiles('OBS Test 6-16-7-32.pdf')".substr(110)


                    _queryId = _queryId[1].substring(0, _queryId[1].indexOf(')'));

                    var _queryRow = $('#tblVariation>tbody').find("tr[id='" + _queryId + "']");

                    for (var i = 0; i < attachmentResponse.length ; i++) {

                        var _filesHTML = "<li><a href=\"" + attachmentResponse[i].ServerRelativeUrl + "\" target='_blank' >" + attachmentResponse[i].FileName + "</a></li>";
                        //var _filesHTML = "<li>" + attachmentResponse[i].FileName + "</li>";


                        _queryRow.find('ol').append(_filesHTML);

                    }
                }
            },
            error: function (error) {
            }
        });

    }



    function spdailogpositionsetter() {


        var observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutationRecord) {
                setTimeout(function () {
                    console.log('style changed!');
                    $("body").css('position', 'fixed');
                    setTimeout(function () {
                        $("body").css('position', '');
                    }, 00);
                }, 00);
            });
        });

        var target = $(".ms-dlgContent").get(0);
        observer.observe(target, { attributes: true, attributeFilter: ['style'] });

    }

</script>



<script type="text/javascript">


    // start
    function saveAttachment() {

        var docidall = "0;";
        // Define the folder path for this example.
        var serverRelativeUrlToFolder = 'CompanyCredentialsAttachment';

        // Get test values from the file input and text input page controls.
        var fileInput = jQuery('#fileAttachedFiles');
        var fileCount = fileInput[0].files.length;
        // Get the server URL.
        var serverUrl = _spPageContextInfo.webAbsoluteUrl;
        var filesUploaded = 0;

        var _CompanyCredentialsId = $("#divModal-CompanyCredentialsDetails").find('#hid_ID').val();

        if (isPDFFiles()) {

            //RequestStarted();
            showLoader();

            setTimeout(function () {
                $("#custom-loader").css("z-index", "2002");
            }, 100);

            for (var i = 0; i < fileCount; i++) {
                // Initiate method calls using jQuery promises.
                // Get the local file as an array buffer.
                var getFile = getFileBuffer(i);
                getFile.done(function (arrayBuffer, i) {

                    // Add the file to the SharePoint folder.
                    var addFile = addFileToFolder(arrayBuffer, i);
                    addFile.done(function (data, status, xhr) {
                        //$("#msg").append("<div>File : "+file.d.Name+" ... uploaded sucessfully</div>");
                        filesUploaded++;
                        var file = data.d;
                        // register/post register
                        var _FolderId = $('#ddlFolders').val();
                        var updateObject = {
                            __metadata: {
                                type: file.ListItemAllFields.__metadata.type
                            },
                            CompanyCredentialLookupId: _CompanyCredentialsId,
                            FileName: fileInput[0].files[i].name
                        };

                        if (_FolderId > 0)
                            updateObject.FolderLookupId = _FolderId;

                        var url = serverUrl + "/_api/Web/lists/getbytitle('" + serverRelativeUrlToFolder + "')/items(" + file.ListItemAllFields.Id + ")";
                        docidall += file.ListItemAllFields.Id + ";";
                        updateFileMetadata(url, updateObject, file, function (result) {
                            //alert("File metadata updation done successfully");
                        }, function (result) {
                            //alert("File upload done but metadata updating FAILED");
                        });
                        if (fileCount == filesUploaded) {

                            bindAttachment(_CompanyCredentialsId);
                            //RequestEnded();
                            hideLoader();
                            alert("All files uploaded successfully.");
                            $('#divModal-CompanyCredentialsAttachment').modal('hide');
                            $('#ddlFolders').val('');
                            $("#fileAttachedFiles").val("");



                            filesUploaded = 0;
                        }
                    });
                    addFile.fail(onError);
                });
                getFile.fail(onError);
            }
        }

        function isPDFFiles() {
            var flag = true;
            var files = fileInput[0].files;
            var maxsize = 2 * 1024 * 1024 * 1024;//2GB
            for (var i = 0; i < files.length; i++) {
                // validate extension
                //if (files[i].name.split(".")[1].toLowerCase() != "pdf") {
                //    flag = false;
                //    alert("Please update PDF files.");
                //    break;
                //}
                if (files[i].name.substr(-3).toLowerCase() != "pdf") {
                    flag = false;
                    alert("Please update PDF files.");
                    break;
                }

                // validate file size
                if (files[i].size > maxsize) {
                    flag = false;
                    alert("File size must be under 2GB.");
                    break;

                }
            }
            return flag;
        }
        //update file metadata
        function updateFileMetadata(apiUrl, updateObject, file, success, failure) {
            $.ajax({
                url: apiUrl,
                type: "POST",
                async: false,
                data: JSON.stringify(updateObject),
                headers: {
                    "accept": "application/json;odata=verbose",
                    "X-RequestDigest": $("#__REQUESTDIGEST").val(),
                    "Content-Type": "application/json;odata=verbose",
                    "X-Http-Method": "MERGE",
                    "IF-MATCH": file.ListItemAllFields.__metadata.etag,
                },
                success: function (data) {
                    success(data);
                },
                error: function (data) {
                    failure(data);
                }
            });
        }
        // Get the local file as an array buffer.
        function getFileBuffer(i) {
            var deferred = jQuery.Deferred();
            var reader = new FileReader();
            reader.onloadend = function (e) {
                deferred.resolve(e.target.result, i);
            }
            reader.onerror = function (e) {
                deferred.reject(e.target.error);
            }
            reader.readAsArrayBuffer(fileInput[0].files[i]);
            return deferred.promise();
        }

        // Add the file to the file collection in the Shared Documents folder.
        function addFileToFolder(arrayBuffer, i) {
            var index = i;

            // Get the file name from the file input control on the page.
            //   var fileName = fileInput[0].files[index].name;

            var today = new Date();
            var cHour = today.getHours();
            var cMin = today.getMinutes();
            var cSec = today.getSeconds();
            //  var fileName = fileInput[0].val().split('.').pop();

            // var fileName = fileInput[0].files[index].name.split('.');
            var filenameLength = fileInput[0].files[index].name.length;
            var fileName = fileInput[0].files[index].name.substr(0, filenameLength - 4);

            fileName = fileName + "-" + cHour + "-" + cMin + "-" + cSec + ".pdf";


            // Construct the endpoint.
            var fileCollectionEndpoint = String.format(
                "{0}/_api/web/getfolderbyserverrelativeurl('{1}')/files" +
                "/add(overwrite=true, url='{2}')?$expand=ListItemAllFields",
                serverUrl, serverRelativeUrlToFolder, fileName);

            // Send the request and return the response.
            // This call returns the SharePoint file.
            return jQuery.ajax({
                url: fileCollectionEndpoint,
                type: "POST",
                data: arrayBuffer,
                processData: false,
                headers: {
                    "accept": "application/json;odata=verbose",
                    "X-RequestDigest": jQuery("#__REQUESTDIGEST").val(),
                    "content-length": arrayBuffer.byteLength
                },
                xhr: function () {
                    var xhr = new window.XMLHttpRequest();

                    xhr.upload.addEventListener("progress", function (_evt) { fileuploaderprogresser(_evt, "li-file-" + index); }, false);

                    return xhr;
                }
            });
        }

    }
    // Display error messages.
    function onError(error) {
        alert('File Uploading Fail! Try again after refreshing page.\n\nError Text:\n\n' + error.responseText);
        //RequestEnded();
        hideLoader();
    }



        function fileAttachedFiles_onChange(_fileUploader) {
        var _htmlSelectFiles = "";

        if (_fileUploader.files.length > 0) {
            for (var fi = 0 ; fi < _fileUploader.files.length; fi++) {
                var fileName = _fileUploader.files[fi].name;
                var displayfileName = fileName.length > 40 ? fileName.substring(0, 25) + '...' + fileName.substring(fileName.length - 15) : fileName;
                var fileSize = _fileUploader.files[fi].size / 1024;

                if (fileSize > 1023)
                    fileSize = (fileSize / 1024).toFixed(2) + " MB";
                else
                    fileSize = fileSize.toFixed(2) + " KB";

                displayfileName = displayfileName + " (" + fileSize + ")";

                var htmlProgressBar = "<div class='progress no-margin'>" +
                      "  <div class='progress-bar progress-bar-warning progress-bar-striped' role='progressbar' aria-valuenow='0' aria-valuemin='0' aria-valuemax='100' style='width: 0%'>" +
                      "    <span class='sr-only'>" + 0 + "% Complete (Still uploading)</span>" +
                      "  </div>" +
                      " <span style='padding-left: 6px;position: absolute;left: 30px;color: darkred;'>" + displayfileName + "<span class='span-info small' style='padding-left: 10px;'></span></span>" +
                      "</div>";


                _htmlSelectFiles = _htmlSelectFiles + "<li id='li-file-" + fi + "' style='margin-bottom: 6px;'> " + htmlProgressBar + "</li>";
                //_htmlSelectFiles = _htmlSelectFiles + "<li id='" + fileName + "' > " + displayfileName + " (" + fileSize + ") <div class='progessbarhere'></div></li>";



            }
        }

        $("#olSelectFiles").html(_htmlSelectFiles);
    }

    function fileuploaderprogresser(evt, _uploadingFileId) {
        var testTisObj = this;

        if (evt.lengthComputable) {
            var percentComplete = evt.loaded / evt.total;
            percentComplete = parseInt(percentComplete * 100);
            //var $link = $('.' + ids);
            //var $img = $link.find('i');
            //$link.html('Uploading..(' + percentComplete + '%)');
            //$link.append($img);

            //var _progressBar = $("#olSelectFiles").find("#progessbarhere").find(".progress-bar");
            var _progressBar = $("#olSelectFiles").find("#" + _uploadingFileId).find(".progress-bar");
            if (_progressBar.length == 0) {
                var htmlProgressBar = "<div class='progress no-margin'>" +
                "  <div class='progress-bar progress-bar-warning progress-bar-striped' role='progressbar' aria-valuenow='" + percentComplete + "' aria-valuemin='0' aria-valuemax='100' style='width: " + percentComplete + "%'>" +
                "    <span class='sr-only'>" + percentComplete + "% Complete (Still uploading)</span>" +
                "  </div>" +
                "</div>";

                //$("#olSelectFiles").find(".progessbarhere").html(htmlProgressBar);
                $("#olSelectFiles").find("#" + _uploadingFileId).html(htmlProgressBar);
            }
            else {
                _progressBar.css("width", percentComplete + '%');
                if (percentComplete < 100) {
                    _progressBar.find(".sr-only").text("" + percentComplete + "% Complete (Still uploading)");

                    var fileSize = evt.loaded / 1024;

                    if (fileSize > 1023)
                        fileSize = (fileSize / 1024).toFixed(3) + " MB uploaded";
                    else
                        fileSize = fileSize.toFixed(3) + " KB uploaded";


                    $("#" + _uploadingFileId).find('.span-info').text(fileSize);

                }
                else {
                    _progressBar.find(".sr-only").text("" + percentComplete + "% Uploaded");
                    _progressBar.addClass("progress-bar-success").removeClass("progress-bar-warning");
                    $("#" + _uploadingFileId).find('span').css("color", "white");
                    $("#" + _uploadingFileId).find('.span-info').text('');
                }
            }

        }
    }




    function deleteCompanyCredentialsAttachment(_recordID) {

        var _confirmResult = confirm("Are you sure you want to delete this attachment?");
        if (_confirmResult == true) {

            GetSPListItems("CompanyCredentialsAttachment", _recordID, '').done(function (data) {

                if (data && data.d) {
                    deleteItem("CompanyCredentialsAttachment", data.d).done(function (data) {
                        alert('Attachment has been deleted successfully');


                        var _recordId = $("#divModal-CompanyCredentialsDetails").find('#hid_ID').val();

                        bindAttachment(_recordId, 'Edit');

                        RequestEnded();
                    });
                }

            }).fail(function (jqXHR, textStatus) {

                alert("CompanyCredentials Deleting Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                RequestEnded();
            });
        }

    }



    function downloadDocument(_fileId) {

        var listName = 'CompanyCredentialsAttachment';
        var apiURL = _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('" + listName + "')/items/GetById(" + _fileId + ")/file"

        $.ajax({
            url: apiURL,
            type: "GET",
            async: false,
            headers: {
                "Accept": "application/json; odata=verbose",
            },
            success: function (dataFileInfo) {

                if (dataFileInfo.d) {

                    var fileURL = location.origin + dataFileInfo.d.ServerRelativeUrl;
                    downloadFunction(fileURL);
                }

            },
            error: function (error) {
                console.log("Error on getting file info", error);

                RequestEnded();
            }
        });
    }


    function downloadFunction(url) {
        var file_path = url;
        var a = document.createElement('A');
        a.href = file_path;
        a.download = file_path.substr(file_path.lastIndexOf('/') + 1);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

    }

</script>


<script type="text/javascript">

    function bindShareDocumentUsers() {

        var template = "<tr id='tr_UserID'>" +
                            "<td>" +
                                "<input type='checkbox' class='chkItem' />" +
                                "<span class='hide' id='spanUser_ID'>UserID</span>" +
                                "<span class='hide' id='spanShareWith'>UserLoginName</span>" +
                            "</td>" +
                            "<td>" +
                                "<span class='news_cls'>UserName</span>" +
                            "</td>" +
                            "<td>" +
                                "<span class='dep_cls1' id='td_usertype'>UserType</span>" +
                            "</td>" +
                            "<td>" +
                                "<span class='type_cls'>EmailAddress</span>" +
                            "</td>" +
                            "<td>" +
                                "<span class='type_flag'>IsActive</span>" +
                            "</td>" +
                        "</tr>";


        var isActiveFilter = "IsActive eq '1' and IsDeleted eq '0'&$top=5000&$select=Id,Title,Email,UserType,IsActive,LoginIDId";

        GetSPListItems("Users", 0, isActiveFilter)
            .done(function (data) {


                if (data.d && data.d.results.length > 0) {

                    for (var _u = 0 ; _u < data.d.results.length; _u++) {
                        var _thisUserItem = data.d.results[_u];
                        //if (_thisUserItem.Id != currentUserCustomInfo.Id)
                        {

                            var html = template;

                            var _UserType = _thisUserItem.UserType;
                            var _IsActive = _thisUserItem.IsActive == true ? 'Active' : 'In-Active';


                            html = html.replace(/UserID/g, _thisUserItem.Id);
                            html = html.replace(/UserLoginName/g, _thisUserItem.LoginIDId);
                            html = html.replace(/UserName/g, _thisUserItem.Title);
                            html = html.replace(/EmailAddress/g, _thisUserItem.Email);
                            html = html.replace(/UserType/g, _UserType);
                            html = html.replace(/IsActive/g, _IsActive);


                            $("#tbluser>tbody").append(html);
                        }
                    }
                }

                $("#tbluser").DataTable({
                    destroy: true
                });

            });
    }
    function openShareWindow(_id, _fileId, _name) {
        var _DocID = 0;

        if (Number(_fileId) > 0) {
            _DocID = _fileId;
        }


        if (_DocID > 0) {

            $('#hid_docid_shared').val(_DocID);
            $("#tbluser>tbody").find("input[type='checkbox']").prop('checked', false); // reset all selected check boxes

            $('#div_DocName').html("<b>Name:</b> " + _name);
            $('#div_DocNumberVersion').html("");

            $('#divModal-ShareDocument').find(".modal-title").text('Share: ' + _name);

            $('#divModal-ShareDocument').modal('show');

            _needtoReopenthisWindow = $("#divModal-CompanyCredentialsDetails");
        }
        return false;
    }
    function checkAll(_control) {
        if ($(_control).prop('checked') == true) {
            $("#tbluser>tbody").find("input[type='checkbox']").prop('checked', true);
        } else {
            $("#tbluser>tbody").find("input[type='checkbox']").prop('checked', false);
        }
    }

    //  user shared document section
    function SharedDocWithuser() {

        var listName = "CompanyCredentialsShare";

        var flag = false;
        var id_ = "";

        var docShareSuccessIndex = 0;

        $("#tbluser>tbody").find("input[type='checkbox']:checked").each(function (a, item) {
            var row = $($(item).parents('tr').first());

            docShareSuccessIndex++;

            var obj = {};
            obj.Title = "";
            obj.CompanyCredentialLookupId = $("#hid_ID").val();
            obj.DocumentLookupId = $('#hid_docid_shared').val();
            obj.UserLookupId = row.find("#spanUser_ID").text();


            InsertIntoSPList(listName, obj).done(function () {
                docShareSuccessIndex--;
                if (docShareSuccessIndex == 0) {
                    alert("Document has been shared by all selected user(s)!");

                    $('#divModal-ShareDocument').modal('hide');
                }

            }).fail(function () {
                docShareSuccessIndex--;
            });

            flag = true;
        });


        if (flag) {

        }
        else {
            alert('Please select atlest a user to share with!');
        }
        return false;
    }

</script>

<!--  Notification  -->
<script type="text/javascript">




    function notificationMarkAsSeen() {
        try {

            var _cid = GetUrlKeyValue('cid');
            var _notid = GetUrlKeyValue('notid');

            if (Number(_notid) > 0 && Number(_cid) > 0) {

                tblCompanyCredentialsDataTable.column(0).visible(true);
                $('#tblCompanyCredentials').find(".record-id").val("-" + _cid + "-").trigger('change');
                tblCompanyCredentialsDataTable.column(0).visible(false);


                markAsRead(_notid);

            }


            /*var _ProductId = $('#hid_ID').val();

            if (Number(_ProductId) > 0) {

                var notificationsJson = {
                    RecordId: "" + _ProductId
                };

                notificationsJson.ModuleType = Module.Artwork;


                var filterNomenclature = "HasSeen eq 0 and NotifyToUsersId eq " + _spPageContextInfo.userId + " and ModuleType eq '" + notificationsJson.ModuleType + "' and RecordId eq '" + notificationsJson.RecordId + "' and Action ne 'Submit'&$top=1000&$select=Id,Title,RecordId,ProductLookupId,ArtworkLookupId,CredentialLookupId,Action,HasSeen,SeenOn,ModuleType,Created";
                GetSPListItems("Notifications", 0, filterNomenclature)
                 .done(function (data) {

                     var response = data.d.results;
                     for (var i = 0; i < response.length ; i++) {
                         if (Number(response[i].Id) > 0) {
                             markAsRead(response[i].Id);
                         }
                     }
                 });

            }*/

        } catch (ex2) {
            console.log(ex2);
        }
    }


    function sendNotification() {


        /*

Title   Single line of text
Modified	Date and Time
Created	Date and Time
Action	Single line of text
NotifyToLookup	Lookup
NotifyToUsers	Person or Group
ActionByUser	Lookup
HasSeen	Yes/No
SeenOn	Date and Time
RecordId	Single line of text
ProductLookup	Lookup
ArtworkLookup	Lookup
CredentialLookup	Lookup
ModuleType	Single line of text
Created By	Person or Group
Modified By	Person or Group

            */

        var sendNotifiaction = false;

        var notificationText = "";
        var notificationToUserLookupIds = [];
        var notificationToSPUserIds = [];
        var notificationAsGroup = false;



        notificationText = "A Company Credential has been submitted and waiting for your approval!";

        var profileIdLst = [];
        var filterProfileQuery = "CanApprove eq 1 and ModuleType eq '" + Module.CompanyCredentials + "' and CountryLookupId eq " + $("#divModal-CompanyCredentialsDetails").find('#ddlCountry').val() + "&$top=5000&$select=Id,ProfileLookupId";
        GetSPListItems("ProfileRights", 0, filterProfileQuery, false)
            .done(function (data) {
                if (data.d.results.length > 0) {
                    data.d.results.forEach(function (pdetails) {

                        if (Number(pdetails.ProfileLookupId) > 0) {

                            profileIdLst.push(pdetails.ProfileLookupId);

                        }
                    });

                }
            });

        var filterQuery = "IsActive eq 1&$top=5000&$select=Id,LoginIDId,ProfileLookupId";
        GetSPListItems("Users", 0, filterQuery, false)
            .done(function (data) {
                if (data.d.results.length > 0) {

                    data.d.results.forEach(function (uid) {
                        if (Number(uid.LoginIDId) > 0 && Number(uid.LoginIDId) != _spPageContextInfo.userId) {
                            if (uid.ProfileLookupId && uid.ProfileLookupId != null && uid.ProfileLookupId.results != null && uid.ProfileLookupId.results.length > 0) {
                                uid.ProfileLookupId.results.forEach(function (profileId) {

                                    if (Number(profileId) > 0 && profileIdLst.includes(profileId)) {

                                        notificationToUserLookupIds.push(uid.Id);
                                        notificationToSPUserIds.push(uid.LoginIDId);

                                        sendNotifiaction = true;
                                        notificationAsGroup = true;
                                    }

                                });
                            }
                        }
                    });

                }
            });




        if (sendNotifiaction == true) {

            if (notificationAsGroup == true) {

                var notificationsJson = {
                    Title: notificationText,
                    RecordId: $('#hid_ID').val(),
                    CredentialLookupId: $('#hid_ID').val(),
                    Action: "Submit",
                    ActionByUserId: currentUserCustomInfo.Id,
                    NotifyToUsersId: { 'results': notificationToSPUserIds },
                    NotifyToLookupId: { 'results': notificationToUserLookupIds },
                    HasSeen: false,
                    ModuleType: Module.CompanyCredentials

                }

                InsertIntoSPList("Notifications", notificationsJson).done(function (data) {
                    console.log("Notifications Saved.");
                }).fail(onerror);

            }
        }
    }

</script>
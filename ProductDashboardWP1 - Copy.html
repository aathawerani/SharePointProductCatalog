<!-- Bootstrap core CSS -->

<link href="../Style%20Library/CustomStyleLibraries/jquery-ui-datepicker/jquery-ui.min.css?v=1.0" rel="stylesheet">
<link href="../Style%20Library/CustomStyleLibraries/bootstrap-3.3.7-dist/css/bootstrap.min.css?v=1.0" rel="stylesheet">
<link href="../Style%20Library/CustomStyleLibraries/datatable/dataTables.bootstrap4.css?v=1.0" rel="stylesheet" />
<link href="../Style%20Library/CustomStyleLibraries/datatable/dataTables.responsive.css?v=1.0" rel="stylesheet" />
<link href="../Style%20Library/CustomStyleLibraries/datatable/dataTables.bootstrap4.min.css?v=1.0" rel="stylesheet" />
<link href="../Style%20Library/CustomStyleLibraries/bootstrap-5.1.0-dist/form-wizard/form-wizard.css?v=1.0"
    rel="stylesheet">
<link href="../Style%20Library/CustomStyleLibraries/bootstrap-tagsinput/bootstrap-tagsinput.css?v=1.0" rel="stylesheet">

<script src="../Style%20Library/CustomStyleLibraries/jquery-ui-datepicker/jquery-ui.min.js?v=1.0"></script>

<script src="../Style%20Library/CustomStyleLibraries/bootstrap-3.3.7-dist/js/bootstrap.min.js?v=1.0"></script>
<script src="../Style%20Library/CustomStyleLibraries/datatable/jquery.dataTables.min.js?v=1.0"></script>
<script src="../Style%20Library/CustomStyleLibraries/datatable/dataTables.bootstrap.min.js?v=1.0"></script>
<script src="../Style%20Library/CustomStyleLibraries/datatable/dataTables.responsive.js?v=1.0"></script>
<script src="../Style%20Library/CustomStyleLibraries/bootstrap-tagsinput/bootstrap-tagsinput.js?v=1.0"></script>


<script src="../Style%20Library/CustomStyleLibraries/datatable/dataTables.responsive.js?v=1.0"></script>
<script type="text/javascript"
    src="https://iblgrouppk.sharepoint.com/sites/SearimsTest/_layouts/15/SP.RequestExecutor.js"></script>




<style type="text/css">
    input[type=text][disabled],
    input[type=file][disabled],
    input:not([type])[disabled],
    textarea[disabled],
    select[disabled],
    .sp-peoplepicker-topLevelDisabled,
    .ms-inputBoxDisabled {
        background-color: #eee;
    }

    hr {
        border-top: 1px solid lightsteelblue;
    }

    h2 {
        border-bottom: 1px solid #33993355;
    }

    .intend-5 {
        margin-left: 50px;
    }

    .m-5 {
        margin: 6px;
    }

    .attachemnt-folder-expender-col {
        width: 30px;
    }

    .attachemnt-folder-icon {
        padding-right: 12px;
    }

    .attachemnt-file-index {
        padding-right: 12px;
    }

    .attachemnt-file-index-infolder {
        padding-left: 32px;
        margin-right: 12px;
    }
</style>

<style type="text/css">
    .material-switch>input[type="checkbox"] {
        display: none;
    }

    .material-switch>label {
        cursor: pointer;
        height: 0px;
        position: relative;
        width: 40px;
    }

    .material-switch>label::before {
        background: rgb(0, 0, 0);
        box-shadow: inset 0px 0px 10px rgba(0, 0, 0, 0.5);
        border-radius: 8px;
        content: '';
        height: 16px;
        margin-top: -8px;
        position: absolute;
        opacity: 0.3;
        transition: all 0.4s ease-in-out;
        width: 40px;
    }

    .material-switch>label::after {
        background: rgb(255, 255, 255);
        border-radius: 16px;
        box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.3);
        content: '';
        height: 24px;
        left: -4px;
        margin-top: -8px;
        position: absolute;
        top: -4px;
        transition: all 0.3s ease-in-out;
        width: 24px;
    }

    .material-switch>input[type="checkbox"]:checked+label::before {
        background: inherit;
        opacity: 0.5;
    }

    .material-switch>input[type="checkbox"]:checked+label::after {
        background: inherit;
        left: 20px;
    }
</style>



<script>
    //http://sharepoint2010europeanhosting.hostforlife.eu/sharepoint-2013-hosting-hostforlife-eu-uploading-large-files-sharepoint-online/
    var siteUrl = _spPageContextInfo.webAbsoluteUrl;
    var siteRelativeUrl = _spPageContextInfo.webServerRelativeUrl != "/" ? _spPageContextInfo.webServerRelativeUrl : "";
    var Tasks = {
        urlName: window.location.origin + "/",
        siteName: '/sites/SearimsTest',
    };

    function UploadFile(event) {
        var fileList = event.files;
        if (fileList.length != 0) {
            uploadLargeFile(fileList[0], "TestLargeFile", fileList[0].name);

            // .then(addFileToFolder => {
            //     console.log("File Uploaded Successfully");
            // }).catch(addFileToFolderError => {
            //     console.log(addFileToFolderError);
            // });
        }
    }

    function uploadLargeFile(file, libname, filename) {
        var docLibraryName = "/sites/SearimsTest/" + libname;
        var fileName = filename;
        var folderName = "";
        //createDummaryFile(docLibraryName, fileName, folderName)
        createDummyFile(docLibraryName, fileName)
        var fr = new FileReader();
        var offset = 0;
        var total = file.size;
        //var length = 1000000 > total ? total : 1000000;
        var length = parseInt(1000000) > total ? Math.round(total * 0.8) : parseInt(1000000);
        var chunks = [];
        //fr.readAsArrayBuffer(file);
        fr.onload = evt => {
            while (offset < total) {
                if (offset + length > total)
                    length = total - offset;
                chunks.push({
                    offset,
                    length,
                    method: getUploadMethod(offset, length, total)
                });
                offset += length;
            }
            for (var i = 0; i < chunks.length; i++)
                console.log(chunks[i]);
            const chunkPercentage = (total / chunks.length) / total * 100;
            if (chunks.length > 0) {
                //const id = getGuid();
                const id = this.guid();
                //uploadFile(evt.target.result, id, docLibraryName, fileName, chunks, 0);
                this.uploadFile(evt.target.result, id, docLibraryName, file.name, chunks, 0, 0, chunkPercentage);
            }
        };
        fr.readAsArrayBuffer(file);
    }

    //AAT commenting
    //function createDummaryFile(libraryName, fileName, folderName) {
        //return new Promise((resolve, reject) => {
            //var endpoint = Tasks.urlName + Tasks.siteName + "/_api/web/GetFolderByServerRelativeUrl('" + libraryName + "/" + folderName + "')/Files/add(url=@TargetFileName,overwrite='true')?" +
                //"&@TargetFileName='" + fileName + "'";
            //console.error('endpoint' + endpoint)
            //var url;
            //const headers = {
                //"accept": "application/json;odata=verbose",
                //"X-RequestDigest": REQUEST_DIGEST_VALUE, 
            //};
            //performUpload(endpoint, headers, libraryName, fileName, folderName, convertDataBinaryString(0));
        //});
    //}

    function createDummyFile(libraryName, fileName) {
        return new Promise((resolve, reject) => {
            // Construct the endpoint - The GetList method is available for SharePoint Online only.  
            //var serverRelativeUrlToFolder = "decodedurl='" + this.siteRelativeUrl + "/" + libraryName + "'";
            //var file = jQuery("#AttachmentUploadField")[0].files[0];
            //currentDlg = null;
            //var endpoint = this.siteUrl + "/_api/Web/GetFolderByServerRelativePath(" + serverRelativeUrlToFolder + ")/files" + "/add(overwrite=true, url='" + file.name + "')"
            var endpoint = Tasks.urlName + Tasks.siteName + "/_api/web/GetFolderByServerRelativeUrl('" + libraryName + "')/Files/add(url=@TargetFileName,overwrite='true')?" +
                "&@TargetFileName='" + fileName + "'";
            const headers = {
                "accept": "application/json;odata=verbose"
            };
            this.executeAsync(endpoint, this.convertDataBinaryString(2), headers).then(file => resolve(true)).catch(err => reject(err));
        });
    }

    function S4() {
        return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
    }

    function getGuid() {
        return (S4() + S4() + "-" + S4() + "-4" + S4().substr(0, 3) + "-" + S4() + "-" + S4() + S4() + S4()).toLowerCase();
    }
    //check position for selecting method

    function guid() {
        function s4() {
            return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
        }
        return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
    }

    function getUploadMethod(offset, length, total) {
        if (offset + length + 1 > total) {
            return 'finishupload';
        } else if (offset === 0) {
            return 'startupload';
        } else if (offset < total) {
            return 'continueupload';
        }
        return null;
    }

    //AAT commenting
    //function uploadFile(result, id, libraryPath, fileName, chunks, index) {
        //const data = convertFileToBlobChunks(result, chunks[index]);
        //var response = uploadFileChunk(id, libraryPath, fileName, chunks[index], data);
        //index += 1;
        //if (index < chunks.length)
            //uploadFile(result, id, libraryPath, fileName, chunks, index, chunks[index].offset);
    //}

    function uploadFile(result, id, libraryPath, fileName, chunks, index, byteOffset, chunkPercentage) {
        //we slice the file blob into the chunk we need to send in this request (byteOffset tells us the start position)  
        const data = this.convertFileToBlobChunks(result, byteOffset, chunks[index]);
        //upload the chunk to the server using REST, using the unique upload guid as the identifier  
        this.uploadFileChunk(id, libraryPath, fileName, chunks[index], data, byteOffset).then(value => {
            const isFinished = index === chunks.length - 1;
            index += 1;
            const percentageComplete = isFinished ? 100 : Math.round((index * chunkPercentage));
            //More chunks to process before the file is finished, continue  
            if (index < chunks.length) {
                this.uploadFile(result, id, libraryPath, fileName, chunks, index, byteOffset, chunkPercentage);
            } else {
                console.error('resolve ');
            }
        }).catch(err => {
            console.error('Error in uploadFileChunk! ' + err);
        });
    }



    //AAT commenting
    //function convertFileToBlobChunks(result, chunkInfo) {
        //var arrayBuffer = chunkInfo.method === 'finishupload' ? result.slice(chunkInfo.offset) : result.slice(chunkInfo.offset, chunkInfo.offset + chunkInfo.length);
       // return convertDataBinaryString(arrayBuffer);
        //return arrayBuffer;
    //}

    function convertFileToBlobChunks(result, byteOffset, chunkInfo) {
        let arrayBuffer = result.slice(chunkInfo.offset, chunkInfo.offset + chunkInfo.length);
        return this.convertDataBinaryString(arrayBuffer);
    }

    function convertDataBinaryString(data) {
        var fileData = '';
        var byteArray = new Uint8Array(data);
        for (var i = 0; i < byteArray.byteLength; i++) {
            fileData += String.fromCharCode(byteArray[i]);
        }
        return fileData;
    }

    //AAT commenting
    //function uploadFileChunk(id, libraryPath, fileName, chunk, data) {
        //new Promise((resolve, reject) => {
            //var offset = chunk.offset === 0 ? '' : ',fileOffset=' + chunk.offset;
            //var folderName = "";
            //var endpoint = Tasks.urlName + Tasks.siteName + "/_api/web/getfilebyserverrelativeurl('" + libraryPath + "/" + fileName + "')/" + chunk.method + "(uploadId=guid'" + id + "'" + offset + ")";
            //console.error('endpoint' + endpoint)
            //const headers = {
                //"Accept": "application/json; odata=verbose",
                //"X-RequestDigest": REQUEST_DIGEST_VALUE,
            //};
            //performUpload(endpoint, headers, libraryPath, fileName, folderName, data);
        //});
    //}

    function uploadFileChunk(id, libraryPath, fileName, chunk, data, byteOffset) {
        return new Promise((resolve, reject) => {
            let offset = chunk.offset === 0 ? '' : ',fileOffset=' + chunk.offset;
            //parameterising the components of this endpoint avoids the max url length problem in SP (Querystring parameters are not included in this length)
            //let endpoint = this.siteUrl + "/_api/web/getfilebyserverrelativeurl('" + this.siteRelativeUrl + "/" + libraryPath + "/" + fileName + "')/" + chunk.method + "(uploadId=guid'" + id + "'" + offset + ")";
            var endpoint = Tasks.urlName + Tasks.siteName + "/_api/web/getfilebyserverrelativeurl('" + libraryPath + "/" + fileName + "')/" + chunk.method + "(uploadId=guid'" + id + "'" + offset + ")";
            const headers = {
                "Accept": "application/json; odata=verbose",
                "Content-Type": "application/octet-stream"
            };
            this.executeAsync(endpoint, data, headers).then(offset => resolve(offset)).catch(err => reject(err));
        });
    }

    //AAT commenting
    //function performUpload(endpoint, headers, libraryName, fileName, folderName, fileData) {
        //new Promise((resolve, reject) => {
            //var digest = $("#__REQUESTDIGEST").val();
            //$.ajax({
                //url: endpoint,
                //async: false,
                //method: "POST",
                //headers: headers,
                //data: fileData,
                //binaryStringRequestBody: true,
                //success: function (data) { },
                //error: err => reject(err.responseText)
            //});
        //});
    //}

    function executeAsync(endPointUrl, data, requestHeaders) {
        return new Promise((resolve, reject) => {
            // using a utils function we would get the APP WEB url value and pass it into the constructor...  
            let executor = new SP.RequestExecutor(this.siteUrl);
            // Send the request.  
            executor.executeAsync({
                url: endPointUrl,
                method: "POST",
                body: data,
                binaryStringRequestBody: true,
                headers: requestHeaders,
                success: offset => resolve(offset),
                error: err => reject(err.responseText)
            });
        });
    }

</script>

<input class="upload form-control" id="DocUploader" placeholder="Upload file" type="file" onchange="UploadFile(this)">


<div class="pull-right xh3 no-margin" id="divCurrentStatus" style="display:none;">

    <div style="top: -50px; position: relative;">
        <div>
            Current Stage: <span id="currentStageText" class="badge" style="font-size: 16px;">Created</span>
        </div>
    </div>

    <div style="top: -35px; position: relative;">
        Current Status: <span id="currentStatusText" class="badge" style="font-size: 16px;">On Hold</span>

    </div>
</div>


<div style="margin-top: 0px;">


    <div class="row">
        <div class="container">
            <section>


                <div class="wizard">
                    <div class="wizard-inner">
                        <div class="connecting-line"></div>
                        <ul class="nav nav-tabs" role="tablist">
                            <li id="li_Step1" role="presentation" class="active" style="width:16.66%">
                                <a href="#divCreateStep" data-toggle="tab" aria-controls="step1" role="tab"
                                    title="Create" data-original-title="Create" onclick="moveTo(1)">
                                    <span class="round-tab">
                                        <i class="glyphicon glyphicon-record"></i>
                                    </span>
                                </a>
                                <center style="top: -14px;position: relative;">Create</center>

                            </li>
                            <li id="li_Step2" role="presentation" class="" style="width:16.66%">
                                <a href="#divAppliedStep" data-toggle="tab" aria-controls="step2" role="tab"
                                    title="Applied" data-original-title="Applied" onclick="moveTo(2)">
                                    <span class="round-tab">
                                        <i class="glyphicon "></i>
                                    </span>
                                </a>
                                <center style="top: -14px;position: relative;">Applied</center>
                            </li>
                            <li id="li_Step3" role="presentation" class="" style="width:16.66%">
                                <a href="#divPreRegistrationStep" data-toggle="tab" aria-controls="step3" role="tab"
                                    title="Pre-Registration" data-original-title="Pre-Registration" onclick="moveTo(3)">
                                    <span class="round-tab">
                                        <i class="glyphicon "></i>
                                    </span>
                                </a>
                                <center style="top: -14px;position: relative;">Pre-Registration</center>
                            </li>
                            <li id="li_Step4" role="presentation" class="" style="width:16.66%">
                                <a href="#divRegistrationStep" data-toggle="tab" aria-controls="step4" role="tab"
                                    title="Registered" data-original-title="Registered" onclick="moveTo(4)">
                                    <span class="round-tab">
                                        <i class="glyphicon "></i>
                                    </span>
                                </a>
                                <center style="top: -14px;position: relative;">Registered</center>
                            </li>

                            <li id="li_Step5" role="presentation" class="disabled" style="width:16.66%">
                                <a href="#divPRVStep" data-toggle="tab" aria-controls="step5" role="tab"
                                    title="Post-Registration Variation" disabled="disabled"
                                    data-original-title="Post-Registration Variation" onclick="moveTo(5)">
                                    <span class="round-tab">
                                        <i class="glyphicon "></i>
                                    </span>
                                </a>
                                <center style="top: -14px;position: relative;">Post-Registration Variation</center>
                            </li>

                            <li id="li_Step6" role="presentation" class="disabled" style="width:16.66%">
                                <a href="#divRenewalStep" data-toggle="tab" aria-controls="step6" role="tab"
                                    title="Renewal" disabled="disabled" data-original-title="Renewal"
                                    onclick="moveTo(6)">
                                    <span class="round-tab">
                                        <i class="glyphicon "></i>
                                    </span>
                                </a>
                                <center style="top: -14px;position: relative;">Renewal</center>
                            </li>

                        </ul>

                    </div>


                </div>


            </section>
        </div>
    </div>


</div>




<hr />

<div id="divFromDetials">

    <input type='hidden' id='hid_ID' />
    <input type='hidden' id='hid_Status' />
    <input type='hidden' id='hid_Stage' />
    <input type='hidden' id='hid_CurrentStatus' value="On Hold" />
    <input type='hidden' id='hid_CurrentStage' value="Create" />
    <input type='hidden' id='hid_CurrentRenewalId' />
    <input type='hidden' id='hid_CurrentRenewalType' />
    <input type='hidden' id='hid_IsNewEntryTrailOpen' />


    <div id="divCreateStep">

        <div class="row">
            <div class="col-md-12">
                <h2>
                    Basic Information

                    <div id="ulAdminControls" style="display:none; margin: -5px 0px 0px 12px;"
                        class="material-switch pull-right">
                        <input id="adminUpdateToggle1" name="adminUpdateToggle1" type="checkbox"
                            onchange="enableStepForAdmin(this,1)" />
                        <label for="adminUpdateToggle1" class="label-warning"
                            title="Enable the Basic Information?"></label>
                    </div>

                    <button type="button" id="btnAdminUpdate_Step1" class="btn btn-warning pull-right"
                        style="display:none;" onclick="saveBasicInformationByAdmin(1)"
                        title="Update Basic Information As Admin"><i class="glyphicon glyphicon-floppy-disk"></i> Update
                        Basic Information</button>

                </h2>

            </div>


        </div>
        <div class="row intend-5">

            <div class="col-md-4">
                <div class="form-group">
                    <div class="form-label-group">
                        <label>Company<i class="text-danger">*</i></label>
                        <select id="ddlCompany" class="form-control"></select>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <div class="form-label-group">
                        <label>Country<i class="text-danger">*</i></label>
                        <select id="ddlCountry" class="form-control"></select>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <div class="form-label-group">
                        <label>Product Category<i class="text-danger">*</i> </label>
                        <select id="ddlProductCategory" class="form-control"></select>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="form-group">
                    <div class="form-label-group">
                        <label>Dosage Form<i class="text-danger">*</i> </label>
                        <select id="ddlDosageType" class="form-control"></select>
                    </div>
                </div>
            </div>


            <div class="col-md-4">
                <div class="form-group">
                    <div class="form-label-group">
                        <label>Product Name<i class="text-danger">*</i></label>
                        <input type="text" id="txtProduct" class="form-control" maxlength="255" />
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="form-group">
                    <div class="form-label-group">
                        <label>Generic<i class="text-danger">*</i></label>
                        <input type="text" id="txtGeneric" class="form-control" maxlength="255" />
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="form-group">
                    <div class="form-label-group">
                        <label>Strength<i class="text-danger">*</i></label>
                        <input type="text" id="txtStrength" class="form-control" maxlength="255" />
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="form-group">
                    <div class="form-label-group">
                        <label>Marketed Status <i class="text-danger hide">*</i></label>
                        <select id="ddlMarketedStatus" class="form-control">
                            <option value="">-- None --</option>
                            <option value="Not Marketed">Not Marketed</option>
                            <option value="Marketed">Marketed</option>
                            <option value="Discontinued">Discontinued</option>
                        </select>
                    </div>
                </div>
            </div>

        </div>
        <hr />
        <center>
            <ul id="ulControlsStep1" class="list-inline pull-center">
                <li>
                    <button type="button" class="btn btn-primary save-btn" onclick="SaveStep(1)"><i
                            class="glyphicon glyphicon-floppy-disk"></i> Save</button>
                    <button type="button" class="btn btn-success finish-btn" onclick="FinishStep(1)"><i
                            class="glyphicon glyphicon-floppy-saved"></i> Finish</button>
                    <button type="button" class="btn btn-info" onclick="moveTo(2)">Next <i
                            class="glyphicon glyphicon-arrow-right"></i></button>
                </li>
            </ul>
        </center>
    </div>


    <div id="divAppliedStep" style="display:none;">

        <div class="row">
            <div class="col-md-12">
                <h2>Applied Information</h2>
            </div>
        </div>

        <div class="row intend-5">

            <div class="col-md-4">
                <div class="form-group">
                    <div class="form-label-group">
                        <label>Manufacturing Site<i class="text-danger hide">*</i></label>
                        <select id="ddlManufacturingSite" class="form-control"></select>
                    </div>
                </div>
            </div>

            <div class="col-md-4" style="display:none">
                <div class="form-group">
                    <div class="form-label-group">
                        <label>Shelf Life<i class="text-danger hide">*</i></label>
                        <select id="ddlShelfLife" class="form-control"></select>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="form-group">
                    <div class="form-label-group">
                        <label>Date of Submission<i class="text-danger hide">*</i></label>
                        <input type="text" id="txtSubmissionDate" class="form-control datepicker" maxlength="15"
                            autocomplete="off" />
                    </div>
                </div>
            </div>


            <div class="col-md-8">
                <div class="form-group">
                    <div class="form-label-group">
                        <label>Source of API / Pellets (By “press enter” or “,” sign multiple tags could be define) <i
                                class="text-danger hide">*</i></label>
                        <input type="text" id="txtSourceOfAPI" class="form-control" maxlength="500" />
                    </div>
                </div>
            </div>


            <div class="col-md-4">
                <div class="form-group">
                    <div class="form-label-group">
                        <label>Storage Condition <i class="text-danger hide">*</i></label>
                        <select id="ddlStorageCondition" class="form-control"></select>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="form-group">
                    <div class="form-label-group">
                        <label>Product Ownership <i class="text-danger hide">*</i></label>
                        <input type="text" id="txtProductOwnership" class="form-control" maxlength="255" />
                    </div>
                </div>
            </div>



            <div class="col-md-4 hide">
                <div class="form-group">
                    <div class="form-label-group">
                        <label> Pack Type <i class="text-danger hide">*</i></label>
                        <input type="text" id="txtPackType" class="form-control" maxlength="255" />
                    </div>
                </div>
            </div>


        </div>


        <div class="row intend-5" id="divPackSizeTable">
            <div class="col-md-12">
                <hr />
                <h4 class="pull-left">Applied Packaging</h4>
                <a id="btnAddPackSize" href="#" title="Add Applied Packaging" onclick="openProductPackSize(0)"
                    class="btn btn-info btn-sm pull-right h5"><i class="glyphicon glyphicon-plus"></i>&nbsp;Add Applied
                    Packaging</a>
            </div>
            <div class="col-md-12">

                <table id="tblProductPackSize" class="table table-striped small" style="width: 100%">
                    <thead class="alert alert-info h5">

                        <tr>
                            <th class="th-sm">
                                #
                            </th>
                            <th class="th-sm">
                                Pack Size
                            </th>
                            <th class="th-sm">
                                Applied Shelf
                            </th>
                            <th class="th-sm">
                                Applied MRP
                            </th>
                            <th class="th-sm">
                                Applied Strength
                            </th>
                            <th class="th-sm">
                                SAP
                            </th>
                            <th class="th-sm" align='center' style='text-align:center;'>
                                Action
                            </th>
                        </tr>

                    </thead>

                    <tbody>
                        <tr>
                            <td colspan="7">No applied packaging defined!</td>
                        </tr>
                    </tbody>

                </table>


            </div>
        </div>



        <div class="row intend-5" id="divAttachment_Applied">
            <div class="col-md-12">
                <hr />
                <h4 class="pull-left">Applied Attachment</h4>
                <a id="btnAddAttachment" href="#" title="Add Attachment" onclick="openAddAttachment(0,'Applied')"
                    class="btn btn-info btn-sm pull-right h5"><i class="glyphicon glyphicon-plus"></i>&nbsp;Add
                    Attachment</a>

                <a id="btnAddFolder" href="#" title="Add Folder" onclick="openFolderSPDialog(0, 'Applied')"
                    class="btn btn-info btn-sm pull-right h5" style="margin-right: 8px;"><i
                        class="glyphicon glyphicon-plus"></i>&nbsp;Add Folder</a>
            </div>
            <div class="col-md-12">

                <table id="tblAttachment_Applied" class="table table-striped small" style="width: 100%">
                    <thead class="alert alert-info h5">

                        <tr>
                            <th class="th-sm attachemnt-folder-expender-col">
                                &nbsp;
                            </th>
                            <th class="th-sm">
                                Folder Name
                            </th>
                            <th class="th-sm">
                                File Name
                            </th>
                            <th class="th-sm">
                                Date of Submission
                            </th>
                            <!--<th class="th-sm">
                                        Is Certificate
                                    </th>-->
                            <th class="th-sm" align='center' style='text-align:center;'>
                                Action
                            </th>
                        </tr>

                    </thead>

                    <tbody>
                        <tr class="empty-row">
                            <td colspan="5">No attachment attachted!</td>
                        </tr>
                    </tbody>

                </table>


            </div>
        </div>

        <hr />
        <center>
            <ul id="ulControlsStep2" class="list-inline pull-center">
                <li>
                    <button type="button" class="btn btn-default" onclick="backTo(1)"><i
                            class="glyphicon glyphicon-arrow-left"></i> Back</button>
                    <button type="button" class="btn btn-success save-btn" onclick="SaveStep(2)"><i
                            class="glyphicon glyphicon-floppy-disk"></i> Save</button>
                    <button type="button" class="btn btn-primary finish-btn" onclick="FinishStep(2)"><i
                            class="glyphicon glyphicon-floppy-saved"></i> Finish</button>
                    <button type="button" class="btn btn-info" onclick="moveTo(3)">Next <i
                            class="glyphicon glyphicon-arrow-right"></i></button>
                </li>
            </ul>
        </center>
    </div>

    <div id="divPreRegistrationStep" style="display:none;">

        <div class="row">
            <div class="col-md-12">
                <h2>Pre-Registration Information</h2>
            </div>
        </div>

        <div class="row intend-5">

            <div class="col-md-4">
                <div class="form-group">
                    <div class="form-label-group">
                        <label>Date</label>
                        <input type="text" id="txtPreRegistrationDate" class="form-control datepicker " maxlength="15"
                            autocomplete="off" />
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="form-group">
                    <div class="form-label-group">
                        <label>Description </label>
                        <textarea id="txtDescription" class="form-control" cols="20" rows="3"></textarea>
                    </div>
                </div>
            </div>

        </div>

        <div class="row intend-5" id="divAttachment_PreRegistration">
            <div class="col-md-12">
                <hr />
                <h4 class="pull-left">Pre-Registration Attachment</h4>
                <a id="btnAddAttachment" href="#" title="Add Attachment"
                    onclick="openAddAttachment(0, 'Pre-Registration')" class="btn btn-info btn-sm pull-right h5"><i
                        class="glyphicon glyphicon-plus"></i>&nbsp;Add Attachment</a>

                <a id="btnAddFolder" href="#" title="Add Folder" onclick="openFolderSPDialog(0, 'Pre-Registration')"
                    class="btn btn-info btn-sm pull-right h5" style="margin-right: 8px;"><i
                        class="glyphicon glyphicon-plus"></i>&nbsp;Add Folder</a>
            </div>
            <div class="col-md-12">

                <table id="tblAttachment_PreRegistration" class="table table-striped small" style="width: 100%">
                    <thead class="alert alert-info h5">

                        <tr>
                            <th class="th-sm attachemnt-folder-expender-col">
                                &nbsp;
                            </th>
                            <th class="th-sm">
                                Folder Name
                            </th>
                            <th class="th-sm">
                                File Name
                            </th>
                            <th class="th-sm">
                                Date
                            </th>
                            <th class="th-sm">
                                Description
                            </th>

                            <th class="th-sm">
                                Is Certificate
                            </th>
                            <th class="th-sm" align='center' style='text-align:center;'>
                                Action
                            </th>
                        </tr>

                    </thead>

                    <tbody>
                        <tr class="empty-row">
                            <td colspan="7">No attachment attachted!</td>
                        </tr>
                    </tbody>

                </table>


            </div>
        </div>

        <hr />
        <center>
            <ul id="ulControlsStep3" class="list-inline pull-center">
                <li>
                    <button type="button" class="btn btn-default" onclick="backTo(2)"><i
                            class="glyphicon glyphicon-arrow-left"></i> Back</button>
                    <button type="button" class="btn btn-success save-btn" onclick="SaveStep(3)"><i
                            class="glyphicon glyphicon-floppy-disk"></i> Save</button>
                    <button type="button" class="btn btn-primary finish-btn" onclick="FinishStep(3)"><i
                            class="glyphicon glyphicon-floppy-saved"></i> Finish</button>
                    <button type="button" class="btn btn-info" onclick="moveTo(4)">Next <i
                            class="glyphicon glyphicon-arrow-right"></i></button>
                </li>
            </ul>
        </center>
    </div>

    <div id="divRegistrationStep" style="display:none;">

        <div class="row">
            <div class="col-md-12">
                <h2>Registration Information</h2>
            </div>
        </div>


        <div class="row intend-5">

            <div class="col-md-3">
            </div>
            <div class="col-md-12">
                <div class="col-md-4">
                    <div class="form-group">
                        <div class="form-label-group">
                            <label for="ckbRegistration_CanExpire">Have Expiry Date?</label>

                            <div class="onoffswitch">
                                <input type="checkbox" name="ckbRegistration_CanExpire" class="onoffswitch-checkbox"
                                    id="ckbRegistration_CanExpire" onchange="onChangeIsExpiry()"
                                    style="height: 18px;width: 18px;">
                                <label class="onoffswitch-label" for="ckbRegistration_CanExpire">
                                    <span class="onoffswitch-inner"></span>
                                    <span class="onoffswitch-switch"></span>
                                </label>
                            </div>
                            <br />
                        </div>
                    </div>
                </div>
                <div class="col-md-4" id="divRegistrationExpiryDate" style="display:none;">
                    <div class="form-group">
                        <div class="form-label-group">
                            <label>Date of Expiry<i class="text-danger">*</i></label>
                            <input type="text" id="txtRegistration_ExpiryDate" class="form-control datepicker "
                                maxlength="15" autocomplete="off" />
                        </div>
                    </div>
                </div>

            </div>
            <div class="col-md-12">

                <div class="col-md-4">
                    <div class="form-group">
                        <div class="form-label-group">
                            <label>Date of Registration<i class="text-danger">*</i></label>
                            <input type="text" id="txtRegistration_RegistrationDate" class="form-control datepicker "
                                maxlength="15" autocomplete="off" />
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-group">
                        <div class="form-label-group">
                            <label>Registration Number<i class="text-danger">*</i></label>
                            <input type="text" id="txtRegistration_RegistrationNo" class="form-control"
                                maxlength="255" />
                        </div>
                    </div>
                </div>

                <div class="col-md-4 hide">
                    <div class="form-group">
                        <div class="form-label-group">
                            <label>Packaging Type<i class="text-danger">*</i></label>
                            <input type="text" id="txtRegistration_PackType" class="form-control" maxlength="255" />
                        </div>
                    </div>
                </div>

            </div>


            <div class="col-md-3">
            </div>
        </div>

        <div class="row intend-5 hide">

            <div class="col-md-3">
            </div>
            <div class="col-md-12">
                <div class="col-md-4">
                    <div class="form-group">
                        <div class="form-label-group">
                            <label>Approved MRP<i class="text-danger hide">*</i></label>
                            <input type="number" id="txtApprovedMRP" class="form-control" maxlength="15"
                                autocomplete="off" value="0" />
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-group">
                        <div class="form-label-group">
                            <label>Marketed MRP<i class="text-danger hide">*</i></label>
                            <input type="number" id="txtMarketedMRP" class="form-control" maxlength="15"
                                autocomplete="off" value="0" />
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-group">
                        <div class="form-label-group">
                            <label>Date of Implementation<i class="text-danger hide">*</i></label>
                            <input type="text" id="txtImplementationDate" class="form-control datepicker "
                                maxlength="15" autocomplete="off" />
                        </div>
                    </div>
                </div>

            </div>

            <div class="col-md-3">
            </div>
        </div>

        <div class="row intend-5 hide">

            <div class="col-md-3">
            </div>
            <div class="col-md-12">

                <div class="col-md-4">
                    <div class="form-group">
                        <div class="form-label-group">
                            <label>Registration Shelf Life <i class="text-danger hide">*</i></label>

                            <select id="ddlRegisteredShelfLife" class="form-control"></select>
                        </div>
                    </div>
                </div>


            </div>

            <div class="col-md-3">
            </div>
        </div>


        <div class="row intend-5" id="divRegisteredPackaging">
            <div class="col-md-12">
                <hr />
                <h4 class="pull-left">Registered Packaging</h4>
                <a id="btnRegisteredPackaging" href="#" title="Add Registered Packaging"
                    onclick="openRegistrationPackaging(0)" class="btn btn-info btn-sm pull-right h5"><i
                        class="glyphicon glyphicon-plus"></i>&nbsp;Add Registered Packaging</a>
            </div>
            <div class="col-md-12">

                <table id="tblRegistrationPackaging" class="table table-striped small" style="width: 100%">
                    <thead class="alert alert-info h5">

                        <tr>
                            <th class="th-sm">
                                #
                            </th>
                            <th class="th-sm">
                                Registered Pack Size
                            </th>
                            <th class="th-sm">
                                Registered Shelf
                            </th>
                            <th class="th-sm">
                                Registered MRP
                            </th>
                            <th class="th-sm">
                                Marketed MRP
                            </th>
                            <th class="th-sm">
                                Date of Implementation
                            </th>
                            <th class="th-sm">
                                Registered Strength
                            </th>
                            <th class="th-sm">
                                SAP
                            </th>
                            <th class="th-sm" align='center' style='text-align:center;'>
                                Action
                            </th>
                        </tr>

                    </thead>

                    <tbody>
                        <tr>
                            <td colspan="9">No registered packaging defined!</td>
                        </tr>
                    </tbody>

                </table>


            </div>
        </div>


        <div class="row intend-5" id="divAttachment_Registration">
            <div class="col-md-12">
                <hr />
                <h4 class="pull-left">Registration Attachment</h4>
                <a id="btnAddAttachment" href="#" title="Add Attachment" onclick="openAddAttachment(0, 'Registered')"
                    class="btn btn-info btn-sm pull-right h5"><i class="glyphicon glyphicon-plus"></i>&nbsp;Add
                    Attachment</a>

                <a id="btnAddFolder" href="#" title="Add Folder" onclick="openFolderSPDialog(0, 'Registered')"
                    class="btn btn-info btn-sm pull-right h5" style="margin-right: 8px;"><i
                        class="glyphicon glyphicon-plus"></i>&nbsp;Add Folder</a>
            </div>
            <div class="col-md-12">

                <table id="tblAttachment_Registration" class="table table-striped small" style="width: 100%">
                    <thead class="alert alert-info h5">

                        <tr>
                            <th class="th-sm attachemnt-folder-expender-col">
                                &nbsp;
                            </th>
                            <th class="th-sm">
                                Folder Name
                            </th>
                            <th class="th-sm">
                                File Name
                            </th>
                            <th class="th-sm">
                                Date of Registration
                            </th>
                            <th class="th-sm">
                                Date of Expiry
                            </th>
                            <th class="th-sm">
                                Is Certificate
                            </th>
                            <th class="th-sm" align='center' style='text-align:center;'>
                                Action
                            </th>
                        </tr>

                    </thead>

                    <tbody>
                        <tr class="empty-row">
                            <td colspan="7">No attachment attachted!</td>
                        </tr>
                    </tbody>

                </table>


            </div>
        </div>

        <hr />
        <center>
            <ul id="ulControlsStep4" class="list-inline pull-center">
                <li>
                    <button type="button" class="btn btn-default" onclick="backTo(3)"><i
                            class="glyphicon glyphicon-arrow-left"></i> Back</button>
                    <button type="button" class="btn btn-success save-btn" onclick="SaveStep(4)"><i
                            class="glyphicon glyphicon-floppy-disk"></i> Save</button>
                    <button type="button" class="btn btn-primary finish-btn" onclick="FinishStep(4)"><i
                            class="glyphicon glyphicon-floppy-saved"></i> Finish</button>
                    <button type="button" class="btn btn-info" onclick="moveTo(5)">Next <i
                            class="glyphicon glyphicon-arrow-right"></i></button>
                </li>
            </ul>
        </center>
    </div>


    <div id="divPRVStep" style="display:none;">

        <div class="row">
            <div class="col-md-12">
                <h2>
                    PRV Information
                    <div id="ulMaintainPRVTrail" style="display:none; margin: -5px 0px 0px 12px;"
                        class="material-switch pull-right">
                        <input id="inputMaintainPRV" name="inputMaintainPRV" type="checkbox"
                            onchange="enableForTrail(this,'prv')" />
                        <label for="inputMaintainPRV" class="label-success" title="Enable for new PRV?"></label>
                    </div>

                    <label class="pull-right h5" title="New PRV"><b>New PRV</b></label>

                </h2>
            </div>


        </div>


        <div class="row intend-5">

            <div class="col-md-3">
            </div>
            <div class="col-md-12">

                <div class="col-md-7 no-padding">

                    <div class="col-md-12">
                        <div class="form-group">
                            <div class="form-label-group">
                                <label>Post Registered Product <i class="text-danger">*</i></label>
                                <input type="text" id="txtPRV_ProductName" class="form-control" maxlength="255" />
                            </div>
                        </div>
                    </div>


                    <div class="col-md-6">
                        <div class="form-label-group">
                            <div class="form-row">

                                <div class="col-sm-6  no-padding">
                                    <br>
                                    <div class="custom-control custom-radio custom-control-inline">
                                        <input class="custom-control-input" type="radio" name="rdPRV_Applied"
                                            id="rdPRV_Applied" onclick="onChangePRV_Type()" value="Applied">
                                        <label class="custom-control-label no-margin"
                                            for="rdPRV_Applied">&nbsp;Applied</label>
                                    </div>
                                </div>

                                <div class="col-sm-6 no-padding">
                                    <br>
                                    <div class="custom-control custom-radio custom-control-inline">
                                        <input class="custom-control-input" type="radio" name="rdPRV_Applied"
                                            id="rdPRV_Approved" onclick="onChangePRV_Type()" value="Approved"
                                            checked="checked">
                                        <label class="custom-control-label no-margin"
                                            for="rdPRV_Approved">&nbsp;Approved</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="form-label-group">
                                <label id="lblPRV_DateText">Applied Date <i class="text-danger">*</i></label>
                                <input type="text" id="txtPRV_Date" class="form-control datepicker" maxlength="15"
                                    autocomplete="off" value="0" />
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="form-label-group">
                                <label>Post Shelf Life <i class="text-danger">*</i></label>
                                <select id="ddlPRV_ShelfLife" class="form-control"></select>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="form-label-group">
                                <label>Post Strength <i class="text-danger">*</i></label>
                                <input type="text" id="txtPRV_Strength" class="form-control" maxlength="255" />
                            </div>
                        </div>
                    </div>


                    <div class="col-md-12">

                        <div id="divPRV_RelatedTo" class="form-group">
                            <div class="form-row">
                                <div class="col-md-3 no-padding">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="chkproduct"
                                            value="Product Related">
                                        <label class="custom-control-label no-margin" for="chkproduct">Product
                                            Related</label>
                                    </div>
                                </div>
                                <div class="col-md-3 no-padding">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="chkprice"
                                            value="Price Related">
                                        <label class="custom-control-label no-margin" for="chkprice">Price
                                            Related</label>
                                    </div>
                                </div>
                                <div class="col-md-3 no-padding">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="chkplant"
                                            value="Plant Related">
                                        <label class="custom-control-label no-margin" for="chkplant">Plant
                                            Related</label>
                                    </div>
                                </div>
                                <div class="col-md-3 no-padding">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="chkothers"
                                            value="Others">
                                        <label class="custom-control-label no-margin" for="chkothers">Others</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>

                <div class="col-md-5 no-padding">

                    <div class="col-md-12">
                        <div class="form-group">
                            <div class="form-label-group">
                                <label>Application Details </label>
                                <textarea name="textarea" rows="4" cols="26" id="txtPRV_ApplicationDetails"
                                    class="form-control"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-12">
                        <div class="form-group">
                            <div class="form-label-group">
                                <label>Remarks </label>
                                <textarea name="textarea" rows="4" cols="26" id="txtPRV_Remarks"
                                    class="form-control"></textarea>
                            </div>
                        </div>
                    </div>

                </div>

            </div>

            <div class="col-md-3">
            </div>
        </div>


        <div class="row intend-5">

            <div class="col-md-12">


                <div class="row" id="divAttachment_PRV">
                    <div class="col-md-12">
                        <hr />
                        <h4 class="pull-left">PRV Attachment</h4>
                        <a id="btnAddAttachment" href="#" title="Add Attachment" onclick="openAddAttachment(0, 'PRV')"
                            class="btn btn-info btn-sm pull-right h5"><i class="glyphicon glyphicon-plus"></i>&nbsp;Add
                            Attachment</a>

                        <a id="btnAddFolder" href="#" title="Add Folder" onclick="openFolderSPDialog(0, 'PRV')"
                            class="btn btn-info btn-sm pull-right h5" style="margin-right: 8px;"><i
                                class="glyphicon glyphicon-plus"></i>&nbsp;Add Folder</a>
                    </div>
                    <div class="col-md-12">

                        <table id="tblAttachment_PRV" class="table table-striped small" style="width: 100%">
                            <thead class="alert alert-info h5">

                                <tr>
                                    <th class="th-sm attachemnt-folder-expender-col">
                                        &nbsp;
                                    </th>
                                    <th class="th-sm">
                                        Folder Name
                                    </th>
                                    <th class="th-sm">
                                        File Name
                                    </th>
                                    <th class="th-sm">
                                        Applied Date
                                    </th>
                                    <th class="th-sm">
                                        Approved Date
                                    </th>
                                    <th class="th-sm">
                                        Is Certificate
                                    </th>
                                    <th class="th-sm" align='center' style='text-align:center;'>
                                        Action
                                    </th>
                                </tr>

                            </thead>

                            <tbody>
                                <tr class="empty-row">
                                    <td colspan="7">No attachment attachted!</td>
                                </tr>
                            </tbody>

                        </table>


                    </div>
                </div>
            </div>

        </div>
        <hr />
        <center>
            <ul id="ulControlsStep5" class="list-inline pull-center">
                <li>
                    <button type="button" class="btn btn-default" onclick="backTo(4)"><i
                            class="glyphicon glyphicon-arrow-left"></i> Back</button>
                    <button type="button" class="btn btn-success save-btn" onclick="SaveStep(5)"><i
                            class="glyphicon glyphicon-floppy-disk"></i> Save</button>
                    <button type="button" class="btn btn-primary finish-btn" onclick="FinishStep(5)"><i
                            class="glyphicon glyphicon-floppy-saved"></i> Finish</button>


                    <button type="button" class="btn btn-info" onclick="moveTo(6)">Next <i
                            class="glyphicon glyphicon-arrow-right"></i></button>
                </li>
            </ul>
            <ul id="btnMaintainPRV" class="list-inline pull-center" style="display:none;">
                <li>
                    <!--<button type="button"  class="btn btn-success " onclick="savePRVDetails()" title="Add New PRV"><i class="glyphicon glyphicon-floppy-disk"></i> Add New PRV</button>-->

                    <button type="button" class="btn btn-success" onclick="savePRVDetails('Save')"><i
                            class="glyphicon glyphicon-floppy-disk"></i> Save</button>
                    <button type="button" class="btn btn-primary" onclick="savePRVDetails('Finish')"><i
                            class="glyphicon glyphicon-floppy-saved"></i> Finish</button>
                </li>
            </ul>
        </center>
    </div>

    <div id="divRenewalStep" style="display:none;">

        <div class="row">
            <div class="col-md-12">
                <h2>Renewal Information
                    <div id="ulMaintainRenewalTrail" style="display:none; margin: -5px 0px 0px 12px;"
                        class="material-switch pull-right">
                        <input id="inputMaintainRenewal" name="inputMaintainRenewal" type="checkbox"
                            onchange="enableForTrail(this, 'renewal')" />
                        <label for="inputMaintainRenewal" class="label-success" title="Enable for new renewal?"></label>
                    </div>

                    <label class="pull-right h5" title="New Renewal"><b>New Renewal</b></label>
                </h2>
            </div>
        </div>
        <div class="row intend-5">


            <div class="col-md-12">

                <div class="row" style="margin-top: 20px;">
                    <div class="col-md-3">

                    </div>

                    <div class="col-md-7">
                        <div class="col-md-6 no-padding">
                            <div class="form-group">

                                <input type="radio" id="radRenewalApplied" name="RenewalType" class="no-margin"
                                    title="Renewal as Applied" style="width: 25px;height: 16px;"
                                    onchange="onChangeRenewalType()" checked>
                                <label for="radRenewalApplied" class="no-margin h4">Renewal Applied</label>

                            </div>
                        </div>
                        <div class="col-md-6 no-padding">
                            <div class="form-group">

                                <input type="radio" id="radRenewalApproved" name="RenewalType" class="no-margin"
                                    title="Renewal as Approved" style="width: 25px;height: 16px;"
                                    onchange="onChangeRenewalType()">
                                <label for="radRenewalApproved" class="no-margin h4">Renewal Approved</label>

                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">

                    </div>
                </div>



                <div class="row" id="divRenewalOptions">
                    <div class="col-md-2">
                    </div>
                    <div class="col-md-8">
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Date Of Submission<i class="text-danger">*</i></label>
                                    <input type="text" id="txtRenewalSubmissionDate" class="form-control datepicker "
                                        maxlength="15" autocomplete="off" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4" style="display:none;">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Registration Date<i class="text-danger">*</i></label>
                                    <input type="text" id="txtRenewalRegistrationDate" class="form-control datepicker "
                                        maxlength="15" autocomplete="off" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4" style="display:none;">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Expiry Date<i class="text-danger">*</i></label>
                                    <input type="text" id="txtRenewalExpiryDate" class="form-control datepicker "
                                        maxlength="15" autocomplete="off" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4"></div>
                        <div class="col-md-4" style="display:none;">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Registration Number<i class="text-danger">*</i></label>
                                    <input type="text" id="txtRegistrationNum" class="form-control "/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="col-md-12">


                <div class="row" id="divAttachment_Renewal">
                    <div class="col-md-12">
                        <hr />
                        <h4 class="pull-left">Renewal Applied Attachment</h4>
                        <a id="btnAddAttachment" href="#" title="Add Attachment"
                            onclick="openAddAttachment(0, 'Renewal', 'Applied')"
                            class="btn btn-info btn-sm pull-right h5"><i class="glyphicon glyphicon-plus"></i>&nbsp;Add
                            Renewal Applied Attachment</a>

                        <a id="btnAddFolder" href="#" title="Add Folder" onclick="openFolderSPDialog(0, 'Renewal')"
                            class="btn btn-info btn-sm pull-right h5" style="margin-right: 8px;"><i
                                class="glyphicon glyphicon-plus"></i>&nbsp;Add Folder</a>
                    </div>
                    <div class="col-md-12">

                        <table id="tblAttachment_RenewalApplied" class="table table-striped small" style="width: 100%">
                            <thead class="alert alert-info h5">

                                <tr>
                                    <th class="th-sm attachemnt-folder-expender-col">
                                        &nbsp;
                                    </th>
                                    <th class="th-sm">
                                        Folder Name
                                    </th>
                                    <th class="th-sm">
                                        File Name
                                    </th>
                                    <th class="th-sm">
                                        Date Of Submission
                                    </th>
                                    <th class="th-sm">
                                        Is Certificate
                                    </th>
                                    <th class="th-sm" align='center' style='text-align:center;'>
                                        Action
                                    </th>
                                </tr>

                            </thead>

                            <tbody>
                                <tr class="empty-row">
                                    <td colspan="6">No attachment attachted!</td>
                                </tr>
                            </tbody>

                        </table>


                    </div>

                    <div class="col-md-12">
                        <hr />
                        <h4 class="pull-left">Renewal Approved Attachment</h4>
                        <a id="btnAddAttachment" href="#" title="Add Attachment"
                            onclick="openAddAttachment(0, 'Renewal', 'Approved')"
                            class="btn btn-info btn-sm pull-right h5"><i class="glyphicon glyphicon-plus"></i>&nbsp;Add
                            Renewal Approved Attachment</a>

                        <a id="btnAddFolder" href="#" title="Add Folder" onclick="openFolderSPDialog(0, 'Renewal')"
                            class="btn btn-info btn-sm pull-right h5" style="margin-right: 8px;"><i
                                class="glyphicon glyphicon-plus"></i>&nbsp;Add Folder</a>
                    </div>
                    <div class="col-md-12">

                        <table id="tblAttachment_RenewalApproved" class="table table-striped small" style="width: 100%">
                            <thead class="alert alert-info h5">

                                <tr>
                                    <th class="th-sm attachemnt-folder-expender-col">
                                        &nbsp;
                                    </th>
                                    <th class="th-sm">
                                        Folder Name
                                    </th>
                                    <th class="th-sm">
                                        File Name
                                    </th>
                                    <th class="th-sm">
                                        Registration Date
                                    </th>
                                    <th class="th-sm">
                                        Expiry Date
                                    </th>
                                    <th class="th-sm">
                                        Is Certificate
                                    </th>
                                    <th class="th-sm" align='center' style='text-align:center;'>
                                        Action
                                    </th>
                                </tr>

                            </thead>

                            <tbody>
                                <tr class="empty-row">
                                    <td colspan="7">No attachment attachted!</td>
                                </tr>
                            </tbody>

                        </table>


                    </div>
                </div>


            </div>

        </div>
        <hr />
        <center>
            <ul id="ulControlsStep6" class="list-inline pull-center">
                <li>
                    <button type="button" class="btn btn-default" onclick="backTo(5)"><i
                            class="glyphicon glyphicon-arrow-left"></i> Back</button>
                    <button type="button" class="btn btn-success save-btn" onclick="SaveStep(6)"><i
                            class="glyphicon glyphicon-floppy-disk"></i> Save</button>
                    <button type="button" class="btn btn-primary finish-btn" onclick="FinishStep(6)"><i
                            class="glyphicon glyphicon-floppy-saved"></i> Finish</button>
                </li>
            </ul>
        </center>
    </div>

    <center>
        <ul id="ulControlsClose" class="list-inline pull-center" style="display:none;">
            <li>
                <button type="button" class="btn btn-default"
                    onclick="javascript: window.location = 'Products.aspx';">Close</button>
            </li>
        </ul>
    </center>


    <div class="row" id="divProductTrail" style="display:none;">


        <div class="col-md-12">
            <hr />
            <h4 class="pull-left">Product Trail History</h4>
        </div>
        <div class="col-md-12">


            <!--
            Product Name	Generic Name 	Submission Date	Registration Date 	Expiry Date 	Status 	Shelf life 	MRP 	Marketing Status 	Registration No. 		Edit

            Applied
            Product 	FileName 	Submission.Date 	    Is.Certtificate 	Shelf Life 	Applied Date 	Delete


            Register
            Product 	FileName 	Reg.Date 	Exp.Date 	Is.Certtificate 	Shelf Life 	Applied Date 	Delete

            PRV
            Product 	FileName 	Approval.Date 	        Is.Certtificate 	Shelf Life 	Applied Date 	Delete
            -->


            <table id="tblProductTrail" class="table table-striped small" style="width: 100%">
                <thead class="alert alert-info xh5">
                    <!--style="background-color: #336699; color: white"-->

                    <tr>
                        <th class="th-sm">#</th>
                        <th class="th-sm">Product Name</th>
                        <th class="th-sm">Generic Name </th>
                        <th class="th-sm">Submission Date</th>
                        <th class="th-sm">Registration Date</th>
                        <th class="th-sm">Expiry Date</th>
                        <th class="th-sm">Stage</th>
                        <th class="th-sm">Shelf life</th>
                        <th class="th-sm">MRP</th>
                        <th class="th-sm">Marketing Status</th>
                        <th class="th-sm">Registration No</th>
                    </tr>

                </thead>

                <tbody></tbody>


            </table>
        </div>


    </div>



    <div class="row" id="divProductQuery" style="display:none;">
        <div class="col-md-12">
            <hr />
            <h4 class="pull-left">Queries</h4>
            <a id="btnAddQuery" href="#" title="Add Query" onclick="openQuerySPDialog(0)"
                class="btn btn-info btn-sm pull-right h5" style="margin-right: 8px;"><i
                    class="glyphicon glyphicon-plus"></i>&nbsp;Add Query</a>
        </div>
        <div class="col-md-12">

            <table id="tblQuery" class="table table-striped small" style="width: 100%">
                <thead class="alert alert-info h5">

                    <tr>
                        <th class="th-sm">
                            #
                        </th>
                        <th class="th-sm">
                            Date & Time
                        </th>
                        <th class="th-sm">
                            Title
                        </th>
                        <th class="th-sm">
                            Description
                        </th>
                        <th class="th-sm">
                            Files
                        </th>
                    </tr>

                </thead>

                <tbody>
                    <tr>
                        <td colspan="5">No query attached!</td>
                    </tr>
                </tbody>

            </table>


        </div>
    </div>



    <div class="row" id="divActionLogs" style="display:none;">

        <div class="col-md-12">

            <hr class="xno-margin" />

            <h4 class="pull-left">Action History</h4>

            <div>

                <table id="tblActionHistory" class="table table-striped small" style="width: 100%">
                    <thead class="alert alert-info h5">
                        <!--style="background-color: #336699; color: white"-->

                        <tr>
                            <th class="th-sm">
                                Action On
                            </th>
                            <th style="text-align: left" class="th-sm">
                                Action By
                            </th>
                            <th class="th-sm">
                                Action Taken
                            </th>
                            <th class="th-sm" style="width:57%;">
                                Comment
                            </th>
                        </tr>

                    </thead>

                    <tbody></tbody>


                </table>

            </div>




        </div>
    </div>

    <div style="display:none;">

        <button type="button" id="btnClose" class="btn btn-default" data-dismiss="modal">Close</button>
        <!--<button type="button" id="btnSave" class="btn btn-success" onclick="saveProduct();"><i class="glyphicon glyphicon-floppy-disk"></i> Save</button>-->

    </div>

</div>



<!-- Start PackSize Modal -->
<div class="modal fade" id="divModal-PackSize" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" id="mod_mesga">&times;</span>
                </button>
                <h2 class="modal-title">Add Product Pack Size</h2>
            </div>
            <div class="modal-body">
                <input type='hidden' id='hid_PackSizeId' />
                <input type='hidden' id='hid_ProductId' />

                <div>

                    <div class="row">

                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Applied Pack Size<i class="text-danger">*</i></label>
                                    <input type="text" id="txtPackSize" class="form-control" maxlength="255" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Applied Packaging Type<i class="text-danger">*</i></label>
                                    <input type="text" id="txtPackagingType" class="form-control" maxlength="255" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Applied Shelf Life<i class="text-danger">*</i></label>
                                    <select id="ddlAppliedShelfLife" class="form-control"></select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Applied MRP<i class="text-danger hide">*</i> </label>
                                    <input type="text" id="txtMRP" class="form-control" maxlength="255" />
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Applied Strength<i class="text-danger">*</i> </label>
                                    <input type="text" id="txtStrength" class="form-control" maxlength="255" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>SAP<i class="text-danger hide">*</i></label>
                                    <input type="text" id="txtSAP" class="form-control" maxlength="255" />
                                </div>
                            </div>
                        </div>

                    </div>

                </div>


            </div>
            <div class="modal-footer">

                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" id="btnSave" class="btn btn-success" onclick="savePackSize();"><i
                        class="glyphicon glyphicon-floppy-disk"></i> Save</button>

            </div>
        </div>
    </div>


</div>

<div class="modal fade" id="divModal-RegisteredPackaging" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document" style="width:700px;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" id="mod_mesga">&times;</span>
                </button>
                <h2 class="modal-title">Add Registered Packaging</h2>
            </div>
            <div class="modal-body">

                <div>

                    <div class="row">

                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Registered Pack Size<i class="text-danger">*</i></label>
                                    <input type="text" id="txtRegisteredPackSize" class="form-control"
                                        maxlength="255" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Registered Packaging Type<i class="text-danger hide">*</i></label>
                                    <input type="text" id="txtRegisteredPackagingType" class="form-control"
                                        maxlength="255" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Registered Shelf Life<i class="text-danger hide">*</i></label>
                                    <select id="ddlRegisteredShelfLife" class="form-control"></select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Registered MRP<i class="text-danger hide">*</i> </label>
                                    <input type="number" id="txtRegisteredMRP" class="form-control" maxlength="9"
                                        autocomplete="off" value="0" />
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Registered Strength<i class="text-danger hide">*</i> </label>
                                    <input type="text" id="txtRegisteredStrength" class="form-control"
                                        maxlength="255" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>SAP<i class="text-danger hide">*</i></label>
                                    <input type="text" id="txtRegisteredSAP" class="form-control" maxlength="255" />
                                </div>
                            </div>
                        </div>


                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Marketed MRP<i class="text-danger hide">*</i></label>
                                    <input type="number" id="txtRegisteredMarketedMRP" class="form-control"
                                        maxlength="9" autocomplete="off" value="0" />
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Date of Implementation<i class="text-danger hide">*</i></label>
                                    <input type="text" id="txtRegisteredImplementationDate"
                                        class="form-control datepicker " maxlength="15" autocomplete="off" />
                                </div>
                            </div>
                        </div>

                    </div>

                </div>


            </div>
            <div class="modal-footer">

                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" id="btnRegisteredSave" class="btn btn-success"
                    onclick="saveRegisteredPackSize();"><i class="glyphicon glyphicon-floppy-disk"></i> Save</button>

            </div>
        </div>
    </div>


</div>
<!-- End PackSize Modal -->
<!-- Start Attachment Modal -->
<div class="modal fade" id="divModal-Attachment" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" id="mod_mesga">&times;</span>
                </button>
                <h2 class="modal-title">Add Attachment</h2>
            </div>
            <div class="modal-body">
                <input type='hidden' id='hid_ProductId' />
                <input type='hidden' id='hid_AttachmentType' />

                <div>

                    <div class="row" id="divAttachmentFolder">

                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Folder<i class="text-danger hide">*</i></label>
                                    <select id="ddlFolders" class="form-control"></select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3" id="divIsCertificate" style="display:none;">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Is Certificate</label>
                                    <br />
                                    <input id="chkIsCertificate" type="checkbox" style="width: 18px; height: 18px;" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3" id="divRenewwalType" style="display:none;">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Renewal Type</label>
                                    <br />
                                    <label class="badge" id="lblRenewwalType"></label>
                                </div>
                            </div>
                        </div>
                    </div>



                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>File Attachment<i class="text-danger">*</i> </label>
                                    <input type="file" id="fileAttachedFiles" class="form-control" multiple="multiple"
                                        onchange="fileAttachedFiles_onChange(this)" />
                                </div>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <ol id="olSelectFiles" style="padding-left: 13px;">

                            </ol>
                        </div>

                    </div>
                </div>

            </div>
            <div class="modal-footer">

                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" id="btnSave" class="btn btn-success" onclick="saveAttachment();"><i
                        class="glyphicon glyphicon-floppy-disk"></i> Save Attachment</button>

            </div>
        </div>
    </div>


</div>
<!-- End Attachment Modal -->
<!-- Modal -->
<div class="modal fade" id="divModal-ShareDocument" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="width: 750px;right: 63px;">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" id="mod_mesga">&times;</span>
                </button>
                <h2 class="modal-title">Share Document</h2>

                <input type="hidden" id="hid_docid_shared" value="0" />

            </div>
            <div class="modal-body">
                <table id="tbluser" class="table table-striped" cellspacing="0" width="100%">
                    <thead class="alert alert-info h5">


                        <tr>
                            <th>
                                <input type="checkbox" class="chkHeader" id="chkhead" onclick="checkAll(this);" />
                            </th>

                            <th class="th-sm">
                                Name

                                <i class="fa fa-sort float-right" aria-hidden="true"></i>
                            </th>
                            <th class="th-sm">
                                User Type
                                <i class="fa fa-sort float-right" aria-hidden="true"></i>
                            </th>
                            <th class="th-sm">
                                Email
                                <i class="fa fa-sort float-right" aria-hidden="true"></i>
                            </th>

                            <th style="text-align: left" class="th-sm">
                                Status
                                <i class="fa fa-sort float-right" aria-hidden="true"></i>
                            </th>

                        </tr>

                    </thead>


                    <tbody></tbody>


                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" onclick="SharedDocWithuser();">Share</button>
            </div>
        </div>
    </div>

</div>


<!-- Modal View Document -->
<div class="modal fade" id="divModal_ViewDocument" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" id="mod_mesga">&times;</span>
                </button>
                <button type="button" class="close" onclick="min_max(this)">
                    <span><i class="glyphicon glyphicon-resize-horizontal"></i></span>
                </button>
                <h3 class="modal-title" id="h4NomenclatureTitle">Nomenclature Title</h3>
            </div>
            <div class="modal-body">
                <div id="divfrmpdf"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>

            </div>
        </div>
    </div>
</div>
<!-- Modal View Document -->


<script type="text/javascript">



// new changes
function CheckLoginUserType(){
    var filterQuery = "IsActive eq 1&$top=5000&$select=Id,UserType,LoginIDId,ProfileLookupId";
        GetSPListItems("Users", 0, filterQuery, false)
            .done(function (data) {
                if (data.d.results.length > 0) {

                    data.d.results.forEach(function (uid) {
                        if (Number(uid.LoginIDId) > 0 && Number(uid.LoginIDId) == _spPageContextInfo.userId) {
                            
                            checkUserTypeForAttachment = uid.UserType;
                        }
                    });

                }
            });

}

function getCurrentStataus(){
    
    var pid = GetUrlKeyValue('pid');
    var filterQuery = "ID eq "+pid+"&$Select=Id,Status";
        GetSPListItems("Products", 0, filterQuery, false)
            .done(function (data) {
                if (data.d.results.length > 0) {

                    data.d.results.forEach(function (std) {
                        globalStatus = std.Status;
                    });

                }
            });

}


    var storeNumForReneval;

    var _isEditable = false;
    var checkUserTypeForAttachment;
    var globalStatus;
    CheckLoginUserType();
    getCurrentStataus();
    function backTo(index) {

        if ($("#inputMaintainRenewal").prop('checked') == true || $("#inputMaintainPRV").prop('checked') == true) {
            var toggleText = $("#inputMaintainPRV").prop('checked') == true ? 'New PRV' : "New Renewal";
            alert("Stage could not be when '" + toggleText + "' toggle is opened!");
            return false;

        } else {
            /// Normal Move
            moveTo(index);
        }
    }
    function moveTo(index) {
        if ($("#inputMaintainRenewal").prop('checked') == true || $("#inputMaintainPRV").prop('checked') == true) {
            var toggleText = $("#inputMaintainPRV").prop('checked') == true ? 'New PRV' : "New Renewal";
            alert("Stage could not be when '" + toggleText + "' toggle is opened!");
            return false;

        } else {
            /// Normal Move

            /*
                    if ($('#hid_Status').val() == "Rejected") {
 
                        switch ($('#hid_Stage').val()) {
                            case "Create":
                                //if (index != 1)
                                {
                                    moveTo(1);
                                }
                                break;
                            case "Applied":
                                //if (index != 2)
                                {
                                    moveTo(2);
                                }
                                break;
                            case "Pre-Registration":
                                //if (index != 3)
                                {
                                    moveTo(3);
                                }
                                break;
                            case "Registered":
                                //if (index != 4)
                                {
                                    moveTo(4);
                                }
                                break;
                            case "PRV":
                                //if (index != 5)
                                {
                                    moveTo(5);
                                }
                                break;
                            case "Renewal":
                                //if (index != 6)
                                {
                                    moveTo(6);
                                }
                                break;
                            default:
                                if (index != 1) {
                                    moveTo(1);
                                }
                                break;
                        }
 
                        $("ul[id*='ulControlsStep']").hide();
                    }
                    else {
                    */

            var focusOnSecsion = "";

            switch (index) {
                case 1:
                    $("#divCreateStep,#ulControlsStep1").show();

                    $("#divAppliedStep,#ulControlsStep2,#divPreRegistrationStep,#ulControlsStep3,#divRegistrationStep,#divRenewalStep,#divPRVStep,#ulControlsStep4,#ulControlsStep5,#ulControlsStep6").hide();
                    if (($('#hid_CurrentStatus').val() == "Draft" || $('#hid_CurrentStatus').val() == "On Hold" || $('#hid_CurrentStatus').val() == "EmptyRecord" || $('#hid_CurrentStatus').val() == "Send Back")//) {
                        //&& $('#hid_CurrentStage').val() == 'Create') {
                        && Number($('#hid_CurrentRenewalId').val()) < 1) {
                        $("#divCreateStep").find('input,select,textarea').prop('disabled', false);
                    } else {
                        $("#divCreateStep").find('input,select,textarea').prop('disabled', true);
                        //$('#ulAdminControls').find('input').prop('disabled', false);
                        $("#divCreateStep").find(".save-btn,.finish-btn").remove();
                    }

                    $("#btnAddPackSize,#btnAddAttachment,#btnAddFolder,#btnAddQuery").hide();
                    $("#divPackSizeTable,#divAttachment,#divProductQuery").hide();
                    $("#ulControlsClose").hide();


                    $(".wizard").find(".nav > li").removeClass('active').addClass('disabled');
                    $(".wizard").find(".nav  .glyphicon").removeClass('glyphicon-record glyphicon-ok');
                    $(".wizard").find(".nav > #li_Step1").addClass('active');
                    $(".wizard").find(".nav > #li_Step1").find('.glyphicon').addClass('glyphicon-record');

                    //$('#hid_Status').val(_item.Status);
                    $('#hid_Stage').val("Create");
                    focusOnSecsion = "#divCreateStep";



                    break;
                case 2:
                    $("#divCreateStep,#divAppliedStep,#ulControlsStep2").show();
                    $("#ulControlsStep1,#divPreRegistrationStep,#ulControlsStep3,#divPRVStep,#ulControlsStep4,#divRegistrationStep,#divRenewalStep,#ulControlsStep5,#ulControlsStep6").hide();
                    $("#divAppliedStep").find('input,select,textarea').prop('disabled', false);

                    if (($('#hid_CurrentStatus').val() == "Draft" || $('#hid_CurrentStatus').val() == "On Hold" || $('#hid_CurrentStatus').val() == "EmptyRecord" || $('#hid_CurrentStatus').val() == "Send Back")//) {
                        //&& $('#hid_CurrentStage').val() == 'Create') {
                        && Number($('#hid_CurrentRenewalId').val()) < 1) {
                        $("#divCreateStep").find('input,select,textarea').prop('disabled', false);
                    } else {
                        $("#divCreateStep").find('input,select,textarea').prop('disabled', true);
                        // $('#ulAdminControls').find('input').prop('disabled', false);
                    }

                    $("#btnAddPackSize,#btnAddQuery").show();
                    $("#divPackSizeTable,#divAttachment,#divProductQuery").show();
                    //$("#btnAddAttachment,#btnAddFolder").hide();
                    if (havePremission(Permission.UPLOAD, Module.ProductManagement, $("#ddlCountry").val())) {
                        $("#btnAddAttachment,#btnAddFolder").show();
                        $("#divAttachment_Applied").find("#btnAddAttachment,#btnAddFolder").show();
                    } else {
                        $("#btnAddAttachment,#btnAddFolder").hide();
                    }
                    $("#ulControlsClose").hide();

                    $(".wizard").find(".nav > li").removeClass('active').addClass('disabled');
                    $(".wizard").find(".nav  .glyphicon").removeClass('glyphicon-record glyphicon-ok');
                    $(".wizard").find(".nav > #li_Step1").find('.glyphicon').addClass('glyphicon-ok');
                    $(".wizard").find(".nav > #li_Step2").addClass('active');
                    $(".wizard").find(".nav > #li_Step2").find('.glyphicon').addClass('glyphicon-record');

                    //$('#hid_Status').val(_item.Status);
                    $('#hid_Stage').val("Applied");
                    focusOnSecsion = "#divAppliedStep";
                    break;
                case 3:
                    $("#divCreateStep,#divAppliedStep,#divPreRegistrationStep,#ulControlsStep3").show();
                    $("#ulControlsStep1,#ulControlsStep2,#divPRVStep,#ulControlsStep4,#divRegistrationStep,#divRenewalStep,#ulControlsStep5,#ulControlsStep6").hide();
                    $("#divAppliedStep").find('input,select,textarea').prop('disabled', false);
                    $("#divPreRegistrationStep").find('input,select,textarea').prop('disabled', false);

                    if (($('#hid_CurrentStatus').val() == "Draft" || $('#hid_CurrentStatus').val() == "On Hold" || $('#hid_CurrentStatus').val() == "EmptyRecord" || $('#hid_CurrentStatus').val() == "Send Back")//) {
                        // && $('#hid_CurrentStage').val() == 'Create') {
                        && Number($('#hid_CurrentRenewalId').val()) < 1) {
                        $("#divCreateStep").find('input,select,textarea').prop('disabled', false);
                    } else {
                        $("#divCreateStep").find('input,select,textarea').prop('disabled', true);
                        //$('#ulAdminControls').find('input').prop('disabled', false);
                    }

                    $("#btnAddPackSize,#btnAddQuery,#divPackSizeTable,#divProductQuery,#divAttachment").show();
                    $("#btnRegisteredPackaging").hide();

                    //$("#btnAddAttachment,#btnAddFolder").hide();
                    if (havePremission(Permission.UPLOAD, Module.ProductManagement, $("#ddlCountry").val())) {
                        $("#btnAddAttachment,#btnAddFolder").show();
                        $("#divAttachment_PreRegistration").find("#btnAddAttachment,#btnAddFolder").show();
                    } else {
                        $("#btnAddAttachment,#btnAddFolder").hide();
                    }


                    $("#ulControlsClose").hide();

                    $(".wizard").find(".nav > li").removeClass('active').addClass('disabled');
                    $(".wizard").find(".nav  .glyphicon").removeClass('glyphicon-record glyphicon-ok');
                    $(".wizard").find(".nav > #li_Step1,.nav #li_Step2").find('.glyphicon').addClass('glyphicon-ok');
                    $(".wizard").find(".nav > #li_Step3").addClass('active');
                    $(".wizard").find(".nav > #li_Step3").find('.glyphicon').addClass('glyphicon-record');

                    //$('#hid_Status').val(_item.Status);
                    $('#hid_Stage').val("Pre-Registration");
                    focusOnSecsion = "#divPreRegistrationStep";
                    break;
                case 4:
                    $("#divCreateStep,#divAppliedStep,#divPreRegistrationStep,#divRegistrationStep,#ulControlsStep4").show();
                    $("#ulControlsStep1,#ulControlsStep2,#ulControlsStep3,#divPRVStep,#divRenewalStep,#ulControlsStep5,#ulControlsStep6").hide();
                    $("#divAppliedStep,#divPreRegistrationStep").find('input,select,textarea').prop('disabled', false);
                    $("#divRegistrationStep").find('input,select,textarea').prop('disabled', false);
                    $("#divPRVStep,#ddlShelfLife").prop('disabled', false);
                    $("#divPRVStep").find('input,select,textarea').prop('disabled', false);

                    if (($('#hid_CurrentStatus').val() == "Draft" || $('#hid_CurrentStatus').val() == "On Hold" || $('#hid_CurrentStatus').val() == "EmptyRecord" || $('#hid_CurrentStatus').val() == "Send Back")//) {
                        // && $('#hid_CurrentStage').val() == 'Create') {
                        && Number($('#hid_CurrentRenewalId').val()) < 1) {
                        $("#divCreateStep").find('input,select,textarea').prop('disabled', false);
                    } else {
                        $("#divCreateStep").find('input,select,textarea').prop('disabled', true);
                        //$('#ulAdminControls').find('input').prop('disabled', false);
                    }

                    //$("#btnAddAttachment,#btnAddFolder").hide();
                    $("#btnAddPackSize,#divPackSizeTable,#divAttachment,#divProductQuery,#btnAddQuery,#btnRegisteredPackaging").show();


                    if (havePremission(Permission.UPLOAD, Module.ProductManagement, $("#ddlCountry").val())) {
                        $("#btnAddAttachment,#btnAddFolder").show();
                        $("#divAttachment_Registration").find("#btnAddAttachment,#btnAddFolder").show();
                    } else {
                        $("#btnAddAttachment,#btnAddFolder").hide();
                    }


                    $("#ulControlsClose").hide();


                    $(".wizard").find(".nav > li").removeClass('active').addClass('disabled');
                    $(".wizard").find(".nav  .glyphicon").removeClass('glyphicon-record glyphicon-ok');
                    $(".wizard").find(".nav #li_Step1,.nav #li_Step2,.nav #li_Step3").find('.glyphicon').addClass('glyphicon-ok');
                    $(".wizard").find(".nav > #li_Step4").addClass('active');
                    $(".wizard").find(".nav > #li_Step4").find('.glyphicon').addClass('glyphicon-record');

                    //$('#hid_Status').val(_item.Status);
                    $('#hid_Stage').val("Registered");
                    focusOnSecsion = "#divRegistrationStep";
                    break;
                case 5:
                    $("#divCreateStep,#divAppliedStep,#divPreRegistrationStep,#divRegistrationStep,#divPRVStep,#ulControlsStep5").show();
                    $("#ulControlsStep1,#ulControlsStep2,#ulControlsStep3,#divRenewalStep,#ulControlsStep4,#ulControlsStep6").hide();
                    $("#divAppliedStep,#divPreRegistrationStep,#divRegistrationStep").find('input,select,textarea').prop('disabled', false);
                    $("#divPRVStep,#ddlShelfLife").prop('disabled', false);
                    $("#divPRVStep").find('input,select,textarea').prop('disabled', false);

                    if (($('#hid_CurrentStatus').val() == "Draft" || $('#hid_CurrentStatus').val() == "On Hold" || $('#hid_CurrentStatus').val() == "EmptyRecord" || $('#hid_CurrentStatus').val() == "Send Back")//) {
                        // && $('#hid_CurrentStage').val() == 'Create') {
                        && Number($('#hid_CurrentRenewalId').val()) < 1) {
                        $("#divCreateStep").find('input,select,textarea').prop('disabled', false);
                    } else {
                        $("#divCreateStep").find('input,select,textarea').prop('disabled', true);
                        //$('#ulAdminControls').find('input').prop('disabled', false);
                    }

                    $("#btnAddPackSize,#divPackSizeTable,#divAttachment,#divProductQuery,#btnAddQuery,#btnRegisteredPackaging").show();
                    //$("#btnAddAttachment,#btnAddFolder").hide();

                    if (havePremission(Permission.UPLOAD, Module.ProductManagement, $("#ddlCountry").val())) {
                        $("#btnAddAttachment,#btnAddFolder").show();
                        $("#divAttachment_PRV").find("#btnAddAttachment,#btnAddFolder").show();
                    } else {
                        $("#btnAddAttachment,#btnAddFolder").hide();
                    }

                    $("#ulControlsClose").hide();
                    $("#ulMaintainRenewalTrail").hide();

                    $(".wizard").find(".nav > li").removeClass('active').addClass('disabled');
                    $(".wizard").find(".nav  .glyphicon").removeClass('glyphicon-record glyphicon-ok');
                    $(".wizard").find(".nav #li_Step1,.nav #li_Step2,.nav #li_Step3,.nav #li_Step4").find('.glyphicon').addClass('glyphicon-ok');
                    $(".wizard").find(".nav > #li_Step5").addClass('active');
                    $(".wizard").find(".nav > #li_Step5").find('.glyphicon').addClass('glyphicon-record');

                    //$('#hid_Status').val(_item.Status);
                    $('#hid_Stage').val("PRV");
                    focusOnSecsion = "#divPRVStep";
                    break;
                case 6:
                    $("#divCreateStep,#divAppliedStep,#divPreRegistrationStep,#divPRVStep,#divRegistrationStep,#divRenewalStep,#ulControlsStep6").show();
                    $("#ulControlsStep1,#ulControlsStep2,#ulControlsStep3,#ulControlsStep4,#ulControlsStep5").hide();
                    $("#divAppliedStep,#divPreRegistrationStep,#divRegistrationStep,#divPRVStep").find('input,select,textarea').prop('disabled', false);
                    $("#divRenewalStep").find('input,select,textarea').prop('disabled', false);

                    if (($('#hid_CurrentStatus').val() == "Draft" || $('#hid_CurrentStatus').val() == "On Hold" || $('#hid_CurrentStatus').val() == "EmptyRecord" || $('#hid_CurrentStatus').val() == "Send Back")//) {
                        // && $('#hid_CurrentStage').val() == 'Create') {
                        && Number($('#hid_CurrentRenewalId').val()) < 1) {
                        $("#divCreateStep").find('input,select,textarea').prop('disabled', false);
                    } else {
                        $("#divCreateStep").find('input,select,textarea').prop('disabled', true);
                        //$('#ulAdminControls').find('input').prop('disabled', false);
                    }

                    $("#btnAddPackSize,#divPackSizeTable,#divAttachment,#divProductQuery,#btnAddQuery,#btnRegisteredPackaging").show();
                    //$("#btnAddAttachment,#btnAddFolder").hide();

                    if (havePremission(Permission.UPLOAD, Module.ProductManagement, $("#ddlCountry").val())) {
                        $("#btnAddAttachment,#btnAddFolder").show();
                        $("#divAttachment_Renewal").find("#btnAddAttachment,#btnAddFolder").show();
                    } else {
                        $("#btnAddAttachment,#btnAddFolder").hide();
                    }

                    $("#ulControlsClose").hide();
                    $("#ulMaintainPRVTrail").hide();


                    $(".wizard").find(".nav > li").removeClass('active').addClass('disabled');
                    $(".wizard").find(".nav  .glyphicon").removeClass('glyphicon-record glyphicon-ok');
                    $(".wizard").find(".nav #li_Step1,.nav #li_Step2,.nav #li_Step3,.nav #li_Step4,.nav #li_Step5").find('.glyphicon').addClass('glyphicon-ok');
                    $(".wizard").find(".nav > #li_Step6").addClass('active');
                    $(".wizard").find(".nav > #li_Step6").find('.glyphicon').addClass('glyphicon-record');


                    onChangeRenewalType();

                    //$('#hid_Status').val(_item.Status);
                    $('#hid_Stage').val("Renewal");
                    focusOnSecsion = "#divRenewalStep";
                    break;
                default:

                    $("#divCreateStep,#ulControlsStep1").show();
                    $("#divAppliedStep,#ulControlsStep2,#divPreRegistrationStep,#ulControlsStep3,#divRegistrationStep,#divRenewalStep,#divPRVStep,#ulControlsStep4,#ulControlsStep5,#ulControlsStep6").hide();
                    $("#divCreateStep").find('input,select,textarea').prop('disabled', false);

                    $("#btnAddPackSize,#btnAddAttachment,#btnAddFolder,#btnAddQuery,#btnRegisteredPackaging").hide();
                    $("#divPackSizeTable,#divAttachment,#divProductQuery").hide();
                    $("#ulControlsClose").hide();

                    $(".wizard").find(".nav > li").removeClass('active').addClass('disabled');
                    $(".wizard").find(".nav  .glyphicon").removeClass('glyphicon-record glyphicon-ok');
                    $(".wizard").find(".nav > #li_Step1").addClass('active');
                    $(".wizard").find(".nav > #li_Step1").find('.glyphicon').addClass('glyphicon-record');

                    //$('#hid_Status').val(_item.Status);
                    $('#hid_Stage').val("Create");
                    break;
            }

            if (_isEditable == true) {


                if ($('#hid_Stage').val() != $('#hid_CurrentStage').val()) {
                    $(".save-btn,.finish-btn").prop('disabled', false);
                    $(".save-btn,.finish-btn").removeClass('disabled');


                    $('#hid_Status').val("On Hold");
                } else {

                    $(".save-btn,.finish-btn").prop('disabled', true);
                    $(".save-btn,.finish-btn").addClass('disabled');



                    $('#hid_Status').val($("#hid_CurrentStatus").val());
                }

                /*
                if (($('#hid_CurrentStatus').val() == "Draft" || $('#hid_CurrentStatus').val() == "On Hold" || $('#hid_CurrentStatus').val() == "Send Back") &&
                  $('#hid_CurrentStage').val() == 'Created') {
                    $("#divCreateStep").find(".save-btn,.finish-btn").prop('disabled', false);
                    $("#divCreateStep").find(".save-btn,.finish-btn").removeClass('disabled');
                } else {
                    $("#divCreateStep").find(".save-btn,.finish-btn").prop('disabled', true);
                    $("#divCreateStep").find(".save-btn,.finish-btn").addClass('disabled');
                }
                */


                if ($('#hid_Status').val() == "Draft" || $('#hid_Status').val() == "On Hold" || $('#hid_Status').val() == "Send Back") {
                    $(".save-btn,.finish-btn").prop('disabled', false);
                    $(".save-btn,.finish-btn").removeClass('disabled');
                }

                //$('#hid_Status').val("On Hold");
                /*if ($('#hid_Status').val() == $("#hid_CurrentStatus").val()) {
 
                }*/



            }

            var pid = Number($('#hid_ID').val());
            if (pid == 0) {
                saveEmptyProduct();
            }

            if (focusOnSecsion.length > 0) {
                setTimeout(function () {
                    var a = document.createElement('A');
                    a.href = focusOnSecsion;
                    //document.body.appendChild(a);
                    a.click();

                }, 100);
            }

            //}
        }
    }

    function lockMoving() {
        setTimeout(function () {

            switch ($('#hid_Stage').val()) {
                case "Create":
                    moveTo(1);
                    break;
                case "Applied":
                    moveTo(2);
                    break;
                case "Pre-Registration":
                    moveTo(3);
                    break;
                case "Registered":
                    moveTo(4);
                    break;
                case "PRV":
                    moveTo(5);
                    break;
                case "Renewal":
                    moveTo(6);
                    break;
                default:
                    moveTo(1);
                    break;
            }

            setTimeout(function () {

                $("ul[id*='ulControlsStep']").hide();

                $("#ulControlsClose").show();

                mode = 'view';

                $("#divCreateStep,#divAppliedStep,#divPreRegistrationStep,#divPRVStep,#divRegistrationStep,#divRenewalStep").find('input,select,textarea').prop('disabled', true);

                $("#btnAddPackSize,#btnAddQuery,#btnAddAttachment,#btnAddFolder,#btnRegisteredPackaging").hide();

            }, 100);

        }, 100);

    }


    function SaveStep(index) {

        showLoader();

        setTimeout(function () {
            saveProduct('Save');
        }, 100);
    }


    function FinishStep(index) {

        showLoader();

        setTimeout(function () {
            saveProduct('Finish');
        }, 100);
    }


    function enableStepForAdmin(_control, _step) {
        if ($(_control).prop('checked') === true) {

            $("#divCreateStep").find('input,select,textarea').prop('disabled', false);
            $("#btnAdminUpdate_Step1").show('slow');

            $("#ulAdminControls").find('input,button').prop('disabled', false);

        } else {
            $("#divCreateStep").find('input,select,textarea').prop('disabled', true);
            $("#btnAdminUpdate_Step1").hide('slow');

            $("#ulAdminControls").find('input,button').prop('disabled', false);
        }
    }


    function enableForTrail(_control, _step) {
        if (_step.toLowerCase() == 'prv') {

            var isNewEntry = $(_control).prop('checked');
            if (isNewEntry == true) {
                var _isOktoGo = confirm("This will create a new PRV entry in Trail report.\n\nAre you sure to enter new PRV details?");
                if (_isOktoGo === false) {
                    isNewEntry = false;
                    $("#ulMaintainPRVTrail").find('input').prop('checked', false);
                }
            }


            if (isNewEntry == true) {
                $("#divPRVStep").find('input,select,textarea').not('.save-btn,.finish-btn').prop('disabled', false);

                $("#divPRVStep").find("input,select,textarea").not("[type='checkbox'],[type='radio']").val('');
                $("#divPRVStep").find("input[type='checkbox']").not('#ulMaintainPRVTrail input').prop('checked', false);
                $("#rdPRV_Applied").prop('checked', true);
                onChangePRV_Type();

                $("#hid_IsNewEntryTrailOpen").val('prv');
                $('#hid_Status').val('On Hold');

                $("#btnMaintainPRV").show();
                $("#ulControlsStep5").hide();

                // $(".nav").find("a").attr('onclick', 'lockMoving()');



                $("#ulMaintainPRVTrail").find('input,button').prop('disabled', false);

                // $(".save-btn,.finish-btn").prop('disabled', false);
                //$(".save-btn,.finish-btn").removeClass('disabled');

                $("#divAttachment_PRV").find("#btnAddAttachment,#btnAddFolder").show();
                //$("#ulControlsStep5").find('.save-btn,.finish-btn').prop('disabled', false);

            } else {
                $("#divPRVStep").find('input,select,textarea').not('.save-btn,.finish-btn,#ulMaintainPRVTrail input').prop('disabled', true);
                $("#btnMaintainPRV").hide();

                if ($("#ulControlsStep6").is(":visible") == false) {
                    $("#ulControlsStep5").show();
                }

                $("#ulMaintainPRVTrail").find('input,button').prop('disabled', false);
                //$("#ulControlsStep5").find('input,button').prop('disabled', false);

                if ($("#hid_IsNewEntryTrailOpen").val().length > 0) {
                    $("#hid_IsNewEntryTrailOpen").val('');
                    openProductDetails(_recordId);
                }
            }
        } else if (_step.toLowerCase() == 'renewal') {


            var isNewEntry = $(_control).prop('checked');
            if (isNewEntry == true) {
                var _isOktoGo = confirm("This will create a new renewal entry in Trail report.\n\nAre you sure to enter new renewal details?");
                if (_isOktoGo === false) {
                    isNewEntry = false;
                    $("#ulMaintainRenewalTrail").find('input').prop('checked', false);
                }
            }


            if (isNewEntry == true) {
                $("#divRenewalStep").find('input,select,textarea').not('.save-btn,.finish-btn').prop('disabled', false);

                if ($("#hid_CurrentRenewalType").val() == "Applied") {

                    $("#txtRenewalRegistrationDate,#txtRenewalExpiryDate").val('');
                    $("#radRenewalApproved").prop('checked', true);

                } else if ($("#hid_CurrentRenewalType").val() == "Approved") {
                    $("#divRenewalStep").find("input,select,textarea").not("[type='checkbox'],[type='radio']").val('');
                    $("#radRenewalApplied").prop('checked', true);
                }
                //$("#divRenewalStep").find("input,select,textarea").not("[type='checkbox'],[type='radio']").val('');

                $("#divRenewalStep").find("input[type='checkbox']").not('#ulMaintainRenewalTrail input').prop('checked', false);

                onChangeRenewalType();

                $("#hid_IsNewEntryTrailOpen").val('renewal');
                $('#hid_Status').val('On Hold');

                // $(".nav").find("a").attr('onclick', 'lockMoving()');                            

                $("#ulMaintainRenewalTrail").find('input,button').prop('disabled', false);

                $("#ulControlsStep6").find(".save-btn,.finish-btn").prop('disabled', false);
                $("#ulControlsStep6").find(".save-btn,.finish-btn").removeClass('disabled');

                $("#divRenewalStep").find("#btnAddAttachment,#btnAddFolder").show();

                //$("#ulControlsStep6").find('.save-btn,.finish-btn').prop('disabled', false);

            } else {
                $("#divRenewalStep").find('input,select,textarea').not('.save-btn,.finish-btn,#ulMaintainRenewalTrail input').prop('disabled', true);

                $("#ulMaintainRenewalTrail").find('input,button').prop('disabled', false);
                //$("#ulControlsStep6").find('input,button').prop('disabled', false);

                if ($("#hid_IsNewEntryTrailOpen").val().length > 0) {
                    $("#hid_IsNewEntryTrailOpen").val('');
                    openProductDetails(_recordId);
                }
            }
        }
    }
</script>


<script type="text/javascript">
    $(document).ready(function () {

        var REQUEST_DIGEST_VALUE = "";
        //RequestStarted();
        getFormDigestValue();

        $("#pageContentTitle").text("Create New Product");

        //$(".ms-listviewtable").find('thead th').addClass("alert alert-info h5 ");
        //$(".ms-listviewtable").addClass('table table-bordered');

        if (havePremission(Permission.UPLOAD, Module.ProductManagement, $("#ddlCountry").val()) == false) {
            $("#btnAddProduct").hide();
            $("#btnAddAttachment,#btnAddFolder").hide();
        }


        $('.datepicker').datepicker({
            onSelect: function (dateText, datepickerObj) {
                console.log("Selected date: " + dateText + "; input's current value: " + this.value, datepickerObj);
            }
        });

        $("#txtSourceOfAPI").tagsinput({
            tagClass: 'label label-default'
        });
        setTimeout(function () {
            $(".bootstrap-tagsinput").css('width', '100%');
        }, 100);

        $("#txtApprovedMRP,#txtMarketedMRP").val('');

        bindAllProductsDDLs();
        bindShareDocumentUsers();

        //RequestEnded();

        var pid = GetUrlKeyValue('pid');
        if ((Number(pid) > 0) == true) {
            $('#hid_ID').val(pid);

            openProductDetails(pid);
        }


        $(".modal").on("hidden.bs.modal", function () {
            $(".modal").find("iframe").remove();
        });



    });

    function getFormDigestValue() {
        try {
            $.ajax({
                url: "https://iblgrouppk.sharepoint.com/sites/SearimsTest/_api/contextinfo",
                type: 'POST',
                xhrFields: { withCredentials: true },
                dataType: "json",
                contentType: "application/x-www-url-encoded",
                headers: { "accept": "application/json;odata=verbose" },
                success: function (data) {
                    if (data.d) {
                        REQUEST_DIGEST_VALUE = data.d.GetContextWebInformation.FormDigestValue;
                    }
                },
                error: function (error) {
                    console.log(JSON.stringify(error));
                }
            });
        } catch (ex) {
            console.log("Error: " + ex);
        }
    }

    //$(document).load(function () {

    function afterWebPageLoad() {

        // executes when complete page is fully loaded, including all frames, objects and images
        console.log("afterWebPageLoad()");

        if (Number(_recordId) > 0) {
            bindProductQuery(_recordId, _currentMode);
            bindActionHistory(_recordId);
            if (_currentItem && _currentItem != null) {
                bindProductTrail(_recordId, _currentItem);
            }
        }
    }
    //});

    /*
    document.addEventListener("DOMContentLoaded", function () {
        console.log(" window.addEventListener >  addEventListener('DOMContentLoaded')");
    });

    window.addEventListener("load", function () {
        console.log(" window.addEventListener >  addEventListener('load')");
        afterWebPageLoad();
    });
    */



    var _recordId = 0;
    var _currentMode = 'view';
    var _currentItem = null;
    function openProductDetails(_id, mode) {

        var modalWindow = $("#divFromDetials");


        mode = 'edit';

        modalWindow.find(".modal-title").text('Applind For New Product');

        // reset All controls
        modalWindow.find("select,input[type='text'],input[type='number'],input[type='hidden']").val('');
        modalWindow.find(".is-invalid").removeClass("is-invalid");

        if (_id && Number(_id) > 0) {

            /*
            var idFilter = "Id eq '" + _id + "'";
            var filterProducts = idFilter + "&$select=ID,Title,Generic,PackType,Strength,MarketedStatus,SubmissionDate,Status,Stage," +
                "CompanyLookupId," +
                "CountryLookupId," +
                "CategoryLookupId," +
                "DosageTypeId," +
                "ManufacturingSiteLookupId," +
                "ShelfLifeLookupId," +
                "Created";*/
            _recordId = _id;
            showLoader();
            setTimeout(function () {
                GetSPListItems("Products", _recordId, '', true)
                    .done(function (data) {

                        try {

                            var _item = data.d;
                            if (_item) {

                                // is record Accessiable

                                isPageAccessable(_item.CountryLookupId);

                                modalWindow.find('#hid_ID').val(_item.Id);
                                modalWindow.find('#hid_Status').val(_item.Status);
                                modalWindow.find('#hid_Stage').val(_item.Stage);
                                modalWindow.find('#hid_CurrentStatus').val(_item.Status);
                                modalWindow.find('#hid_CurrentStage').val(_item.Stage);
                                modalWindow.find('#hid_CurrentRenewalId').val(_item.RenewalOrderLookupId);
                                modalWindow.find('#hid_CurrentRenewalType').val(_item.RenewalType);
                                storeNumForReneval =  _item.Registration_RegistrationNo;


                                $('#currentStatusText').text(_item.Status);
                                $('#currentStageText').text(_item.Stage);
                                $('#divCurrentStatus').show();

                                $("#pageContentTitle").text("View Details: " + _item.Title);

                                modalWindow.find('#ddlCompany').val(_item.CompanyLookupId);
                                modalWindow.find('#ddlCountry').val(_item.CountryLookupId);
                                modalWindow.find('#ddlProductCategory').val(_item.CategoryLookupId);
                                modalWindow.find('#ddlDosageType').val(_item.DosageTypeId);
                                modalWindow.find('#txtProduct').val(_item.Title);
                                modalWindow.find('#txtGeneric').val(_item.Generic);
                                modalWindow.find('#txtStrength').val(_item.Strength);

                                modalWindow.find('#ddlManufacturingSite').val(_item.ManufacturingSiteLookupId);
                                modalWindow.find('#ddlShelfLife').val(_item.ShelfLifeLookupId);
                                modalWindow.find('#txtPackType').val(_item.PackType);
                                modalWindow.find('#ddlMarketedStatus').val(_item.MarketedStatus);

                                var _submissionDate = new Date(_item.SubmissionDate);
                                if (_submissionDate && _submissionDate.getFullYear() > 1970)
                                    modalWindow.find("#txtSubmissionDate").datepicker('setDate', _submissionDate);


                                modalWindow.find('#txtSourceOfAPI').tagsinput('removeAll');
                                modalWindow.find('#txtSourceOfAPI').tagsinput('add', _item.SourceOfAPI);
                                //modalWindow.find('#txtSourceOfAPI').val(_item.SourceOfAPI);

                                modalWindow.find('#ddlStorageCondition').val(_item.StorageCondition);
                                modalWindow.find('#txtProductOwnership').val(_item.ProductOwnership);

                                var _preRegistrationDate = new Date(_item.PreRegistrationDate);
                                if (_preRegistrationDate && _preRegistrationDate.getFullYear() > 1970)
                                    modalWindow.find("#txtPreRegistrationDate").datepicker('setDate', _preRegistrationDate);

                                modalWindow.find('#txtDescription').val(_item.Description);
                                modalWindow.find('#txtApprovedMRP').val(_item.ApprovedMRP > 0 ? _item.ApprovedMRP : '');
                                modalWindow.find('#txtMarketedMRP').val(_item.MarketedMRP > 0 ? _item.MarketedMRP : '');
                                //modalWindow.find('#txtImplementationDate').val(_item.DateOfImplementation);


                                modalWindow.find('#ckbRegistration_CanExpire').prop('checked', _item.Registration_CanExpire);
                                modalWindow.find('#txtRegistration_RegistrationNo').val(_item.Registration_RegistrationNo);
                                modalWindow.find('#txtRegistration_PackType').val(_item.Registration_PackType);


                                var _registration_ExpiryDate = new Date(_item.Registration_ExpiryDate);
                                if (_registration_ExpiryDate && _registration_ExpiryDate.getFullYear() > 1970)
                                    modalWindow.find("#txtRegistration_ExpiryDate").datepicker('setDate', _registration_ExpiryDate);

                                var _registration_DateOfRegistration = new Date(_item.Registration_DateOfRegistration);
                                if (_registration_DateOfRegistration && _registration_DateOfRegistration.getFullYear() > 1970)
                                    modalWindow.find("#txtRegistration_RegistrationDate").datepicker('setDate', _registration_DateOfRegistration);


                                var _dateOfImplementation = new Date(_item.DateOfImplementation);
                                if (_dateOfImplementation && _dateOfImplementation.getFullYear() > 1970)
                                    modalWindow.find("#txtImplementationDate").datepicker('setDate', _dateOfImplementation);

                                modalWindow.find('#ddlRegisteredShelfLife').val(_item.Registration_ShelfLifeLookupId);


                                modalWindow.find('#txtPRV_ProductName').val(_item.PRV_ProductName);
                                //modalWindow.find('#txtPRV_Date').val(_item.PRV_Date);
                                modalWindow.find('#ddlPRV_ShelfLife').val(_item.PRV_ShelfLifeLookupId);
                                modalWindow.find('#txtPRV_Strength').val(_item.PRV_Strength);
                                modalWindow.find('#txtPRV_ApplicationDetails').val(_item.PRV_ApplicationDetails);
                                modalWindow.find('#txtPRV_Remarks').val(_item.PRV_Remarks);

                                var _datePRV_Date = new Date(_item.PRV_Date);
                                if (_datePRV_Date && _datePRV_Date.getFullYear() > 1970)
                                    modalWindow.find("#txtPRV_Date").datepicker('setDate', _datePRV_Date);


                                if (_item.PRV_Type != null && _item.PRV_Type.search("Applied") > -1) {
                                    modalWindow.find('#rdPRV_Applied').prop("checked", true);
                                }
                                if (_item.PRV_Type != null && _item.PRV_Type.search("Approved") > -1) {
                                    modalWindow.find('#rdPRV_Approved').prop("checked", true);
                                }
                                onChangePRV_Type();


                                if (_item.PRV_RelatedTo != null && _item.PRV_RelatedTo.length > 0) {
                                    var _PRV_RelatedToArry = _item.PRV_RelatedTo.split(',');
                                    if (_PRV_RelatedToArry && _PRV_RelatedToArry.length > 0) {
                                        _PRV_RelatedToArry.forEach(function (arryItem) {
                                            modalWindow.find("#divPRV_RelatedTo").find("[value='" + arryItem + "']").prop('checked', true);
                                        });
                                    }
                                }


                                var _dateRenewal_SubmissionDate = new Date(_item.Renewal_SubmissionDate);
                                if (_dateRenewal_SubmissionDate && _dateRenewal_SubmissionDate.getFullYear() > 1970)
                                    modalWindow.find("#txtRenewalSubmissionDate").datepicker('setDate', _dateRenewal_SubmissionDate);


                                var _dateRegistrationDate = new Date(_item.Renewal_RegistrationDate);
                                if (_dateRegistrationDate && _dateRegistrationDate.getFullYear() > 1970)
                                    modalWindow.find("#txtRenewalRegistrationDate").datepicker('setDate', _dateRegistrationDate);

                                var _dateExpiryDate = new Date(_item.Renewal_ExpiryDate);
                                if (_dateExpiryDate && _dateExpiryDate.getFullYear() > 1970)
                                    modalWindow.find("#txtRenewalExpiryDate").datepicker('setDate', _dateExpiryDate);


                                if (_item.RenewalType == 'Applied') {
                                    modalWindow.find('#radRenewalApplied').prop("checked", true);


                                }
                                else if (_item.RenewalType == 'Approved') {
                                    modalWindow.find('#radRenewalApproved').prop("checked", true);



                                }

                                onChangeRenewalType();


                                switch (_item.Stage) {
                                    case 'Create':
                                        moveTo(1);
                                        break;
                                    case 'Applied':
                                        moveTo(2);
                                        break;
                                    case 'Pre-Registration':
                                        moveTo(3);
                                        break;
                                    case 'Registered':
                                        moveTo(4);
                                        break;
                                    case 'PRV':

                                        moveTo(5);

                                        break;
                                    case 'Renewal':
                                        moveTo(6);
                                        break;
                                    default:
                                        moveTo(1);
                                        break;
                                }


                                if (Number($('#hid_CurrentRenewalId').val()) > 2) {
                                    //$("#divRenewalStep").show();
                                    $("#divCreateStep,#divAppliedStep,#divPreRegistrationStep,#divPRVStep,#divRegistrationStep,#divRenewalStep").show();
                                    //ulMaintainPRVTrail
                                }
                                _isEditable = true;


                                //if (mode == 'view') {
                                //    modalWindow.find("select,input[type='text']").prop('disabled', true);
                                //    modalWindow.find("#btnSave,#btnAddPackSize,#btnAddAttachment,#btnAddFolder,#btnAddQuery").hide();
                                //    modalWindow.find(".modal-title").text('View Product Detail');
                                //} else if (mode == 'new') {
                                //    modalWindow.find("select,input[type='text']").prop('disabled', false);
                                //    modalWindow.find("#btnSave").show();
                                //    modalWindow.find("#btnAddPackSize,#btnAddAttachment,#btnAddFolder,#btnAddQuery").hide();

                                //    modalWindow.find(".modal-title").text('Add Product');
                                //} else if (mode == 'edit') {
                                //    modalWindow.find("select,input[type='text']").prop('disabled', false);
                                //    modalWindow.find("#btnSave,#btnAddPackSize,#btnAddAttachment,#btnAddFolder,#btnAddQuery").show();

                                //    modalWindow.find(".modal-title").text('Edit Product');
                                //}


                                if ($('#hid_Status').val() == "Rejected" ||
                                    $('#hid_Status').val() == "Send For Approval" ||
                                    $('#hid_Status').val() == "Approved") {


                                    // $(".nav").find("a").attr('onclick', 'lockMoving()');
                                    $(".save-btn,.finish-btn").prop('disabled', true);
                                    $(".save-btn,.finish-btn").addClass('disabled');

                                }


                                if (_item.Status == "Draft" || _item.Status == "On Hold" || _item.Status == "Send Back") {

                                    mode = 'edit';

                                    $(".save-btn,.finish-btn").prop('disabled', false);
                                    $(".save-btn,.finish-btn").removeClass('disabled');

                                    if (havePremission(Permission.UPLOAD, Module.ProductManagement, _item.CountryLookupId) == false) {

                                        $("ul[id*='ulControlsStep']").hide();

                                        $("#ulControlsClose").show();

                                        mode = 'view';

                                        $("#divCreateStep,#divAppliedStep,#divPreRegistrationStep,#divPRVStep,#divRegistrationStep,#divRenewalStep").find('input,select,textarea').prop('disabled', true);

                                        $("#btnAddPackSize,#btnAddQuery,#btnAddAttachment,#btnAddFolder,#btnRegisteredPackaging").hide();

                                        $(".nav").find("a").attr('onclick', 'lockMoving()');

                                        $(".save-btn,.finish-btn").prop('disabled', true);
                                        $(".save-btn,.finish-btn").addClass('disabled');
                                    }


                                }
                                else if (_item.Status == "Send For Approval" || _item.Status == "Rejected") {

                                    $("ul[id*='ulControlsStep']").hide();

                                    $("#ulControlsClose").show();

                                    mode = 'view';

                                    $("#divCreateStep,#divAppliedStep,#divPreRegistrationStep,#divPRVStep,#divRegistrationStep,#divRenewalStep").find('input,select,textarea').prop('disabled', true);

                                    $("#btnAddPackSize,#btnAddQuery,#btnAddAttachment,#btnAddFolder,#btnRegisteredPackaging").hide();

                                    $(".nav").find("a").attr('onclick', 'lockMoving()');

                                    $(".save-btn,.finish-btn").prop('disabled', true);
                                    $(".save-btn,.finish-btn").addClass('disabled');


                                }
                                else if (_item.Status == "Approved") {

                                    //$("ul[id*='ulControlsStep']").();

                                    $("#ulControlsClose").show();

                                    mode = 'view';

                                    $("#divCreateStep,#divAppliedStep,#divPreRegistrationStep,#divPRVStep,#divRegistrationStep,#divRenewalStep").find('input,select,textarea').prop('disabled', true);

                                    $("#btnAddPackSize,#btnAddQuery,#btnAddAttachment,#btnAddFolder,#btnRegisteredPackaging").hide();


                                    if (havePremission(Permission.UPLOAD, Module.ProductManagement, _item.CountryLookupId) == false) {

                                        $("ul[id*='ulControlsStep']").hide();

                                        $(".nav").find("a").attr('onclick', 'lockMoving()');

                                        $("#ulMaintainPRVTrail,#ulMaintainRenewalTrail").hide();
                                    }
                                    else {
                                        if (_item.Stage == 'PRV') {
                                            $("#ulMaintainPRVTrail").show();
                                            $("#ulMaintainPRVTrail").find('input').prop('disabled', false);
                                        }
                                        else if (_item.Stage == 'Renewal') {
                                            $("#ulMaintainRenewalTrail").show();
                                            $("#ulMaintainRenewalTrail").find('input').prop('disabled', false);


                                            $("#ulMaintainPRVTrail").show();
                                            $("#ulMaintainPRVTrail").find('input').prop('disabled', false);
                                        }
                                    }

                                    $(".save-btn,.finish-btn").prop('disabled', true);
                                    $(".save-btn,.finish-btn").addClass('disabled');

                                }

                                /// Unableing Basic Information for Admin User
                                if (currentUserCustomInfo.UserType == 'Admin') {
                                    if (haveAccessTo(Module.ProductManagement, _item.CountryLookupId) == true) {

                                        //$("#divCreateStep").find('input,select,textarea').prop('disabled', false);

                                        $("#ulAdminControls").show();

                                        $("#ulAdminControls").find('input,button').prop('disabled', false);


                                    }
                                }

                                onChangeIsExpiry();

                                notificationMarkAsSeen();

                                //RequestEnded();

                                RequestEnded();
                                RequestEnded();
                                RequestEnded();

                                bindPackSize(_item.Id, mode);
                                bindAttachment(_item.Id, mode);

                                /////* these are moved to document load function, for performance issue
                                bindProductQuery(_item.Id, mode);
                                bindActionHistory(_item.Id);
                                bindProductTrail(_item.Id, _item);

                                _currentMode = mode;
                                _currentItem = _item;

                                setTimeout(function () {
                                    bindPackSize(_recordId, mode);
                                    bindAttachment(_recordId, mode);
                                }, 100);


                                RequestEnded();
                                hideLoader();


                            }

                        } catch (ex2) {
                            console.error(ex2);
                            RequestEnded();
                            hideLoader();
                        }

                        //modalWindow.modal('show');

                    }).fail(function (data) {
                        RequestEnded();
                    });
            }, 1000);

            //modalWindow.find("#divPackSizeTable,#divAttachment,#divProductQuery").show();

        } else {

            //modalWindow.modal('show');

            //modalWindow.find("#divPackSizeTable,#divAttachment,#divProductQuery").hide();
        }

    }



    function openProductPackSize(_id) {

        var modalWindow = $("#divModal-PackSize");

        modalWindow.find(".modal-title").text('Add Applied Packaging');

        // reset All controls
        modalWindow.find("select,input[type='text'],input[type='number'],input[type='hidden']").val('');
        modalWindow.find(".is-invalid").removeClass("is-invalid");
        modalWindow.find('#hid_ProductId').val($('#hid_ID').val());


        if (_id && Number(_id) > 0) {

            modalWindow.find(".modal-title").text('Edit Applied Packaging');

            GetSPListItems("ProductPackSize", _id, '')
                .done(function (data) {

                    var _item = data.d;
                    if (_item) {

                        modalWindow.find('#hid_PackSizeId').val(_item.Id);
                        modalWindow.find('#hid_ProductId').val(_item.ProductLookupId);

                        modalWindow.find('#txtPackSize').val(_item.PackSize);
                        modalWindow.find('#txtPackagingType').val(_item.PackagingType);

                        //modalWindow.find('#ddlAppliedShelfLife').val(_item.Shelf);
                        modalWindow.find('#ddlAppliedShelfLife').val(_item.ShelfLifeLookupId);

                        modalWindow.find('#txtMRP').val(_item.MRP);
                        modalWindow.find('#txtStrength').val(_item.Strength);
                        modalWindow.find('#txtSAP').val(_item.SAP);

                    }

                    modalWindow.modal('show');

                });

        } else {

            modalWindow.modal('show');
        }
    }


    function openRegistrationPackaging(_id) {

        var modalWindow = $("#divModal-RegisteredPackaging");

        modalWindow.find(".modal-title").text('Add Registered Packaging');

        // reset All controls
        modalWindow.find("select,input[type='text'],input[type='number'],input[type='hidden']").val('');
        modalWindow.find(".is-invalid").removeClass("is-invalid");
        $("#divModal-PackSize").find('#hid_ProductId').val($('#hid_ID').val());


        if (_id && Number(_id) > 0) {

            modalWindow.find(".modal-title").text('Edit Registered Packaging');

            GetSPListItems("ProductPackSize", _id, '')
                .done(function (data) {

                    var _item = data.d;
                    if (_item) {

                        $("#divModal-PackSize").find('#hid_PackSizeId').val(_item.Id);
                        $("#divModal-PackSize").find('#hid_ProductId').val(_item.ProductLookupId);

                        modalWindow.find('#txtRegisteredPackSize').val(_item.PackSize);
                        modalWindow.find('#txtRegisteredPackagingType').val(_item.PackagingType);

                        //modalWindow.find('#ddlRegisteredShelfLife').val(_item.Shelf);
                        modalWindow.find('#ddlRegisteredShelfLife').val(_item.ShelfLifeLookupId);
                        modalWindow.find('#txtRegisteredMRP').val(_item.MRP);
                        modalWindow.find('#txtRegisteredStrength').val(_item.Strength);
                        modalWindow.find('#txtRegisteredSAP').val(_item.SAP);


                        modalWindow.find('#txtRegisteredMarketedMRP').val(_item.MarketedMRP);


                        var _MRPImplementationDate = new Date(_item.MRPImplementationDate);
                        if (_MRPImplementationDate && _MRPImplementationDate.getFullYear() > 1970)
                            modalWindow.find("#txtRegisteredImplementationDate").datepicker('setDate', _MRPImplementationDate);

                    }

                    modalWindow.modal('show');

                });

        } else {

            modalWindow.modal('show');
        }
    }

    function bindAllProductsDDLs() {

        $("#ddlCompany,#ddlCountry,#ddlProductCategory,#ddlDosageType,#ddlManufacturingSite,#ddlShelfLife").find('option').remove();
        $("#ddlCompany,#ddlCountry,#ddlProductCategory,#ddlDosageType,#ddlManufacturingSite,#ddlShelfLife").append("<option value=''> -- None -- </option>");


        var isActiveFilter = "Id gt 0&$orderby=Title asc"; //"IsActive eq '1'";

        GetSPListItems("Companies", 0, isActiveFilter, true)
            .done(function (data) {
                try {

                    if (data && data.d && data.d.results.length > 0) {
                        for (var _u = 0; _u < data.d.results.length; _u++) {
                            var _thisUserItem = data.d.results[_u];
                            var newOPtion = "<option value='" + _thisUserItem.Id + "'>" + _thisUserItem.Title + "</option>";
                            $("#ddlCompany").append(newOPtion);
                        }
                    }

                } catch (ex) { console.log(ex); }
            });

        GetSPListItems("Countries", 0, isActiveFilter, true)
            .done(function (data) {
                try {

                    if (data && data.d && data.d.results.length > 0) {
                        for (var _u = 0; _u < data.d.results.length; _u++) {
                            var _thisUserItem = data.d.results[_u];

                            if (havePremission(Permission.UPLOAD, Module.ProductManagement, _thisUserItem.Id) == true) {
                                var newOPtion = "<option value='" + _thisUserItem.Id + "'>" + _thisUserItem.Title + "</option>";
                                $("#ddlCountry").append(newOPtion);
                            }
                            else if (havePremission(Permission.VIEW, Module.ProductManagement, _thisUserItem.Id) == true) {
                                var newOPtion = "<option value='" + _thisUserItem.Id + "' disabled='disabled'>" + _thisUserItem.Title + "</option>";
                                $("#ddlCountry").append(newOPtion);
                            }

                        }
                    }

                } catch (ex) { console.log(ex); }
            });

        GetSPListItems("ProductCategories", 0, isActiveFilter, true)
            .done(function (data) {
                try {

                    if (data && data.d && data.d.results.length > 0) {
                        for (var _u = 0; _u < data.d.results.length; _u++) {
                            var _thisUserItem = data.d.results[_u];
                            var newOPtion = "<option value='" + _thisUserItem.Id + "'>" + _thisUserItem.Title + "</option>";
                            $("#ddlProductCategory").append(newOPtion);
                        }
                    }

                } catch (ex) { console.log(ex); }
            });

        GetSPListItems("DosageType", 0, isActiveFilter, true)
            .done(function (data) {
                try {

                    if (data && data.d && data.d.results.length > 0) {
                        for (var _u = 0; _u < data.d.results.length; _u++) {
                            var _thisUserItem = data.d.results[_u];
                            var newOPtion = "<option value='" + _thisUserItem.Id + "'>" + _thisUserItem.Title + "</option>";
                            $("#ddlDosageType").append(newOPtion);
                        }
                    }

                } catch (ex) { console.log(ex); }
            });


        GetSPListItems("ManufacturingSites", 0, isActiveFilter, true)
            .done(function (data) {
                try {

                    if (data && data.d && data.d.results.length > 0) {
                        for (var _u = 0; _u < data.d.results.length; _u++) {
                            var _thisUserItem = data.d.results[_u];
                            var newOPtion = "<option value='" + _thisUserItem.Id + "'>" + _thisUserItem.Title + "</option>";
                            $("#ddlManufacturingSite").append(newOPtion);
                        }
                    }

                } catch (ex) { console.log(ex); }
            });

        GetSPListItems("ShelfLife", 0, isActiveFilter, true)
            .done(function (data) {
                try {
                    var noneOption = "<option value=''> -- None -- </option>";

                    $("#ddlShelfLife,#ddlPRV_ShelfLife,#ddlAppliedShelfLife,#ddlRegisteredShelfLife").find("option").remove();

                    $("#ddlShelfLife,#ddlPRV_ShelfLife,#ddlRegisteredShelfLife").append(noneOption);
                    $("#ddlAppliedShelfLife").append(noneOption);


                    if (data && data.d && data.d.results.length > 0) {
                        for (var _u = 0; _u < data.d.results.length; _u++) {
                            var _thisUserItem = data.d.results[_u];
                            var newOPtion = "<option value='" + _thisUserItem.Id + "'>" + _thisUserItem.Title + "</option>";
                            $("#ddlShelfLife,#ddlPRV_ShelfLife,#ddlRegisteredShelfLife,#ddlAppliedShelfLife").append(newOPtion);

                            //var newOPtion2 = "<option value='" + _thisUserItem.Title + "'>" + _thisUserItem.Title + "</option>";
                            //$("#ddlAppliedShelfLife").append(newOPtion2);

                        }
                    }

                } catch (ex) { console.log(ex); }
            });


        GetSPListItems("StorageConditions", 0, isActiveFilter, true)
            .done(function (data) {
                try {

                    if (data && data.d && data.d.results.length > 0) {
                        for (var _u = 0; _u < data.d.results.length; _u++) {
                            var _thisUserItem = data.d.results[_u];
                            var newOPtion = "<option value='" + _thisUserItem.Id + "'>" + _thisUserItem.Title + "</option>";
                            $("#ddlStorageCondition").append(newOPtion);
                        }
                    }

                } catch (ex) { console.log(ex); }
            });

    }


    function bindPackSize(_productId, mode) {

        if (Number(_productId) > 0) {


            var idFilter = "ProductLookupId eq " + _productId;

            var filterProducts = idFilter + "&$select=ID,Title,PackSize,Shelf,MRP,MarketedMRP,MRPImplementationDate,Strength,SAP,ProductLookupId,Stage,ShelfLifeLookup/Id,ShelfLifeLookup/Title&$expand=ShelfLifeLookup";

            GetSPListItems("ProductPackSize", 0, filterProducts)
                .done(function (data) {

                    var response = data.d.results;

                    $('#tblProductPackSize>tbody').html('');
                    $('#tblRegistrationPackaging>tbody').html('');


                    for (var i = 0; i < response.length; i++) {

                        var _item = response[i];
                        var _table = "#tblProductPackSize";


                        var newRow = "<tr id='" + _item["ID"] + "'>" +

                            "<td>" + "[RowIndex]" + "</td>" +
                            "<td>" + _item["PackSize"] + "</td>" +
                            "<td>" + (_item["ShelfLifeLookup"] && typeof (_item["ShelfLifeLookup"].Title) != 'undefined' ? _item["ShelfLifeLookup"].Title : "") + "</td>" +
                            "<td>" + (Number(_item["MRP"]) > 0 ? _item["MRP"] : "") + "</td>" +
                            "[RegisteredColumns]" +
                            "<td>" + (_item["Strength"] == null ? "" : _item["Strength"]) + "</td>" +
                            "<td>" + (_item["SAP"] == null ? "" : _item["SAP"]) + "</td>";

                        var _actionButtonHTML = "";

                        if (_item.Stage == "Registered") {

                            _table = "#tblRegistrationPackaging";

                            _actionButtonHTML = "<a href='#' title='Edit' onclick='openRegistrationPackaging(" + _item.Id + ",\"edit\")' ><i class='glyphicon glyphicon-edit'></i></a> &nbsp; "
                                + "<a href='#'  title='Delete'  onclick='deleteProductPackSize(" + _item.Id + ")' ><i class='glyphicon glyphicon-trash'></i></a>";

                            newRow = newRow.replace(/\[RegisteredColumns\]/,
                                ("<td>" + (Number(_item["MarketedMRP"]) > 0 ? _item["MarketedMRP"] : "") + "</td>" +
                                    "<td>" + toDisplayDate(_item["MRPImplementationDate"]) + "</td>"));

                        } else {
                            _table = "#tblProductPackSize";

                            _actionButtonHTML = "<a href='#' title='Edit' onclick='openProductPackSize(" + _item.Id + ",\"edit\")' ><i class='glyphicon glyphicon-edit'></i></a> &nbsp; "
                                + "<a href='#'  title='Delete'  onclick='deleteProductPackSize(" + _item.Id + ")' ><i class='glyphicon glyphicon-trash'></i></a>";
                        }


                        newRow = newRow.replace(/\[RegisteredColumns\]/, "");

                        if (mode == 'view') {
                            _actionButtonHTML = "";
                        }

                        newRow = newRow + "<td align='center' style='text-align:center;' class='h5'>" + _actionButtonHTML + "</td>";
                        newRow = newRow + "</tr>";


                        newRow = newRow.replace(/\[RowIndex\]/g, ($(_table + '>tbody').find('tr').length + 1));

                        $(_table + '>tbody').append(newRow);

                    }


                    if ($('#tblProductPackSize>tbody').find('tr').length == 0) {
                        $('#tblProductPackSize>tbody').html('<tr><td colspan="7">No applied packaging defined!</td></tr>');
                    }
                    if ($('#tblRegistrationPackaging>tbody').find('tr').length == 0) {
                        $('#tblRegistrationPackaging>tbody').html('<tr><td colspan="9">No registered packaging defined!</td></tr>');
                    }

                });
        }
    }

    // simple table
    function xbindAttachment(_productId, mode) {

        if (Number(_productId) > 0) {

            // Specify the Id of the Item that you want to fetch
            //$("table[id*='tblAttachment']").find('tbody').html('<tr class="empty-row"><td colspan="6">No attachment attachted!</td></tr>');

            //$("table[id*='tblAttachment_Renewal']").find('tbody').html('<tr class="empty-row"><td colspan="8">No attachment attachted!</td></tr>');

            var idFilter = "ProductLookupId eq " + _productId;


            var filterProducts = idFilter + "&$select=ID,Title,FileName,Stage,Created,ProductLookup/Id,ProductLookup/Title,FolderLookup/Id,FolderLookup/Title,IsCertificate,RenewalType,SubmissionDate,RegistrationDate,ExpiryDate&$expand=ProductLookup,FolderLookup";

            GetSPListItems("ProductAttachments", 0, filterProducts)
                .done(function (data) {

                    var response = data.d.results;

                    if (response.length > 0) {
                        $("table[id*='tblAttachment']").find('tbody').find('tr').not('.empty-row').remove();
                    }

                    for (var i = 0; i < response.length; i++) {

                        var _item = response[i];



                        var newRow = "<tr id='" + _item["ID"] + "' data-folderid='" + _item["FolderLookup"].Id + "'> " +
                            "<td>[index]" + "</td>";



                        var tableId = "";
                        alert(_item.Stage)
                        switch (_item.Stage) {
                            case 'Applied':
                                tableId = "#tblAttachment_Applied";

                                newRow = newRow +
                                    "<td><i class='glyphicon glyphicon-folder-open' style='color:#f0ad4e;margin-right: 8px;'></i>" + _item["FolderLookup"].Title + "</td>" +
                                    "<td>" + _item["FileName"] + "</td>" +
                                    "<td>" + toDisplayDate(_item["Created"]) + "</td>";
                                //// Zafar: Remove IsCertificate from Applied Attachments
                                //"<td>" + (_item["IsCertificate"] == true ? 'Yes' : 'No') + "</td>";

                                break;
                            case 'Pre-Registration':
                                tableId = "#tblAttachment_PreRegistration";

                                newRow = newRow +
                                    "<td><i class='glyphicon glyphicon-folder-open' style='color:#f0ad4e;margin-right: 8px;'></i>" + _item["FolderLookup"].Title + "</td>" +
                                    "<td>" + _item["FileName"] + "</td>" +
                                    "<td>" + toDisplayDate(_item["Created"]) + "</td>" +
                                    "<td>" + (_item["IsCertificate"] == true ? 'Yes' : 'No') + "</td>";
                                break;
                            case 'Registered':
                                tableId = "#tblAttachment_Registration";

                                newRow = newRow +
                                    "<td><i class='glyphicon glyphicon-folder-open' style='color:#f0ad4e;margin-right: 8px;'></i>" + _item["FolderLookup"].Title + "</td>" +
                                    "<td>" + _item["FileName"] + "</td>" +
                                    "<td>" + toDisplayDate(_item["Created"]) + "</td>" +
                                    "<td>" + (_item["IsCertificate"] == true ? 'Yes' : 'No') + "</td>";
                                break;
                            case 'PRV':
                                tableId = "#tblAttachment_PRV";

                                newRow = newRow +
                                    "<td><i class='glyphicon glyphicon-folder-open' style='color:#f0ad4e;margin-right: 8px;'></i>" + _item["FolderLookup"].Title + "</td>" +
                                    "<td>" + _item["FileName"] + "</td>" +
                                    "<td>" + toDisplayDate(_item["Created"]) + "</td>" +
                                    "<td>" + (_item["IsCertificate"] == true ? 'Yes' : 'No') + "</td>";
                                break;
                            case 'Renewal':
                                //tableId = "#tblAttachment_Renewal";
                                if (_item.RenewalType.length > 0 && _item.RenewalType.trim().toLowerCase() == 'Renewal Approved'.trim().toLowerCase()) {
                                    tableId = "#tblAttachment_RenewalApproved";
                                }
                                else {
                                    tableId = "#tblAttachment_RenewalApplied";
                                }

                                /*newRow = newRow +
                                    "<td>" + _item["FileName"] + "</td>" +
                                    "<td>" + _item["RenewalType"] + "</td>" +
                                    "<td>" + (_item["SubmissionDate"] == null ? '-' : toDisplayDate(_item["SubmissionDate"])) + "</td>" +
                                    "<td>" + (_item["RegistrationDate"] == null ? '-' : toDisplayDate(_item["RegistrationDate"])) + "</td>" +
                                    "<td>" + (_item["ExpiryDate"] == null ? '-' : toDisplayDate(_item["ExpiryDate"])) + "</td>" +
                                    "<td>" + toDisplayDate(_item["Created"]) + "</td>";
                                    */

                                newRow = newRow +
                                    "<td><i class='glyphicon glyphicon-folder-open' style='color:#f0ad4e;margin-right: 8px;'></i>" + _item["FolderLookup"].Title + "</td>" +
                                    "<td>" + _item["FileName"] + "</td>" +
                                    "<td>" + toDisplayDate(_item["Created"]) + "</td>" +
                                    "<td>" + (_item["IsCertificate"] == true ? 'Yes' : 'No') + "</td>";

                                break;
                            default:
                                break;
                        }

                        var _actionButtonHTML = "";

                        if (havePremission(Permission.DOWNLOAD, Module.ProductManagement, $("#ddlCountry").val()) == true) {
                        
                           
                            if(globalStatus =="Send For Approval" || globalStatus =="Approved"){
                            if(checkUserTypeForAttachment== "Admin"){
                                _actionButtonHTML = _actionButtonHTML + "<a href='#'  title='Delete'  onclick='deleteProductAttachment(" + _item.Id + ")' class='m-5' ><i class='glyphicon glyphicon-trash'></i></a>";
                           
                            }
                            }else if(globalStatus =="On Hold"){
                                _actionButtonHTML = _actionButtonHTML + "<a href='#'  title='Delete'  onclick='deleteProductAttachment(" + _item.Id + ")' class='m-5' ><i class='glyphicon glyphicon-trash'></i></a>";
                                
                            }
                        }
                        if (havePremission(Permission.DOWNLOAD, Module.ProductManagement, $("#ddlCountry").val()) == true) {
                            _actionButtonHTML = _actionButtonHTML + "<a href='#'  title='Download'  onclick='downloadDocument(" + _item.Id + ")' class='m-5' ><i class='glyphicon glyphicon-download'></i></a>";
                        
                        }
                        if (mode != 'view' && havePremission(Permission.UPLOAD, Module.ProductManagement, $("#ddlCountry").val()) == true) {
                          //  _actionButtonHTML = _actionButtonHTML + "<a href='#'  title='Delete'  onclick='deleteProductAttachment(" + _item.Id + ")' class='m-5' ><i class='glyphicon glyphicon-trash'></i></a>";
                        }

                        if (havePremission(Permission.Share, Module.ProductManagement, $("#ddlCountry").val()) == true) {
                            _actionButtonHTML = _actionButtonHTML + "&nbsp;<a id='btnShareIt_" + _item.Id + "' href='#' onclick=\"openShareWindow(" + _item.Id + "," + _item.Id + ",'" + _item["FileName"] + "');\"  title='Share'><i class='glyphicon glyphicon-share'></i></a> ";
                        }



                        newRow = newRow + "<td align='center' style='text-align:center;' class='h5'>" + _actionButtonHTML + "</td>";
                        newRow = newRow + "</tr>";



                        if (tableId.length > 0) {

                            var _rowIndex = $(tableId + '>tbody').find('tr').not('.empty-row').length + 1;
                            newRow = newRow.replace(/\[index\]/g, _rowIndex);

                            $(tableId + '>tbody').append(newRow);
                        }
                    }

                    var allTables = $("table[id*='tblAttachment']");
                    if (allTables != null && allTables) {
                        allTables.each(function () {
                            if ($(this).find('tbody').find('tr').not('.empty-row').length > 0)
                                $(this).find('tbody').find('tr.empty-row').hide();
                            else
                                $(this).find('tbody').find('tr.empty-row').show();
                        });
                    }
                });
        }
    }

    // tree view table (seems like tree view)
    function bindAttachment(_productId, mode) {

        if (Number(_productId) > 0) {

            // Specify the Id of the Item that you want to fetch
            //$("table[id*='tblAttachment']").find('tbody').html('<tr class="empty-row"><td colspan="6">No attachment attachted!</td></tr>');

            //$("table[id*='tblAttachment_Renewal']").find('tbody').html('<tr class="empty-row"><td colspan="8">No attachment attachted!</td></tr>');

            var idFilter = "ProductLookupId eq " + _productId;


            var filterProducts = idFilter + "&$select=ID,Title,FileName,Stage,Created,ProductLookup/Id,ProductLookup/Title,FolderLookup/Id,FolderLookup/Title,IsCertificate,RenewalType,SubmissionDate,RegistrationDate,ExpiryDate&$expand=ProductLookup,FolderLookup";

            GetSPListItems("ProductAttachments", 0, filterProducts)
                .done(function (data) {

                    var response = data.d.results;

                    if (response.length > 0) {
                        $("table[id*='tblAttachment']").find('tbody').find('tr').not('.empty-row').remove();
                    }

                    for (var i = 0; i < response.length; i++) {

                        var _item = response[i];

                        var folderId = "none";
                        var folderTitle = _item["FolderLookup"].Title;
                        if (_item["FolderLookup"] && Number(_item["FolderLookup"].Id) > 0) {
                            folderId = _item["FolderLookup"].Id;
                        }

                        var newRow = "<tr id='" + _item["ID"] + "' data-folderid-file='" + folderId + "' style='/*display:none;*/'  class='file-row'> " +
                            "<td>&nbsp;" + "</td>";

                        var fileTitleWithPreview = "<a href='#' class='alert-link' onclick='viewDocument(" + _item.Id + ",\"" + _item.FileName + "\");'>" + _item["FileName"] + "</a>";

                        var tableId = "";

                        switch (_item.Stage) {
                            case 'Applied':
                                tableId = "#tblAttachment_Applied";

                                newRow = newRow +
                                    "<td><i class='glyphicon glyphicon-folder-open' style='color:#f0ad4e;margin-right: 8px;'></i>" + folderTitle + "</td>" +
                                    "<td><span class='attachemnt-file-index'>[index]</span>" + fileTitleWithPreview + "</td>" +
                                    "<td>" + toDisplayDate(_item["SubmissionDate"]) + "</td>";
                                //// Zafar: Remove IsCertificate from Applied Attachments
                                //"<td>" + (_item["IsCertificate"] == true ? 'Yes' : 'No') + "</td>";

                                break;
                            case 'Pre-Registration':
                                tableId = "#tblAttachment_PreRegistration";

                                newRow = newRow +
                                    "<td><i class='glyphicon glyphicon-folder-open' style='color:#f0ad4e;margin-right: 8px;'></i>" + folderTitle + "</td>" +
                                    "<td><span class='attachemnt-file-index'>[index]</span>" + fileTitleWithPreview + "</td>" +
                                    "<td>" + toDisplayDate(_item["SubmissionDate"]) + "</td>" +
                                    "<td>" + $("#txtDescription").val() + "</td>" +
                                    "<td>" + (_item["IsCertificate"] == true ? 'Yes' : 'No') + "</td>";
                                break;
                            case 'Registered':
                                tableId = "#tblAttachment_Registration";

                                newRow = newRow +
                                    "<td><i class='glyphicon glyphicon-folder-open' style='color:#f0ad4e;margin-right: 8px;'></i>" + folderTitle + "</td>" +
                                    "<td><span class='attachemnt-file-index' >[index]</span>" + fileTitleWithPreview + "</td>" +
                                    "<td>" + toDisplayDate(_item["RegistrationDate"]) + "</td>" +
                                    "<td>" + toDisplayDate(_item["ExpiryDate"]) + "</td>" +
                                    "<td>" + (_item["IsCertificate"] == true ? 'Yes' : 'No') + "</td>";
                                break;
                            case 'PRV':
                                tableId = "#tblAttachment_PRV";

                                newRow = newRow +
                                    "<td><i class='glyphicon glyphicon-folder-open' style='color:#f0ad4e;margin-right: 8px;'></i>" + folderTitle + "</td>" +
                                    "<td><span class='attachemnt-file-index' >[index]</span>" + fileTitleWithPreview + "</td>" +
                                    "<td>" + toDisplayDate(_item["SubmissionDate"]) + "</td>" +
                                    "<td>" + toDisplayDate(_item["RegistrationDate"]) + "</td>" +
                                    "<td>" + (_item["IsCertificate"] == true ? 'Yes' : 'No') + "</td>";
                                break;
                            case 'Renewal':
                                //tableId = "#tblAttachment_Renewal";
                                var dateRowsHtml = "";
                                if (_item.RenewalType && _item.RenewalType.length > 0 && _item.RenewalType.trim().toLowerCase() == 'Renewal Approved'.trim().toLowerCase()) {
                                    tableId = "#tblAttachment_RenewalApproved";

                                    dateRowsHtml = "<td>" + toDisplayDate(_item["RegistrationDate"]) + "</td>" +
                                        "<td>" + toDisplayDate(_item["ExpiryDate"]) + "</td>";
                                }
                                else {
                                    tableId = "#tblAttachment_RenewalApplied";

                                    dateRowsHtml = "<td>" + toDisplayDate(_item["SubmissionDate"]) + "</td>";
                                }

                                /*newRow = newRow +
                                    "<td>" + _item["FileName"] + "</td>" +
                                    "<td>" + _item["RenewalType"] + "</td>" +
                                    "<td>" + (_item["SubmissionDate"] == null ? '-' : toDisplayDate(_item["SubmissionDate"])) + "</td>" +
                                    "<td>" + (_item["RegistrationDate"] == null ? '-' : toDisplayDate(_item["RegistrationDate"])) + "</td>" +
                                    "<td>" + (_item["ExpiryDate"] == null ? '-' : toDisplayDate(_item["ExpiryDate"])) + "</td>" +
                                    "<td>" + toDisplayDate(_item["Created"]) + "</td>";
                                    */

                                newRow = newRow +
                                    "<td><i class='glyphicon glyphicon-folder-open' style='color:#f0ad4e;margin-right: 8px;'></i>" + folderTitle + "</td>" +
                                    "<td><span class='attachemnt-file-index'>[index]</span>" + fileTitleWithPreview + "</td>" +
                                    dateRowsHtml +
                                    "<td>" + (_item["IsCertificate"] == true ? 'Yes' : 'No') + "</td>";

                                break;
                            default:
                                break;
                        }

                        var _actionButtonHTML = "";

                        if (havePremission(Permission.DOWNLOAD, Module.ProductManagement, $("#ddlCountry").val()) == true) {
                        
                       
                        if(globalStatus =="Send For Approval" || globalStatus =="Approved"){
                        if(checkUserTypeForAttachment== "Admin"){
                            _actionButtonHTML = _actionButtonHTML + "<a href='#'  title='Delete'  onclick='deleteProductAttachment(" + _item.Id + ")' class='m-5' ><i class='glyphicon glyphicon-trash'></i></a>";
                       
                        }
                        }else if(globalStatus =="On Hold"){
                            _actionButtonHTML = _actionButtonHTML + "<a href='#'  title='Delete'  onclick='deleteProductAttachment(" + _item.Id + ")' class='m-5' ><i class='glyphicon glyphicon-trash'></i></a>";
                            
                        }
                        }
                        if (havePremission(Permission.DOWNLOAD, Module.ProductManagement, $("#ddlCountry").val()) == true) {
                        
                            _actionButtonHTML = _actionButtonHTML + "<a href='#'  title='Download'  onclick='downloadDocument(" + _item.Id + ")' class='m-5' ><i class='glyphicon glyphicon-download'></i></a>";
                        }

                        if (mode != 'view' && havePremission(Permission.UPLOAD, Module.ProductManagement, $("#ddlCountry").val()) == true) {
                           // _actionButtonHTML = _actionButtonHTML + "<a href='#'  title='Delete'  onclick='deleteProductAttachment(" + _item.Id + ")' class='m-5' ><i class='glyphicon glyphicon-trash'></i></a>";
                        }

                        if (havePremission(Permission.Share, Module.ProductManagement, $("#ddlCountry").val()) == true) {
                            _actionButtonHTML = _actionButtonHTML + "&nbsp;<a id='btnShareIt_" + _item.Id + "' href='#' onclick=\"openShareWindow(" + _item.Id + "," + _item.Id + ",'" + _item["FileName"] + "');\"  title='Share'><i class='glyphicon glyphicon-share'></i></a> ";
                        }


                        newRow = newRow + "<td align='center' style='text-align:center;' class='h5'>" + _actionButtonHTML + "</td>";
                        newRow = newRow + "</tr>";



                        if (tableId.length > 0) {



                            var folderrow = $(tableId + '>tbody').find("tr[data-folderid-folder='" + folderId + "']");
                            if (Number(folderId) > 0 && folderrow && folderrow.length == 0) {

                                var colspanName = $(tableId + '>thead').find('th').length - 2;

                                var newFolderRow = "<tr id='folder_" + _item["ID"] + "' data-folderid-folder='" + folderId + "' onclick='expandableRows(this)' class='folder-row'> " +
                                    "<td><i class='glyphicon glyphicon-triangle-bottom expand-icon'></i></td><td>" + folderTitle + "</td><td colspan='" + colspanName + "' class='expandable'><strong><i class='glyphicon glyphicon-folder-open attachemnt-folder-icon' style='color:#f0ad4e;'></i>" + folderTitle + "</strong></td>" +
                                    "</tr>";

                                $(tableId + '>tbody').append(newFolderRow);

                                folderrow = $(tableId + '>tbody').find("tr[data-folderid-folder='" + folderId + "']");
                            }


                            var _rowIndex = $(tableId + '>tbody').find("tr[data-folderid-file='" + folderId + "']").not('.empty-row').length + 1;
                            newRow = newRow.replace(/\[index\]/g, _rowIndex);

                            if (folderrow && folderrow.length > 0) {
                                var folderfilesrow = $(tableId + '>tbody').find("tr[data-folderid-file='" + folderId + "']").last();

                                newRow = newRow.replace("attachemnt-file-index", "attachemnt-file-index-infolder");

                                if (folderfilesrow && folderfilesrow.length > 0) {
                                    folderfilesrow.after(newRow);
                                } else {
                                    folderrow.after(newRow);
                                }
                            } else {

                                $(tableId + '>tbody').append(newRow);
                            }

                            $(tableId).find('tr').each(function () {
                                $(this).find('th,td').eq(1).hide();
                            });
                        }
                    }

                    var allTables = $("table[id*='tblAttachment']");
                    if (allTables != null && allTables) {
                        allTables.each(function () {
                            if ($(this).find('tbody').find('tr').not('.empty-row').length > 0)
                                $(this).find('tbody').find('tr.empty-row').hide();
                            else
                                $(this).find('tbody').find('tr.empty-row').show();
                        });
                    }
                });
        }
    }

    function expandableRows(_row) {
        var _folderId = $(_row).data('folderid-folder');
        //$(_row).parents("table").find("[data-folderid-file='" + _folderId + "']").toggle('fast');                    
        $(_row.parentElement.parentElement).find("[data-folderid-file='" + _folderId + "']").toggle('fast');

        if ($(_row).find(".expand-icon").hasClass('glyphicon-triangle-bottom') == true) {
            $(_row).find(".expand-icon").removeClass('glyphicon-triangle-bottom');
            $(_row).find(".expand-icon").addClass('glyphicon-triangle-right');
        } else {
            $(_row).find(".expand-icon").addClass('glyphicon-triangle-bottom');
            $(_row).find(".expand-icon").removeClass('glyphicon-triangle-right');
        }

    }

    function bindProductQuery(_productId, mode) {

        if (Number(_productId) > 0) {

            // Specify the Id of the Item that you want to fetch
            $('#tblQuery>tbody').html('<tr><td colspan="5">No query attachted!</td></tr>');

            var idFilter = "ProductLookupId eq " + _productId;


            var filterProducts = idFilter + "&$select=ID,Title,QueryDescription,Created,Attachments";

            GetSPListItems("ProductQuery", 0, filterProducts)
                .done(function (data) {

                    var response = data.d.results;

                    if (response.length > 0) {
                        $('#tblQuery>tbody').html('');
                    }

                    for (var i = 0; i < response.length; i++) {

                        var _item = response[i];

                        var newRow = "<tr id='" + _item["ID"] + "'>" +

                            "<td>" + (i + 1) + "</td>" +
                            "<td>" + toDisplayDateTime(_item["Created"]) + "</td>" +
                            "<td>" + _item["Title"] + "</td>" +
                            "<td>" + _item["QueryDescription"] + "</td>";

                        var _filesHTML = "";//"<li><a href='#'  title='Delete'  onclick='deleteProductAttachment(" + _item.Id + ")' ><i class='glyphicon glyphicon-trash'></i></a></li>";


                        newRow = newRow + "<td  class='h5'><ol>" + _filesHTML + "</ol></td>";
                        newRow = newRow + "</tr>";

                        $('#tblQuery>tbody').append(newRow);

                        bindAttachmentsInItem("ProductQuery", _item.Id);
                    }

                });
        }
    }

    function bindAttachmentsInItem(listName, id) {

        var apiURL = _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('" + listName + "')/items(" + id + ")/AttachmentFiles?pqid=" + id;

        $.ajax({
            url: apiURL,
            type: "GET",
            async: true,
            headers: {
                "Accept": "application/json; odata=verbose",
            },
            success: function (data) {
                var attachmentResponse = data.d.results;
                if (attachmentResponse.length > 0) {
                    var _queryId = attachmentResponse[0].__metadata.id.split('/Items(');
                    //"https:/ /iblgrouppk.sharepoint.com/sites/SearimsTest/_api/Web/Lists(guid'1dd329a2-9da8-469f-9148-8e5cd670a032')/Items(1)/AttachmentFiles('OBS Test 6-16-7-32.pdf')".substr(110)


                    _queryId = _queryId[1].substring(0, _queryId[1].indexOf(')'));

                    var _queryRow = $('#tblQuery>tbody').find("tr[id='" + _queryId + "']");

                    for (var i = 0; i < attachmentResponse.length; i++) {

                        var _filesHTML = "<li><a href=\"" + attachmentResponse[i].ServerRelativeUrl + "\" target='_blank' >" + attachmentResponse[i].FileName + "</a></li>";
                        //var _filesHTML = "<li>" + attachmentResponse[i].FileName + "</li>";


                        _queryRow.find('ol').append(_filesHTML);

                    }
                }
            },
            error: function (error) {
            }
        });

    }


    function bindActionHistory(_productId) {
        // Specify the Id of the Item that you want to fetch
        $('#tblActionHistory>tbody').html('');

        if (Number(_productId) > 0) {
            var filterNomenclature = "ProductLookupId eq " + _productId + " and Module eq '" + Module.ProductManagement + "'&$select=ID,Title,ActionName,Comments,Created,Author/Title&$expand=Author&$orderby=Id desc";
            GetSPListItems("ActionLogs", 0, filterNomenclature)
                .done(function (data) {
                    var response = data.d.results;
                    for (var i = 0; i < response.length; i++) {
                        var _item = response[i];

                        var newRow = "<tr id='" + _item["ID"] + "'>" +
                            "<td>" + toDisplayDateTime(_item["Created"]) + "</td>" +
                            "<td>" + toDisplayName(_item["Author"].Title) + "</td>" +
                            "<td>" + _item["ActionName"] + "</td>" +
                            "<td>" + (_item["Comments"] == null ? "" : _item["Comments"]) + "</td>" +
                            "</tr>";

                        $('#tblActionHistory>tbody').append(newRow);
                        $('#divActionLogs').show();

                    }
                });
        }
    }


    function bindProductTrail(_id, _currentItem) {
        // Specify the Id of the Item that you want to fetch

        $('#tblProductTrail>tbody').html('');
        if (Number(_id) > 0) {


            //var _mrpButtonHTMLEmpty = "<span ><i class='glyphicon glyphicon-minus-sign'></i></span>";
            var _mrpButtonHTMLEmpty = "<span ><i class='glyphicon '></i></span>";
            var _mrpButtonHTML = "<span onclick='expandMRP(this)'><i class='glyphicon glyphicon-plus-sign'></i></span>";

            var _prvButtonHTML = "<span id='btnPRVExpender' onclick='expandPRV(this)' style='display:none;'><i class='glyphicon glyphicon-plus-sign '></i></span>";

            var newRowMRPTableTemplate = "<table class='table table-striped small no-margin' style='width: 100%'>" +
                "<thead class=''>" +
                "<tr>" +
                "<th class='th-sm'>#</th>" +
                "<th class='th-sm'>Pack Size</th>" +
                /*"<th class='th-sm'>Packaging Type</th>" +
                "<th class='th-sm'>Strength</th>" +
                "<th class='th-sm'>Shelf Life</th>" +*/
                "<th class='th-sm'>MRP</th>" +
                "<th class='th-sm'>Marketed MRP</th>" +
                "<th class='th-sm'>MRP Implementation</th>" +
                "</tr>" +
                "</thead>" +
                "<tbody>[MRPRowsHere]</tbody>" +
                "</table>";


            var _prvTableTemplate = "<table id='tblprv_" + "[PRVTableIDHere]" + "' [RenewalIDAttrHere] class='table table-hove' style='border:5px;'> " + "<thead class='thead-light'><tr>" + "<th class='th-sm'> Product </th>" + "<th class='th-sm'> App.Date </th>" + "<th class='th-sm'> Strength </th>" + "<th class='th-sm'> Shelf Life </th>" + "<th class='th-sm'> Details </th>" + "<th class='th-sm'> Prv Status </th>" +
                "</tr></thead><tbody></tbody></table>";



            //#region CurrentStatus Line Item


            if (havePremission(Permission.DossierTrail_PRCReport, Module.ProductManagement, _currentItem["CountryLookupId"]) == true) {
                var _currentTrailRenewalOrderText = "";
                if (Number(_currentItem["RenewalOrderLookupId"]) > 0) {
                    GetSPListItems("Renewedorder", _currentItem["RenewalOrderLookupId"], "", false)
                        .done(function (data2) {
                            if (data2 && data2.d) {
                                _currentTrailRenewalOrderText = data2.d.Title;
                            }
                        });
                }


                if (_currentItem["Stage"] != "PRV") {

                    //var newRow = "<tr id='Trail_0" + _currentItem["ID"] + "' data-RenewalOrderLookupId='" + _currentItem["RenewalOrderLookupId"] + "'>";


                    //var newRowMRPTable = newRowMRPTableTemplate;

                    //var newRowMRPRows = "";

                    //var _selfLiftAppliedText = (Number(_currentItem["ShelfLifeLookupId"]) > 0 ? $("#ddlShelfLife").find("option[value='" + _currentItem["ShelfLifeLookupId"] + "']").text() : "-");
                    //if (Number(_currentItem["Registration_ShelfLifeLookupId"]) > 0) {
                    //    _selfLiftAppliedText = (Number(_currentItem["Registration_ShelfLifeLookupId"]) > 0 ? $("#ddlShelfLife").find("option[value='" + _currentItem["Registration_ShelfLifeLookupId"] + "']").text() : "-");
                    //}

                    //if (_currentItem["Stage"] == "Applied") {

                    //    newRow = newRow + "<td>" + "1" + "</td>" +
                    //        "<td>" + ((_currentItem["Title"] != null) ? _currentItem["Title"] : "-") + "</td>" +
                    //        "<td>" + ((_currentItem["Generic"] != null) ? _currentItem["Generic"] : "-") + "</td>" +
                    //        "<td>" + ((_currentItem["SubmissionDate"] != null) ? toDisplayDate(_currentItem["SubmissionDate"]) : "-") + "</td>" +
                    //        "<td>" + "-" + "</td>" +
                    //        "<td>" + "-" + "</td>" +
                    //        "<td>" + "Applied" + "</td>" +
                    //        "<td>" + _selfLiftAppliedText + "</td>" +
                    //        "<td>" + _mrpButtonHTML + "</td>" +
                    //        "<td>" + ((_currentItem["MarketedStatus"] != null) ? _currentItem["MarketedStatus"] : "-") + "</td>" +
                    //        "<td>" + ((_currentItem["Registration_RegistrationNo"] != null) ? _currentItem["Registration_RegistrationNo"] : "-") + "</td>";


                    //    newRowMRPRows = "";

                    //    var _mrpFilter = "ProductLookupId eq " + _currentItem["Id"] + " and Stage ne 'Registered'";

                    //    var _mrpQuery = _mrpFilter + "&$select=ID,Title,PackSize,Shelf,MRP,MarketedMRP,MRPImplementationDate,Strength,PackagingType,SAP,ProductLookupId,Stage,ShelfLifeLookup/Id,ShelfLifeLookup/Title&$expand=ShelfLifeLookup";
                    //    //GetSPListItems("ProductPackSize", 0, _mrpQuery, false)
                    //    GetSPListItems("ProductPackSize", 0, _mrpQuery, true)
                    //        .done(function (data2) {
                    //            var response2 = data2.d.results;
                    //            for (var j = 0; j < response2.length ; j++) {
                    //                var _item2 = response2[j];
                    //                var newRow2 = "<tr id='" + _item2["ID"] + "'>" +
                    //                    "<td>" + "[RowIndex]" + "</td>" +
                    //                    "<td>" + _item2["PackSize"] + "</td>" +
                    //                  /*  "<td>" + _item2["PackagingType"] + "</td>" +
                    //                    "<td>" + _item2["Strength"] + "</td>" +
                    //                    "<td>" + (_item2["ShelfLifeLookup"] && typeof (_item2["ShelfLifeLookup"].Title) != 'undefined' ? _item2["ShelfLifeLookup"].Title : "") + "</td>" +*/
                    //                    "<td>" + _item2["MRP"] + "</td>" +
                    //                    "<td>" + (_item2["MarketedMRP"] ? _item2["MarketedMRP"] : "") + "</td>" +
                    //                    "<td>" + toDisplayDate(_item2["MRPImplementationDate"]) + "</td>" +
                    //                    "</tr>";

                    //                newRowMRPRows = newRowMRPRows + newRow2.replace(/\[RowIndex\]/g, (j + 1));
                    //            }
                    //        });

                    //}
                    //else if (_currentItem["Stage"] == "Registered") {

                    //    newRow = newRow + "<td>" + "1" + "</td>" +
                    //        "<td>" + ((_currentItem["Title"] != null) ? _currentItem["Title"] : "-") + "</td>" +
                    //        "<td>" + ((_currentItem["Generic"] != null) ? _currentItem["Generic"] : "-") + "</td>" +
                    //        "<td>" + "-" + "</td>" +
                    //        "<td>" + ((_currentItem["Registration_DateOfRegistration"] != null) ? toDisplayDate(_currentItem["Registration_DateOfRegistration"]) : "-") + "</td>" +
                    //        "<td>" + ((_currentItem["Registration_ExpiryDate"] != null) ? toDisplayDate(_currentItem["Registration_ExpiryDate"]) : "-") + "</td>" +
                    //        "<td>" + "Registered" + "</td>" +
                    //        "<td>" + _selfLiftAppliedText + "</td>" +
                    //        "<td>" + _mrpButtonHTML + "</td>" + //_item["MarketedMRP"]
                    //        "<td>" + ((_currentItem["MarketedStatus"] != null) ? _currentItem["MarketedStatus"] : "-") + "</td>" +
                    //        "<td>" + ((_currentItem["Registration_RegistrationNo"] != null) ? _currentItem["Registration_RegistrationNo"] : "-") + "</td>";

                    //    newRowMRPRows = "";

                    //    var _mrpFilter = "ProductLookupId eq " + _currentItem["Id"] + " and Stage eq 'Registered'";

                    //    var _mrpQuery = _mrpFilter + "&$select=ID,Title,PackSize,Shelf,MRP,MarketedMRP,MRPImplementationDate,Strength,PackagingType,SAP,ProductLookupId,Stage,ShelfLifeLookup/Id,ShelfLifeLookup/Title&$expand=ShelfLifeLookup";
                    //    //GetSPListItems("ProductPackSize", 0, _mrpQuery, false)
                    //    GetSPListItems("ProductPackSize", 0, _mrpQuery, true)
                    //        .done(function (data2) {
                    //            var response2 = data2.d.results;
                    //            for (var j = 0; j < response2.length ; j++) {
                    //                var _item2 = response2[j];
                    //                var newRow2 = "<tr id='" + _item2["ID"] + "'>" +
                    //                    "<td>" + "[RowIndex]" + "</td>" +
                    //                    "<td>" + _item2["PackSize"] + "</td>" +
                    //                    /*"<td>" + _item2["PackagingType"] + "</td>" +
                    //                    "<td>" + _item2["Strength"] + "</td>" +
                    //                    "<td>" + (_item2["ShelfLifeLookup"] && typeof (_item2["ShelfLifeLookup"].Title) != 'undefined' ? _item2["ShelfLifeLookup"].Title : "") + "</td>" +*/
                    //                    "<td>" + _item2["MRP"] + "</td>" +
                    //                    "<td>" + (_item2["MarketedMRP"] ? _item2["MarketedMRP"] : "") + "</td>" +
                    //                    "<td>" + toDisplayDate(_item2["MRPImplementationDate"]) + "</td>" +
                    //                    "</tr>";

                    //                newRowMRPRows = newRowMRPRows + newRow2.replace(/\[RowIndex\]/g, (j + 1));
                    //            }
                    //        });

                    //}
                    //else if (_currentItem["Stage"] == "PRV") {

                    //    newRow = newRow + "<td>" + "1" + "</td>" +
                    //        "<td>" + ((_currentItem["PRV_ProductName"] != null) ? _currentItem["PRV_ProductName"] : "-") + "</td>" +
                    //        "<td>" + ((_currentItem["Generic"] != null) ? _currentItem["Generic"] : "-") + "</td>" +
                    //        "<td>" + "-" + "</td>" +
                    //        "<td>" + "-" + "</td>" +
                    //        "<td>" + "-" + "</td>" +
                    //        "<td>" + _currentTrailRenewalOrderText + "</td>" +
                    //        "<td>" + _selfLiftAppliedText + "</td>" +
                    //        "<td>" + _mrpButtonHTMLEmpty + "</td>" +
                    //        "<td>" + "-" + "</td>" +
                    //        "<td>" + "-" + "</td>";

                    //}
                    //else if (_currentItem["Stage"] == "Renewal") {

                    //    newRow = newRow + "<td>" + "1" + "</td>" +
                    //        "<td>" + ((_currentItem["Title"] != null) ? _currentItem["Title"] : "-") + "</td>" +
                    //        "<td>" + ((_currentItem["Generic"] != null) ? _currentItem["Generic"] : "-") + "</td>" +
                    //        "<td>" + ((_currentItem["Renewal_SubmissionDate"] != null) ? toDisplayDate(_currentItem["Renewal_SubmissionDate"]) : "-") + "</td>" +
                    //        "<td>" + ((_currentItem["Renewal_RegistrationDate"] != null) ? toDisplayDate(_currentItem["Renewal_RegistrationDate"]) : "-") + "</td>" +
                    //        "<td>" + ((_currentItem["Renewal_ExpiryDate"] != null) ? toDisplayDate(_currentItem["Renewal_ExpiryDate"]) : "-") + "</td>" +
                    //        "<td>" + _currentTrailRenewalOrderText + " (" + _currentItem.RenewalType + ")" + "</td>" +
                    //        "<td>" + _selfLiftAppliedText + "</td>" +
                    //        "<td>" + _mrpButtonHTMLEmpty + "</td>" +
                    //        "<td>" + ((_currentItem["MarketedStatus"] != null) ? _currentItem["MarketedStatus"] : "-") + "</td>" +
                    //        "<td>" + ((_currentItem["Registration_RegistrationNo"] != null) ? _currentItem["Registration_RegistrationNo"] : "-") + "</td>";

                    //}
                    ///*else {

                    //    newRow = newRow + "<td>" + "1" + "</td>" +
                    //        "<td>" + ((_currentItem["Title"] != null) ? _currentItem["Title"] : "-") + "</td>" +
                    //        "<td>" + ((_currentItem["Generic"] != null) ? _currentItem["Generic"] : "-") + "</td>" +
                    //        "<td>" + ((_currentItem["SubmissionDate"] != null) ? toDisplayDate(_currentItem["SubmissionDate"]) : "-") + "</td>" +
                    //        "<td>" + ((_currentItem["Registration_DateOfRegistration"] != null) ? toDisplayDate(_currentItem["Registration_DateOfRegistration"]) : "-") + "</td>" +
                    //        "<td>" + ((_currentItem["Registration_ExpiryDate"] != null) ? toDisplayDate(_currentItem["Registration_ExpiryDate"]) + "</td>" : "-") +
                    //        "<td>" + "-" + "</td>" +
                    //        "<td>" + _selfLiftAppliedText + "</td>" +
                    //        "<td>" + _mrpButtonHTMLEmpty + "</td>" +
                    //        "<td>" + ((_currentItem["MarketedStatus"] != null) ? _currentItem["MarketedStatus"] : "-") + "</td>" +
                    //        "<td>" + ((_currentItem["Registration_RegistrationNo"] != null) ? _currentItem["Registration_RegistrationNo"] : "-") + "</td>";

                    //}*/
                    //if (newRow.search("<td>") > 0) {

                    //    newRow = newRow + "</tr>";

                    //    if (newRowMRPRows.length == 0) {
                    //        newRowMRPTable = newRowMRPTable.replace("[MRPRowsHere]", "<tr><td colspan='6'>No packaging defined!</td></tr>");
                    //    } else {
                    //        newRowMRPTable = newRowMRPTable.replace("[MRPRowsHere]", newRowMRPRows);
                    //    }

                    //    var newRowMRPTableRow = "<tr id='MRP_" + _currentItem["ID"] + "' style='display:none;'><td></td><td></td><td colspan='9'>" + newRowMRPTable + "</td></tr>";

                    //    newRow = newRow + newRowMRPTableRow;

                    //    $('#tblProductTrail>tbody').append(newRow);
                    //}
                }

                //#endregion CurrentStatus Line Item

                //#region Previous Trails 

                var _trailFilter = "ProductLookupId eq " + _id;

                var _trailQuery = _trailFilter + "&$select=ProductLookupId,ID,Title,Generic,PackType,Strength,MarketedStatus,SubmissionDate,Status,Stage,RenewalType," +
                    "CountryLookupId," +
                    "ShelfLifeLookup/Id,ShelfLifeLookup/Title," +
                    "Created,IsDeleted," +
                    "Registration_DateOfRegistration,Registration_ExpiryDate,Registration_ShelfLifeLookup/Id,Registration_ShelfLifeLookup/Title,Registration_RegistrationNo,MarketedMRP," +
                    "PRV_ProductName,PRV_ShelfLifeLookup/Id,PRV_ShelfLifeLookup/Title,PRV_ApplicationDetails,PRV_Type,PRV_Date,PRV_Strength,PRV_Remarks," +
                    "Renewal_SubmissionDate,Renewal_RegistrationDate,Renewal_ExpiryDate," +
                    "RenewalOrderLookup/Id,RenewalOrderLookup/Title" +
                    "&$expand=ShelfLifeLookup,Registration_ShelfLifeLookup,PRV_ShelfLifeLookup,RenewalOrderLookup&$orderby=Id desc";


                GetSPListItems("ProductTrails", 0, _trailQuery, false)
                    .done(function (data) {

                        var response = data.d.results;
                        for (var i = 0; i < response.length; i++) {

                            var _item = response[i];


                            //if (havePremission(Permission.DossierTrail_PRCReport, Module.ProductManagement, _item["CountryLookupId"]) == true)
                            {


                                if (_item["Stage"] != "PRV") {


                                    /*var _statusText = 'In-Active';
 
                                    if (_item.IsActive)
                                        _statusText = (_item.IsActive == true ? 'Active' : 'In-Active');
                                        */

                                    var stageTxt = _item["Stage"];
                                    if (stageTxt == "Renewal" && _item.RenewalType && _item.RenewalType.length > 0) {
                                        stageTxt = (_item["RenewalOrderLookup"] && _item["RenewalOrderLookup"].Title ? _item["RenewalOrderLookup"].Title : " - ") + " (" + _item.RenewalType + ")";
                                    } else {
                                        stageTxt = stageTxt + " | " + (_item["RenewalOrderLookup"] && _item["RenewalOrderLookup"].Title ? _item["RenewalOrderLookup"].Title : " - ")
                                    }

                                    var newRowMRPRows = "";
                                    var newRowMRPTable = newRowMRPTableTemplate;
                                    var rowStartIndexNumber = 2;

                                    var renewalIdAttr = "data-RenewalOrderLookupId='" + (_item["RenewalOrderLookup"] && _item["RenewalOrderLookup"].Id ? _item["RenewalOrderLookup"]["Id"] : "") + "'";


                                    //if (_item["Stage"] == "Renewal") {
                                    if (_item.RenewalType != null && _item.RenewalType.length > 0) {
                                        renewalIdAttr = renewalIdAttr + " data-RenewalType='" + _item.RenewalType + "'";
                                    }

                                    var newRow = "<tr id='Trail_" + _item["ID"] + "' " + renewalIdAttr + ">";




                                    if (_item["Stage"] == "Applied") {

                                        newRow = newRow + "<td>" + "[MainRowIndex]" + " &nbsp;[PRVRowsExpenderHere]</td>" +
                                            "<td>" + ((_item["Title"] != null) ? _item["Title"] : "-") + "</td>" +
                                            "<td>" + ((_item["Generic"] != null) ? _item["Generic"] : "-") + "</td>" +
                                            "<td>" + ((_item["SubmissionDate"] != null) ? toDisplayDate(_item["SubmissionDate"]) : "-") + "</td>" +
                                            "<td>" + "-" + "</td>" +
                                            "<td>" + "-" + "</td>" +
                                            "<td>" + stageTxt + "</td>" +
                                            "<td>" + ((_item["ShelfLifeLookup"] != null && _item["ShelfLifeLookup"].Title) ? _item["ShelfLifeLookup"].Title : "-") + "</td>" +
                                            "<td>" + "[MRPRowsExpenderHere]" + "</td>" +
                                            "<td>" + ((_item["MarketedStatus"] != null) ? _item["MarketedStatus"] : "-") + "</td>" +
                                            "<td>" + "" + "</td>";
                                        //"<td>" + ((_item["Registration_RegistrationNo"] != null) ? _item["Registration_RegistrationNo"] : "-") + "</td>";


                                        newRowMRPRows = "";

                                        var _mrpFilter = "ProductLookupId eq " + _item["ProductLookupId"] + " and Stage ne 'Registered'";

                                        var _mrpQuery = _mrpFilter + "&$select=ID,Title,PackSize,Shelf,MRP,MarketedMRP,MRPImplementationDate,Strength,PackagingType,SAP,ProductLookupId,Stage,ShelfLifeLookup/Id,ShelfLifeLookup/Title&$expand=ShelfLifeLookup";
                                        //GetSPListItems("ProductPackSize", 0, _mrpQuery, false)
                                        GetSPListItems("ProductPackSize", 0, _mrpQuery, false)
                                            .done(function (data2) {
                                                var response2 = data2.d.results;
                                                for (var j = 0; j < response2.length; j++) {
                                                    var _item2 = response2[j];
                                                    var newRow2 = "<tr id='" + _item2["ID"] + "'>" +
                                                        "<td>" + "[RowIndex]" + "</td>" +
                                                        "<td>" + _item2["PackSize"] + "</td>" +
                                                        /*  "<td>" + _item2["PackagingType"] + "</td>" +
                                                          "<td>" + _item2["Strength"] + "</td>" +
                                                          "<td>" + (_item2["ShelfLifeLookup"] && typeof (_item2["ShelfLifeLookup"].Title) != 'undefined' ? _item2["ShelfLifeLookup"].Title : "") + "</td>" +*/
                                                        "<td>" + _item2["MRP"] + "</td>" +
                                                        "<td>" + (_item2["MarketedMRP"] ? _item2["MarketedMRP"] : "") + "</td>" +
                                                        "<td>" + toDisplayDate(_item2["MRPImplementationDate"]) + "</td>" +
                                                        "</tr>";

                                                    newRowMRPRows = newRowMRPRows + newRow2.replace(/\[RowIndex\]/g, (j + 1));
                                                }
                                            });

                                    }
                                    else if (_item["Stage"] == "Registered") {

                                        newRow = newRow + "<td>" + "[MainRowIndex]" + " &nbsp;[PRVRowsExpenderHere]</td>" +
                                            "<td>" + ((_item["Title"] != null) ? _item["Title"] : "-") + "</td>" +
                                            "<td>" + ((_item["Generic"] != null) ? _item["Generic"] : "-") + "</td>" +
                                            "<td>" + ((_item["SubmissionDate"] != null) ? toDisplayDate(_item["SubmissionDate"]) : "-") + "</td>" +
                                            "<td>" + ((_item["Registration_DateOfRegistration"] != null) ? toDisplayDate(_item["Registration_DateOfRegistration"]) : "-") + "</td>" +
                                            "<td>" + ((_item["Registration_ExpiryDate"] != null) ? toDisplayDate(_item["Registration_ExpiryDate"]) : "-") + "</td>" +
                                            "<td>" + stageTxt + "</td>" +
                                            "<td>" + ((_item["Registration_ShelfLifeLookup"] != null && _item["Registration_ShelfLifeLookup"].Title) ? _item["Registration_ShelfLifeLookup"].Title : "-") + "</td>" +
                                            "<td>" + "[MRPRowsExpenderHere]" + "</td>" + //_item["MarketedMRP"]
                                            "<td>" + ((_item["MarketedStatus"] != null) ? _item["MarketedStatus"] : "-") + "</td>" +
                                            "<td>" + ((_item["Registration_RegistrationNo"] != null) ? _item["Registration_RegistrationNo"] : "-") + "</td>";

                                        newRowMRPRows = "";

                                        var _mrpFilter = "ProductLookupId eq " + _item["ProductLookupId"] + " and Stage eq 'Registered'";

                                        var _mrpQuery = _mrpFilter + "&$select=ID,Title,PackSize,Shelf,MRP,MarketedMRP,MRPImplementationDate,Strength,PackagingType,SAP,ProductLookupId,Stage,ShelfLifeLookup/Id,ShelfLifeLookup/Title&$expand=ShelfLifeLookup";
                                        //GetSPListItems("ProductPackSize", 0, _mrpQuery, false)
                                        GetSPListItems("ProductPackSize", 0, _mrpQuery, false)
                                            .done(function (data2) {
                                                var response2 = data2.d.results;
                                                for (var j = 0; j < response2.length; j++) {
                                                    var _item2 = response2[j];
                                                    var newRow2 = "<tr id='" + _item2["ID"] + "'>" +
                                                        "<td>" + "[RowIndex]" + "</td>" +
                                                        "<td>" + _item2["PackSize"] + "</td>" +
                                                        /*"<td>" + _item2["PackagingType"] + "</td>" +
                                                        "<td>" + _item2["Strength"] + "</td>" +
                                                        "<td>" + (_item2["ShelfLifeLookup"] && typeof (_item2["ShelfLifeLookup"].Title) != 'undefined' ? _item2["ShelfLifeLookup"].Title : "") + "</td>" +*/
                                                        "<td>" + _item2["MRP"] + "</td>" +
                                                        "<td>" + (_item2["MarketedMRP"] ? _item2["MarketedMRP"] : "") + "</td>" +
                                                        "<td>" + toDisplayDate(_item2["MRPImplementationDate"]) + "</td>" +
                                                        "</tr>";

                                                    newRowMRPRows = newRowMRPRows + newRow2.replace(/\[RowIndex\]/g, (j + 1));
                                                }
                                            });

                                    }
                                    else if (_item["Stage"] == "Renewal") {

                                        newRow = newRow + "<td>" + "[MainRowIndex]" + " &nbsp;[PRVRowsExpenderHere]</td>" +
                                            "<td>" + ((_item["Title"] != null) ? _item["Title"] : "-") + "</td>" +
                                            "<td>" + ((_item["Generic"] != null) ? _item["Generic"] : "-") + "</td>" +
                                            "<td>" + ((_item["Renewal_SubmissionDate"] != null) ? toDisplayDate(_item["Renewal_SubmissionDate"]) : "-") + "</td>" +
                                            "<td>" + ((_item["Renewal_RegistrationDate"] != null) ? toDisplayDate(_item["Renewal_RegistrationDate"]) : "-") + "</td>" +
                                            "<td>" + ((_item["Renewal_ExpiryDate"] != null) ? toDisplayDate(_item["Renewal_ExpiryDate"]) : "-") + "</td>" +
                                            "<td>" + stageTxt + "</td>" +
                                            "<td>" + ((_item["Registration_ShelfLifeLookup"] != null && _item["Registration_ShelfLifeLookup"].Title) ? _item["Registration_ShelfLifeLookup"].Title : "-") + "</td>" +
                                            "<td>" + "[MRPRowsExpenderHere]" + "</td>" +
                                            "<td>" + ((_item["MarketedStatus"] != null) ? _item["MarketedStatus"] : "-") + "</td>" +
                                            "<td>" + ((_item["Registration_RegistrationNo"] != null) ? _item["Registration_RegistrationNo"] : "-") + "</td>";

                                    }
                                    /*else {

                                        newRow = newRow + "<td>" + "[MainRowIndex]" + " &nbsp;[PRVRowsExpenderHere]</td>" +
                                            "<td>" + ((_item["Title"] != null) ? _item["Title"] : "-") + "</td>" +
                                            "<td>" + ((_item["Generic"] != null) ? _item["Generic"] : "-") + "</td>" +
                                            "<td>" + ((_item["SubmissionDate"] != null) ? toDisplayDate(_item["SubmissionDate"]) : "-") + "</td>" +
                                            "<td>" + ((_item["Registration_DateOfRegistration"] != null) ? toDisplayDate(_item["Registration_DateOfRegistration"]) : "-") + "</td>" +
                                            "<td>" + ((_item["Registration_ExpiryDate"] != null) ? toDisplayDate(_item["Registration_ExpiryDate"]) + "</td>" : "-") +
                                            "<td>" + stageTxt + "</td>" +
                                            "<td>" + ((_item["Registration_ShelfLifeLookup"]) ? _item["Registration_ShelfLifeLookup"].Title : "") + "</td>" +
                                            "<td>" + "[MRPRowsExpenderHere]" + "</td>" +
                                            "<td>" + ((_item["MarketedStatus"] != null) ? _item["MarketedStatus"] : "-") + "</td>" +
                                            "<td>" + ((_item["Registration_RegistrationNo"] != null) ? _item["Registration_RegistrationNo"] : "-") + "</td>";

                                    }*/


                                    if (newRow.search("<td>") > 0) {

                                        newRow = newRow + "</tr>";

                                        /*//// PRV Table Row   */

                                        if (_item["Stage"] != "PRV") {
                                            var _prvTableHTML = _prvTableTemplate.replace(/\[PRVTableIDHere\]/g, _item["ID"]).replace(/\[RenewalIDAttrHere\]/g, renewalIdAttr);

                                            var newRowPRVTableRow = "<tr id='PRV_" + _item["ID"] + "' style='display:none;' " + renewalIdAttr + "><td></td><td></td><td colspan='9'>" + _prvTableHTML + "</td></tr>";

                                            newRow = newRow + newRowPRVTableRow;
                                        }

                                        newRow = newRow.replace("[PRVRowsExpenderHere]", _prvButtonHTML);

                                        /*//// End PVR Table Row  */

                                        if (newRowMRPRows.length == 0) {
                                            newRow = newRow.replace("[MRPRowsExpenderHere]", _mrpButtonHTMLEmpty);
                                            newRowMRPTable = newRowMRPTable.replace("[MRPRowsHere]", "<tr><td colspan='6'>No packaging defined!</td></tr>");
                                        } else {
                                            newRow = newRow.replace("[MRPRowsExpenderHere]", _mrpButtonHTML);
                                            newRowMRPTable = newRowMRPTable.replace("[MRPRowsHere]", newRowMRPRows);
                                        }

                                        var newRowMRPTableRow = "<tr id='MRP_" + _item["ID"] + "' style='display:none;'><td></td><td></td><td colspan='9'>" + newRowMRPTable + "</td></tr>";

                                        newRow = newRow + newRowMRPTableRow;

                                        // set Row Index
                                        newRow = newRow.replace("[MainRowIndex]", ($("#tblProductTrail>tbody tr[id*='Trail_']").length + 1));


                                        $('#tblProductTrail>tbody').append(newRow);
                                        $('#divProductTrail').show();
                                    }
                                }
                            }
                        }


                        for (var i = 0; i < response.length; i++) {

                            var _item = response[i];


                            //if (havePremission(Permission.DossierTrail_PRCReport, Module.ProductManagement, _item["CountryLookupId"]) == true)
                            {

                                var renewalIdAttr = "data-RenewalOrderLookupId='" + (_item["RenewalOrderLookup"] && _item["RenewalOrderLookup"].Id ? _item["RenewalOrderLookup"]["Id"] : "") + "'";
                                var renewalTypeAttr = "data-RenewalType='" + _item["RenewalType"] + "'";

                                if (_item["Stage"] == "PRV") {

                                    var prvTableElmt = $('#tblProductTrail>tbody').find("table[id*='tblprv_'][" + renewalIdAttr + "]");

                                    if (_item.RenewalType != null && _item.RenewalType.length > 0 && prvTableElmt.length > 1) {
                                        var prvRewalTypeItemRow = null;
                                        //prvTableElmt = prvTableElmt.find("[" + renewalTypeAttr + "]");
                                        prvTableElmt.each(function () {
                                            if ($(this).attr("data-RenewalType") == _item.RenewalType) {
                                                prvRewalTypeItemRow = $(this);

                                            }
                                        });

                                        if (prvRewalTypeItemRow != null && prvRewalTypeItemRow.length > 0) {
                                            prvTableElmt = prvRewalTypeItemRow;
                                        }

                                    }

                                    if (prvTableElmt && prvTableElmt.length > 0) {


                                        /* var prvtTable = $('#tblProductTrail>tbody').find("tr[id*='tblprv_'][" + renewalIdAttr + "]");
                                         if ((prvtTable && prvtTable.length > 0) == false) {
                                             var parantTailItem = $('#tblProductTrail>tbody').find("tr[id*='Trail_'][" + renewalIdAttr + "]");
                                             if (parantTailItem && parantTailItem.length > 0) {
                                                 //$('#tblProductTrail>tbody').find('tr').eq(j). // inseert this table or row here
 
                                                 parantTailItem.after(_prvTableTemplate);
                                                 _prvTableTemplate.replace(/,/g, renewalIdAttr);
 
                                                 parantTailItem.after(_prvTableTemplate);
                                             }
 
                                         }
 
                                         var newRow = "<tr id='Trail_" + _item["ID"] + "'  " + renewalIdAttr + " >";
                                         */
                                        /*PRV_ProductName	Single line of text	
                                          PRV_ApplicationDetails	Multiple lines of text	
                                          PRV_Type	Choice	
                                          PRV_Date	Date and Time	
                                          PRV_ShelfLifeLookup	Lookup	
                                          PRV_Strength	Single line of text	
                                          PRV_Remarks	Multiple lines of text	
                                          PRV_RelatedTo	Single line of text
                                          */
                                        var _prvRowHTML = "<tr id='" + _item["ID"] + "'>" +
                                            "<td>" + ((_item["PRV_ProductName"] != null) ? _item["PRV_ProductName"] : "-") + "</td>" +
                                            "<td>" + ((_item["PRV_Date"] != null) ? toDisplayDate(_item["PRV_Date"]) : "-") + "</td>" +
                                            "<td>" + ((_item["PRV_Strength"] != null) ? _item["PRV_Strength"] : "-") + "</td>" +
                                            "<td>" + ((_item["PRV_ShelfLifeLookup"] != null && _item["PRV_ShelfLifeLookup"].Title) ? _item["PRV_ShelfLifeLookup"].Title : "-") + "</td>" +
                                            "<td>" + ((_item["PRV_ApplicationDetails"] != null) ? _item["PRV_ApplicationDetails"] : "-") + "</td>" +
                                            "<td> " + ((_item["PRV_Type"] != null) ? _item["PRV_Type"] : "-") + "</td> " +
                                            "</tr>";

                                        /*
                                        newRow = newRow + "<td>" + (i + rowStartIndexNumber) + "</td>" +
                                            "<td>" + ((_item["PRV_ProductName"] != null) ? _item["PRV_ProductName"] : "-") + "</td>" +
                                            "<td>" + ((_item["Generic"] != null) ? _item["Generic"] : "-") + "</td>" +
                                            "<td>" + "-" + "</td>" +
                                            "<td>" + "-" + "</td>" +
                                            "<td>" + "-" + "</td>" +
                                            "<td>" + stageTxt + "</td>" +
                                            "<td>" + ((_item["PRV_ShelfLifeLookup"]) ? _item["PRV_ShelfLifeLookup"].Title : "") + "</td>" +
                                            "<td>" + "[MRPRowsExpenderHere]" + "</td>" +
                                            "<td>" + "-" + "</td>" +
                                            "<td>" + "-" + "</td>";*/


                                        //prvTableElmt.last().find('tbody').append(_prvRowHTML);





                                        //data-RenewalType='" + _item.RenewalType + "'";
                                        var _lastItemToAttached = prvTableElmt;

                                        /*if(_item.RenewalType !=null && _item.RenewalType.length > 0)
                                        {
                                            _lastItemToAttached = prvTableElmt.find("[data-RenewalType='" + _item.RenewalType + "']");
                                        }*/

                                        _lastItemToAttached.find('tbody').append(_prvRowHTML);


                                        var prvTableRow = $("#tblProductTrail").find("tr[id*='Trail_'][" + renewalIdAttr + "]");
                                        if (prvTableRow && prvTableRow.length > 0) {

                                            if (_item.RenewalType != null && _item.RenewalType.length > 0 && prvTableRow.length > 1) {
                                                prvTableRow.each(function () {
                                                    if ($(this).attr("data-RenewalType") == _item.RenewalType) {
                                                        $(this).find('#btnPRVExpender').show();
                                                    }
                                                });

                                            } else {
                                                prvTableRow.find('#btnPRVExpender').show();
                                            }

                                        }

                                    }
                                }



                            }
                        }


                    });


                //#endregion Previous Trails 


                /*//#region For current Status is PRV item*/

                if (_currentItem["Stage"] == "PRV") {
                    /*
                    var prvTableElmt = $('#tblProductTrail>tbody').find("table[id*='tblprv_'][data-RenewalOrderLookupId='" + _currentItem["RenewalOrderLookupId"] + "']");
                    if (prvTableElmt && prvTableElmt.length > 0) {

                        var _selftListText = (Number(_currentItem["PRV_ShelfLifeLookupId"]) > 0 ? $("#ddlPRV_ShelfLife").find("option[value='" + _currentItem["PRV_ShelfLifeLookupId"] + "']").text() : "-");

                        var _prvRowHTML = "<tr id='" + _currentItem["ID"] + "'>" +
                                                "<td>" + ((_currentItem["PRV_ProductName"] != null) ? _currentItem["PRV_ProductName"] : "-") + "</td>" +
                                                "<td>" + ((_currentItem["PRV_Date"] != null) ? toDisplayDate(_currentItem["PRV_Date"]) : "-") + "</td>" +
                                                "<td>" + ((_currentItem["PRV_Strength"] != null) ? _currentItem["PRV_Strength"] : "-") + "</td>" +
                                                "<td>" + _selftListText + "</td>" +
                                                "<td>" + ((_currentItem["PRV_ApplicationDetails"] != null) ? _currentItem["PRV_ApplicationDetails"] : "-") + "</td>" +
                                                "<td> " + ((_currentItem["PRV_Type"] != null) ? _currentItem["PRV_Type"] : "-") + "</td> " +
                                          "</tr>";

                        prvTableElmt.first().find('tbody').prepend(_prvRowHTML);


                        var prvTableRow = $("#tblProductTrail").find("tr[id*='Trail_'][data-RenewalOrderLookupId='" + _currentItem["RenewalOrderLookupId"] + "']");
                        if (prvTableRow && prvTableRow.length > 0) {
                            prvTableRow.first().find('#btnPRVExpender').show();
                        }

                    }*/
                }

                /*//#endregion For Current Status is PRV    */


            }
        }
    }

    function expandMRP(_control) {
        _control = $(_control);
        var _trilRecordId = _control.parents('tr').first().attr('id').replace('Trail_', '');

        if ($("#tblProductTrail").find('#MRP_' + _trilRecordId).is(':visible') == true) {
            $("#tblProductTrail").find('#MRP_' + _trilRecordId).hide("slow");
            _control.find('i').removeClass("glyphicon-minus-sign");
            _control.find('i').addClass("glyphicon-plus-sign");
        } else {
            $("#tblProductTrail").find('#MRP_' + _trilRecordId).show("slow");
            _control.find('i').removeClass("glyphicon-plus-sign");
            _control.find('i').addClass("glyphicon-minus-sign");
        }
    }

    function expandPRV(_control) {
        _control = $(_control);
        var _id = _control.parents('tr').first().attr('id').replace('Trail_', '');
        var _renewalorderlookupid = _control.parents('tr').first().data('renewalorderlookupid');
        var prvTableRow = $("#tblProductTrail").find("tr[id*='PRV_" + _id + "'][data-renewalorderlookupid='" + _renewalorderlookupid + "']");
        if (prvTableRow && prvTableRow.length > 0) {
            if (prvTableRow.find('table>tbody tr').length > 0) {  // if there are any data then show or hide, other view skip showing
                if (prvTableRow.is(':visible') == true) {
                    prvTableRow.hide("slow");
                    _control.find('i').removeClass("glyphicon-minus-sign");
                    _control.find('i').addClass("glyphicon-plus-sign");
                } else {
                    prvTableRow.show("slow");
                    _control.find('i').removeClass("glyphicon-plus-sign");
                    _control.find('i').addClass("glyphicon-minus-sign");
                }
            }
        }
    }

    function openAddAttachment(_id, stage, _type) {

        var modalWindow = $("#divModal-Attachment");

        var _productId = $('#hid_ID').val();

        // reset All controls
        modalWindow.find("select,input[type='text'],input[type='number'],input[type='hidden'],input[type='file']").val('');
        modalWindow.find("#chkIsCertificate").prop('checked', false);

        modalWindow.find(".is-invalid").removeClass("is-invalid");
        modalWindow.find('#hid_ProductId').val(_productId);
        modalWindow.find('#ddlFolders').find('option').remove();
        modalWindow.find('#ddlFolders').append("<option value=''>-- None --</option>");

        modalWindow.find("#olSelectFiles").html('');

        $('#hid_AttachmentType').val(stage);

        $('#divAttachmentFolder').show();

        if (stage == "Renewal") {

            //$('#divAttachmentFolder').hide();

            // On Asma, Request to Remove these filed from Attachments
            //updateObject.Renewal_SubmissionDate = $("#divFromDetials").find('#txtRenewalSubmissionDate').datepicker('getDate');
            //updateObject.Renewal_RegistrationDate = $("#divFromDetials").find('#txtRenewalRegistrationDate').datepicker('getDate');
            //updateObject.Renewal_ExpiryDate = $("#divFromDetials").find('#txtRenewalExpiryDate').datepicker('getDate');

            modalWindow.find("#divRenewwalType").show();

            if (_type == "Applied")
                modalWindow.find("#lblRenewwalType").text('Renewal Applied');
            if (_type == "Approved")
                modalWindow.find("#lblRenewwalType").text('Renewal Approved');

            /*
            //// On Asma Request to remove these fileds from  Attachment
                 if ($("#radRenewalApplied").prop('checked') == true) {
                     modalWindow.find("#txtRenewalSubmissionDate").parents('.col-md-6').eq(0).show();
                     modalWindow.find("#txtRenewalRegistrationDate").parents('.col-md-6').eq(0).hide();
                     modalWindow.find("#txtRenewalExpiryDate").parents('.col-md-6').eq(0).hide();
                 }
                 else if ($("#radRenewalApproved").prop('checked') == true) {
                     modalWindow.find("#txtRenewalSubmissionDate").parents('.col-md-6').eq(0).hide();
                     modalWindow.find("#txtRenewalRegistrationDate").parents('.col-md-6').eq(0).show();
                     modalWindow.find("#txtRenewalExpiryDate").parents('.col-md-6').eq(0).show();
                 }
                 else {
                     modalWindow.find("#txtRenewalSubmissionDate").parents('.col-md-6').eq(0).hide();
                     modalWindow.find("#txtRenewalRegistrationDate").parents('.col-md-6').eq(0).hide();
                     modalWindow.find("#txtRenewalExpiryDate").parents('.col-md-6').eq(0).hide();
                 }
                 */

        }
        else {
            modalWindow.find("#divRenewwalType").hide();
            modalWindow.find("#lblRenewwalType").text('');
        }

        if (stage == "Applied") {
            modalWindow.find('#divIsCertificate').hide();
        } else {
            modalWindow.find('#divIsCertificate').show();
        }

        var isDateSetted = true;

        if (stage == 'Applied') {
            if ($("#divFromDetials").find('#txtSubmissionDate').datepicker('getDate') == null) {
                $("#divFromDetials").find('#txtSubmissionDate').addClass("is-invalid");
                isDateSetted = false;
            } else {
                $("#divFromDetials").find('#txtSubmissionDate').removeClass("is-invalid");
            }
        }
        else if (stage == 'Pre-Registration') {
            if ($("#divFromDetials").find('#txtPreRegistrationDate').datepicker('getDate') == null) {
                $("#divFromDetials").find('#txtPreRegistrationDate').addClass("is-invalid");
                isDateSetted = false;
            } else {
                $("#divFromDetials").find('#txtPreRegistrationDate').removeClass("is-invalid");
            }
        }
        else if (stage == 'Registered') {
            if ($("#divFromDetials").find('#txtRegistration_RegistrationDate').datepicker('getDate') == null) {
                $("#divFromDetials").find('#txtRegistration_RegistrationDate').addClass("is-invalid");
                isDateSetted = false;
            } else {
                $("#divFromDetials").find('#txtRegistration_RegistrationDate').removeClass("is-invalid");
            }

            if ($("#divFromDetials").find('#ckbRegistration_CanExpire').prop('checked') == true) {
                if ($("#divFromDetials").find('#txtRegistration_ExpiryDate').datepicker('getDate') == null) {
                    $("#divFromDetials").find('#txtRegistration_ExpiryDate').addClass("is-invalid");
                    isDateSetted = false;
                } else {
                    $("#divFromDetials").find('#txtRegistration_ExpiryDate').removeClass("is-invalid");
                }
            }
        }
        else if (stage == 'PRV') {

            if ($("#divFromDetials").find('#txtPRV_Date').datepicker('getDate') == null) {
                $("#divFromDetials").find('#txtPRV_Date').addClass("is-invalid");
                isDateSetted = false;
            } else {
                $("#divFromDetials").find('#txtPRV_Date').removeClass("is-invalid");
            }
        }
        else if (stage == 'Renewal') {
            $("#divFromDetials").find("#radRenewalApplied,#radRenewalApproved,#txtRenewalSubmissionDate,#txtRenewalExpiryDate,#txtRenewalRegistrationDate").removeClass("is-invalid");

            if (_type == "Applied") {
                if ($("#divFromDetials").find('#txtRenewalSubmissionDate').datepicker('getDate') == null) {
                    $("#divFromDetials").find('#txtRenewalSubmissionDate').addClass("is-invalid");
                    $("#radRenewalApplied").addClass("is-invalid");
                    isDateSetted = false;
                } else {
                    $("#divFromDetials").find('#txtRenewalSubmissionDate').removeClass("is-invalid");
                    $("#radRenewalApplied").removeClass("is-invalid");
                }

            }
            if (_type == "Approved") {



                if ($("#divFromDetials").find('#txtRenewalRegistrationDate').datepicker('getDate') == null) {
                    $("#divFromDetials").find('#txtRenewalRegistrationDate').addClass("is-invalid");
                    $("#radRenewalApproved").addClass("is-invalid");
                    isDateSetted = false;
                } else {
                    $("#divFromDetials").find('#txtRenewalRegistrationDate').removeClass("is-invalid");
                    $("#radRenewalApproved").removeClass("is-invalid");
                }

                if ($("#divFromDetials").find('#txtRenewalExpiryDate').datepicker('getDate') == null) {
                    $("#divFromDetials").find('#txtRenewalExpiryDate').addClass("is-invalid");
                    $('#radRenewalApproved').addClass("is-invalid");
                    isDateSetted = false;
                } else {
                    $("#divFromDetials").find('#txtRenewalExpiryDate').removeClass("is-invalid");
                    $('#radRenewalApproved').removeClass("is-invalid");
                }
            }

        }


        if (_productId && Number(_productId) > 0) {
            if (isDateSetted == false) {
                alert("Please select the highlighted dates first!"); /// for Attahcemnts Date need to be selected first so that its will be saved agains attached files
            } else {

                var folderFilter = "ProductLookupId eq " + _productId

                if (stage.length > 0) {
                    folderFilter = folderFilter + " and Section eq '" + stage + "'";
                }

                GetSPListItems("ProductFolders", 0, folderFilter)
                    .done(function (data) {
                        if (data && data.d && data.d.results && data.d.results.length > 0) {


                            data.d.results.forEach(function (_item) {
                                var _optionfolderhtml = "<option value='" + _item.Id + "'>" + _item.Title + "</option>";

                                modalWindow.find('#ddlFolders').append(_optionfolderhtml);
                            });

                            ////-- making Folder optional for all steps
                            /*modalWindow.modal('show');
                        } else {
                            alert("No folder created for this stage '" + stage + "'!");
                        */
                        }

                    });

                modalWindow.modal('show');
            }

        } else {
            alert("Please save the 'Basic Information' first!");
        }
    }

    function openFolderSPDialog(_id, _section) {

        var _productId = $('#hid_ID').val();
        var queryString = "pid=" + _productId + "&section=" + _section;
        var source = window.location.href;
        var sucMsg = "New Folder has been added successfully.";
        openNewItemDialog('ProductFolders', 'Add Folder', source, queryString, sucMsg, 650, false);

    }




    function openQuerySPDialog(_id) {

        var _productId = $('#hid_ID').val();
        var queryString = "pid=" + _productId;
        var source = window.location.href;
        var sucMsg = "New query has been added successfully.";
        openNewQueryDialog('ProductQuery', 'Add Query', source, queryString, sucMsg, 650);

    }


    function openNewQueryDialog(listName, title, source, queryString, successMsg, _width) {
        var _width = 650;
        var needToReloadPage = true;

        var options = {
            title: title,
            //url: _spPageContextInfo.webAbsoluteUrl + "/Lists/" + listName + "/NewForm.aspx?Source=" + source + queryString,
            url: _spPageContextInfo.webAbsoluteUrl + "/Lists/" + listName + "/NewForm.aspx?" + queryString,
            allowMaximize: true,
            width: _width
        };

        options.dialogReturnValueCallback = function (dialogResult, returnValue) {
            if (dialogResult == 1) {

                var _hid_ProductId = $('#hid_ID').val();
                bindProductQuery(_hid_ProductId);
            }
        }


        SP.SOD.execute('sp.ui.dialog.js', 'SP.UI.ModalDialog.showModalDialog', options);

        SP.SOD.executeFunc('sp.ui.dialog.js', 'SP.UI.ModalDialog.showModalDialog', function () {
            $(".ms-dlgTitleBtns").css('margin-right', '0px');
            $("#s4-bodyContainer").css('min-height', 'auto');
        });


        setTimeout(function () { spdailogpositionsetter() }, 1000);
    }



    function onChangeIsExpiry() {

        if ($("#ckbRegistration_CanExpire").prop('checked') == true) {
            $("#divRegistrationExpiryDate").show();
        } else {
            $("#divRegistrationExpiryDate").hide()
        }

    }
    function onChangePRV_Type() {

        if ($("#rdPRV_Applied").prop('checked') == true) {
            $("#lblPRV_DateText").text('Applied Date');
        } else if ($("#rdPRV_Approved").prop('checked') == true) {
            $("#lblPRV_DateText").text('Approved Date');
        }

    }

    function onChangeRenewalType() {

        var modalWindow = $("#divFromDetials");
        $("#txtRegistrationNum").val(storeNumForReneval);
        modalWindow.find("#txtRenewalSubmissionDate,#txtRenewalRegistrationDate,#txtRenewalExpiryDate,#txtRegistrationNum").each(function () { $(this).parents('.col-md-4').eq(0).show(); });

        if ($("#radRenewalApplied").prop('checked') == true) {
            //modalWindow.find("#txtRenewalSubmissionDate").parents('.col-md-6').eq(0).show();
            //modalWindow.find("#txtRenewalRegistrationDate").parents('.col-md-6').eq(0).hide();
            //modalWindow.find("#txtRenewalExpiryDate").parents('.col-md-6').eq(0).hide();

            modalWindow.find("#txtRenewalSubmissionDate").prop('disabled', false);
            modalWindow.find("#txtRenewalRegistrationDate,#txtRenewalExpiryDate,#txtRegistrationNum").prop('disabled', true);
            modalWindow.find("#txtRenewalRegistrationDate,#txtRenewalExpiryDate,#txtRegistrationNum").each(function () { $(this).parents('.col-md-4').eq(0).hide(); });
        }
        else if ($("#radRenewalApproved").prop('checked') == true) {
            //modalWindow.find("#txtRenewalSubmissionDate").parents('.col-md-6').eq(0).hide();
            //modalWindow.find("#txtRenewalRegistrationDate").parents('.col-md-6').eq(0).show();
            //modalWindow.find("#txtRenewalExpiryDate").parents('.col-md-6').eq(0).show();

            modalWindow.find("#txtRenewalSubmissionDate").prop('disabled', true);
            modalWindow.find("#txtRenewalRegistrationDate,#txtRenewalExpiryDate,#txtRegistrationNum").prop('disabled', false);
            modalWindow.find("#txtRenewalRegistrationDate,#txtRenewalExpiryDate,#txtRegistrationNum").each(function () { $(this).parents('.col-md-4').eq(0).show(); });
        }
        else {
            //modalWindow.find("#txtRenewalSubmissionDate").parents('.col-md-6').eq(0).hide();
            //modalWindow.find("#txtRenewalRegistrationDate").parents('.col-md-6').eq(0).hide();
            //modalWindow.find("#txtRenewalExpiryDate").parents('.col-md-6').eq(0).hide();

            modalWindow.find("#txtRenewalSubmissionDate").prop('disabled', true);
            modalWindow.find("#txtRenewalRegistrationDate,#txtRenewalExpiryDate").prop('disabled', true);
            modalWindow.find("#txtRenewalRegistrationDate,#txtRenewalExpiryDate").each(function () { $(this).parents('.col-md-4').eq(0).hide(); });
        }

    }

    function spdailogpositionsetter() {


        var observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutationRecord) {
                setTimeout(function () {
                    console.log('style changed!');
                    $("body").css('position', 'fixed');
                    setTimeout(function () {
                        $("body").css('position', '');
                    }, 00);
                }, 00);
            });
        });

        var target = $(".ms-dlgContent").get(0);
        observer.observe(target, { attributes: true, attributeFilter: ['style'] });

    }


</script>

<script type="text/javascript">

    function saveEmptyProduct() {
        try {

            var modalWindow = $("#divFromDetials");
            var jsonProductData = {
                CompanyLookupId: modalWindow.find('#ddlCompany').val(),
                CountryLookupId: modalWindow.find('#ddlCountry').val(),
                CategoryLookupId: modalWindow.find('#ddlProductCategory').val(),
                DosageTypeId: modalWindow.find('#ddlDosageType').val(),
                Title: modalWindow.find('#txtProduct').val(),
                Generic: modalWindow.find('#txtGeneric').val(),
                Strength: modalWindow.find('#txtStrength').val(),


                Status: 'EmptyRecord',
                IsDeleted: false,
                IsActive: false, // as it should be visible at any screen

            }

            if (Number(jsonProductData.CompanyLookupId) == 0) { jsonProductData.CompanyLookupId = null; }
            if (Number(jsonProductData.CountryLookupId) == 0) { jsonProductData.CountryLookupId = null; }
            if (Number(jsonProductData.CategoryLookupId) == 0) { jsonProductData.CategoryLookupId = null; }
            if (Number(jsonProductData.DosageTypeId) == 0) { jsonProductData.DosageTypeId = null; }


            InsertIntoSPList('Products', jsonProductData).done(function (data) {
                //console.log(data.d.results);
                if (Number(data.d.ID) > 0) {
                    $('#hid_ID').val(data.d.ID);
                }
            }).fail(function (jqXHR, textStatus) {
                console.error("Request fail on saveEmptyProduct() : ", jqXHR);

            });
        }
        catch (ex) {
            console.log(ex);
        }

    }

    function saveProduct(_action) {

        var isValid = true;

        var modalWindow = $("#divFromDetials");

        var _datePreRegistration;
        var _submissionDate;

        modalWindow.find('.is-invalid').removeClass("is-invalid");

        if ((modalWindow.find("#ddlCompany").val().length > 0) == false) {
            isValid = false;
            modalWindow.find("#ddlCompany").addClass("is-invalid");
        }

        if ((modalWindow.find("#ddlCountry").val().length > 0) == false) {
            isValid = false;
            modalWindow.find("#ddlCountry").addClass("is-invalid");
        }

        if ((modalWindow.find("#ddlProductCategory").val().length > 0) == false) {
            isValid = false;
            modalWindow.find("#ddlProductCategory").addClass("is-invalid");
        }

        if ((modalWindow.find("#txtProduct").val().trim().length > 0) == false) {
            isValid = false;
            modalWindow.find("#txtProduct").addClass("is-invalid");
        }
        if ((modalWindow.find("#ddlDosageType").val().length > 0) == false) {
            isValid = false;
            modalWindow.find("#ddlDosageType").addClass("is-invalid");
        }
        if ((modalWindow.find("#txtGeneric").val().trim().length > 0) == false) {
            isValid = false;
            modalWindow.find("#txtGeneric").addClass("is-invalid");
        }
        if ((modalWindow.find("#txtStrength").val().trim().length > 0) == false) {
            isValid = false;
            modalWindow.find("#txtStrength").addClass("is-invalid");
        }


        if (modalWindow.find('#hid_Stage').val() == "Applied" ||
            modalWindow.find('#hid_Stage').val() == "Pre-Registration" ||
            modalWindow.find('#hid_Stage').val() == "Registered" ||
            modalWindow.find('#hid_Stage').val() == "PRV" ||
            modalWindow.find('#hid_Stage').val() == "Renewal") {

            /*
            if ((modalWindow.find("#ddlManufacturingSite").val().length > 0) == false) {
                isValid = false;
                modalWindow.find("#ddlManufacturingSite").addClass("is-invalid");
            }
            if ((Number(modalWindow.find("#ddlShelfLife").val()) > 0) == false) {
                isValid = false;
                modalWindow.find("#ddlShelfLife").addClass("is-invalid");
            }
            */
            var _submissionDate = modalWindow.find("#txtSubmissionDate").datepicker('getDate');
            /*if ((_submissionDate != null && _submissionDate.getFullYear() > 1970) == false) {
                isValid = false;
                modalWindow.find("#txtSubmissionDate").addClass("is-invalid");
            }


            if ((modalWindow.find("#txtSourceOfAPI").val().length > 0) == false) {
                isValid = false;
                modalWindow.find("#txtSourceOfAPI").parents('div').find(".bootstrap-tagsinput").addClass("is-invalid")

            }
            if ((Number(modalWindow.find("#ddlStorageCondition").val()) > 0) == false) {
                isValid = false;
                modalWindow.find("#ddlStorageCondition").addClass("is-invalid");
            }
            if ((modalWindow.find("#txtProductOwnership").val().length > 0) == false) {
                isValid = false;
                modalWindow.find("#txtProductOwnership").addClass("is-invalid");
            }

            if ((modalWindow.find("#txtPackType").val().length > 0) == false) {
                isValid = false;
                modalWindow.find("#txtPackType").addClass("is-invalid");
            }
            if ((modalWindow.find("#ddlMarketedStatus").val().length > 0) == false) {
                isValid = false;
                modalWindow.find("#ddlMarketedStatus").addClass("is-invalid");
            }
            */
        }
        if (modalWindow.find('#hid_Stage').val() == "Pre-Registration" ||
            modalWindow.find('#hid_Stage').val() == "Registered" ||
            modalWindow.find('#hid_Stage').val() == "PRV" ||
            modalWindow.find('#hid_Stage').val() == "Renewal") {

            /* var _datePreRegistration = modalWindow.find('#txtPreRegistrationDate').datepicker('getDate');
             if ((_datePreRegistration != null && _datePreRegistration.getFullYear() > 1970) == false) {
                 isValid = false;
                 modalWindow.find("#txtPreRegistrationDate").addClass("is-invalid");
             }

             if ((modalWindow.find("#txtDescription").val().trim().length > 0) == false) {
                 isValid = false;
                 modalWindow.find("#txtDescription").addClass("is-invalid");
             }
             */
        }
        if (modalWindow.find('#hid_Stage').val() == "Registered" ||
            modalWindow.find('#hid_Stage').val() == "PRV" ||
            modalWindow.find('#hid_Stage').val() == "Renewal") {

            if (modalWindow.find('#ckbRegistration_CanExpire').prop('checked') == true) {
                var _dateOfExpiry = modalWindow.find('#txtRegistration_ExpiryDate').datepicker('getDate');
                if ((_dateOfExpiry != null && _dateOfExpiry.getFullYear() > 1970) == false) {
                    isValid = false;
                    modalWindow.find("#txtRegistration_ExpiryDate").addClass("is-invalid");
                }
            }
            var _dateOfRegistrationDate = modalWindow.find('#txtRegistration_RegistrationDate').datepicker('getDate');
            if ((_dateOfRegistrationDate != null && _dateOfRegistrationDate.getFullYear() > 1970) == false) {
                isValid = false;
                modalWindow.find("#txtRegistration_RegistrationDate").addClass("is-invalid");
            }
            if ((modalWindow.find("#txtRegistration_RegistrationNo").val().trim().length > 0) == false) {
                isValid = false;
                modalWindow.find("#txtRegistration_RegistrationNo").addClass("is-invalid");
            }


            /*if ((modalWindow.find("#txtRegistration_PackType").val().trim().length > 0) == false) {
                isValid = false;
                modalWindow.find("#txtRegistration_PackType").addClass("is-invalid");
            }*/
            /* 
            //// Zafar: Remove its restiction 
            var _dateOfImplementation = modalWindow.find('#txtImplementationDate').datepicker('getDate');
            if ((_dateOfImplementation != null && _dateOfImplementation.getFullYear() > 1970) == false) {
                isValid = false;
                modalWindow.find("#txtImplementationDate").addClass("is-invalid");
            }

            var _txtApprovedMRPValue = modalWindow.find('#txtApprovedMRP').val();
            if ((_txtApprovedMRPValue != null && Number(_txtApprovedMRPValue) > 0) == false) {
                isValid = false;
                modalWindow.find("#txtApprovedMRP").addClass("is-invalid");
            }
            var _txtMarketedMRPValue = modalWindow.find('#txtMarketedMRP').val();
            if ((_txtMarketedMRPValue != null && Number(_txtMarketedMRPValue) > 0) == false) {
                isValid = false;
                modalWindow.find("#txtMarketedMRP").addClass("is-invalid");
            }

            if ((Number(modalWindow.find("#ddlRegisteredShelfLife").val()) > 0) == false) {
                isValid = false;
                modalWindow.find("#ddlRegisteredShelfLife").addClass("is-invalid");
            }*/

        }

        //// on Zafar request, Make PRV optional
        /*if (modalWindow.find('#hid_Stage').val() == "PRV" ||
            modalWindow.find('#hid_Stage').val() == "Renewal") {*/

        if (modalWindow.find('#hid_Stage').val() == "PRV") {


            if ((modalWindow.find("#txtPRV_ProductName").val().trim().length > 0) == false) {
                isValid = false;
                modalWindow.find("#txtPRV_ProductName").addClass("is-invalid");
            }


            var _datePRV_Date = modalWindow.find('#txtPRV_Date').datepicker('getDate');
            if ((_datePRV_Date != null && _datePRV_Date.getFullYear() > 1970) == false) {
                isValid = false;
                modalWindow.find("#txtPRV_Date").addClass("is-invalid");
            }

            if ((Number(modalWindow.find("#ddlPRV_ShelfLife").val()) > 0) == false) {
                isValid = false;
                modalWindow.find("#ddlPRV_ShelfLife").addClass("is-invalid");
            }

            if ((modalWindow.find("#txtPRV_Strength").val().trim().length > 0) == false) {
                isValid = false;
                modalWindow.find("#txtPRV_Strength").addClass("is-invalid");
            }

        }
        if (modalWindow.find('#hid_Stage').val() == "Renewal") {

            /* if ((modalWindow.find('#radRenewalApplied').prop("checked") == true ||
                  modalWindow.find('#radRenewalApproved').prop("checked") == true) == false) {
                 isValid = false;
                 modalWindow.find("#radRenewalApplied").parents(".form-group").eq(0).addClass("is-invalid");
                 modalWindow.find("#radRenewalApproved").parents(".form-group").eq(0).addClass("is-invalid");
             }*/


            if (modalWindow.find('#radRenewalApplied').prop("checked") == true) {
                var _dateSubmissionDate = modalWindow.find('#txtRenewalSubmissionDate').datepicker('getDate');
                if ((_dateSubmissionDate != null && _dateSubmissionDate.getFullYear() > 1970) == false) {
                    isValid = false;
                    modalWindow.find("#txtRenewalSubmissionDate").addClass("is-invalid");
                }
            }

            if (modalWindow.find('#radRenewalApproved').prop("checked") == true) {
                var _dateRegistrationDate = modalWindow.find('#txtRenewalRegistrationDate').datepicker('getDate');
                if ((_dateRegistrationDate != null && _dateRegistrationDate.getFullYear() > 1970) == false) {
                    isValid = false;
                    modalWindow.find("#txtRenewalRegistrationDate").addClass("is-invalid");
                }
                var _dateExpiryDate = modalWindow.find('#txtRenewalExpiryDate').datepicker('getDate');
                if ((_dateExpiryDate != null && _dateExpiryDate.getFullYear() > 1970) == false) {
                    isValid = false;
                    modalWindow.find("#txtRenewalExpiryDate").addClass("is-invalid");
                }

            }
        }


        if (isValid == true) {

            RequestStarted();

            _recordId = $("#hid_ID").val();

            var jsonProductData = {
                CompanyLookupId: modalWindow.find('#ddlCompany').val(),
                CountryLookupId: modalWindow.find('#ddlCountry').val(),
                CategoryLookupId: modalWindow.find('#ddlProductCategory').val(),
                DosageTypeId: modalWindow.find('#ddlDosageType').val(),
                Title: modalWindow.find('#txtProduct').val().trim(),
                Generic: modalWindow.find('#txtGeneric').val().trim(),
                Strength: modalWindow.find('#txtStrength').val().trim(),
                MarketedStatus: modalWindow.find('#ddlMarketedStatus').val(),

                Status: $('#hid_Status').val(),
                Stage: $('#hid_Stage').val(),
                IsDeleted: false,
                IsActive: true,

            }


            if (jsonProductData.Stage == "Applied" ||
                jsonProductData.Stage == "Pre-Registration" ||
                jsonProductData.Stage == "Registered" ||
                jsonProductData.Stage == "PRV" ||
                jsonProductData.Stage == "Renewal") {

                var _manufacturingSiteLookupId = modalWindow.find('#ddlManufacturingSite').val();
                var _shelfLifeLookupId = modalWindow.find('#ddlShelfLife').val();
                var _storageCondition = modalWindow.find('#ddlStorageCondition').val();

                if (Number(_manufacturingSiteLookupId) > 0)
                    jsonProductData.ManufacturingSiteLookupId = _manufacturingSiteLookupId;
                if (Number(_shelfLifeLookupId) > 0)
                    jsonProductData.ShelfLifeLookupId = _shelfLifeLookupId;

                jsonProductData.SourceOfAPI = modalWindow.find('#txtSourceOfAPI').val();
                if (Number(_storageCondition) > 0)
                    jsonProductData.StorageCondition = _storageCondition;
                jsonProductData.ProductOwnership = modalWindow.find('#txtProductOwnership').val();
                jsonProductData.PackType = modalWindow.find('#txtPackType').val();
                //SubmissionDate: _submissionDate,

                if (_submissionDate && _submissionDate.getFullYear() > 1970) {
                    jsonProductData.SubmissionDate = _submissionDate;
                }

            }
            if (jsonProductData.Stage == "Pre-Registration" ||
                jsonProductData.Stage == "Registered" ||
                jsonProductData.Stage == "PRV" ||
                jsonProductData.Stage == "Renewal") {

                var _PreRegistrationDate = modalWindow.find("#txtPreRegistrationDate").datepicker('getDate');
                if (_PreRegistrationDate && _PreRegistrationDate.getFullYear() > 1970) {
                    jsonProductData.PreRegistrationDate = _PreRegistrationDate;
                }

                jsonProductData.Description = modalWindow.find('#txtDescription').val();
            }
            if (jsonProductData.Stage == "Registered" ||
                jsonProductData.Stage == "PRV" ||
                jsonProductData.Stage == "Renewal") {


                if (modalWindow.find('#ckbRegistration_CanExpire').prop('checked') == true) {
                    jsonProductData.Registration_CanExpire = true;

                    var _registration_ExpiryDate = modalWindow.find('#txtRegistration_ExpiryDate').datepicker('getDate');
                    jsonProductData.Registration_ExpiryDate = _registration_ExpiryDate;
                } else {
                    jsonProductData.Registration_CanExpire = false;
                    jsonProductData.Registration_ExpiryDate = null;
                }

                jsonProductData.Registration_RegistrationNo = modalWindow.find('#txtRegistration_RegistrationNo').val();

                var _registration_DateOfRegistration = modalWindow.find('#txtRegistration_RegistrationDate').datepicker('getDate');
                jsonProductData.Registration_DateOfRegistration = _registration_DateOfRegistration;



                jsonProductData.Registration_PackType = modalWindow.find('#txtRegistration_PackType').val().trim();

                var _ApprovedMRP = Number(modalWindow.find('#txtApprovedMRP').val());
                if (_ApprovedMRP > 0)
                    jsonProductData.ApprovedMRP = _ApprovedMRP;
                else
                    jsonProductData.ApprovedMRP = 0;

                var _MarketedMRP = Number(modalWindow.find('#txtMarketedMRP').val());
                if (_MarketedMRP > 0)
                    jsonProductData.MarketedMRP = _MarketedMRP;
                else
                    jsonProductData.MarketedMRP = 0;
                //DateOfImplementation: _dateOfImplementation,

                var _dateOfImplementation = modalWindow.find('#txtImplementationDate').datepicker('getDate');
                if (_dateOfImplementation && _dateOfImplementation.getFullYear() > 1970) {
                    jsonProductData.DateOfImplementation = _dateOfImplementation;
                } else {
                    jsonProductData.DateOfImplementation = null;
                }

                var _Registration_ShelfLifeLookupId = modalWindow.find('#ddlRegisteredShelfLife').val();
                if (Number(_Registration_ShelfLifeLookupId) > 0) {
                    jsonProductData.Registration_ShelfLifeLookupId = _Registration_ShelfLifeLookupId;
                } else {
                    jsonProductData.Registration_ShelfLifeLookupId = null;
                }



            }
            //// on Zafar request, Make PRV optional
            if (jsonProductData.Stage == "PRV" ||
                jsonProductData.Stage == "Renewal") {
                //if (jsonProductData.Stage == "PRV") {

                /*

                PRV_ProductName	Single line of text
                PRV_ApplicationDetails	Multiple lines of text
                PRV_Type	Choice
                PRV_Date	Date and Time
                PRV_ShelfLifeLookup	Lookup
                PRV_Strength	Single line of text
                PRV_Remarks	Multiple lines of text
                PRV_RelatedTo	Choice
                */


                jsonProductData.PRV_ProductName = modalWindow.find('#txtPRV_ProductName').val().trim();

                if (modalWindow.find('#rdPRV_Applied').prop("checked") == true) {
                    jsonProductData.PRV_Type = modalWindow.find('#rdPRV_Applied').val();
                }
                else if (modalWindow.find('#rdPRV_Approved').prop("checked") == true) {
                    jsonProductData.PRV_Type = modalWindow.find('#rdPRV_Approved').val();
                }

                var _datePRV_Date = modalWindow.find('#txtPRV_Date').datepicker('getDate');
                if (_datePRV_Date && _datePRV_Date.getFullYear() > 1970) {
                    jsonProductData.PRV_Date = _datePRV_Date;
                }



                var _PRV_ShelfLifeLookupId = modalWindow.find('#ddlPRV_ShelfLife').val();
                if (Number(_PRV_ShelfLifeLookupId) > 0) {
                    jsonProductData.PRV_ShelfLifeLookupId = _PRV_ShelfLifeLookupId;
                } else {
                    jsonProductData.PRV_ShelfLifeLookupId = null;
                }

                jsonProductData.PRV_Strength = modalWindow.find('#txtPRV_Strength').val().trim();

                jsonProductData.PRV_ApplicationDetails = modalWindow.find('#txtPRV_ApplicationDetails').val().trim();

                jsonProductData.PRV_Remarks = modalWindow.find('#txtPRV_Remarks').val().trim();

                var _PRV_RelatedToStr = "";
                modalWindow.find("#divPRV_RelatedTo").find(":checked").each(function () {
                    _PRV_RelatedToStr = (_PRV_RelatedToStr.length > 0 ? _PRV_RelatedToStr + "," : "") + $(this).val();
                });

                jsonProductData.PRV_RelatedTo = _PRV_RelatedToStr;

            }

            if (jsonProductData.Stage == "Renewal") {

                if (modalWindow.find('#radRenewalApplied').prop("checked") === true) {
                    jsonProductData.RenewalType = 'Applied';
                }
                else if (modalWindow.find('#radRenewalApproved').prop("checked") === true) {
                    jsonProductData.RenewalType = 'Approved';
                }
                else
                    jsonProductData.RenewalType = '';



                var _dateSubmissionDate = modalWindow.find('#txtRenewalSubmissionDate').datepicker('getDate');
                if (_dateSubmissionDate && _dateSubmissionDate.getFullYear() > 1970) {
                    jsonProductData.Renewal_SubmissionDate = _dateSubmissionDate;
                }

                var _dateRegistrationDate = modalWindow.find('#txtRenewalRegistrationDate').datepicker('getDate');
                if (_dateRegistrationDate && _dateRegistrationDate.getFullYear() > 1970) {
                    jsonProductData.Renewal_RegistrationDate = _dateRegistrationDate;
                }

                var _dateExpiryDate = modalWindow.find('#txtRenewalExpiryDate').datepicker('getDate');
                if (_dateExpiryDate && _dateExpiryDate.getFullYear() > 1970) {
                    jsonProductData.Renewal_ExpiryDate = _dateExpiryDate;
                }

            }




            /*
            if (jsonProductData.Stage == 'Create') {

            }
            else if (jsonProductData.Stage == 'Applied') {

            }
            else if (jsonProductData.Stage == 'Pre-Registration') {
                jsonProductData.PreRegistrationDate = modalWindow.find('#txtPreRegistrationDate').val();
                jsonProductData.Description = modalWindow.find('#txtDescription').val();
            }
            else if (jsonProductData.Stage == 'Registered') {

                jsonProductData.ApprovedMRP = modalWindow.find('#txtApprovedMRP').val();
                jsonProductData.MarketedMRP = modalWindow.find('#txtMarketedMRP').val();
                jsonProductData.DateOfImplementation = _dateOfImplementation;
            }
            */


            var _confirmResult = false;
            if (_action == 'Finish') {
                jsonProductData.Status = 'Send For Approval';

                _confirmResult = confirm("Are you sure you want to send to admin for approval?");
            }
            else {
                _confirmResult = true;
            }

            if (typeof (jsonProductData.Status) == 'undefined' || jsonProductData.Status == null || jsonProductData.Status == '') {
                jsonProductData.Status = 'On Hold';
            }
            if (typeof (jsonProductData.Stage) == 'undefined' || jsonProductData.Stage == null || jsonProductData.Stage == '') {
                jsonProductData.Stage = "Create";
            }

            var _isUniqueValue = checkForDuplicateValues(jsonProductData.Title, _recordId);

            /* /// -- old trail work

            // Maintaining product Trail once Saveing or finishing any Approved Product
            if (jsonProductData.Status != $("#hid_CurrentStatus").val() &&
                $("#hid_CurrentStatus").val() == "Approved") {

                saveATrailRecord(jsonProductData.Stage.toLowerCase());

                if (jsonProductData.Stage == "Registered" ||
                    jsonProductData.Stage == "Renewal") {

                    var _currentRenewalOrderId = $("#hid_CurrentRenewalId").val();

                    jsonProductData.RenewalOrderLookupId = Number(_currentRenewalOrderId) + 1;
                }

            }
            */


            if (jsonProductData.Stage == "Registered" ||
                jsonProductData.Stage == "PRV") {

                var _currentRenewalOrderId = Number($("#hid_CurrentRenewalId").val());
                if (Number(_currentRenewalOrderId) == 0) {
                    _currentRenewalOrderId = 1;
                }

                jsonProductData.RenewalOrderLookupId = _currentRenewalOrderId;
            }

            if (jsonProductData.Stage == "Renewal") {

                var _currentRenewalOrderId = Number($("#hid_CurrentRenewalId").val());
                if (Number(_currentRenewalOrderId) == 0 || Number(_currentRenewalOrderId) == 1) {
                    _currentRenewalOrderId = 2;
                } else if ($("#hid_CurrentStatus").val() == "Approved") {

                    if ($("#hid_CurrentRenewalType").val() == "Applied" && jsonProductData.RenewalType == "Approved") {  // if TypeOdRenewal Changed then new state will be consider                                    
                        _currentRenewalOrderId = Number(_currentRenewalOrderId);

                        //jsonProductData.Renewal_SubmissionDate = null;
                        //jsonProductData.Renewal_RegistrationDate = null;
                        //jsonProductData.Renewal_ExpiryDate = null;

                    }
                    else {
                        _currentRenewalOrderId = Number(_currentRenewalOrderId) + 1;

                        if (jsonProductData.RenewalType == "Applied") {
                            jsonProductData.Renewal_RegistrationDate = null;
                            jsonProductData.Renewal_ExpiryDate = null;
                        }
                    }

                }
                jsonProductData.RenewalOrderLookupId = _currentRenewalOrderId;
            }


            if (_confirmResult == true && _isUniqueValue == true) {


                //// Save a Trail entry
                saveATrailRecord(jsonProductData.Stage.toLowerCase(), _action, jsonProductData);

                if (Number(_recordId) > 0) {

                    var isAlreadyRegisterted = false;

                    if (jsonProductData.Stage == "Registered" || jsonProductData.Stage == "Applied") {

                        var _trailFilter = "ProductLookupId eq " + Number(_recordId) + " and ProductLookupId gt 0 and Stage eq '" + jsonProductData.Stage + "'";
                        GetSPListItems("ProductTrails", 0, _trailFilter, false)
                            .done(function (data) {
                                if (data.d.results.length > 0) {
                                    isAlreadyRegisterted = true;
                                }
                            });
                    }
                    if (isAlreadyRegisterted == false) {

                        UpdateSPList("Products", _recordId, jsonProductData).done(function (data) {

                            saveActionLog(_recordId, "Edit Product as " + $('#hid_Stage').val(), jsonProductData.Status, Module.ProductManagement);

                            if (jsonProductData.Status == 'Send For Approval') {
                                sendNotification();
                            }

                            window.location.href = "../Products.aspx";
                            //RequestEnded();

                            /*
 
                            if (jsonProductData.Status == "Draft" || jsonProductData.Status == "On Hold" || jsonProductData.Status == "Send Back") {
 
                                alert('Product has been saved successfully');
 
                            }
                            else if (jsonProductData.Status == "Send For Approval") {
                                alert('Product has been send for approval');
                            }
 
                            // Retrive Nomenclatures newly Added
 
                            //openProductDetails(_recordId);
                            window.location.reload();
 
 
                            */
                        }).fail(function (jqXHR, textStatus) {

                            alert("Product Saving Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                            RequestEnded();

                            hideLoader();
                        });

                    } else {
                        alert("This product already been '" + jsonProductData.Stage + "', you need to renew it now! ");

                        hideLoader();
                        RequestEnded();
                    }
                }
                else {

                    InsertIntoSPList('Products', jsonProductData).done(function (data) {
                        //console.log(data.d.results);
                        if (Number(data.d.ID) > 0) {


                            saveActionLog(data.d.ID, "Created New Product as " + $('#hid_Stage').val(), data.d.Status, Module.ProductManagement);

                            if (data.d.Status == 'Send For Approval') {
                                sendNotification();
                            }

                            window.location.href = "../Products.aspx";
                            //window.location = "../ProductDashboard.aspx?pid=" + data.d.ID;
                            /*
                            if (data.d.Status == "Draft" || data.d.Status == "On Hold" || data.d.Status == "Send Back") {

                                alert('Product has been saved successfully');

                            }
                            else if (data.d.Status == "Send For Approval") {
                                alert('Product has been send for approval');
                            }

                            // Retrive Nomenclatures newly Added
                            //bindProductTable(0);



                            RequestEnded();
                            */
                        }

                    }).fail(function (jqXHR, textStatus) {

                        alert("Product Saving Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                        RequestEnded();

                        hideLoader();
                    });
                }
            }
            else {

                hideLoader();
                RequestEnded();
                if (_isUniqueValue == false) {
                    modalWindow.find("#txtProduct").addClass("is-invalid");
                    alert("Another product already exist with same name!\n'" + jsonProductData.Title + "'");
                }

            }

        }
        else {
            hideLoader();
            modalWindow.find(".is-invalid").first().focus();
            alert("Please fill highlighted fields first!");
        }
    }

    function saveATrailRecord(_stage, _action, _jsonData) {
        return;

        // ////Maintaining product Trail once Saveing or finishing any Approved Product
        //if (_jsonData.Status != $("#hid_CurrentStatus").val() &&
        //    $("#hid_CurrentStatus").val() == "Approved")


        if (($("#hid_CurrentStatus").val() == 'EmptyRecord' ||
            $("#hid_CurrentStatus").val() == 'On Hold' ||
            $("#hid_Status").val() == 'EmptyRecord' ||
            $("#hid_Status").val() == 'On Hold' ||
            _recordId == 0) &&
            _action == 'Finish') {

            var _alreadySavedTraillst = [];

            var _trailFilter = "ProductLookupId eq " + Number(_recordId) + " and ProductLookupId gt 0"
            GetSPListItems("ProductTrails", 0, _trailFilter, false)
                .done(function (data) {
                    _alreadySavedTraillst = data.d.results;
                });

            var _haveingApplied = _alreadySavedTraillst.filter(function (a) { return a.Stage == 'Applied' });
            var _haveingRegistered = _alreadySavedTraillst.filter(function (a) { return a.Stage == 'Registered' });
            var _haveingPRV = _alreadySavedTraillst.filter(function (a) { return a.Stage == 'PRV' });
            var _haveingRenewal = _alreadySavedTraillst.filter(function (a) { return a.Stage == 'Renewal' });


            if (_jsonData.Stage == "Applied" ||
                _jsonData.Stage == "Pre-Registration" ||
                _jsonData.Stage == "Registered" ||
                _jsonData.Stage == "PRV" ||
                _jsonData.Stage == "Renewal") {
                // for applied entry
                if (_haveingApplied.length == 0) {

                    if (_jsonData.SubmissionDate != null && _jsonData.SubmissionDate.getFullYear() > 1900) {   /// if Applied data field
                        var trailData =
                        {
                            AppliedDate: _jsonData.AppliedDate,
                            ApprovedMRP: _jsonData.ApprovedMRP,
                            ApproverDecision: _jsonData.ApproverDecision,
                            CategoryLookupId: _jsonData.CategoryLookupId,
                            CompanyLookupId: _jsonData.CompanyLookupId,
                            CountryLookupId: _jsonData.CountryLookupId,
                            DateOfImplementation: _jsonData.DateOfImplementation,
                            Description: _jsonData.Description,
                            DosageTypeId: _jsonData.DosageTypeId,
                            Generic: _jsonData.Generic,
                            IsActive: _jsonData.IsActive,
                            IsDeleted: _jsonData.IsDeleted,
                            ManufacturingSiteLookupId: _jsonData.ManufacturingSiteLookupId,
                            MarketedMRP: _jsonData.MarketedMRP,
                            MarketedStatus: _jsonData.MarketedStatus,
                            Modified: _jsonData.Modified,
                            PRV_ApplicationDetails: _jsonData.PRV_ApplicationDetails,
                            PRV_Date: _jsonData.PRV_Date,
                            PRV_ProductName: _jsonData.PRV_ProductName,
                            PRV_RelatedTo: _jsonData.PRV_RelatedTo,
                            PRV_Remarks: _jsonData.PRV_Remarks,
                            PRV_ShelfLifeLookupId: _jsonData.PRV_ShelfLifeLookupId,
                            PRV_Strength: _jsonData.PRV_Strength,
                            PRV_Type: _jsonData.PRV_Type,
                            PackType: _jsonData.PackType,
                            PreRegistrationDate: _jsonData.PreRegistrationDate,
                            ProductOwnership: _jsonData.ProductOwnership,
                            RegistrationNo: _jsonData.RegistrationNo,
                            Registration_CanExpire: _jsonData.Registration_CanExpire,
                            Registration_DateOfRegistration: _jsonData.Registration_DateOfRegistration,
                            Registration_ExpiryDate: _jsonData.Registration_ExpiryDate,
                            Registration_PackType: _jsonData.Registration_PackType,
                            Registration_RegistrationNo: _jsonData.Registration_RegistrationNo,
                            Registration_ShelfLifeLookupId: _jsonData.Registration_ShelfLifeLookupId,
                            RenewalType: _jsonData.RenewalType,
                            Renewal_ExpiryDate: _jsonData.Renewal_ExpiryDate,
                            Renewal_RegistrationDate: _jsonData.Renewal_RegistrationDate,
                            Renewal_SubmissionDate: _jsonData.Renewal_SubmissionDate,
                            ShelfLifeLookupId: _jsonData.ShelfLifeLookupId,
                            SourceOfAPI: _jsonData.SourceOfAPI,
                            Stage: 'Applied',
                            Status: _jsonData.Status,
                            StorageCondition: _jsonData.StorageCondition,
                            Strength: _jsonData.Strength,
                            SubmissionDate: _jsonData.SubmissionDate,
                            Title: _jsonData.Title,
                            TrialStage: $("#hid_IsNewEntryTrailOpen").val(),
                            TrialStatus: _stage,
                            RenewalOrderLookupId: 0,
                        }
                        trailData.ProductLookupId = _recordId;

                        //if (data.d.Status == "Approved") {

                        InsertIntoSPList('ProductTrails', trailData, false).done(function (data) {
                            //console.log(data.d.results);
                            if (Number(data.d.ID) > 0) {
                                console.log("Fixed Trails Created for Applied!");
                            }

                        }).fail(function (jqXHR, textStatus) {
                            console.error("Fixed Trails Created Fails for Applied!", jqXHR);
                        });

                    }
                }
            }

            if (_jsonData.Stage == "PRV" ||
                _jsonData.Stage == "Renewal") {
                // for registered entry

                if (_haveingRegistered.length == 0) {

                    var trailData =
                    {
                        AppliedDate: _jsonData.AppliedDate,
                        ApprovedMRP: _jsonData.ApprovedMRP,
                        ApproverDecision: _jsonData.ApproverDecision,
                        CategoryLookupId: _jsonData.CategoryLookupId,
                        CompanyLookupId: _jsonData.CompanyLookupId,
                        CountryLookupId: _jsonData.CountryLookupId,
                        DateOfImplementation: _jsonData.DateOfImplementation,
                        Description: _jsonData.Description,
                        DosageTypeId: _jsonData.DosageTypeId,
                        Generic: _jsonData.Generic,
                        IsActive: _jsonData.IsActive,
                        IsDeleted: _jsonData.IsDeleted,
                        ManufacturingSiteLookupId: _jsonData.ManufacturingSiteLookupId,
                        MarketedMRP: _jsonData.MarketedMRP,
                        MarketedStatus: _jsonData.MarketedStatus,
                        Modified: _jsonData.Modified,
                        PRV_ApplicationDetails: _jsonData.PRV_ApplicationDetails,
                        PRV_Date: _jsonData.PRV_Date,
                        PRV_ProductName: _jsonData.PRV_ProductName,
                        PRV_RelatedTo: _jsonData.PRV_RelatedTo,
                        PRV_Remarks: _jsonData.PRV_Remarks,
                        PRV_ShelfLifeLookupId: _jsonData.PRV_ShelfLifeLookupId,
                        PRV_Strength: _jsonData.PRV_Strength,
                        PRV_Type: _jsonData.PRV_Type,
                        PackType: _jsonData.PackType,
                        PreRegistrationDate: _jsonData.PreRegistrationDate,
                        ProductOwnership: _jsonData.ProductOwnership,
                        RegistrationNo: _jsonData.RegistrationNo,
                        Registration_CanExpire: _jsonData.Registration_CanExpire,
                        Registration_DateOfRegistration: _jsonData.Registration_DateOfRegistration,
                        Registration_ExpiryDate: _jsonData.Registration_ExpiryDate,
                        Registration_PackType: _jsonData.Registration_PackType,
                        Registration_RegistrationNo: _jsonData.Registration_RegistrationNo,
                        Registration_ShelfLifeLookupId: _jsonData.Registration_ShelfLifeLookupId,
                        RenewalType: _jsonData.RenewalType,
                        Renewal_ExpiryDate: _jsonData.Renewal_ExpiryDate,
                        Renewal_RegistrationDate: _jsonData.Renewal_RegistrationDate,
                        Renewal_SubmissionDate: _jsonData.Renewal_SubmissionDate,
                        ShelfLifeLookupId: _jsonData.ShelfLifeLookupId,
                        SourceOfAPI: _jsonData.SourceOfAPI,
                        Stage: 'Registered',
                        Status: _jsonData.Status,
                        StorageCondition: _jsonData.StorageCondition,
                        Strength: _jsonData.Strength,
                        SubmissionDate: _jsonData.SubmissionDate,
                        Title: _jsonData.Title,
                        TrialStage: $("#hid_IsNewEntryTrailOpen").val(),
                        TrialStatus: _stage,
                        RenewalOrderLookupId: 1,
                    }
                    trailData.ProductLookupId = _recordId;

                    //if (data.d.Status == "Approved") {

                    InsertIntoSPList('ProductTrails', trailData, false).done(function (data) {
                        //console.log(data.d.results);
                        if (Number(data.d.ID) > 0) {
                            console.log("Fixed Trails Created for Applied!");
                        }

                    }).fail(function (jqXHR, textStatus) {
                        console.error("Fixed Trails Created Fails for Applied!", jqXHR);
                    });


                }
            }
            if (_jsonData.Stage == "PRV" ||
                _jsonData.Stage == "Renewal") {
                // for PRV entry
                if (_haveingPRV.length == 0) {

                    if (_jsonData.PRV_Date != null && _jsonData.PRV_Date.getFullYear() > 1900 && _jsonData.PRV_ProductName.length > 0) {   /// if PRV data is filled

                        var trailData =
                        {
                            AppliedDate: _jsonData.AppliedDate,
                            ApprovedMRP: _jsonData.ApprovedMRP,
                            ApproverDecision: _jsonData.ApproverDecision,
                            CategoryLookupId: _jsonData.CategoryLookupId,
                            CompanyLookupId: _jsonData.CompanyLookupId,
                            CountryLookupId: _jsonData.CountryLookupId,
                            DateOfImplementation: _jsonData.DateOfImplementation,
                            Description: _jsonData.Description,
                            DosageTypeId: _jsonData.DosageTypeId,
                            Generic: _jsonData.Generic,
                            IsActive: _jsonData.IsActive,
                            IsDeleted: _jsonData.IsDeleted,
                            ManufacturingSiteLookupId: _jsonData.ManufacturingSiteLookupId,
                            MarketedMRP: _jsonData.MarketedMRP,
                            MarketedStatus: _jsonData.MarketedStatus,
                            Modified: _jsonData.Modified,
                            PRV_ApplicationDetails: _jsonData.PRV_ApplicationDetails,
                            PRV_Date: _jsonData.PRV_Date,
                            PRV_ProductName: _jsonData.PRV_ProductName,
                            PRV_RelatedTo: _jsonData.PRV_RelatedTo,
                            PRV_Remarks: _jsonData.PRV_Remarks,
                            PRV_ShelfLifeLookupId: _jsonData.PRV_ShelfLifeLookupId,
                            PRV_Strength: _jsonData.PRV_Strength,
                            PRV_Type: _jsonData.PRV_Type,
                            PackType: _jsonData.PackType,
                            PreRegistrationDate: _jsonData.PreRegistrationDate,
                            ProductOwnership: _jsonData.ProductOwnership,
                            RegistrationNo: _jsonData.RegistrationNo,
                            Registration_CanExpire: _jsonData.Registration_CanExpire,
                            Registration_DateOfRegistration: _jsonData.Registration_DateOfRegistration,
                            Registration_ExpiryDate: _jsonData.Registration_ExpiryDate,
                            Registration_PackType: _jsonData.Registration_PackType,
                            Registration_RegistrationNo: _jsonData.Registration_RegistrationNo,
                            Registration_ShelfLifeLookupId: _jsonData.Registration_ShelfLifeLookupId,
                            RenewalType: _jsonData.RenewalType,
                            Renewal_ExpiryDate: _jsonData.Renewal_ExpiryDate,
                            Renewal_RegistrationDate: _jsonData.Renewal_RegistrationDate,
                            Renewal_SubmissionDate: _jsonData.Renewal_SubmissionDate,
                            ShelfLifeLookupId: _jsonData.ShelfLifeLookupId,
                            SourceOfAPI: _jsonData.SourceOfAPI,
                            Stage: 'PRV',
                            Status: _jsonData.Status,
                            StorageCondition: _jsonData.StorageCondition,
                            Strength: _jsonData.Strength,
                            SubmissionDate: _jsonData.SubmissionDate,
                            Title: _jsonData.Title,
                            TrialStage: $("#hid_IsNewEntryTrailOpen").val(),
                            TrialStatus: _stage,
                            RenewalOrderLookupId: 1,
                        }
                        trailData.ProductLookupId = _recordId;

                        //if (data.d.Status == "Approved") {

                        InsertIntoSPList('ProductTrails', trailData, false).done(function (data) {
                            //console.log(data.d.results);
                            if (Number(data.d.ID) > 0) {
                                console.log("Fixed Trails Created for Applied!");
                            }

                        }).fail(function (jqXHR, textStatus) {
                            console.error("Fixed Trails Created Fails for Applied!", jqXHR);
                        });


                    }
                }
            }
            /* // no need renewal entry
            if (_jsonData.Stage == "Renewal") {
                // for renewal entry
            
                if (_haveingRenewal.length == 0) {
                }
            }*/


        }

        if ((typeof (_jsonData) != 'undefined' &&
            //_jsonData.Status != $("#hid_CurrentStatus").val() &&
            //$("#hid_CurrentStatus").val() == "Approved") ||

            ($("#hid_Status").val() == 'On Hold' ||
                $("#hid_Status").val() == "Approved")) ||
            typeof (_action) == 'undefined') {

            if (Number(_recordId) > 0) {

                GetSPListItems("Products", _recordId, "", false)
                    .done(function (data) {

                        var trailData =
                        {
                            AppliedDate: data.d.AppliedDate,
                            ApprovedMRP: data.d.ApprovedMRP,
                            ApproverDecision: data.d.ApproverDecision,
                            CategoryLookupId: data.d.CategoryLookupId,
                            CompanyLookupId: data.d.CompanyLookupId,
                            CountryLookupId: data.d.CountryLookupId,
                            DateOfImplementation: data.d.DateOfImplementation,
                            Description: data.d.Description,
                            DosageTypeId: data.d.DosageTypeId,
                            Generic: data.d.Generic,
                            IsActive: data.d.IsActive,
                            IsDeleted: data.d.IsDeleted,
                            ManufacturingSiteLookupId: data.d.ManufacturingSiteLookupId,
                            MarketedMRP: data.d.MarketedMRP,
                            MarketedStatus: data.d.MarketedStatus,
                            Modified: data.d.Modified,
                            PRV_ApplicationDetails: data.d.PRV_ApplicationDetails,
                            PRV_Date: data.d.PRV_Date,
                            PRV_ProductName: data.d.PRV_ProductName,
                            PRV_RelatedTo: data.d.PRV_RelatedTo,
                            PRV_Remarks: data.d.PRV_Remarks,
                            PRV_ShelfLifeLookupId: data.d.PRV_ShelfLifeLookupId,
                            PRV_Strength: data.d.PRV_Strength,
                            PRV_Type: data.d.PRV_Type,
                            PackType: data.d.PackType,
                            PreRegistrationDate: data.d.PreRegistrationDate,
                            ProductOwnership: data.d.ProductOwnership,
                            RegistrationNo: data.d.RegistrationNo,
                            Registration_CanExpire: data.d.Registration_CanExpire,
                            Registration_DateOfRegistration: data.d.Registration_DateOfRegistration,
                            Registration_ExpiryDate: data.d.Registration_ExpiryDate,
                            Registration_PackType: data.d.Registration_PackType,
                            Registration_RegistrationNo: data.d.Registration_RegistrationNo,
                            Registration_ShelfLifeLookupId: data.d.Registration_ShelfLifeLookupId,
                            RenewalType: data.d.RenewalType,
                            Renewal_ExpiryDate: data.d.Renewal_ExpiryDate,
                            Renewal_RegistrationDate: data.d.Renewal_RegistrationDate,
                            Renewal_SubmissionDate: data.d.Renewal_SubmissionDate,
                            ShelfLifeLookupId: data.d.ShelfLifeLookupId,
                            SourceOfAPI: data.d.SourceOfAPI,
                            Stage: data.d.Stage,
                            Status: data.d.Status,
                            StorageCondition: data.d.StorageCondition,
                            Strength: data.d.Strength,
                            SubmissionDate: data.d.SubmissionDate,
                            Title: data.d.Title,
                            TrialStage: $("#hid_IsNewEntryTrailOpen").val(),
                            TrialStatus: _stage,
                            RenewalOrderLookupId: data.d.RenewalOrderLookupId,
                        }
                        trailData.ProductLookupId = data.d.Id;

                        //if (data.d.Status == "Approved") {
                        if (data.d.Status != "On Hold") {

                            InsertIntoSPList('ProductTrails', trailData, false).done(function (data) {
                                //console.log(data.d.results);
                                if (Number(data.d.ID) > 0) {
                                    console.log("Product Trails maintained");
                                }

                            }).fail(function (jqXHR, textStatus) {

                                alert("Product Trails maintaining Failed! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                            });
                        }

                    });


            }
        }
    }

    function saveBasicInformationByAdmin(_step) {

        var isValid = true;

        var modalWindow = $("#divFromDetials");

        var _datePreRegistration;
        var _submissionDate;

        modalWindow.find('.is-invalid').removeClass("is-invalid");

        if ((modalWindow.find("#ddlCompany").val().length > 0) == false) {
            isValid = false;
            modalWindow.find("#ddlCompany").addClass("is-invalid");
        }

        if ((modalWindow.find("#ddlCountry").val().length > 0) == false) {
            isValid = false;
            modalWindow.find("#ddlCountry").addClass("is-invalid");
        }

        if ((modalWindow.find("#ddlProductCategory").val().length > 0) == false) {
            isValid = false;
            modalWindow.find("#ddlProductCategory").addClass("is-invalid");
        }

        if ((modalWindow.find("#txtProduct").val().trim().length > 0) == false) {
            isValid = false;
            modalWindow.find("#txtProduct").addClass("is-invalid");
        }
        if ((modalWindow.find("#ddlDosageType").val().length > 0) == false) {
            isValid = false;
            modalWindow.find("#ddlDosageType").addClass("is-invalid");
        }
        if ((modalWindow.find("#txtGeneric").val().trim().length > 0) == false) {
            isValid = false;
            modalWindow.find("#txtGeneric").addClass("is-invalid");
        }
        if ((modalWindow.find("#txtStrength").val().trim().length > 0) == false) {
            isValid = false;
            modalWindow.find("#txtStrength").addClass("is-invalid");
        }


        if (isValid == true) {


            showLoader();

            var _recordId = $("#hid_ID").val();

            var jsonProductData = {
                CompanyLookupId: modalWindow.find('#ddlCompany').val(),
                CountryLookupId: modalWindow.find('#ddlCountry').val(),
                CategoryLookupId: modalWindow.find('#ddlProductCategory').val(),
                DosageTypeId: modalWindow.find('#ddlDosageType').val(),
                Title: modalWindow.find('#txtProduct').val().trim(),
                Generic: modalWindow.find('#txtGeneric').val().trim(),
                Strength: modalWindow.find('#txtStrength').val().trim()
            }

            var _isUniqueValue = checkForDuplicateValues(jsonProductData.Title, _recordId);

            if (_isUniqueValue == true) {

                if (Number(_recordId) > 0) {

                    UpdateSPList("Products", _recordId, jsonProductData).done(function (data) {

                        saveActionLog(_recordId, "Update Basic Information By Admin", "Update By Admin", Module.ProductManagement);

                        hideLoader();

                        alert("Basic Information has been updated.");

                        var _toggleControl = $("#ulAdminControls").find("input[type='checkbox']");
                        _toggleControl.prop('checked', false);
                        enableStepForAdmin(_toggleControl, 1);

                        bindActionHistory(_recordId);


                    }).fail(function (jqXHR, textStatus) {

                        alert("Update By Admin Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                        hideLoader();
                    });

                }
            }
            else {

                hideLoader();
                if (_isUniqueValue == false) {
                    modalWindow.find("#txtProduct").addClass("is-invalid");
                    alert("Another product already exist with same name!\n'" + jsonProductData.Title + "'");
                }

            }

        }
        else {
            alert("Please fill highlighted fields first!");
        }
    }

    function savePRVDetails(_actoin) {

        var isValid = true;

        var modalWindow = $("#divFromDetials");

        var _datePreRegistration;
        var _submissionDate;

        modalWindow.find('.is-invalid').removeClass("is-invalid");


        if ((modalWindow.find("#txtPRV_ProductName").val().trim().length > 0) == false) {
            isValid = false;
            modalWindow.find("#txtPRV_ProductName").addClass("is-invalid");
        }


        var _datePRV_Date = modalWindow.find('#txtPRV_Date').datepicker('getDate');
        if ((_datePRV_Date != null && _datePRV_Date.getFullYear() > 1970) == false) {
            isValid = false;
            modalWindow.find("#txtPRV_Date").addClass("is-invalid");
        }

        if ((Number(modalWindow.find("#ddlPRV_ShelfLife").val()) > 0) == false) {
            isValid = false;
            modalWindow.find("#ddlPRV_ShelfLife").addClass("is-invalid");
        }

        if ((modalWindow.find("#txtPRV_Strength").val().trim().length > 0) == false) {
            isValid = false;
            modalWindow.find("#txtPRV_Strength").addClass("is-invalid");
        }

        if (isValid == true) {


            showLoader();

            var _recordId = $("#hid_ID").val();

            var jsonProductData = {
                Id: _recordId
            }


            jsonProductData.PRV_ProductName = modalWindow.find('#txtPRV_ProductName').val().trim();

            if (modalWindow.find('#rdPRV_Applied').prop("checked") == true) {
                jsonProductData.PRV_Type = modalWindow.find('#rdPRV_Applied').val();
            }
            else if (modalWindow.find('#rdPRV_Approved').prop("checked") == true) {
                jsonProductData.PRV_Type = modalWindow.find('#rdPRV_Approved').val();
            }

            var _datePRV_Date = modalWindow.find('#txtPRV_Date').datepicker('getDate');
            if (_datePRV_Date && _datePRV_Date.getFullYear() > 1970) {
                jsonProductData.PRV_Date = _datePRV_Date;
            }



            jsonProductData.PRV_ShelfLifeLookupId = modalWindow.find('#ddlPRV_ShelfLife').val().trim();

            jsonProductData.PRV_Strength = modalWindow.find('#txtPRV_Strength').val().trim();

            jsonProductData.PRV_ApplicationDetails = modalWindow.find('#txtPRV_ApplicationDetails').val().trim();

            jsonProductData.PRV_Remarks = modalWindow.find('#txtPRV_Remarks').val().trim();

            var _PRV_RelatedToStr = "";
            modalWindow.find("#divPRV_RelatedTo").find(":checked").each(function () {
                _PRV_RelatedToStr = (_PRV_RelatedToStr.length > 0 ? _PRV_RelatedToStr + "," : "") + $(this).val();
            });

            jsonProductData.PRV_RelatedTo = _PRV_RelatedToStr;


            var _isUniqueValue = true; // checkForDuplicateValues(jsonProductData.PRV_ProductName, _recordID);

            if (_isUniqueValue == true) {

                if (Number(_recordId) > 0) {

                    if (_actoin == 'Save') {
                        jsonProductData.Status = 'On Hold';
                    }
                    else if (_actoin == 'Finish') {
                        jsonProductData.Status = 'Send For Approval';

                        saveATrailRecord('prv');
                    }


                    UpdateSPList("Products", _recordId, jsonProductData).done(function (data) {

                        saveActionLog(_recordId, "Add New PRV", "PRV", Module.ProductManagement);

                        hideLoader();

                        //alert("PRV has been added.");

                        var _toggleControl = $("#ulMaintainPRVTrail").find("input[type='checkbox']");
                        _toggleControl.prop('checked', false);
                        enableForTrail(_toggleControl, 'prv');

                        window.location.href = "../Products.aspx";

                        //// these function alredy call in enableForTrail()
                        //bindProductTrail(_recordId);
                        //bindActionHistory(_recordId);


                    }).fail(function (jqXHR, textStatus) {

                        alert("PRV Adding Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                        hideLoader();
                    });

                }
            }
            else {

                hideLoader();
                if (_isUniqueValue == false) {
                    modalWindow.find("#txtProduct").addClass("is-invalid");
                    alert("Another product already exist with same name!\n'" + jsonProductData.PRV_ProductName + "'");
                }

            }

        }
        else {
            alert("Please fill highlighted fields first!");
        }
    }


    function checkForDuplicateValues(_name, _id) {
        var isValidName = true;

        var filterProducts = "Title eq '" + _name + "' and IsDeleted eq 0 ";
        if (Number(_id) > 0) {
            filterProducts = filterProducts + " and Id ne '" + _id + "'";
        }
        GetSPListItems("Products", 0, filterProducts, false)
            .done(function (data) {

                var response = data.d.results;

                if (response.length > 0) {
                    isValidName = false;
                }

            });

        return isValidName;
    }

    function deleteProduct(_recordID) {

        var _confirmResult = confirm("Are you sure you want to delete this product?");
        if (_confirmResult == true) {
            var jsonData = {
                IsDeleted: true
            }
            UpdateSPList("Products", _recordID, jsonData).done(function (data) {

                alert('Product has been deleted successfully');
                // Retrive Nomenclatures newly Added
                //bindProductTable(0);

                RequestEnded();

            }).fail(function (jqXHR, textStatus) {

                alert("Product Deleting Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                RequestEnded();
            });
        }

    }



    function savePackSize() {

        var isValid = true;

        var modalWindow = $("#divModal-PackSize");

        var _hid_ProductId = modalWindow.find('#hid_ProductId').val();

        if (Number(_hid_ProductId) > 0) {

            modalWindow.find('.is-invalid').removeClass("is-invalid");

            if ((modalWindow.find("#txtPackSize").val().trim().length > 0) == false) {
                isValid = false;
                modalWindow.find("#txtPackSize").addClass("is-invalid");
            }
            if ((modalWindow.find("#txtPackagingType").val().trim().length > 0) == false) {
                isValid = false;
                modalWindow.find("#txtPackagingType").addClass("is-invalid");
            }


            if ((modalWindow.find("#ddlAppliedShelfLife").val().length > 0) == false) {
                isValid = false;
                modalWindow.find("#ddlAppliedShelfLife").addClass("is-invalid");
            }

            // Zafar: Its not mandatory 
            //if ((modalWindow.find("#txtMRP").val().length > 0) == false) {
            //    isValid = false;
            //    modalWindow.find("#txtMRP").addClass("is-invalid");
            //}

            if ((modalWindow.find("#txtStrength").val().trim().length > 0) == false) {
                isValid = false;
                modalWindow.find("#txtStrength").addClass("is-invalid");
            }
            /*
            if ((modalWindow.find("#txtSAP").val().length > 0) == false) {
                isValid = false;
                modalWindow.find("#txtSAP").addClass("is-invalid");
            }*/



            if (isValid == true) {

                RequestStarted();

                $("#divFromDetials").find("#txtPackType").val(modalWindow.find('#txtPackagingType').val());


                var _recordID = $("#hid_PackSizeId").val();

                var jsonData = {
                    PackSize: modalWindow.find('#txtPackSize').val(),
                    PackagingType: modalWindow.find('#txtPackagingType').val(),

                    Shelf: modalWindow.find('#ddlAppliedShelfLife').val(),
                    ShelfLifeLookupId: modalWindow.find('#ddlAppliedShelfLife').val(),
                    MRP: modalWindow.find('#txtMRP').val(),
                    Strength: modalWindow.find('#txtStrength').val(),
                    SAP: modalWindow.find('#txtSAP').val(),
                    ProductLookupId: _hid_ProductId,
                    Stage: "Applied"
                }

                if (Number(_recordID) > 0) {

                    UpdateSPList("ProductPackSize", _recordID, jsonData).done(function (data) {

                        alert('Pack size has been edit successfully');
                        // Retrive Nomenclatures newly Added



                        var _hid_ProductId = $('#hid_ID').val();

                        bindPackSize(_hid_ProductId);

                        $("#divModal-PackSize").modal('hide');

                        RequestEnded();

                    }).fail(function (jqXHR, textStatus) {

                        alert("Product Saving Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                        RequestEnded();
                    });

                }
                else {



                    InsertIntoSPList('ProductPackSize', jsonData).done(function (data) {
                        //console.log(data.d.results);
                        if (Number(data.d.ID) > 0) {


                            alert('Pack size has been added successfully');
                            // Retrive Nomenclatures newly Added
                            var _hid_ProductId = $('#hid_ID').val();

                            bindPackSize(_hid_ProductId);

                            $("#divModal-PackSize").modal('hide');

                            RequestEnded();
                        }

                    }).fail(function (jqXHR, textStatus) {

                        alert("Product Saving Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                        RequestEnded();
                    });
                }

            }
            else {
                alert("Please fill highlighted fields first!");
            }
        }
        else {
            alert("Please save the 'Basic Information' first!");
        }
    }

    function saveRegisteredPackSize() {

        var isValid = true;

        var modalWindow = $("#divModal-RegisteredPackaging");

        var _hid_ProductId = $("#divModal-PackSize").find('#hid_ProductId').val();

        if (Number(_hid_ProductId) > 0) {

            modalWindow.find('.is-invalid').removeClass("is-invalid");

            if ((modalWindow.find("#txtRegisteredPackSize").val().trim().length > 0) == false) {
                isValid = false;
                modalWindow.find("#txtRegisteredPackSize").addClass("is-invalid");
            }
            /// On Zafar request: Make them optional
            //if ((modalWindow.find("#txtRegisteredPackagingType").val().length > 0) == false) {
            //    isValid = false;
            //    modalWindow.find("#txtRegisteredPackagingType").addClass("is-invalid");
            //}


            //if ((modalWindow.find("#ddlRegisteredShelfLife").val().length > 0) == false) {
            //    isValid = false;
            //    modalWindow.find("#ddlRegisteredShelfLife").addClass("is-invalid");
            //}

            //if ((modalWindow.find("#txtRegisteredMRP").val().length > 0) == false) {
            //    isValid = false;
            //    modalWindow.find("#txtRegisteredMRP").addClass("is-invalid");
            //}

            //if ((modalWindow.find("#txtRegisteredStrength").val().length > 0) == false) {
            //    isValid = false;
            //    modalWindow.find("#txtRegisteredStrength").addClass("is-invalid");
            //}
            ///*
            //if ((modalWindow.find("#txtRegisteredSAP").val().length > 0) == false) {
            //    isValid = false;
            //    modalWindow.find("#txtRegisteredSAP").addClass("is-invalid");
            //}
            //*/


            //if ((modalWindow.find("#txtRegisteredMarketedMRP").val().length > 0) == false) {
            //    isValid = false;
            //    modalWindow.find("#txtRegisteredMarketedMRP").addClass("is-invalid");
            //}


            //if ((modalWindow.find("#txtRegisteredImplementationDate").val().length > 0) == false) {
            //    isValid = false;
            //    modalWindow.find("#txtRegisteredImplementationDate").addClass("is-invalid");
            //}


            if (isValid == true) {

                RequestStarted();

                var _recordID = $("#hid_PackSizeId").val();

                var _shelfLifeLookupId = null;
                if (Number(modalWindow.find('#ddlRegisteredShelfLife').val()) > 0) {
                    _shelfLifeLookupId = modalWindow.find('#ddlRegisteredShelfLife').val();
                }



                var jsonData = {
                    PackSize: modalWindow.find('#txtRegisteredPackSize').val(),
                    PackagingType: modalWindow.find('#txtRegisteredPackagingType').val(),

                    Shelf: _shelfLifeLookupId,
                    ShelfLifeLookupId: _shelfLifeLookupId,

                    MRP: (modalWindow.find('#txtRegisteredMRP').val()),
                    Strength: modalWindow.find('#txtRegisteredStrength').val(),
                    SAP: modalWindow.find('#txtRegisteredSAP').val(),
                    MarketedMRP: (modalWindow.find('#txtRegisteredMarketedMRP').val()),
                    //MRPImplementationDate: modalWindow.find('#txtRegisteredImplementationDate').val(),
                    ProductLookupId: _hid_ProductId,
                    Stage: "Registered"
                }

                var _registeredImplementationDate = modalWindow.find("#txtRegisteredImplementationDate").datepicker('getDate');
                if ((_registeredImplementationDate != null && _registeredImplementationDate.getFullYear() > 1970) == true) {
                    jsonData.MRPImplementationDate = _registeredImplementationDate;
                } else {
                    jsonData.MRPImplementationDate = null;
                }

                if (Number(_recordID) > 0) {

                    UpdateSPList("ProductPackSize", _recordID, jsonData).done(function (data) {

                        alert('Registered packaging has been edit successfully');
                        // Retrive Nomenclatures newly Added

                        var _hid_ProductId = $('#hid_ID').val();

                        bindPackSize(_hid_ProductId);

                        $("#divModal-RegisteredPackaging").modal('hide');

                        RequestEnded();

                    }).fail(function (jqXHR, textStatus) {

                        alert("Product Saving Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                        RequestEnded();
                    });

                }
                else {


                    InsertIntoSPList('ProductPackSize', jsonData).done(function (data) {
                        //console.log(data.d.results);
                        if (Number(data.d.ID) > 0) {


                            alert('Registered packaging has been added successfully');
                            // Retrive Nomenclatures newly Added
                            var _hid_ProductId = $('#hid_ID').val();

                            bindPackSize(_hid_ProductId);

                            $("#divModal-RegisteredPackaging").modal('hide');

                            RequestEnded();
                        }

                    }).fail(function (jqXHR, textStatus) {

                        alert("Product Saving Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                        RequestEnded();
                    });
                }
                try {
                    var mainFom = $("#divFromDetials");
                    mainFom.find('#txtApprovedMRP').val(jsonData.MRP > 0 ? jsonData.MRP : '');
                    mainFom.find('#txtMarketedMRP').val(jsonData.MarketedMRP > 0 ? jsonData.MarketedMRP : '');
                    mainFom.find('#txtRegistration_PackType').val(jsonData.PackagingType);

                    var _dateOfImplementation = new Date(jsonData.MRPImplementationDate);
                    if (_dateOfImplementation && _dateOfImplementation.getFullYear() > 1970)
                        mainFom.find("#txtImplementationDate").datepicker('setDate', _dateOfImplementation);

                    mainFom.find('#ddlRegisteredShelfLife').val(jsonData.ShelfLifeLookupId);
                } catch (ex) { console.error("Error On Setting register step deatils.", ex); }
            }
            else {
                alert("Please fill highlighted fields first!");
            }
        }
        else {
            alert("Please save the 'Basic Information' first!");
        }
    }


    function deleteProductPackSize(_recordID) {

        var _confirmResult = confirm("Are you sure you want to delete this pack size?");
        if (_confirmResult == true) {

            GetSPListItems("ProductPackSize", _recordID, '').done(function (data) {

                if (data && data.d) {
                    deleteItem("ProductPackSize", data.d).done(function (data) {
                        alert('Pack size has been deleted successfully');

                        var _hid_ProductId = $('#hid_ID').val();
                        bindPackSize(_hid_ProductId);

                        RequestEnded();
                    });
                }

            }).fail(function (jqXHR, textStatus) {

                alert("Product Deleting Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                RequestEnded();
            });
        }

    }



</script>




<script type="text/javascript">

    function fileAttachedFiles_onChange(_fileUploader) {
        var _htmlSelectFiles = "";

        if (_fileUploader.files.length > 0) {
            for (var fi = 0; fi < _fileUploader.files.length; fi++) {
                var fileName = _fileUploader.files[fi].name;
                var displayfileName = fileName.length > 40 ? fileName.substring(0, 25) + '...' + fileName.substring(fileName.length - 15) : fileName;
                var fileSize = _fileUploader.files[fi].size / 1024;

                if (fileSize > 1023)
                    fileSize = (fileSize / 1024).toFixed(2) + " MB";
                else
                    fileSize = fileSize.toFixed(2) + " KB";

                displayfileName = displayfileName + " (" + fileSize + ")";

                var htmlProgressBar = "<div class='progress no-margin'>" +
                    "  <div class='progress-bar progress-bar-warning progress-bar-striped' role='progressbar' aria-valuenow='0' aria-valuemin='0' aria-valuemax='100' style='width: 0%'>" +
                    "    <span class='sr-only'>" + 0 + "% Complete (Still uploading)</span>" +
                    "  </div>" +
                    " <span style='padding-left: 6px;position: absolute;left: 30px;color: darkred;'>" + displayfileName + "<span class='span-info small' style='padding-left: 10px;'></span></span>" +
                    "</div>";


                _htmlSelectFiles = _htmlSelectFiles + "<li id='li-file-" + fi + "' style='margin-bottom: 6px;'> " + htmlProgressBar + "</li>";
                //_htmlSelectFiles = _htmlSelectFiles + "<li id='" + fileName + "' > " + displayfileName + " (" + fileSize + ") <div class='progessbarhere'></div></li>";



            }
        }

        $("#olSelectFiles").html(_htmlSelectFiles);
    }


    // start
    function saveAttachment() {

        var docidall = "0;";
        // Define the folder path for this example.
        var serverRelativeUrlToFolder = 'ProductAttachments';

        // Get test values from the file input and text input page controls.
        var fileInput = jQuery('#fileAttachedFiles');
        var fileCount = fileInput[0].files.length;
        // Get the server URL.
        var serverUrl = _spPageContextInfo.webAbsoluteUrl;
        var filesUploaded = 0;

        var _ProductId = $('#hid_ID').val();

        if (isPDFFiles()) {

            //RequestStarted();
            showLoader();

            setTimeout(function () {
                $("#custom-loader").css("z-index", "2000");
            }, 100);

            for (var i = 0; i < fileCount; i++) {
                // Initiate method calls using jQuery promises.
                // Get the local file as an array buffer.
                var getFile = getFileBuffer(i);
                getFile.done(function (arrayBuffer, i) {

                    // Add the file to the SharePoint folder.
                    var addFile = addFileToFolder(arrayBuffer, i);
                    addFile.done(function (data, status, xhr) {
                        //$("#msg").append("<div>File : "+file.d.Name+" ... uploaded sucessfully</div>");
                        filesUploaded++;
                        var file = data.d;
                        // register/post register
                        var _attachmodalWin = $('#divModal-Attachment');
                        var updateObject = {
                            __metadata: {
                                type: file.ListItemAllFields.__metadata.type
                            },
                            ProductLookupId: _ProductId,
                            FileName: fileInput[0].files[i].name,
                            IsCertificate: $('#chkIsCertificate').is(':checked') ? true : false,
                            Stage: $('#hid_AttachmentType').val(),
                            RenewalOrderId: Number($('#hid_CurrentRenewalId').val()) + ""
                        };

                        if (Number($('#ddlFolders').val()) > 0) {
                            updateObject.FolderLookupId = $('#ddlFolders').val();
                        }

                        if (updateObject.Stage == 'Applied') {
                            updateObject.SubmissionDate = $("#divFromDetials").find('#txtSubmissionDate').datepicker('getDate');
                        }
                        else if (updateObject.Stage == 'Pre-Registration') {
                            updateObject.SubmissionDate = $("#divFromDetials").find('#txtPreRegistrationDate').datepicker('getDate');
                        }
                        else if (updateObject.Stage == 'Registered') {
                            updateObject.RegistrationDate = $("#divFromDetials").find('#txtRegistration_RegistrationDate').datepicker('getDate');
                            updateObject.ExpiryDate = $("#divFromDetials").find('#txtRegistration_ExpiryDate').datepicker('getDate');
                        }
                        else if (updateObject.Stage == 'PRV') {

                            if ($("#rdPRV_Applied").prop('checked')) {
                                updateObject.SubmissionDate = $("#divFromDetials").find('#txtPRV_Date').datepicker('getDate');
                                updateObject.RenewalType = 'Applied';
                            }
                            if ($("#rdPRV_Approved").prop('checked')) {
                                updateObject.RegistrationDate = $("#divFromDetials").find('#txtPRV_Date').datepicker('getDate');
                                updateObject.RenewalType = 'Approved';
                            }
                        }
                        else if (updateObject.Stage == 'Renewal') {

                            // On Asma, Request to Remove these filed from Attachments
                            //updateObject.SubmissionDate = $("#divFromDetials").find('#txtRenewalSubmissionDate').datepicker('getDate');
                            //updateObject.RegistrationDate = $("#divFromDetials").find('#txtRenewalRegistrationDate').datepicker('getDate');
                            //updateObject.ExpiryDate = $("#divFromDetials").find('#txtRenewalExpiryDate').datepicker('getDate');
                            /*
                            if ($("#radRenewalApplied").prop('checked'))
                                updateObject.RenewalType = 'Renewal Applied';
                            if ($("#radRenewalApproved").prop('checked'))
                                updateObject.RenewalType = 'Renewal Approved';
                                */

                            updateObject.RenewalType = _attachmodalWin.find("#lblRenewwalType").text();

                            if ($("#radRenewalApplied").prop('checked')) {
                                updateObject.SubmissionDate = $("#divFromDetials").find('#txtRenewalSubmissionDate').datepicker('getDate');
                            }
                            if ($("#radRenewalApproved").prop('checked')) {
                                updateObject.RegistrationDate = $("#divFromDetials").find('#txtRenewalRegistrationDate').datepicker('getDate');
                                updateObject.ExpiryDate = $("#divFromDetials").find('#txtRenewalExpiryDate').datepicker('getDate');
                                updateObject.Registration_RegistrationNo = $("#txtRegistrationNum").val();
                            }

                        }


                        var url = serverUrl + "/_api/Web/lists/getbytitle('" + serverRelativeUrlToFolder + "')/items(" + file.ListItemAllFields.Id + ")";
                        docidall += file.ListItemAllFields.Id + ";";
                        updateFileMetadata(url, updateObject, file, function (result) {
                            //alert("File metadata updation done successfully");
                        }, function (result) {
                            //alert("File upload done but metadata updating FAILED");
                        });
                        if (fileCount == filesUploaded) {

                            bindAttachment(_ProductId);
                            RequestEnded();

                            alert("All files uploaded successfully, please wait system is updating meta columns");
                            $('#divModal-Attachment').modal('hide');
                            $('#ddlFolders').val('');
                            $("#fileAttachedFiles").val("");
                            $('#chkiscertificate').prop('checked', false);

                            hideLoader();
                            //$('#txtRenewalSubmissionDate,#txtRenewalRegistrationDate,#txtRenewalExpiryDate').datepicker('setDate', null);


                            filesUploaded = 0;
                        }
                    });
                    addFile.fail(onError);
                });
                getFile.fail(onError);
            }
        }

        function isPDFFiles() {
            var flag = true;
            var files = fileInput[0].files;
            var maxsize = 5 * 1024 * 1024 * 1024;//5GB

            if (files.length == 0) {
                flag = false;
            }

            for (var i = 0; i < files.length; i++) {
                // validate extension
                //if (files[i].name.split(".")[1].toLowerCase() != "pdf") {
                //    flag = false;
                //    alert("Please update PDF files.");
                //    break;
                //}
                if (files[i].name.substr(-3).toLowerCase() != "pdf") {
                    flag = false;
                    alert("Please select PDF file(s).");
                    break;
                }

                // validate file size
                if (files[i].size > maxsize) {
                    flag = false;
                    alert("File size must be under 5GB.");
                    break;

                }
            }

            if (flag == false) {
                $('#fileAttachedFiles').addClass("is-invalid");
            } else {
                $('#fileAttachedFiles').removeClass("is-invalid");
            }

            return flag;
        }
        //update file metadata
        function updateFileMetadata(apiUrl, updateObject, file, success, failure) {
            $.ajax({
                url: apiUrl,
                type: "POST",
                async: false,
                data: JSON.stringify(updateObject),
                headers: {
                    "accept": "application/json;odata=verbose",
                    "X-RequestDigest": REQUEST_DIGEST_VALUE,    // $("#__REQUESTDIGEST").val(),
                    "Content-Type": "application/json;odata=verbose",
                    "X-Http-Method": "MERGE",
                    "IF-MATCH": file.ListItemAllFields.__metadata.etag,
                },
                xhr: function () {
                    var xhr = new window.XMLHttpRequest();

                    xhr.upload.addEventListener("progress", function (_evt) { fileuploaderprogresser(_evt, "li-file-" + index); }, false);

                    return xhr;
                },
                success: function (data) {
                    success(data);
                },
                error: function (data) {
                    failure(data);
                }
            });
        }
        // Get the local file as an array buffer.
        function getFileBuffer(i) {
            var deferred = jQuery.Deferred();
            var reader = new FileReader();
            reader.onloadend = function (e) {
                deferred.resolve(e.target.result, i);
            }
            reader.onerror = function (e) {
                deferred.reject(e.target.error);
            }
            reader.readAsArrayBuffer(fileInput[0].files[i]);
            return deferred.promise();
        }

        // Add the file to the file collection in the Shared Documents folder.
        function addFileToFolder(arrayBuffer, i) {
            var index = i;

            // Get the file name from the file input control on the page.
            //   var fileName = fileInput[0].files[index].name;

            var today = new Date();
            var timeStampString = new Date().getTime();
            var cHour = today.getHours();
            var cMin = today.getMinutes();
            var cSec = today.getSeconds();
            //  var fileName = fileInput[0].val().split('.').pop();

            // var fileName = fileInput[0].files[index].name.split('.');
            var filenameLength = fileInput[0].files[index].name.length;
            var fileName = fileInput[0].files[index].name.substr(0, filenameLength - 4);
            var fileExtenstion = fileInput[0].files[index].name.substr(filenameLength - 4);

            fileName = fileName + "-" + timeStampString + fileExtenstion;


            // Construct the endpoint.
            var fileCollectionEndpoint = String.format(
                "{0}/_api/web/getfolderbyserverrelativeurl('{1}')/files" +
                "/add(overwrite=true, url='{2}')?$expand=ListItemAllFields",
                serverUrl, serverRelativeUrlToFolder, fileName);

            // Send the request and return the response.
            // This call returns the SharePoint file.
            return jQuery.ajax({
                url: fileCollectionEndpoint,
                type: "POST",
                data: arrayBuffer,
                processData: false,
                headers: {
                    "accept": "application/json;odata=verbose",
                    "X-RequestDigest": REQUEST_DIGEST_VALUE,    // jQuery("#__REQUESTDIGEST").val(),
                    "content-length": arrayBuffer.byteLength
                },

                xhr: function () {
                    var xhr = new window.XMLHttpRequest();

                    xhr.upload.addEventListener("progress", function (_evt) { fileuploaderprogresser(_evt, "li-file-" + index); }, false);

                    return xhr;
                },
                
            });
        }

    }
    // Display error messages.
    function onError(error) {
        alert('File Uploading Fail! Try again after refreshing page.\n\nError Text:\n\n' + error.responseText);
        RequestEnded();
    }


    function fileuploaderprogresser(evt, _uploadingFileId) {
        var testTisObj = this;

        if (evt.lengthComputable) {
            var percentComplete = evt.loaded / evt.total;
            percentComplete = parseInt(percentComplete * 100);
            //var $link = $('.' + ids);
            //var $img = $link.find('i');
            //$link.html('Uploading..(' + percentComplete + '%)');
            //$link.append($img);

            //var _progressBar = $("#olSelectFiles").find("#progessbarhere").find(".progress-bar");
            var _progressBar = $("#olSelectFiles").find("#" + _uploadingFileId).find(".progress-bar");
            if (_progressBar.length == 0) {
                var htmlProgressBar = "<div class='progress no-margin'>" +
                    "  <div class='progress-bar progress-bar-warning progress-bar-striped' role='progressbar' aria-valuenow='" + percentComplete + "' aria-valuemin='0' aria-valuemax='100' style='width: " + percentComplete + "%'>" +
                    "    <span class='sr-only'>" + percentComplete + "% Complete (Still uploading)</span>" +
                    "  </div>" +
                    "</div>";

                //$("#olSelectFiles").find(".progessbarhere").html(htmlProgressBar);
                $("#olSelectFiles").find("#" + _uploadingFileId).html(htmlProgressBar);
            }
            else {
                _progressBar.css("width", percentComplete + '%');
                if (percentComplete < 100) {
                    _progressBar.find(".sr-only").text("" + percentComplete + "% Complete (Still uploading)");

                    var fileSize = evt.loaded / 1024;

                    if (fileSize > 1023)
                        fileSize = (fileSize / 1024).toFixed(3) + " MB uploaded";
                    else
                        fileSize = fileSize.toFixed(3) + " KB uploaded";


                    $("#" + _uploadingFileId).find('.span-info').text(fileSize);

                }
                else {
                    _progressBar.find(".sr-only").text("" + percentComplete + "% Uploaded");
                    _progressBar.addClass("progress-bar-success").removeClass("progress-bar-warning");
                    $("#" + _uploadingFileId).find('span').css("color", "white");
                    $("#" + _uploadingFileId).find('.span-info').text('');
                }
            }

        }
    }

    function deleteProductAttachment(_recordID) {

        var _confirmResult = confirm("Are you sure you want to delete this attachment?");
        if (_confirmResult == true) {

            GetSPListItems("ProductAttachments", _recordID, '').done(function (data) {

                if (data && data.d) {
                    deleteItem("ProductAttachments", data.d).done(function (data) {
                        alert('Attachment has been deleted successfully');
                        window.location.reload();

                        var _recordID = $('#hid_ID').val();

                        bindAttachment(_recordID, 'Edit');

                        RequestEnded();
                    });
                }

            }).fail(function (jqXHR, textStatus) {

                alert("CompanyCredentials Deleting Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                RequestEnded();
            });
        }

    }


    function viewDocument(_fileId, _NomenclatureTitle) {
        if (Number(_fileId) > 0) {

            //jQuery.noConflict();
            $('#divModal_ViewDocument').find("#h4NomenclatureTitle").text(_NomenclatureTitle);
            $('#divModal_ViewDocument').find("#frmpdf").remove();


            //$("#divModal_ViewAllAttachements").removeClass('fade');
            //$("#divModal_ViewAllAttachements").modal('hide');
            //setTimeout(function () {
            //    _needtoReopenthisWindow = $("#divModal_ViewAllAttachements");

            //}, 500);

            //$('#divModal_ViewDocument').find("#frmpdf").get(0).src = "";
            //$('#divModal_ViewDocument').find("#frmpdf").get(0).style.display = "none";

            //setTimeout(function () { },0);

            var listName = 'ProductAttachments';
            var apiURL = _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('" + listName + "')/items/GetById(" + _fileId + ")/file";

            $.ajax({
                url: apiURL,
                type: "GET",
                headers: {
                    "Accept": "application/json; odata=verbose",
                },
                success: function (dataFileInfo) {

                    if (dataFileInfo.d) {

                        var fileURL = location.origin + dataFileInfo.d.ServerRelativeUrl;
                        window.open(fileURL, '_blank');

                        /*
                        if (fileURL.search('.docx') > 0) {
                            downloadFunction(fileURL);
                            alert("File has been downloaded!");
                        }
                        else {
                            //document.getElementById("frmpdf").style.display = "block";
                            //document.getElementById("frmpdf").src = fileURL;

                            var _iframe = document.createElement("iframe");
                            _iframe.id = "frmpdf";
                            _iframe.src = fileURL;
                            _iframe.width = "100%";
                            _iframe.height = "700px";

                            var element = document.getElementById("divfrmpdf");
                            element.appendChild(_iframe);


                            jQuery.noConflict();
                            jQuery('#divModal_ViewDocument').modal('show');
                        }*/
                    }
                },
                error: function (error) {
                    console.log("Error on getting file info", error);

                    RequestEnded();
                }
            });
        }
        else {
            alert("No document found!");
        }

    }

    function min_max(_control) {

        jQuery.noConflict();
        if (jQuery(_control).parents(".modal-dialog").first().hasClass('maximise') == true) {
            jQuery(_control).parents(".modal-dialog").first().removeClass('maximise');
            jQuery(_control).parents(".modal-dialog").first().css('width', '');
        } else {
            jQuery(_control).parents(".modal-dialog").first().addClass('maximise');
            jQuery(_control).parents(".modal-dialog").first().css('width', '95vw');
            //$(_control).parents(".modal-dialog").first().css('height', '95vh');
        }
    }


    function downloadDocument(_fileId) {

        var listName = 'ProductAttachments';
        var apiURL = _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('" + listName + "')/items/GetById(" + _fileId + ")/file"

        $.ajax({
            url: apiURL,
            type: "GET",
            async: false,
            headers: {
                "Accept": "application/json; odata=verbose",
            },
            success: function (dataFileInfo) {

                if (dataFileInfo.d) {

                    var fileURL = location.origin + dataFileInfo.d.ServerRelativeUrl;
                    downloadFunction(fileURL);
                }

            },
            error: function (error) {
                console.log("Error on getting file info", error);

                RequestEnded();
            }
        });
    }


    function downloadFunction(url) {
        var file_path = url;
        var a = document.createElement('A');
        a.href = file_path;
        a.download = file_path.substr(file_path.lastIndexOf('/') + 1);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

    }


</script>




<script type="text/javascript">

    function bindShareDocumentUsers() {

        var template = "<tr id='tr_UserID'>" +
            "<td>" +
            "<input type='checkbox' class='chkItem' />" +
            "<span class='hide' id='spanUser_ID'>UserID</span>" +
            "<span class='hide' id='spanShareWith'>UserLoginName</span>" +
            "</td>" +
            "<td>" +
            "<span class='news_cls'>UserName</span>" +
            "</td>" +
            "<td>" +
            "<span class='dep_cls1' id='td_usertype'>UserType</span>" +
            "</td>" +
            "<td>" +
            "<span class='type_cls'>EmailAddress</span>" +
            "</td>" +
            "<td>" +
            "<span class='type_flag'>IsActive</span>" +
            "</td>" +
            "</tr>";


        var isActiveFilter = "IsActive eq '1' and IsDeleted eq '0'&$top=5000&$select=Id,Title,Email,UserType,IsActive,LoginIDId";

        GetSPListItems("Users", 0, isActiveFilter)
            .done(function (data) {


                if (data.d && data.d.results.length > 0) {

                    for (var _u = 0; _u < data.d.results.length; _u++) {
                        var _thisUserItem = data.d.results[_u];
                        //if (_thisUserItem.Id != currentUserCustomInfo.Id)
                        {

                            var html = template;

                            var _UserType = _thisUserItem.UserType;
                            var _IsActive = _thisUserItem.IsActive == true ? 'Active' : 'In-Active';


                            html = html.replace(/UserID/g, _thisUserItem.Id);
                            html = html.replace(/UserLoginName/g, _thisUserItem.LoginIDId);
                            html = html.replace(/UserName/g, _thisUserItem.Title);
                            html = html.replace(/EmailAddress/g, _thisUserItem.Email);
                            html = html.replace(/UserType/g, _UserType);
                            html = html.replace(/IsActive/g, _IsActive);


                            $("#tbluser>tbody").append(html);
                        }
                    }
                }

                $("#tbluser").DataTable({
                    destroy: true
                });

            });
    }
    function openShareWindow(_id, _fileId, _name) {
        var _DocID = 0;

        if (Number(_fileId) > 0) {
            _DocID = _fileId;
        }


        if (_DocID > 0) {

            $('#hid_docid_shared').val(_DocID);
            $("#tbluser>tbody").find("input[type='checkbox']").prop('checked', false); // reset all selected check boxes

            $('#div_DocName').html("<b>Name:</b> " + _name);
            $('#div_DocNumberVersion').html("");

            $('#divModal-ShareDocument').find(".modal-title").text('Share: ' + _name);

            $('#divModal-ShareDocument').modal('show');

            // _needtoReopenthisWindow = $("#divModal-CompanyCredentialsDetails");
        }
        return false;
    }
    function checkAll(_control) {
        if ($(_control).prop('checked') == true) {
            $("#tbluser>tbody").find("input[type='checkbox']").prop('checked', true);
        } else {
            $("#tbluser>tbody").find("input[type='checkbox']").prop('checked', false);
        }
    }

    //  user shared document section
    function SharedDocWithuser() {

        var listName = "ProductsShare";

        var flag = false;
        var id_ = "";

        var docShareSuccessIndex = 0;

        $("#tbluser>tbody").find("input[type='checkbox']:checked").each(function (a, item) {
            var row = $($(item).parents('tr').first());

            docShareSuccessIndex++;

            var obj = {};
            obj.Title = "";
            obj.ProductLookupId = $("#hid_ID").val();
            obj.DocumentLookupId = $('#hid_docid_shared').val();
            obj.UserLookupId = row.find("#spanUser_ID").text();


            InsertIntoSPList(listName, obj).done(function () {
                docShareSuccessIndex--;
                if (docShareSuccessIndex == 0) {
                    alert("Document has been shared by all selected user(s)!");

                    $('#divModal-ShareDocument').modal('hide');
                }

            }).fail(function () {
                docShareSuccessIndex--;
            });

            flag = true;
        });


        if (flag) {

        }
        else {
            alert('Please select atlest a user to share with!');
        }
        return false;
    }

</script>

<script type="text/javascript">
    function isPageAccessable(_countryId) {

        if (Number(_countryId) > 0) {
            if (haveAccessTo(Module.ProductManagement, _countryId) == false) {

                document.location = _spPageContextInfo.webAbsoluteUrl + "/SitePages/AccessDenied.aspx";
            }
        }
        else if (haveAccessTo(Module.ProductManagement) == false) {

            document.location = _spPageContextInfo.webAbsoluteUrl + "/SitePages/AccessDenied.aspx";
        }
    }
</script>

<!--  Notification  -->
<script type="text/javascript">




    function notificationMarkAsSeen() {
        try {

            var _notid = GetUrlKeyValue('notid');

            if (Number(_notid) > 0) {

                markAsRead(_notid);

            }


            var _ProductId = $('#hid_ID').val();

            if (Number(_ProductId) > 0) {

                var notificationsJson = {
                    RecordId: "" + _ProductId
                };

                notificationsJson.ModuleType = Module.ProductManagement;
                listTitle = "Products";


                var filterNomenclature = "HasSeen eq 0 and NotifyToUsersId eq " + _spPageContextInfo.userId + " and ModuleType eq '" + notificationsJson.ModuleType + "' and RecordId eq '" + notificationsJson.RecordId + "' and Action ne 'Submit'&$top=1000&$select=Id,Title,RecordId,ProductLookupId,ArtworkLookupId,CredentialLookupId,Action,HasSeen,SeenOn,ModuleType,Created";
                GetSPListItems("Notifications", 0, filterNomenclature)
                    .done(function (data) {

                        var response = data.d.results;
                        for (var i = 0; i < response.length; i++) {
                            if (Number(response[i].Id) > 0) {
                                markAsRead(response[i].Id);
                            }
                        }
                    });

            }

        } catch (ex2) {
            console.log(ex2);
        }
    }


    function sendNotification() {


        /*

Title   Single line of text	
Modified	Date and Time	
Created	Date and Time	
Action	Single line of text	
NotifyToLookup	Lookup	
NotifyToUsers	Person or Group	
ActionByUser	Lookup	
HasSeen	Yes/No	
SeenOn	Date and Time	
RecordId	Single line of text	
ProductLookup	Lookup	
ArtworkLookup	Lookup	
CredentialLookup	Lookup	
ModuleType	Single line of text	
Created By	Person or Group	
Modified By	Person or Group

            */

        var sendNotifiaction = false;

        var notificationText = "";
        var notificationToUserLookupIds = [];
        var notificationToSPUserIds = [];
  
        var notificationAsGroup = false;



        notificationText = "A product has been submitted and waiting for your approval!";

        var profileIdLst = [];
        var filterProfileQuery = "CanApprove eq 1 and ModuleType eq '" + Module.ProductManagement + "' and CountryLookupId eq " + $("#ddlCountry").val() + "&$top=5000&$select=Id,ProfileLookupId";
        GetSPListItems("ProfileRights", 0, filterProfileQuery, false)
            .done(function (data) {
                if (data.d.results.length > 0) {
                    data.d.results.forEach(function (pdetails) {

                        if (Number(pdetails.ProfileLookupId) > 0) {

                            profileIdLst.push(pdetails.ProfileLookupId);

                        }
                    });

                }
            });

        var filterQuery = "IsActive eq 1&$top=5000&$select=Id,LoginIDId,ProfileLookupId";
        GetSPListItems("Users", 0, filterQuery, false)
            .done(function (data) {
                if (data.d.results.length > 0) {

                    data.d.results.forEach(function (uid) {
                        if (Number(uid.LoginIDId) > 0 && Number(uid.LoginIDId) != _spPageContextInfo.userId) {
                            if (uid.ProfileLookupId && uid.ProfileLookupId != null && uid.ProfileLookupId.results != null && uid.ProfileLookupId.results.length > 0) {
                                uid.ProfileLookupId.results.forEach(function (profileId) {

                                    if (Number(profileId) > 0 && profileIdLst.includes(profileId)) {

                                        notificationToUserLookupIds.push(uid.Id);
                                        notificationToSPUserIds.push(uid.LoginIDId);
                                        //checkUserTypeForAttachment = uid.UserType;

                                        sendNotifiaction = true;
                                        notificationAsGroup = true;
                                    }

                                });
                            }
                        }
                    });

                }
            });




        if (sendNotifiaction == true) {

            if (notificationAsGroup == true) {

                var notificationsJson = {
                    Title: notificationText,
                    RecordId: $('#hid_ID').val(),
                    ProductLookupId: $('#hid_ID').val(),
                    Action: "Submit",
                    ActionByUserId: currentUserCustomInfo.Id,
                    NotifyToUsersId: { 'results': notificationToSPUserIds },
                    NotifyToLookupId: { 'results': notificationToUserLookupIds },
                    HasSeen: false,
                    ModuleType: Module.ProductManagement//SeenOn: null

                }

                InsertIntoSPList("Notifications", notificationsJson).done(function (data) {
                    console.log("Notifications Saved.");
                }).fail(onerror);

            }
            else {
                /*
                notificationToSPUserIds.forEach(function (userId) {
                    var userIDArray = [];
                    userIDArray.push(userId);
                    var notificationsJson = {
                        Title: notificationText,
                        NomenclatureLookupId: actionHistoryJson.NomenclatureLookupId,
                        Action: actionHistoryJson.ApproverAction,
                        ActionByUserId: currentUserCustomInfo.Id,
                        NotifyToId: { 'results': userIDArray },
                        HasSeen: false,
                        FolderId: "" + loadedFolder.ID
                        //SeenOn: null

                    }

                    InsertIntoSPList("Notifications", notificationsJson).done(function (data) {
                        console.log("Notification Saved.");
                    }).fail(onerror);
                });
                */
            }
        }
    }

</script>
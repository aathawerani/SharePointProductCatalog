<!-- Bootstrap core CSS -->

<link href="../Style%20Library/CustomStyleLibraries/jquery-ui-datepicker/jquery-ui.min.css?v=1.0" rel="stylesheet">
<link href="../Style%20Library/CustomStyleLibraries/bootstrap-3.3.7-dist/css/bootstrap.min.css?v=1.0" rel="stylesheet">
<link href="../Style%20Library/CustomStyleLibraries/datatable/dataTables.bootstrap4.css?v=1.0" rel="stylesheet" />
<link href="../Style%20Library/CustomStyleLibraries/datatable/dataTables.responsive.css?v=1.0" rel="stylesheet" />
<link href="../Style%20Library/CustomStyleLibraries/datatable/dataTables.bootstrap4.min.css?v=1.0" rel="stylesheet" />

<script src="../Style%20Library/CustomStyleLibraries/jquery-ui-datepicker/jquery-ui.min.js?v=1.0"></script>

<script src="../Style%20Library/CustomStyleLibraries/bootstrap-3.3.7-dist/js/bootstrap.min.js?v=1.0"></script>
<script src="../Style%20Library/CustomStyleLibraries/datatable/jquery.dataTables.min.js?v=1.0"></script>
<script src="../Style%20Library/CustomStyleLibraries/datatable/dataTables.bootstrap.min.js?v=1.0"></script>
<script src="../Style%20Library/CustomStyleLibraries/datatable/dataTables.responsive.js?v=1.0"></script>


<style type="text/css">
    .column_filter {
        width: 100% !important;
    }
</style>

<div style="margin-top: 0px;">

    <div class="row">
        <div class="col-md-12">
            <button type="button" class="btn btn-primary pull-right" id="btnAddLotReleased" onclick="openLotReleased(0, 'Create')"><i class="glyphicon glyphicon-plus"></i> Create Lot Release</button>
        </div>
    </div>

    <!--<div class="panel panel-default">
        <div class="panel-body">-->


    <div class="row" style="margin-top: 20px;">
        <div class="col-md-12">

            <table id="tblLotReleased" class="table table-striped" style="width: 100%">
                <thead class="alert alert-info h5">

                    <tr>

                        <th class="th-sm" data-column='0'> <input type='text' class='column_filter form-control  record-id' onchange='SearchCol(0)' autocomplete="off" /></th>
                        <th class="th-sm" data-column='1'> <input type='text' class='column_filter form-control' onkeyup='SearchCol(1)' autocomplete="off" /></th>
                        <th class="th-sm" data-column='2'> <input type='text' class='column_filter form-control' onkeyup='SearchCol(2)' autocomplete="off" /></th>
                        <th class="th-sm" data-column='3'> <input type='text' class='column_filter form-control' onkeyup='SearchCol(3)' autocomplete="off" /></th>
                        <th class="th-sm" data-column='4'> <input type='text' class='column_filter form-control' onkeyup='SearchCol(4)' autocomplete="off" /></th>
                        <th class="th-sm" data-column='5'> <input type='text' class='column_filter form-control' onkeyup='SearchCol(5)' autocomplete="off" /></th>
                        <th class="th-sm" data-column='6'> <input type='text' class='column_filter form-control' onkeyup='SearchCol(6)' autocomplete="off" /></th>
                        <th class="th-sm" data-column='7'> <input type='text' class='column_filter form-control' onkeyup='SearchCol(7)' autocomplete="off" /></th>
                        <th class="th-sm" data-column='8'> <input type='text' class='column_filter form-control' onkeyup='SearchCol(8)' autocomplete="off" /></th>
                        <th class="th-sm" data-column='9'> <input type='text' class='column_filter form-control' onkeyup='SearchCol(9)' autocomplete="off" /></th>
                        <th class="th-sm" data-column='10'> </th>

                    </tr>
                    <tr>
                        <th style="text-align: left" class="th-sm">
                            Id
                        </th>
                        <th class=" th-sm">
                            Modified
                        </th>
                        <th style="text-align: left" class="th-sm">
                            Company
                        </th>
                        <th class=" th-sm">
                            Product
                        </th>
                        <th class="th-sm">
                            Generic
                        </th>
                        <th class="th-sm">
                            Reg No.
                        </th>
                        <th class="th-sm">
                            Batch No.
                        </th>
                        <th class="th-sm">
                            Batch Size
                        </th>
                        <th class="th-sm">
                            Stage
                        </th>
                        <th class="th-sm">
                            Status
                        </th>
                        <th class="th-sm" align='center' style="text-align:center;">
                            Action
                        </th>
                    </tr>

                </thead>

                <tbody></tbody>

            </table>

        </div>
    </div>


    <!--</div>
    </div>-->

</div>

<!-- Start LotReleased Modal -->
<div class="modal fade" id="divModal-LotReleased" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" id="mod_mesga">&times;</span>
                </button>
                <h2 class="modal-title">Add Lot Release</h2>
            </div>
            <div class="modal-body">
                <input type='hidden' id='hid_LotReleasedId' />
                <input type='hidden' id='hid_ProductId' />
                <input type='hidden' id='hid_RelatedLotReleasedId' />

                <div>


                    <div class="row">

                        <div class="col-md-8">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <br />
                                    <input type="radio" id="radApplied" name="producttype" class="no-margin" title="View Applied Only" checked="checked" style="width: 25px;height: 16px;" onchange="onTypeChange(this)">
                                    <label for="radApplied" class="no-margin h4">Applied</label>

                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <br />
                                    <input type="radio" id="radApproved" name="producttype" class="no-margin" title="View Registered Only" style="width: 25px;height: 16px;" onchange="onTypeChange(this)">
                                    <label for="radApproved" class="no-margin h4">Approved</label>

                                </div>
                            </div>
                        </div>
                    </div>




                    <div class="row">


                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Company<i class="text-danger">*</i></label>
                                    <!--<select id="ddlLotReleasedCompany" class="form-control" onchange="bindProductsDDL()"></select>-->
                                    <select id="ddlLotReleasedCompany" class="form-control" ></select>
                                </div>
                            </div>
                        </div>


                        <div class="col-md-8">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Product Name<i class="text-danger">*</i></label>
                                    <!--<select id="ddlLotReleasedProduct" class="form-control" onchange="onSelectLotReleasedProduct()"></select>-->

                                    <input type="text" id="txtLotReleasedProduct" class="form-control" maxlength="255" />
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Generic</label>
                                    <input type="text" id="txtLotReleasedGeneric" class="form-control" maxlength="255" />
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Strength</label>
                                    <input type="text" id="txtLotReleasedStrength" class="form-control" maxlength="255"  />
                                </div>
                            </div>
                        </div>


                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Dosage Form </label>
                                    <select id="ddlLotReleasedDosageType" class="form-control" ></select>
                                </div>
                            </div>
                        </div>


                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Reg No. </label>
                                    <input type="text" id="txtRegNo" class="form-control" maxlength="255"  />
                                </div>
                            </div>
                        </div>

                    </div>

                    <hr />

                    <div class="row">

                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Batch No<i class="text-danger">*</i></label>
                                    <input type="text" id="txtBatchNo" class="form-control" maxlength="255" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Batch Size<i class="text-danger">*</i></label>
                                    <input type="text" id="txtBatchSize" class="form-control" maxlength="255" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Date of Manufacturing<i class="text-danger">*</i> </label>
                                    <input type="text" id="txtDateOfManufacturing" class="form-control datepicker" maxlength="15" autocomplete="off" />
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Date of Expiry<i class="text-danger">*</i> </label>
                                    <input type="text" id="txtDateOfExpiry" class="form-control datepicker" maxlength="15" autocomplete="off" />
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 approverecord-data" style="display:none;">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Date of Issuance<i class="text-danger">*</i> </label>
                                    <input type="text" id="txtDateOfIssuance" class="form-control datepicker" maxlength="15" autocomplete="off" />
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 approverecord-data" style="display:none;">

                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>Lot Release No<i class="text-danger">*</i> </label>
                                    <!--<label id="lblLotReleasedNo" class="form-control"></label>-->
                                    <input type="text" id="txtLotReleasedNo" class="form-control" maxlength="255" />
                                </div>
                            </div>

                        </div>
                    </div>

                </div>
                <div class="row" id="divAttachment" style="display:none;">
                    <div class="col-md-12">
                        <hr />
                        <h4 class="pull-left">Attachment</h4>
                        <a id="btnAddAttachment" href="#" title="Add Attachment" onclick="openAddAttachment(0)" class="btn btn-info btn-sm pull-right h5"><i class="glyphicon glyphicon-plus"></i>&nbsp;Add Attachment</a>
                    </div>
                    <div class="col-md-12">

                        <table id="tblAttachment" class="table table-striped small" style="width: 100%">
                            <thead class="alert alert-info h5">

                                <tr>
                                    <th class="th-sm">
                                        #
                                    </th>
                                    <th class="th-sm">
                                        File Name
                                    </th>

                                    <th class="th-sm">
                                        Uploaded On
                                    </th>

                                    <th class="th-sm" align='center' style='text-align:center;'>
                                        Delete
                                    </th>
                                </tr>

                            </thead>

                            <tbody><tr><td colspan="3">No attachment attachted!</td></tr></tbody>

                        </table>


                    </div>
                </div>



            </div>
            <div class="modal-footer">

                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" id="btnSave" class="btn btn-info" onclick="saveLotRealeased();"><i class="glyphicon glyphicon-floppy-disk"></i> Save</button>
                <button type="button" id="btnFinish" class="btn btn-success" style="display: none;" onclick="saveLotRealeased('finish');"><i class="glyphicon glyphicon-ok"></i> Finish</button>

            </div>
        </div>
    </div>


</div>
<!-- End LotReleased Modal -->

<!-- Start Attachment Modal -->
<div class="modal fade" id="divModal-Attachment" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" id="mod_mesga">&times;</span>
                </button>
                <h2 class="modal-title">Add Attachment</h2>
            </div>
            <div class="modal-body">
                
                <div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <label>File Attachment<i class="text-danger">*</i> </label>
                                    <input type="file" id="fileAttachedFiles" class="form-control" multiple="multiple" />
                                </div>
                            </div>
                        </div>

                    </div>

                </div>
                
            </div>
            <div class="modal-footer">

                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" id="btnSave" class="btn btn-success" onclick="saveAttachment();"><i class="glyphicon glyphicon-floppy-disk"></i> Save Attachment</button>

            </div>
        </div>
    </div>

</div>
<!-- End Attachment Modal -->

<!-- Modal View Document -->
<div class="modal fade" id="divModal_ViewDocument" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" id="mod_mesga">&times;</span>
                </button>
                <button type="button" class="close" onclick="min_max(this)">
                    <span><i class="glyphicon glyphicon-resize-horizontal"></i></span>
                </button>
                <h3 class="modal-title" id="h4NomenclatureTitle">File Title</h3>
            </div>
            <div class="modal-body">
                <div id="divfrmpdf"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>

            </div>
        </div>
    </div>
</div>
<!-- Modal View Document -->

<script type="text/javascript">
    $(document).ready(function () {


        $('.datepicker').not(".hasDatepicker").datepicker({
            onSelect: function (dateText, datepickerObj) {
                console.log("Selected date: " + dateText + "; input's current value: " + this.value, datepickerObj);
            }
        });

        bindLotReleasedCompanyDDLs();

        var product_ID = 0;
        try {
            product_ID = $("#hid_LotReleasedId").val();
        } catch (a) { }

        bindLotReleasedTable(product_ID);


    });


    var tblLotReleasedDataTable = null;
    function bindLotReleasedTable(_id) {
        // Specify the Id of the Item that you want to fetch

        if ($('#tblLotReleased').hasClass("dataTable") == true) {
            $('#tblLotReleased').DataTable().destroy();
        }
        $('#tblLotReleased>tbody').html('');
        

        var idFilter = ""; //"IsDeleted eq 0"; //"IsActive eq 1";
        if (Number(_id) > 0) {
            idFilter = "ProductLookupId eq " + _id;
        }

        

        var filterProducts = idFilter + "&$select=ID,Title," +
            "RegNo," +
            "LotReleaseNo," +
            "BatchNo," +
            "BatchSize," +
            "DateOfManufacturing," +
            "DateOfExpiry," +
            "DateOfIssuance," +
            "Stage," +
            "Status," +
            "ProductTitle,ProductDosageTypeLookupId,ProductGeneric,ProductStrength,ProductRegistrationNo," +
            "ProductLookup/Id,ProductLookup/Title,ProductLookup/Strength,ProductLookup/Generic,ProductLookup/RegistrationNo," +
            "CompanyLookup/Id,CompanyLookup/Title," +
            "Created,Modified" +
            "&$expand=CompanyLookup,ProductLookup&$orderby=Modified desc";

        GetSPListItems("LotRelease", 0, filterProducts)
            .done(function (data) {

                var response = data.d.results;
                for (var i = 0; i < response.length ; i++) {

                    var _item = response[i];

                    //if (havePremission(Permission.VIEW, Module.LotRelease, _item["CountryLookup"].Id) == true)
                    if (havePremission(Permission.VIEW, Module.LotRelease) == true)
                    {
                        /*var _statusText = 'In-Active';

                        if (_item.IsActive)
                            _statusText = (_item.IsActive == true ? 'Active' : 'In-Active');
                            */

                        var newRow = "<tr id='" + _item["ID"] + "'>" +
                            "<td class='Col-RecordId'>-" + _item["ID"] + "-</td>" +
                            "<td class='Col-RecordModified'>-" + getDataTableSortableDateTime(_item["Modified"]) + _item["Modified"] + "-</td>" +
                            "<td>" + ((_item["CompanyLookup"]) ? _item["CompanyLookup"].Title : "") + "</td>" +
                            //"<td>" + ((_item["ProductLookup"]) ? _item["ProductLookup"].Title : "") + "</td>" +
                            //"<td>" + ((_item["ProductLookup"]) ? _item["ProductLookup"].Generic : "") + "</td>" +
                            //"<td>" + ((_item["ProductLookup"]) ? _item["ProductLookup"].RegistrationNo : "-") + "</td>" +
                            "<td>" + ((_item["ProductTitle"]) ? _item["ProductTitle"] : "") + "</td>" +
                            "<td>" + ((_item["ProductGeneric"]) ? _item["ProductGeneric"] : "") + "</td>" +
                            "<td>" + ((_item["ProductRegistrationNo"]) ? _item["ProductRegistrationNo"] : "-") + "</td>" +
                            "<td>" + _item["BatchNo"] + "</td>" +
                            "<td>" + _item["BatchSize"] + "</td>" +
                            "<td>" + _item["Stage"] + "</td>"+
                            "<td>" + _item["Status"] + "</td>";

                        var _actionButtonHTML = createActionDropdown(_item);

                        newRow = newRow + "<td align='center' style='text-align:center;'>" + _actionButtonHTML + "</td>";
                        newRow = newRow + "</tr>";

                        $('#tblLotReleased>tbody').append(newRow);
                    }
                }

                /*if ($('#tblLotReleased>tbody').find('tr').length == 0) {
                    $('#tblLotReleased>tbody').html('<tr><td colspan="11">No lot release created!</td></tr>');
                }*/
                
                $('#tblLotReleased').on('draw.dt', function () {
                    $(".dataTables_filter").find('input').addClass('form-control input-sm');
                    $(".dataTables_filter").addClass('hide');
                });

                tblLotReleasedDataTable = $("#tblLotReleased").DataTable({
                    "order": [[1, "desc"]]
                });

                tblLotReleasedDataTable.column(0).visible(false);
                tblLotReleasedDataTable.column(1).visible(false);
                
                openLotReleaseFromURL();

                notificationMarkAsSeen();
            });

    }

    function createActionDropdown(_item) {

        var buttonAttr = "";

        var _actionBtnHtml = "<div class='btn-group'>";
        _actionBtnHtml += "  <button type='button' class='btn btn-primary dropdown-toggle' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false' " + buttonAttr + ">        ";
        _actionBtnHtml += "    Action <span class='caret'></span>";
        _actionBtnHtml += "  </button>";
        _actionBtnHtml += "  <ul class='dropdown-menu dropdown-menu-right'>";


        _actionBtnHtml += "    <li class=''><a href='#' id='awf'  onclick='openLotReleased(" + _item.Id + ",\"view\")' ><i class='glyphicon glyphicon-list-alt'></i>&nbsp;View</a></li>";

        //if (havePremission(Permission.UPLOAD, Module.LotRelease, _item["CountryLookup"].Id) == true) {

        if (_item.Status == "Draft" || _item.Status == "Send Back") {
            _actionBtnHtml += "    <li class=''><a href='#' id='awf'  onclick='openLotReleased(" + _item.Id + ",\"edit\")' ><i class='glyphicon glyphicon-edit'></i>&nbsp;Edit</a></li>";
            //_actionBtnHtml += "    <li class=''><a href='#' id='awf'  onclick='openProductPackSize(" + _item.Id + ")' ><i class='glyphicon glyphicon-th-list'></i>&nbsp;Pack Size</a></li>";
        }

        if (_item.Stage == "Applied" && _item.Status == "Approved") {
            _actionBtnHtml += "    <li class=''><a href='#' id='awf'  onclick='openLotReleased(" + _item.Id + ",\"editAfterApproved\")' ><i class='glyphicon glyphicon-edit'></i>&nbsp;Edit</a></li>";
            //_actionBtnHtml += "    <li class=''><a href='#' id='awf'  onclick='openProductPackSize(" + _item.Id + ")' ><i class='glyphicon glyphicon-th-list'></i>&nbsp;Pack Size</a></li>";
        }




        //if (havePremission(Permission.UPLOAD, Module.LotRelease, _item["CountryLookup"].Id) == true) {
        if (havePremission(Permission.UPLOAD, Module.LotRelease) == true) {
            if (_item.Status == "Draft" || _item.Status == "Send Back") {
                _actionBtnHtml += "    <li class=''><a href='#' id='awf'  onclick='deleteLotRealeased(" + _item.Id + ",\"delete\")' ><i class='glyphicon glyphicon-trash'></i>&nbsp;Delete</a></li>";
            }
        }
        //}

        _actionBtnHtml += "  </ul>";
        _actionBtnHtml += "</div>";



        return _actionBtnHtml;
    }


    function openLotReleaseFromURL() {
        var _recordId = 0;

        //GetUrlKeyValue('rid')
        //_recordId = GetQueryString('rid');


        _recordId = localStorage.getItem("LotReleaseIdForView");

        if (Number(_recordId) > 0) {
            openLotReleased(_recordId, 'view');
            localStorage.removeItem("LotReleaseIdForView");
        }
    }

    function openLotReleased(_id, _mode) {

        var modalWindow = $("#divModal-LotReleased");
        

        modalWindow.find(".modal-title").text('Create Lot Release');

        // reset All controls
        modalWindow.find("select,input[type='text'],input[type='hidden']").val('');
        modalWindow.find(".is-invalid").removeClass("is-invalid");
        
        if (_mode == 'view') {
            modalWindow.find(".modal-title").text('View Lot Release');
            modalWindow.find("#btnSave,#btnFinish,#btnAddAttachment").hide();
            modalWindow.find('input,select').prop('disabled', true);
            modalWindow.find("#divAttachment").show();
        }
        else if (_mode == 'edit') {
            modalWindow.find(".modal-title").text('Edit Lot Release');
            modalWindow.find("#btnSave,#btnFinish").show();
            //modalWindow.find('input,select').not("#txtLotReleasedGeneric,#txtLotReleasedStrength,#ddlLotReleasedDosageType,#txtRegNo").prop('disabled', false);
            modalWindow.find('input,select').prop('disabled', false);
            modalWindow.find("#divAttachment,#btnAddAttachment").show();
        }        
        else if (_mode == 'editAfterApproved') {

            modalWindow.find(".modal-title").text('Create Lot Release');
            modalWindow.find("#btnSave").show();
            modalWindow.find("#btnFinish").hide();
            //modalWindow.find('input,select').not("#txtLotReleasedGeneric,#txtLotReleasedStrength,#ddlLotReleasedDosageType,#txtRegNo").prop('disabled', false);
            modalWindow.find('input,select').prop('disabled', false);
            modalWindow.find("#divAttachment,#btnAddAttachment").hide();

            var _boolResult = isAlreadyHavingATrial(_id);
            if (_boolResult == true) {
                alert("You already edit this record!");
                return false;
            }
        } 
        else {
            modalWindow.find(".modal-title").text('Create Lot Release');
            modalWindow.find("#btnSave").show();
            modalWindow.find("#btnFinish").hide();
            //modalWindow.find('input,select').not("#txtLotReleasedGeneric,#txtLotReleasedStrength,#ddlLotReleasedDosageType,#txtRegNo").prop('disabled', false);
            modalWindow.find('input,select').prop('disabled', false);
            modalWindow.find("#divAttachment,#btnAddAttachment").hide();

            //modalWindow.find("#lblLotReleasedNo").text("001");
            /*
            var _getMax_LotReleasedNo = "Id gt 0&$top=1&$orderby=Id desc";
            GetSPListItems("LotRelease", 0, _getMax_LotReleasedNo)
                .done(function (data) {
                    var _LotReleaseNo = 0;
                    if (data.d.results && data.d.results.length > 0) {
                        _LotReleaseNo = ('000' + (data.d.results[0].Id + 1)).substr(-3);
                        modalWindow.find("#lblLotReleasedNo").text(_LotReleaseNo);
                    }
                    
                });
                */
        }


        modalWindow.find("#radApplied").prop("checked", true);
        onTypeChange();

        if (_id && Number(_id) > 0) {

            if (_mode != 'editAfterApproved') {
                modalWindow.find('#hid_LotReleasedId').val(_id);
            }

            GetSPListItems("LotRelease", _id, '')
                .done(function (data) {

                    modalWindow.modal('show');

                    var _item = data.d;
                    if (_item) {

                        modalWindow.find('#hid_ProductId').val(_item.ProductLookupId);
                        modalWindow.find('#hid_RelatedLotReleasedId').val(_item.RelatedRecordLookupId);
                        

                        modalWindow.find('#ddlLotReleasedCompany').val(_item.CompanyLookupId);
                        //bindProductsDDL(_item.ProductLookupId);
                        //modalWindow.find('#ddlLotReleasedProduct').val(_item.ProductLookupId);

                        modalWindow.find('#txtBatchNo').val(_item.BatchNo);
                        modalWindow.find('#txtBatchSize').val(_item.BatchSize);
                        //modalWindow.find('#txtDateOfManufacturing').val(_item.DateOfManufacturing);
                        modalWindow.find("#txtDateOfManufacturing").datepicker('setDate', new Date(_item.DateOfManufacturing));
                        modalWindow.find("#txtDateOfExpiry").datepicker('setDate', new Date(_item.DateOfManufacturing));
                        //modalWindow.find('#txtDateOfExpiry').val(_item.DateOfExpiry);



                        //modalWindow.find('#hid_ProductId').val(_item.Id);
                        modalWindow.find('#txtLotReleasedProduct').val(_item.ProductTitle);
                        modalWindow.find('#ddlLotReleasedDosageType').val(_item.ProductDosageTypeLookupId);
                        modalWindow.find('#txtLotReleasedGeneric').val(_item.ProductGeneric);
                        modalWindow.find('#txtLotReleasedStrength').val(_item.ProductStrength);
                        modalWindow.find('#txtRegNo').val(_item.ProductRegistrationNo);



                        if (_item.Stage == "Applied") {
                            modalWindow.find("#radApplied").prop('checked', true);
                        } else if (_item.Stage == "Approved") {
                            modalWindow.find("#radApproved").prop('checked', true);

                            modalWindow.find("#txtDateOfIssuance").datepicker('setDate', new Date(_item.DateOfIssuance));
                            modalWindow.find("#txtLotReleasedNo").val(_item.LotReleaseNo);
                        }
                        onTypeChange();
                        //RegNo: '',
                        //LotReleaseNo: '',

                        if (_mode == 'editAfterApproved') {
                            modalWindow.find('#hid_RelatedLotReleasedId').val(_item.Id);
                            
                            modalWindow.find("#txtLotReleasedProduct").prop('disabled', true).addClass("disabled");
                            modalWindow.find("#txtBatchNo").prop('disabled', true).addClass("disabled");
                            modalWindow.find("#radApplied,#radApproved").prop('disabled', true).addClass("disabled");

                            modalWindow.find("#radApproved").prop('checked', true);

                            onTypeChange();
                            
                        } else {

                            bindAttachment(_item.Id, _mode);
                        }

                        if(Number(_item.RelatedRecordLookupId) > 0)
                        {
                            modalWindow.find("#txtLotReleasedProduct").prop('disabled', true).addClass("disabled");
                            modalWindow.find("#txtBatchNo").prop('disabled', true).addClass("disabled");

                            modalWindow.find("#radApplied,#radApproved").prop('disabled', true).addClass("disabled");
                        }


                        //bindLotReleasedProductDetials(_item.ProductLookupId);

                    }

                    //modalWindow.modal('show');

                });

        } else {

            modalWindow.find('#hid_LotReleasedId').val("0");
            modalWindow.modal('show');
        }
    }



    function bindLotReleasedCompanyDDLs() {

        $("#ddlLotReleasedCompany,#ddlLotReleasedDosageType").find('option').remove();
        $("#ddlLotReleasedCompany,#ddlLotReleasedDosageType").append("<option value=''> -- None -- </option>");

        var isActiveFilter = ""; //"IsActive eq '1'";

        GetSPListItems("Companies", 0, isActiveFilter)
            .done(function (data) {
                try {

                    if (data && data.d && data.d.results.length > 0) {
                        for (var _u = 0 ; _u < data.d.results.length; _u++) {
                            var _thisUserItem = data.d.results[_u];
                            var newOPtion = "<option value='" + _thisUserItem.Id + "'>" + _thisUserItem.Title + "</option>";
                            $("#ddlLotReleasedCompany").append(newOPtion);
                        }
                    }

                } catch (ex) { console.log(ex); }
            });


        GetSPListItems("DosageType", 0, isActiveFilter)
            .done(function (data) {
                try {

                    if (data && data.d && data.d.results.length > 0) {
                        for (var _u = 0 ; _u < data.d.results.length; _u++) {
                            var _thisUserItem = data.d.results[_u];
                            var newOPtion = "<option value='" + _thisUserItem.Id + "'>" + _thisUserItem.Title + "</option>";
                            $("#ddlLotReleasedDosageType").append(newOPtion);
                        }
                    }

                } catch (ex) { console.log(ex); }
            });

    }
    
    var _selectProductId = 0;
    function bindProductsDDL(_id) {

        _selectProductId = _id;

        $("#ddlLotReleasedProduct").find('option').remove();
        $("#ddlLotReleasedProduct").append("<option value=''> -- None -- </option>");

        var modWin = $("#divModal-LotReleased");
        modWin.find('#hid_ProductId').val('0');
        modWin.find('#ddlLotReleasedDosageType').val('');
        modWin.find('#txtLotReleasedGeneric').val('');
        modWin.find('#txtLotReleasedStrength').val('');
        modWin.find('#txtRegNo').val('');
        

        var _cID = $("#ddlLotReleasedCompany").val();
        if (Number(_cID) > 0) {
            var isActiveFilter = "CompanyLookupId eq '" + _cID + "'"; //"IsActive eq '1'";

            GetSPListItems("Products", 0, isActiveFilter)
                .done(function (data) {
                    try {
                        if (data && data.d && data.d.results.length > 0) {
                            for (var _u = 0 ; _u < data.d.results.length; _u++) {
                                var _thisItem = data.d.results[_u];
                                var newOPtion = "<option value='" + _thisItem.Id + "'>" + _thisItem.Title + "</option>";
                                $("#ddlLotReleasedProduct").append(newOPtion);
                            }

                            if (_selectProductId && Number(_selectProductId) > 0) {
                                $("#ddlLotReleasedProduct").val(_selectProductId);
                            }
                        }
                    } catch (ex) { console.log(ex); }
                });
        }


    }

    function onTypeChange(_control) {
        var isApprovedChecked = $("#radApproved").prop('checked');
        if (isApprovedChecked == true) {
            $(".approverecord-data").show();
        } else {
            $(".approverecord-data").hide();
        }
    }

    function onSelectLotReleasedProduct(_id) {
        
        var _id = $("#ddlLotReleasedProduct").val();
        bindLotReleasedProductDetials(_id);
    }

    function bindLotReleasedProductDetials(_id) {

        var modalWindow = $("#divModal-LotReleased");
        modalWindow.find('#hid_ProductId').val('0');
        modalWindow.find('#ddlLotReleasedDosageType').val('');
        modalWindow.find('#txtLotReleasedGeneric').val('');
        modalWindow.find('#txtLotReleasedStrength').val('');
        modalWindow.find('#txtRegNo').val('');


        if (_id && Number(_id) > 0) {

            GetSPListItems("Products", _id, '')
                .done(function (data) {

                    var modalWindow = $("#divModal-LotReleased");
                    var _item = data.d;
                    if (_item) {


                        //modalWindow.find(".modal-title").text('Edit Lot Release');

                        //modalWindow.find('#hid_LotReleasedId').val(_item.Id);
                        modalWindow.find('#hid_ProductId').val(_item.Id);
                        modalWindow.find('#ddlLotReleasedDosageType').val(_item.DosageTypeId);
                        modalWindow.find('#txtLotReleasedGeneric').val(_item.Generic);
                        modalWindow.find('#txtLotReleasedStrength').val(_item.Strength);
                        modalWindow.find('#txtRegNo').val(_item.RegistrationNo);
                        
                        onTypeChange();
                        
                    }

                    //modalWindow.modal('show');

                });


        } /*else {

            modalWindow.find("select,input[type='text'],input[type='hidden']").not("#ddlLotReleasedCompany,#ddlLotReleasedProduct").val('');
            modalWindow.find(".is-invalid").removeClass("is-invalid");
        }*/

    }
    

    function SearchCol(_index) {
        var tableSelector = '#tblLotReleased';
        var table = $(tableSelector);
        var datatable = $(tableSelector).DataTable();

        table.find('th input,th select').each(function () {
            var index = $(this).parents('th').data("column");
            var searchByValue = $(this).val();
            var isExpression = false;

            if (index > -1) {
                datatable.column(index).search(searchByValue);
            }
        });

        datatable.draw();
    }

</script>

<script type="text/javascript">

    function saveLotRealeased(_action) {

        var isValid = true;

        var modalWindow = $("#divModal-LotReleased");


        modalWindow.find('.is-invalid').removeClass("is-invalid");

        if ((modalWindow.find("#ddlLotReleasedCompany").val().length > 0) == false) {
            isValid = false;
            modalWindow.find("#ddlLotReleasedCompany").addClass("is-invalid");
        }
        /*if ((modalWindow.find("#ddlLotReleasedProduct").val().length > 0) == false) {
            isValid = false;
            modalWindow.find("#ddlLotReleasedProduct").addClass("is-invalid");
        }*/
        if ((modalWindow.find("#txtLotReleasedProduct").val().trim().length > 0) == false) {
            isValid = false;
            modalWindow.find("#txtLotReleasedProduct").addClass("is-invalid");
        }


        if ((modalWindow.find("#txtBatchNo").val().length > 0) == false) {
            isValid = false;
            modalWindow.find("#txtBatchNo").addClass("is-invalid");
        }

        if ((modalWindow.find("#txtBatchSize").val().length > 0) == false) {
            isValid = false;
            modalWindow.find("#txtBatchSize").addClass("is-invalid");
        }

        if ((modalWindow.find("#txtDateOfManufacturing").val().length > 0) == false) {
            isValid = false;
            modalWindow.find("#txtDateOfManufacturing").addClass("is-invalid");
        }

        if ((modalWindow.find("#txtDateOfExpiry").val().length > 0) == false) {
            isValid = false;
            modalWindow.find("#txtDateOfExpiry").addClass("is-invalid");
        }

        if ($("#radApproved").prop('checked') == true) {
            if ((modalWindow.find("#txtDateOfIssuance").val().length > 0) == false) {
                isValid = false;
                modalWindow.find("#txtDateOfIssuance").addClass("is-invalid");
            }
            if ((modalWindow.find("#txtLotReleasedNo").val().trim().length > 0) == false) {
                isValid = false;
                modalWindow.find("#txtLotReleasedNo").addClass("is-invalid");
            }
        }


        if (isValid == true) {

            var _recordID = $("#hid_LotReleasedId").val();

            //var _productId = modalWindow.find('#ddlLotReleasedProduct').val();

            var jsonData = {
                CompanyLookupId: $("#ddlLotReleasedCompany").val(),
                //ProductLookupId: _productId,
                RegNo: modalWindow.find('#txtRegNo').val(),
                BatchNo: modalWindow.find('#txtBatchNo').val(),
                BatchSize: modalWindow.find('#txtBatchSize').val(),
                DateOfManufacturing: modalWindow.find("#txtDateOfManufacturing").datepicker('getDate'),
                DateOfExpiry: modalWindow.find("#txtDateOfExpiry").datepicker('getDate'),

                ProductTitle: modalWindow.find('#txtLotReleasedProduct').val(),
                ProductGeneric: modalWindow.find('#txtLotReleasedGeneric').val(),
                ProductStrength: modalWindow.find('#txtLotReleasedStrength').val(),
                ProductRegistrationNo: modalWindow.find('#txtRegNo').val(),

                //DateOfIssuance: '',
            }

            var _isUniqueValue = checkForDuplicateValues(jsonData.ProductTitle, jsonData.BatchNo, _recordID);

            var _relatedRecordLookupId = Number(modalWindow.find('#hid_RelatedLotReleasedId').val());
            if (_relatedRecordLookupId > 0) {
                jsonData.RelatedRecordLookupId = _relatedRecordLookupId;
                _isUniqueValue = true; // bypass unique check, for related record
            }

            

            if (_isUniqueValue == true) {
                RequestStarted();


                if (Number(modalWindow.find("#ddlLotReleasedDosageType").val()) > 0) {
                    jsonData.DosageForm = modalWindow.find("#ddlLotReleasedDosageType").find("option:selected").text();                    
                    jsonData.ProductDosageTypeLookupId = modalWindow.find('#ddlLotReleasedDosageType').val();
                } else {
                    jsonData.DosageForm = "";
                    jsonData.ProductDosageTypeLookupId = null;
                }


                if ($("#radApplied").prop('checked') == true) {
                    jsonData.Stage = 'Applied';
                }
                else if ($("#radApproved").prop('checked') == true) {
                    jsonData.Stage = 'Approved';
                    jsonData.DateOfIssuance = modalWindow.find("#txtDateOfIssuance").datepicker('getDate');
                    jsonData.LotReleaseNo = modalWindow.find('#txtLotReleasedNo').val();
                }


                if (_action == 'finish') {
                    jsonData.Status = 'Pending';
                }



                if (Number(_recordID) > 0) {

                    UpdateSPList("LotRelease", _recordID, jsonData).done(function (data) {

                        saveActionLog(_recordID, "Edit", jsonData.Status, Module.LotRelease);

                        alert('Lot Release has been edit successfully');
                        // Retrive Nomenclatures newly Added

                        $("#divModal-LotReleased").modal('hide');

                        bindLotReleasedTable();

                        sendNotification();

                        RequestEnded();


                    }).fail(function (jqXHR, textStatus) {

                        alert("Lot Release Saving Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                        RequestEnded();
                    });

                }
                else {

                    if (jsonData.Status == null || typeof (jsonData.Status) == "undefined") {
                        jsonData.Status = 'Draft';
                    }

                    InsertIntoSPList('LotRelease', jsonData).done(function (data) {
                        //console.log(data.d.results);
                        if (Number(data.d.ID) > 0) {


                            saveActionLog(data.d.ID, "Created", data.d.Status, Module.LotRelease);

                            openLotReleased(data.d.ID, "edit");



                            alert('Lot Release has been created successfully');

                            setTimeout(function () {
                                bindLotReleasedTable();
                            }, 50);

                            //$("#divModal-LotReleased").modal('hide');

                            RequestEnded();
                        }

                    }).fail(function (jqXHR, textStatus) {

                        alert("Lot Release Saving Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                        RequestEnded();
                    });
                }
            }
            else {
                
                
                modalWindow.find("#txtLotReleasedProduct").addClass("is-invalid");                
                modalWindow.find("#txtBatchNo").addClass("is-invalid");

                alert("Product Name: '" + modalWindow.find("#txtLotReleasedProduct").val() + "' with Batch No: '" + modalWindow.find("#txtBatchNo").val() + "' is already exists!");
            }
        }
        else {
            alert("Please fill highlighted fields first!");
        }
    }



    function checkForDuplicateValues(_name, _batchNo, _id) {
        var isValidName = true;

        //var filterProducts = "ProductTitle eq '" + _name + "' and BatchNo eq '" + _batchNo + "' and IsDeleted eq 0 ";
        var filterProducts = "ProductTitle eq '" + _name + "' and BatchNo eq '" + _batchNo + "' ";
        if (Number(_id) > 0) {
            filterProducts = filterProducts + " and Id ne '" + _id + "'";
        }
        GetSPListItems("LotRelease", 0, filterProducts, false)
            .done(function (data) {

                var response = data.d.results;

                if (response.length > 0) {
                    isValidName = false;
                }

            });

        return isValidName;
    }


    function isAlreadyHavingATrial(_id) {
        var isValidName = false;

        if (Number(_id) > 0) {

            //var filterProducts = "ProductTitle eq '" + _name + "' and BatchNo eq '" + _batchNo + "' and IsDeleted eq 0 ";
            var filterProducts = "RelatedRecordLookupId eq '" + _id + "' and Status ne 'Rejected'";

            GetSPListItems("LotRelease", 0, filterProducts, false)
                .done(function (data) {

                    var response = data.d.results;

                    if (response.length > 0) {
                        isValidName = true;
                    }

                });
        }
        return isValidName;
    }

    function deleteLotRealeased(_recordID) {

        var _confirmResult = confirm("Are you sure you want to delete this Lot Release?");
        if (_confirmResult == true) {

            GetSPListItems("LotRelease", _recordID, '').done(function (data) {

                if (data && data.d) {
                    deleteItem("LotRelease", data.d).done(function (data) {
                        alert('Lot Release has been deleted successfully');

                        //var _hid_ProductId = $("#divModal-LotReleased").find('#hid_ID').val();
                        bindLotReleasedTable();

                        RequestEnded();
                    });
                }

            }).fail(function (jqXHR, textStatus) {

                alert("Lot Release Deleting Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                RequestEnded();
            });
        }

    }



</script>



<script type="text/javascript">


    function openAddAttachment(_id) {

        var modalWindow = $("#divModal-Attachment");

        var _lotReleasedId = $("#divModal-LotReleased").find('#hid_LotReleasedId').val();

        // reset All controls
        modalWindow.find("select,input[type='text'],input[type='hidden']").val('');
        modalWindow.find(".is-invalid").removeClass("is-invalid");

        if (_lotReleasedId && Number(_lotReleasedId) > 0) {


            modalWindow.modal('show');

            _needtoReopenthisWindow = $("#divModal-LotReleased");

        }
    }

    function bindAttachment(_lotReleasedId, mode) {

        if (Number(_lotReleasedId) > 0) {

            // Specify the Id of the Item that you want to fetch
            $('#tblAttachment>tbody').html('<tr><td colspan="6">No attachment attachted!</td></tr>');

            var idFilter = "LotReleaseLookupId eq " + _lotReleasedId;


            var filterProducts = idFilter + "&$select=ID,Title,FileName,Created";

            GetSPListItems("LotReleaseAttachments", 0, filterProducts)
                .done(function (data) {

                    var response = data.d.results;

                    if (response.length > 0) {
                        $('#tblAttachment>tbody').html('');
                    }

                    for (var i = 0; i < response.length ; i++) {

                        var _item = response[i];

                        var _FilePreviewOption = "<a  href='#' class='alert-link' onclick='viewDocument(" + _item.Id + ",\"" + _item.FileName + "\");' title='Preview'  ><i class='glyphicon glyphicon-file'></i> " + _item["FileName"] + "</a>";



                        var newRow = "<tr id='" + _item["ID"] + "'>" +

                            "<td>" + (i + 1) + "</td>" +
                            "<td>" + _FilePreviewOption + "</td>" +
                            "<td>" + toDisplayDate(_item["Created"]) + "</td>";
                        //"<td>" + (_item["IsCertificate"] == true ? 'Yes' : 'No') + "</td>";

                        var _actionButtonHTML = "<a href='#'  title='Delete'  onclick='deleteLotReleaseAttachment(" + _item.Id + ")' ><i class='glyphicon glyphicon-trash'></i></a>";
                       
                        if (mode == 'view') {
                            _actionButtonHTML = "";
                        }

                        newRow = newRow + "<td align='center' style='text-align:center;' class='h5'>" + _actionButtonHTML + "</td>";
                        newRow = newRow + "</tr>";

                        $('#tblAttachment>tbody').append(newRow);

                    }

                });
        }
    }


    function viewDocument(_fileId, _FileTitle) {
        if (Number(_fileId) > 0) {

            //jQuery.noConflict();
            $('#divModal_ViewDocument').find("#h4NomenclatureTitle").text(_FileTitle);
            $('#divModal_ViewDocument').find("#frmpdf").remove();


            //$("#divModal_ViewAllAttachements").removeClass('fade');
            //$("#divModal_ViewAllAttachements").modal('hide');
            //setTimeout(function () {
            //    _needtoReopenthisWindow = $("#divModal_ViewAllAttachements");

            //}, 500);

            //$('#divModal_ViewDocument').find("#frmpdf").get(0).src = "";
            //$('#divModal_ViewDocument').find("#frmpdf").get(0).style.display = "none";

            //setTimeout(function () { },0);

            var listName = 'LotReleaseAttachments';
            var apiURL = _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('" + listName + "')/items/GetById(" + _fileId + ")/file";

            $.ajax({
                url: apiURL,
                type: "GET",
                headers: {
                    "Accept": "application/json; odata=verbose",
                },
                success: function (dataFileInfo) {

                    if (dataFileInfo.d) {

                        var fileURL = location.origin + dataFileInfo.d.ServerRelativeUrl;
                        window.open(fileURL, '_blank');

                        /*
                        if (fileURL.search('.docx') > 0) {
                            downloadFunction(fileURL);
                            alert("File has been downloaded!");
                        }
                        else {
                            //document.getElementById("frmpdf").style.display = "block";
                            //document.getElementById("frmpdf").src = fileURL;

                            var _iframe = document.createElement("iframe");
                            _iframe.id = "frmpdf";
                            _iframe.src = fileURL;
                            _iframe.width = "100%";
                            _iframe.height = "700px";

                            var element = document.getElementById("divfrmpdf");
                            element.appendChild(_iframe);


                            jQuery.noConflict();
                            jQuery('#divModal_ViewDocument').modal('show');
                        }*/
                    }
                },
                error: function (error) {
                    console.log("Error on getting file info", error);

                    RequestEnded();
                }
            });
        }
        else {
            alert("No document found!");
        }

    }

</script>



<script type="text/javascript">


    // start
    function saveAttachment() {

        var docidall = "0;";
        // Define the folder path for this example.
        var serverRelativeUrlToFolder = 'LotReleaseAttachments';

        // Get test values from the file input and text input page controls.
        var fileInput = jQuery('#fileAttachedFiles');
        var fileCount = fileInput[0].files.length;
        // Get the server URL.
        var serverUrl = _spPageContextInfo.webAbsoluteUrl;
        var filesUploaded = 0;

        var _lotReleasedId = $("#divModal-LotReleased").find('#hid_LotReleasedId').val();

        if (isPDFFiles()) {

            RequestStarted();

            for (var i = 0; i < fileCount; i++) {
                // Initiate method calls using jQuery promises.
                // Get the local file as an array buffer.
                var getFile = getFileBuffer(i);
                getFile.done(function (arrayBuffer, i) {

                    // Add the file to the SharePoint folder.
                    var addFile = addFileToFolder(arrayBuffer, i);
                    addFile.done(function (data, status, xhr) {
                        //$("#msg").append("<div>File : "+file.d.Name+" ... uploaded sucessfully</div>");
                        filesUploaded++;
                        var file = data.d;
                        // register/post register

                        var updateObject = {
                            __metadata: {
                                type: file.ListItemAllFields.__metadata.type
                            },
                            LotReleaseLookupId: _lotReleasedId,
                            FileName: fileInput[0].files[i].name,
                            TypeOfLotRelease:   ($("#divModal-LotReleased").find("#radApproved").prop('checked')  == true ? "Approved" : "Applied")
                        };

                        var url = serverUrl + "/_api/Web/lists/getbytitle('" + serverRelativeUrlToFolder + "')/items(" + file.ListItemAllFields.Id + ")";
                        docidall += file.ListItemAllFields.Id + ";";
                        updateFileMetadata(url, updateObject, file, function (result) {
                            //alert("File metadata updation done successfully");
                        }, function (result) {
                            //alert("File upload done but metadata updating FAILED");
                        });
                        if (fileCount == filesUploaded) {

                            bindAttachment(_lotReleasedId);
                            RequestEnded();
                            alert("All files uploaded successfully.");
                            $('#divModal-Attachment').modal('hide');
                            $("#fileAttachedFiles").val("");

                            
                            filesUploaded = 0;
                        }
                    });
                    addFile.fail(onError);
                });
                getFile.fail(onError);
            }
        }

        function isPDFFiles() {
            var flag = true;
            var files = fileInput[0].files;
            var maxsize = 2 * 1024 * 1024 * 1024;//2GB
            for (var i = 0; i < files.length; i++) {
                // validate extension
                //if (files[i].name.split(".")[1].toLowerCase() != "pdf") {
                //    flag = false;
                //    alert("Please update PDF files.");
                //    break;
                //}
                if (files[i].name.substr(-3).toLowerCase() != "pdf") {
                    flag = false;
                    alert("Please update PDF files.");
                    break;
                }

                // validate file size
                if (files[i].size > maxsize) {
                    flag = false;
                    alert("File size must be under 2GB.");
                    break;

                }
            }
            return flag;
        }
        //update file metadata
        function updateFileMetadata(apiUrl, updateObject, file, success, failure) {
            $.ajax({
                url: apiUrl,
                type: "POST",
                async: false,
                data: JSON.stringify(updateObject),
                headers: {
                    "accept": "application/json;odata=verbose",
                    "X-RequestDigest": $("#__REQUESTDIGEST").val(),
                    "Content-Type": "application/json;odata=verbose",
                    "X-Http-Method": "MERGE",
                    "IF-MATCH": file.ListItemAllFields.__metadata.etag,
                },
                success: function (data) {
                    success(data);
                },
                error: function (data) {
                    failure(data);
                }
            });
        }
        // Get the local file as an array buffer.
        function getFileBuffer(i) {
            var deferred = jQuery.Deferred();
            var reader = new FileReader();
            reader.onloadend = function (e) {
                deferred.resolve(e.target.result, i);
            }
            reader.onerror = function (e) {
                deferred.reject(e.target.error);
            }
            reader.readAsArrayBuffer(fileInput[0].files[i]);
            return deferred.promise();
        }

        // Add the file to the file collection in the Shared Documents folder.
        function addFileToFolder(arrayBuffer, i) {
            var index = i;

            // Get the file name from the file input control on the page.
            //   var fileName = fileInput[0].files[index].name;

            var today = new Date();
            var cHour = today.getHours();
            var cMin = today.getMinutes();
            var cSec = today.getSeconds();
            //  var fileName = fileInput[0].val().split('.').pop();

            // var fileName = fileInput[0].files[index].name.split('.');
            var filenameLength = fileInput[0].files[index].name.length;
            var fileName = fileInput[0].files[index].name.substr(0, filenameLength - 4);

            fileName = fileName + "-" + cHour + "-" + cMin + "-" + cSec + ".pdf";


            // Construct the endpoint.
            var fileCollectionEndpoint = String.format(
                "{0}/_api/web/getfolderbyserverrelativeurl('{1}')/files" +
                "/add(overwrite=true, url='{2}')?$expand=ListItemAllFields",
                serverUrl, serverRelativeUrlToFolder, fileName);

            // Send the request and return the response.
            // This call returns the SharePoint file.
            return jQuery.ajax({
                url: fileCollectionEndpoint,
                type: "POST",
                data: arrayBuffer,
                processData: false,
                headers: {
                    "accept": "application/json;odata=verbose",
                    "X-RequestDigest": jQuery("#__REQUESTDIGEST").val(),
                    "content-length": arrayBuffer.byteLength
                }
            });
        }

    }
    // Display error messages.
    function onError(error) {
        alert('File Uploading Fail! Try again after refreshing page.\n\nError Text:\n\n' + error.responseText);
        RequestEnded();
    }




    function deleteLotReleaseAttachment(_recordID) {

        var _confirmResult = confirm("Are you sure you want to delete this attachment?");
        if (_confirmResult == true) {

            GetSPListItems("LotReleaseAttachments", _recordID, '').done(function (data) {

                if (data && data.d) {
                    deleteItem("LotReleaseAttachments", data.d).done(function (data) {
                        alert('Attachment has been deleted successfully');


                        var _recordId = $("#divModal-LotReleased").find('#hid_LotReleasedId').val();

                        bindAttachment(_recordId, 'Edit');

                        RequestEnded();
                    });
                }

            }).fail(function (jqXHR, textStatus) {

                alert("LotRelease Deleting Fail! \n\nDetails\n" + jqXHR.responseJSON.error.message.value);
                RequestEnded();
            });
        }

    }

</script>


<!--  Notification  -->
<script type="text/javascript">




    function notificationMarkAsSeen() {
        try {

            var _rid = GetUrlKeyValue('rid');
            var _notid = GetUrlKeyValue('notid');

            if (Number(_notid) > 0 && Number(_rid) > 0) {

                tblLotReleasedDataTable.column(0).visible(true);
                $('#tblLotReleased').find(".record-id").val("-" + _rid + "-").trigger('change');
                tblLotReleasedDataTable.column(0).visible(false);


                markAsRead(_notid);

            }


            /*var _ProductId = $('#hid_ID').val();

            if (Number(_ProductId) > 0) {

                var notificationsJson = {
                    RecordId: "" + _ProductId
                };

                notificationsJson.ModuleType = Module.Artwork;


                var filterNomenclature = "HasSeen eq 0 and NotifyToUsersId eq " + _spPageContextInfo.userId + " and ModuleType eq '" + notificationsJson.ModuleType + "' and RecordId eq '" + notificationsJson.RecordId + "' and Action ne 'Submit'&$top=1000&$select=Id,Title,RecordId,ProductLookupId,ArtworkLookupId,CredentialLookupId,Action,HasSeen,SeenOn,ModuleType,Created";
                GetSPListItems("Notifications", 0, filterNomenclature)
                 .done(function (data) {

                     var response = data.d.results;
                     for (var i = 0; i < response.length ; i++) {
                         if (Number(response[i].Id) > 0) {
                             markAsRead(response[i].Id);
                         }
                     }
                 });

            }*/

        } catch (ex2) {
            console.log(ex2);
        }
    }


    function sendNotification() {


        /*

Title   Single line of text
Modified	Date and Time
Created	Date and Time
Action	Single line of text
NotifyToLookup	Lookup
NotifyToUsers	Person or Group
ActionByUser	Lookup
HasSeen	Yes/No
SeenOn	Date and Time
RecordId	Single line of text
ProductLookup	Lookup
ArtworkLookup	Lookup
CredentialLookup	Lookup
ModuleType	Single line of text
Created By	Person or Group
Modified By	Person or Group

            */

        var sendNotifiaction = false;

        var notificationText = "";
        var notificationToUserLookupIds = [];
        var notificationToSPUserIds = [];
        var notificationAsGroup = false;



        notificationText = "A Lot Release has been submitted and waiting for your approval!";

        var profileIdLst = [];
        //var filterProfileQuery = "CanApprove eq 1 and ModuleType eq '" + Module.LotRelease + "' and CountryLookupId eq " + $("#divModal-CompanyCredentialsDetails").find('#ddlCountry').val() + "&$top=5000&$select=Id,ProfileLookupId";
        var filterProfileQuery = "CanApprove eq 1 and ModuleType eq '" + Module.LotRelease + "' &$top=5000&$select=Id,ProfileLookupId";
        GetSPListItems("ProfileRights", 0, filterProfileQuery, false)
            .done(function (data) {
                if (data.d.results.length > 0) {
                    data.d.results.forEach(function (pdetails) {

                        if (Number(pdetails.ProfileLookupId) > 0) {

                            profileIdLst.push(pdetails.ProfileLookupId);

                        }
                    });

                }
            });

        var filterQuery = "IsActive eq 1&$top=5000&$select=Id,LoginIDId,ProfileLookupId";
        GetSPListItems("Users", 0, filterQuery, false)
            .done(function (data) {
                if (data.d.results.length > 0) {

                    data.d.results.forEach(function (uid) {
                        if (Number(uid.LoginIDId) > 0 && Number(uid.LoginIDId) != _spPageContextInfo.userId) {
                            if (uid.ProfileLookupId && uid.ProfileLookupId != null && uid.ProfileLookupId.results != null && uid.ProfileLookupId.results.length > 0) {
                                uid.ProfileLookupId.results.forEach(function (profileId) {

                                    if (Number(profileId) > 0 && profileIdLst.includes(profileId)) {

                                        notificationToUserLookupIds.push(uid.Id);
                                        notificationToSPUserIds.push(uid.LoginIDId);

                                        sendNotifiaction = true;
                                        notificationAsGroup = true;
                                    }

                                });
                            }
                        }
                    });

                }
            });




        if (sendNotifiaction == true) {

            if (notificationAsGroup == true) {

                var notificationsJson = {
                    Title: notificationText,
                    RecordId: $('#hid_LotReleasedId').val(),
                    LotReleaseLookupId: $('#hid_LotReleasedId').val(),
                    Action: "Submit",
                    ActionByUserId: currentUserCustomInfo.Id,
                    NotifyToUsersId: { 'results': notificationToSPUserIds },
                    NotifyToLookupId: { 'results': notificationToUserLookupIds },
                    HasSeen: false,
                    ModuleType: Module.LotRelease

                }

                InsertIntoSPList("Notifications", notificationsJson).done(function (data) {
                    console.log("Notifications Saved.");
                }).fail(onerror);

            }
        }
    }

</script>



